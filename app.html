<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DocuWrite Pro</title>
    <meta name="description" content="DocuWrite Pro Mobile App">
    <link rel="manifest" href="manifest.json">
    
    <!-- Mobile Web App Capable -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2f2f7">

    <!-- Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        /* --- 1. RESET & VARIABLES (THEMING) --- */
        :root {
            /* Default Light Mode Variables */
            --primary-color: #007AFF;
            --primary-light: rgba(0, 122, 255, 0.1);
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --separator: #E5E5EA;
            --danger: #FF3B30;
            --danger-bg: rgba(255, 59, 48, 0.1);
            --nav-bg: rgba(255, 255, 255, 0.85);
            --nav-border: rgba(0,0,0,0.05);
            --search-bg: rgba(142, 142, 147, 0.12);
            --picker-overlay: rgba(0,0,0,0.4);
            
            /* Dimensions */
            --nav-height: 84px;
            --radius-xl: 24px;
            --radius-lg: 16px;
            
            /* Shadows */
            --shadow-card: 0 4px 12px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.04);
        }

        /* Explicit Dark Mode Overrides */
        html[data-theme="dark"] {
            --primary-color: #0A84FF;
            --primary-light: rgba(10, 132, 255, 0.2);
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #98989D;
            --separator: #38383A;
            --nav-bg: rgba(28, 28, 30, 0.85);
            --nav-border: rgba(255,255,255,0.1);
            --search-bg: rgba(118, 118, 128, 0.24);
            --picker-overlay: rgba(0,0,0,0.6);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-touch-callout: none;
            user-select: none;
        }

        input, textarea, [contenteditable] { user-select: text; }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            overflow: hidden;
            overscroll-behavior-y: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- 2. LAYOUT --- */
        #app-container {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            padding-bottom: var(--nav-height);
            position: relative;
        }

        .tab-view {
            flex: 1;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            display: none;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
        }

        .tab-view.active { display: block; animation: fadeIn 0.25s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- 3. BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: var(--nav-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--nav-border);
            display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 12px; z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-secondary); font-size: 11px; font-weight: 500;
            flex: 1; cursor: pointer; transition: transform 0.1s;
        }
        .nav-item:active { transform: scale(0.9); }
        .nav-item.active { color: var(--primary-color); }
        .nav-item .material-symbols-rounded { 
            font-size: 26px; margin-bottom: 4px; 
            font-variation-settings: 'FILL' 0, 'wght' 400;
            transition: all 0.2s;
        }
        .nav-item.active .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 500; }
        
        #nav-scan { display: none; } 
        body.online #nav-scan { display: flex; }

        /* --- 4. COMPONENTS --- */
        h2 { font-size: 34px; font-weight: 700; margin: 20px 0 15px 0; letter-spacing: -0.5px; color: var(--text-primary); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px 0; }
        .section-title { font-size: 20px; font-weight: 700; letter-spacing: -0.4px; }
        .clear-btn { color: var(--primary-color); font-size: 15px; font-weight: 600; padding: 8px 0; }

        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px; }
        .action-btn {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 16px;
            display: flex; flex-direction: row; align-items: center;
            box-shadow: var(--shadow-card); transition: transform 0.1s; cursor: pointer;
        }
        .action-btn:active { transform: scale(0.97); background: var(--separator); }
        .action-icon-circle {
            width: 44px; height: 44px; background: var(--primary-light); color: var(--primary-color);
            border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;
        }
        .action-label { font-size: 15px; font-weight: 600; text-align: left; line-height: 1.2; }

        /* Tool Grid */
        .tools-grid, .recent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 15px; padding-bottom: 20px; }
        .tool-card {
            background: var(--bg-card); border-radius: var(--radius-xl); padding: 18px 10px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            box-shadow: var(--shadow-card); transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .tool-card:active { transform: scale(0.95); opacity: 0.8; }
        .tool-card span.material-symbols-rounded { 
            font-size: 32px; color: var(--primary-color); margin-bottom: 12px;
            background: var(--primary-light); padding: 10px; border-radius: 16px; 
        }
        .tool-name { font-size: 13px; line-height: 1.35; font-weight: 500; color: var(--text-primary); }

        /* Templates (Horizontal) */
        #templates-section { margin-bottom: 10px; }
        .templates-grid {
            display: flex; overflow-x: auto; gap: 15px; padding: 5px 5px 20px 5px;
            scroll-snap-type: x mandatory; scrollbar-width: none;
        }
        .templates-grid::-webkit-scrollbar { display: none; }
        .template-card {
            min-width: 140px; width: 140px; background: var(--bg-card); border-radius: var(--radius-lg);
            overflow: hidden; box-shadow: var(--shadow-card); scroll-snap-align: start;
        }
        .template-img { width: 100%; height: 90px; object-fit: cover; background: #eee; }
        .template-name { padding: 10px; font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .show-all-templates-btn {
            min-width: 60px; display: flex; align-items: center; justify-content: center;
            background: var(--bg-card); color: var(--primary-color); border-radius: var(--radius-lg);
            font-weight: 600; font-size: 13px; box-shadow: var(--shadow-card); cursor: pointer;
        }

        /* Tools Bar */
        .tools-top-bar {
            position: sticky; top: -1px; z-index: 100;
            background: var(--bg-body); backdrop-filter: blur(10px);
            padding: 10px 0; display: flex; gap: 12px; margin-bottom: 10px; align-items: center;
        }
        .search-box {
            flex: 1; background: var(--search-bg); border-radius: 10px; padding: 10px 12px;
            display: flex; align-items: center;
        }
        .search-box input { border: none; background: transparent; width: 100%; outline: none; margin-left: 8px; font-size: 16px; color: var(--text-primary); }
        .sort-btn { 
            width: 44px; height: 44px; background: var(--bg-card); border: none; border-radius: 50%; 
            color: var(--primary-color); box-shadow: var(--shadow-card); display: flex; align-items: center; justify-content: center;
        }
        .tool-category h3 { font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin: 25px 0 10px 5px; font-weight: 600; }

        /* --- 5. SETTINGS (CUSTOM LIST) --- */
        #tab-settings { padding: 0; background: var(--bg-body); }
        #tab-settings h2 { padding: 20px 20px 5px 20px; }
        
        /* Container for grouped settings */
        .settings-group {
            background: var(--bg-card);
            border-radius: 12px;
            margin: 0 16px 20px 16px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* Individual Row */
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px;
            background: var(--bg-card);
            cursor: pointer;
            position: relative;
        }
        
        /* Separator line between rows, but not after last */
        .setting-row:not(:last-child)::after {
            content: ""; position: absolute; bottom: 0; right: 0;
            width: calc(100% - 20px); height: 1px; background: var(--separator);
        }

        .setting-row:active { background: var(--separator); }

        .setting-label { font-size: 16px; color: var(--text-primary); font-weight: 500; }
        
        .setting-value-container { display: flex; align-items: center; gap: 8px; }
        .setting-value { font-size: 16px; color: var(--text-secondary); }
        .setting-chevron { color: var(--text-secondary); font-size: 20px; opacity: 0.5; }

        .btn-danger {
            margin: 30px 16px; width: calc(100% - 32px); background: var(--bg-card);
            color: var(--danger); border: none; padding: 16px; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
        }
        .btn-danger:active { background: var(--danger-bg); }

        /* --- 6. CUSTOM BOTTOM SHEET PICKER --- */
        #picker-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--picker-overlay); z-index: 2500;
            display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #picker-overlay.open { opacity: 1; pointer-events: auto; }

        #picker-sheet {
            background: var(--bg-body); /* Slightly distinct from card */
            border-radius: 20px 20px 0 0;
            padding: 20px 16px 40px 16px; /* Extra bottom padding for home indicator */
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 70vh; display: flex; flex-direction: column;
        }
        #picker-overlay.open #picker-sheet { transform: translateY(0); }

        .picker-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding: 0 5px;
        }
        .picker-title { font-size: 18px; font-weight: 700; }
        .picker-close { 
            width: 30px; height: 30px; background: rgba(120,120,120,0.2); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        .picker-options {
            background: var(--bg-card); border-radius: 12px; overflow: hidden;
        }
        .picker-option {
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
            font-size: 16px; border-bottom: 1px solid var(--separator); cursor: pointer;
        }
        .picker-option:last-child { border-bottom: none; }
        .picker-option:active { background: var(--separator); }
        .picker-option.selected { color: var(--primary-color); font-weight: 600; }
        .picker-check { display: none; color: var(--primary-color); font-size: 20px; }
        .picker-option.selected .picker-check { display: block; }

        /* --- 7. TOOL IFRAME (Slide Up/Down) --- */
        #tool-iframe-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 2000;
            display: flex; flex-direction: column;
            /* Transition handles both up and down */
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            box-shadow: -10px 0 20px rgba(0,0,0,0.1);
        }
        #tool-iframe-container.visible { transform: translateY(0); }
        
        .iframe-header {
            height: 56px; background: var(--nav-bg); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--separator);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; flex-shrink: 0; padding-top: env(safe-area-inset-top);
        }
        .close-tool-btn { 
            color: var(--primary-color); font-weight: 600; font-size: 16px;
            padding: 8px; cursor: pointer; 
        }

        /* Setup & Offline */
        .offline-banner {
            background-color: #323232; color: white; padding: 12px 16px; font-size: 13px; font-weight: 500;
            display: none; justify-content: space-between; align-items: center;
            position: absolute; top: env(safe-area-inset-top); left: 16px; right: 16px;
            border-radius: 8px; z-index: 900; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        body.offline .offline-banner { display: flex; }
        body.offline.banner-dismissed .offline-banner { display: none; }
        
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
        }
        #setup-overlay.hidden { display: none; }
        .setup-btn {
            background: var(--primary-color); color: white; border: none;
            padding: 16px 48px; border-radius: 30px; font-size: 17px; font-weight: 600; margin-top: 40px;
            box-shadow: 0 4px 12px rgba(0,122,255,0.3); transition: transform 0.2s;
        }
        .setup-btn:active { transform: scale(0.96); }

        #popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 2500; display: none;
            backdrop-filter: blur(4px); align-items: center; justify-content: center;
        }
        .popup-content {
            background: var(--bg-card); width: 85%; max-width: 320px;
            border-radius: 14px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); text-align: center;
        }
        
        .online-only { opacity: 1; }
        body.offline .online-only { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

        /* --- CACHING IFRAME (Hidden) --- */
        #caching-iframe {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
            border: none;
        }

        /* --- RIPPLE EFFECT --- */
        .ripple {
            position: absolute;
            background: rgba(26, 115, 232, 0.15);
            border-radius: 50%;
            transform: scale(0);
            animation: rippleEffect 0.5s linear;
            pointer-events: none;
        }
        @keyframes rippleEffect {
            to { transform: scale(4); opacity: 0; }
        }
    </style>
</head>
<body class="online">

    <!-- --- SETUP OVERLAY --- -->
    <div id="setup-overlay">
        <div style="width: 100px; height: 100px; background: white; border-radius: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <span class="material-symbols-rounded" style="font-size: 56px; color: var(--primary-color);">cloud_sync</span>
        </div>
        <h2 style="font-size: 28px; margin-bottom: 12px;">Welcome to<br>DocuWrite Pro</h2>
        <p style="font-size: 17px; color: var(--text-secondary); line-height: 1.5; max-width: 300px;">
            We're downloading all tools for offline use. This only happens once.
        </p>
        <button id="start-setup-btn" class="setup-btn">Get Started</button>
        <p id="setup-status" style="margin-top: 24px; font-size: 13px; color: var(--text-secondary); font-weight: 500;"></p>
        <div id="caching-progress" style="margin-top: 15px; width: 200px; height: 4px; background: var(--separator); border-radius: 2px; overflow: hidden;">
            <div id="progress-bar" style="width: 0%; height: 100%; background: var(--primary-color); transition: width 0.3s;"></div>
        </div>
    </div>

    <!-- --- CUSTOM PICKER (BOTTOM SHEET) --- -->
    <div id="picker-overlay" onclick="closePicker()">
        <div id="picker-sheet" onclick="event.stopPropagation()">
            <div class="picker-header">
                <span class="picker-title" id="picker-title">Select</span>
                <div class="picker-close" onclick="closePicker()">
                    <span class="material-symbols-rounded" style="font-size: 20px; color: var(--text-secondary);">close</span>
                </div>
            </div>
            <div class="picker-options" id="picker-options-container">
                <!-- Options injected via JS -->
            </div>
        </div>
    </div>

    <!-- --- APP CONTAINER --- -->
    <div id="app-container">
        
        <!-- Offline Banner -->
        <div class="offline-banner" id="offline-banner">
            <span style="display:flex; align-items:center; gap:8px;"><span class="material-symbols-rounded" style="font-size:16px">wifi_off</span> Offline Mode</span>
            <div class="banner-actions">
                <button onclick="showOfflinePopup()" style="background:rgba(255,255,255,0.1); border:none; color:white; border-radius:4px; padding:4px 8px;">Details</button>
                <button onclick="dismissBanner()" style="background:rgba(255,255,255,0.1); border:none; color:white; border-radius:4px; padding:4px 8px; margin-left:5px;">✕</button>
            </div>
        </div>

        <!-- === HOME TAB === -->
        <div id="tab-home" class="tab-view active">
            <h2 class="home-header">Home</h2>
            
            <div class="quick-actions">
                <div class="action-btn" id="btn-new-doc">
                    <div class="action-icon-circle"><span class="material-symbols-rounded">note_add</span></div>
                    <div class="action-label">New<br>Document</div>
                </div>
                <div class="action-btn" id="btn-new-img">
                    <div class="action-icon-circle"><span class="material-symbols-rounded">add_photo_alternate</span></div>
                    <div class="action-label">Edit<br>Image</div>
                </div>
                <div class="action-btn" id="btn-new-code">
                    <div class="action-icon-circle"><span class="material-symbols-rounded">terminal</span></div>
                    <div class="action-label">Write<br>Code</div>
                </div>
                <div class="action-btn" onclick="switchTab('tools')">
                    <div class="action-icon-circle" style="background: var(--bg-body); color: var(--text-secondary);"><span class="material-symbols-rounded">apps</span></div>
                    <div class="action-label">All<br>Tools</div>
                </div>
            </div>

            <!-- Templates Section -->
            <div id="templates-section">
                <div class="section-header">
                    <span class="section-title">Templates</span>
                </div>
                <div class="templates-grid" id="templates-grid"></div>
            </div>

            <div class="section-header">
                <span class="section-title">Recents</span>
                <span class="clear-btn" onclick="clearRecents()">Clear</span>
            </div>
            <div class="recent-grid" id="recent-grid">
                <div class="recent-placeholder">No recent tools used</div>
            </div>
            <div style="height: 60px;"></div>
        </div>

        <!-- === TOOLS TAB === -->
        <div id="tab-tools" class="tab-view">
            <div class="tools-top-bar">
                <div class="search-box">
                    <span class="material-symbols-rounded" style="color:var(--text-secondary); opacity:0.7;">search</span>
                    <input type="text" id="tool-search" placeholder="Search">
                </div>
                <button class="sort-btn" id="sort-trigger"><span class="material-symbols-rounded">sort</span></button>
            </div>
            <div id="tools-list-container"></div>
            <div style="height: 80px;"></div>
        </div>

        <!-- === SETTINGS TAB (CUSTOM UI) === -->
        <div id="tab-settings" class="tab-view">
            <h2>Settings</h2>
            
            <div style="margin-top: 10px;">
                <h3 style="margin: 0 0 8px 20px; font-size: 13px; color: var(--text-secondary); text-transform: uppercase;">Preferences</h3>
                
                <div class="settings-group">
                    <!-- Manual Theme Selector -->
                    <div class="setting-row" onclick="openThemePicker()">
                        <span class="setting-label">Theme</span>
                        <div class="setting-value-container">
                            <span class="setting-value" id="display-theme">System</span>
                            <span class="material-symbols-rounded setting-chevron">chevron_right</span>
                        </div>
                    </div>

                    <!-- Document Editor -->
                    <div class="setting-row" onclick="openEditorPicker('doc')">
                        <span class="setting-label">Document Editor</span>
                        <div class="setting-value-container">
                            <span class="setting-value" id="display-doc-editor">Default</span>
                            <span class="material-symbols-rounded setting-chevron">chevron_right</span>
                        </div>
                    </div>

                    <!-- Image Editor -->
                    <div class="setting-row" onclick="openEditorPicker('img')">
                        <span class="setting-label">Image Editor</span>
                        <div class="setting-value-container">
                            <span class="setting-value" id="display-img-editor">Basic</span>
                            <span class="material-symbols-rounded setting-chevron">chevron_right</span>
                        </div>
                    </div>

                    <!-- Code Editor -->
                    <div class="setting-row" onclick="openEditorPicker('code')">
                        <span class="setting-label">Code Editor</span>
                        <div class="setting-value-container">
                            <span class="setting-value" id="display-code-editor">HTML</span>
                            <span class="material-symbols-rounded setting-chevron">chevron_right</span>
                        </div>
                    </div>
                </div>
            </div>

<div style="margin-top: 10px;">
    <h3 style="margin: 0 0 8px 20px; font-size: 13px; color: var(--text-secondary); text-transform: uppercase;">Information</h3>
    <div class="settings-group">
        <div class="setting-row" onclick="openAboutApp()">
            <span class="setting-label">About App</span>
            <div class="setting-value-container">
                <span class="material-symbols-rounded setting-chevron">chevron_right</span>
            </div>
        </div>
    </div>
</div>

            <button class="btn-danger" id="btn-update-app">
                <span class="material-symbols-rounded" style="font-size: 20px; margin-right: 8px;">system_update_alt</span>
                Reset & Update App
            </button>

            <p style="font-size: 13px; color: var(--text-secondary); text-align: center; margin-top: 20px;">Version 5.0.3 • Build 2026</p>
            <div style="height: 80px;"></div>
        </div>

    </div>

    <!-- --- BOTTOM NAVIGATION --- -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
            <span class="material-symbols-rounded">home</span>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchTab('tools')" id="nav-tools">
            <span class="material-symbols-rounded">grid_view</span>
            <span>Tools</span>
        </div>
        <div class="nav-item online-only" id="nav-scan" onclick="openTool('scanner.html', 'Scanner')">
            <span class="material-symbols-rounded">qr_code_scanner</span>
            <span>Scan</span>
        </div>
        <div class="nav-item" onclick="switchTab('settings')" id="nav-settings">
            <span class="material-symbols-rounded">settings</span>
            <span>Settings</span>
        </div>
    </div>

    <!-- --- TOOL IFRAME OVERLAY --- -->
    <div id="tool-iframe-container">
        <div class="iframe-header">
            <div class="iframe-title" id="iframe-title-text">Tool</div>
            <div class="close-tool-btn" onclick="closeTool()">Home</div>
        </div>
        <iframe id="app-frame" src="about:blank" style="flex:1; border:none; width:100%; height:100%;"></iframe>
    </div>

    <!-- --- OFFLINE POPUP --- -->
    <div id="popup-overlay" onclick="this.style.display='none'">
        <div class="popup-content" onclick="event.stopPropagation()">
            <span class="material-symbols-rounded" style="font-size: 40px; color: var(--text-secondary); margin-bottom: 10px;">wifi_off</span>
            <h3 style="margin-top:0">Unavailable In Offline Mdoe</h3>
            <ul style="padding-left: 20px; line-height: 1.6; font-size: 14px; text-align:left; color:var(--text-secondary); margin-bottom:20px;">
                <li>Word Finder</li>
                <li>Markup</li>
                <li>Translator</li>
                <li>Spell Checker</li>
                <li>Share File</li>
                <li>Chart Maker</li>
                <li>Text Scanner</li>
                <li>HTML Writer (AI)</li>
                <li>All Collaboration Tools</li>
            </ul>
            <button onclick="document.getElementById('popup-overlay').style.display='none'" style="width:100%; padding:14px; background:var(--bg-body); color:var(--primary-color); border:none; border-radius:12px; font-weight:600; font-size:16px;">Close</button>
        </div>
    </div>

    <!-- --- HIDDEN IFRAME FOR PAGE CACHING --- -->
    <iframe id="caching-iframe" title="Caching Frame"></iframe>

    <script>
        // --- 1. DATA & CONFIG ---
        const BASE_URL = "https://mahi902.github.io/DocuWritePro/";
        const TEMPLATE_JSON_URL = BASE_URL + "temp.json";

        // Tool Database (from app 10)
        const toolsDB = [
            // Document Editing
            { name: "Editor", url: "document-writer.html", cat: "Document Editing", icon: "edit" },
            { name: "Viewer", url: "viewer.html", cat: "Document Editing", icon: "visibility" },
            { name: "Markup", url: "markup.html", cat: "Document Editing", icon: "ink_highlighter", onlineOnly: true },
            { name: "Word Finder", url: "word-description-finder.html", cat: "Document Editing", icon: "menu_book", onlineOnly: true },
            { name: "Translator", url: "translator.html", cat: "Document Editing", icon: "language", onlineOnly: true },
            { name: "Signer", url: "document-signer.html", cat: "Document Editing", icon: "draw" },
            { name: "Find & Replace", url: "findandreplacer.html", cat: "Document Editing", icon: "find_replace" },
            { name: "Page Numbers", url: "page-number-adder.html", cat: "Document Editing", icon: "format_list_numbered" },
            { name: "Spreadsheet", url: "spreadsheet.html", cat: "Document Editing", icon: "grid_view" },
            { name: "Reorder & Merge", url: "rm.html", cat: "Document Editing", icon: "layers" },
            { name: "Encryptor", url: "fe.html", cat: "Document Editing", icon: "shield" },
            { name: "Chart Maker", url: "chart-maker.html", cat: "Document Editing", icon: "bar_chart", onlineOnly: true },
            { name: "Graph Maker", url: "graphmaker.html", cat: "Document Editing", icon: "query_stats" },
            { name: "Whiteboard", url: "whiteboard.html", cat: "Document Editing", icon: "ad" },
            { name: "Mind Map", url: "mmm.html", cat: "Document Editing", icon: "graph_2" },
            { name: "Table Maker", url: "table-maker.html", cat: "Document Editing", icon: "table_chart" },
            { name: "Watermarker", url: "watermarker.html", cat: "Document Editing", icon: "filter_alt" },
            { name: "Email Writer", url: "email-writer.html", cat: "Document Editing", icon: "email" },
            { name: "Spell Checker", url: "spell-checker.html", cat: "Document Editing", icon: "spellcheck", onlineOnly: true },
            { name: "Extractor", url: "file-extractor.html", cat: "Document Editing", icon: "unarchive" },
            { name: "QR Maker", url: "qr-code-maker.html", cat: "Document Editing", icon: "qr_code" },
            { name: "ID Maker", url: "id-card-maker.html", cat: "Document Editing", icon: "badge" },
            { name: "Zipper", url: "file-zipper.html", cat: "Document Editing", icon: "archive" },
            { name: "PDF Converter", url: "converters.html", cat: "Document Editing", icon: "picture_as_pdf" },
            { name: "Compressor", url: "pdfcompressor.html", cat: "Document Editing", icon: "compress" },
            { name: "Context", url: "context-field.html", cat: "Document Editing", icon: "summarize" },
            { name: "Metadata", url: "metadatainspector.html", cat: "Document Editing", icon: "movie_info" },
            { name: "Gift Card", url: "gift-card-maker.html", cat: "Document Editing", icon: "card_giftcard" },
            { name: "Share File", url: "docudrop.html", cat: "Document Editing", icon: "file_upload", onlineOnly: true },
            { name: "Text Scanner", url: "text-extractor.html", cat: "Document Editing", icon: "document_scanner", onlineOnly: true },
            { name: "Key Test", url: "keyboard-click-test.html", cat: "Document Editing", icon: "keyboard" },
            // Code Editing
            { name: "Frontend IDE", url: "frontend-ide.html", cat: "Code Editing", icon: "developer_mode" },
            { name: "HTML Editor", url: "code-playground.html", cat: "Code Editing", icon: "code" },
            { name: "HTML Writer", url: "html.html", cat: "Code Editing", icon: "html", onlineOnly: true },
            { name: "Markdown", url: "mdeditor.html", cat: "Code Editing", icon: "markdown" },
            { name: "Button Dev", url: "button-designer.html", cat: "Code Editing", icon: "smart_button" },
            { name: "Splitter", url: "html-splitter.html", cat: "Code Editing", icon: "integration_instructions" },
            { name: "GoTo Code", url: "goto-code.html", cat: "Code Editing", icon: "merge" },
            { name: "Snipper", url: "code-snipper.html", cat: "Code Editing", icon: "content_cut" },
            // Image Editing
            { name: "Img Editor", url: "image-editor.html", cat: "Image Editing", icon: "collections" },
            { name: "Attrib Edit", url: "atbedt.html", cat: "Image Editing", icon: "display_settings" },
            { name: "Draw", url: "draw.html", cat: "Image Editing", icon: "brush" },
            // Collaboration
            { name: "Collab Editor", url: "collab-document-editor.html", cat: "Collaboration", icon: "group", onlineOnly: true },
            { name: "Text", url: "connect1.html", cat: "Collaboration", icon: "chat", onlineOnly: true },
            { name: "Call", url: "connect.html", cat: "Collaboration", icon: "call", onlineOnly: true },
        ];

        // --- 2. CORE LOGIC (From app 10) ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            if (tabId === 'home') {
                renderRecents();
                checkTemplateVisibility();
            }
            if (tabId === 'tools') renderTools();
        }

        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            document.body.className = isOnline ? 'online' : 'offline';
            if (!isOnline && getCookie('bannerDismissed') === 'true') {
                document.body.classList.add('banner-dismissed');
            } else {
                document.body.classList.remove('banner-dismissed');
            }
            if (document.getElementById('tab-tools').classList.contains('active')) renderTools();
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // --- 3. TOOLS & ANIMATION (From app 10) ---
        function openTool(url, name) {
            if (name) addToRecents({ name, url, icon: getIconForTool(url) });
            const frame = document.getElementById('app-frame');
            const container = document.getElementById('tool-iframe-container');
            document.getElementById('iframe-title-text').textContent = name || 'Tool';
            frame.src = url;
            container.classList.add('visible');
        }

        // Closing Tool (Slide Down + Clean up)
        function closeTool() {
            const container = document.getElementById('tool-iframe-container');
            const frame = document.getElementById('app-frame');
            
            // 1. Start Slide Down Animation
            container.classList.remove('visible');
            
            // 2. Wait for animation (300ms) then clear source
            setTimeout(() => {
                frame.src = 'about:blank';
            }, 300);
        }

        let currentSort = 'All';
        function renderTools() {
            const container = document.getElementById('tools-list-container');
            const searchTerm = document.getElementById('tool-search').value.toLowerCase();
            const isOnline = navigator.onLine;
            container.innerHTML = '';
            
            const categories = {};
            toolsDB.forEach(tool => {
                if (!isOnline && tool.onlineOnly) return;
                if (!isOnline && tool.cat === "Collaboration") return;
                if (searchTerm && !tool.name.toLowerCase().includes(searchTerm)) return;
                if (currentSort !== 'All' && tool.cat !== currentSort) return;
                if (!categories[tool.cat]) categories[tool.cat] = [];
                categories[tool.cat].push(tool);
            });

            for (const [catName, tools] of Object.entries(categories)) {
                const catDiv = document.createElement('div');
                catDiv.className = 'tool-category';
                catDiv.innerHTML = `<h3>${catName}</h3>`;
                const gridDiv = document.createElement('div');
                gridDiv.className = 'tools-grid';
                tools.forEach(tool => {
                    const card = document.createElement('div');
                    card.className = 'tool-card ' + (tool.onlineOnly ? 'online-only' : '');
                    card.innerHTML = `<span class="material-symbols-rounded">${tool.icon}</span><div class="tool-name">${tool.name}</div>`;
                    card.onclick = () => openTool(tool.url, tool.name);
                    gridDiv.appendChild(card);
                });
                catDiv.appendChild(gridDiv);
                container.appendChild(catDiv);
            }
        }
        document.getElementById('tool-search').addEventListener('keyup', renderTools);
        document.getElementById('sort-trigger').addEventListener('click', () => {
            const sorts = ['All', 'Document Editing', 'Image Editing', 'Code Editing', 'Collaboration'];
            currentSort = sorts[(sorts.indexOf(currentSort) + 1) % sorts.length];
            renderTools();
        });

        // --- 4. TEMPLATE LOGIC (From app 10) ---
        let allTemplates = [];
        let templatesLoaded = false;
        function checkTemplateVisibility() {
            const setting = localStorage.getItem('def_doc');
            const container = document.getElementById('templates-section');
            if (setting === 'sugarcane') {
                container.style.display = 'block';
                if (!templatesLoaded) fetchTemplates();
            } else {
                container.style.display = 'none';
            }
        }
        async function fetchTemplates() {
            try {
                const resp = await fetch(TEMPLATE_JSON_URL);
                const data = await resp.json();
                allTemplates = data.templates;
                templatesLoaded = true;
                renderTemplates(5);
            } catch (e) {
                document.getElementById('templates-grid').innerHTML = '<div style="padding:20px;font-size:12px;color:#999">Offline</div>';
            }
        }
        function renderTemplates(limit) {
            const grid = document.getElementById('templates-grid');
            grid.innerHTML = '';
            const count = limit === -1 ? allTemplates.length : Math.min(allTemplates.length, limit);
            for (let i = 0; i < count; i++) {
                const t = allTemplates[i];
                const imgUrl = t.Image.startsWith('http') ? t.Image : BASE_URL + t.Image;
                const linkUrl = t.Link.startsWith('http') ? t.Link : BASE_URL + t.Link;
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `<img src="${imgUrl}" class="template-img" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='"><div class="template-name">${t.Name}</div>`;
                card.onclick = () => openTool(linkUrl, t.Name);
                grid.appendChild(card);
            }
            if (limit !== -1 && allTemplates.length > limit) {
                const btn = document.createElement('div');
                btn.className = 'show-all-templates-btn';
                btn.innerText = `View All`;
                btn.onclick = () => renderTemplates(-1);
                grid.appendChild(btn);
            }
        }

        // --- 5. RECENTS (From app 10) ---
        function getIconForTool(url) {
            const tool = toolsDB.find(t => t.url === url);
            return tool ? tool.icon : (url.includes('templates') ? 'description' : 'extension');
        }
        function addToRecents(toolObj) {
            let recents = JSON.parse(localStorage.getItem('recentTools') || '[]');
            recents = recents.filter(t => t.url !== toolObj.url);
            recents.unshift(toolObj);
            if (recents.length > 7) recents.length = 7;
            localStorage.setItem('recentTools', JSON.stringify(recents));
        }
        function renderRecents() {
            const grid = document.getElementById('recent-grid');
            const recents = JSON.parse(localStorage.getItem('recentTools') || '[]');
            grid.innerHTML = '';
            if (recents.length === 0) {
                grid.innerHTML = '<div class="recent-placeholder">No recent tools used</div>';
                return;
            }
            recents.forEach(tool => {
                const card = document.createElement('div');
                card.className = 'tool-card';
                card.innerHTML = `<span class="material-symbols-rounded">${tool.icon}</span><div class="tool-name">${tool.name}</div>`;
                card.onclick = () => openTool(tool.url, tool.name);
                grid.appendChild(card);
            });
        }
        function clearRecents() {
            localStorage.removeItem('recentTools');
            renderRecents();
        }

        // --- 6. SETTINGS & CUSTOM PICKER LOGIC (Adapted from app 11) ---
        let activePickerCallback = null;
        
        function openPicker(title, options, selectedValue, onSelect) {
            const overlay = document.getElementById('picker-overlay');
            const container = document.getElementById('picker-options-container');
            document.getElementById('picker-title').textContent = title;
            
            container.innerHTML = '';
            
            options.forEach(opt => {
                const el = document.createElement('div');
                el.className = `picker-option ${opt.value === selectedValue ? 'selected' : ''}`;
                el.innerHTML = `<span>${opt.label}</span><span class="material-symbols-rounded picker-check">check</span>`;
                el.onclick = () => {
                    closePicker();
                    onSelect(opt.value, opt.label);
                };
                container.appendChild(el);
            });
            
            overlay.classList.add('open');
            activePickerCallback = onSelect;
        }

        function closePicker() {
            document.getElementById('picker-overlay').classList.remove('open');
            activePickerCallback = null;
        }

        // Editor Settings Map (from app 11)
        const editorMap = {
            doc: { 
                key: 'def_doc', displayId: 'display-doc-editor',
                options: [{label: 'Default (Writer)', value: 'default'}, {label: 'Sugarcane (Advanced)', value: 'sugarcane'}]
            },
            img: { 
                key: 'def_img', displayId: 'display-img-editor',
                options: [{label: 'Basic Editor', value: 'default'}, {label: 'Attribution Editor', value: 'attribution'}]
            },
            code: { 
                key: 'def_code', displayId: 'display-code-editor',
                options: [{label: 'HTML Editor', value: 'default'}, {label: 'Frontend IDE', value: 'ide'}]
            }
        };

        function openEditorPicker(type) {
            const map = editorMap[type];
            const current = localStorage.getItem(map.key) || 'default';
            
            openPicker(
                document.querySelector(`#${map.displayId}`).parentElement.previousElementSibling.textContent, 
                map.options, 
                current,
                (val, label) => {
                    localStorage.setItem(map.key, val);
                    document.getElementById(map.displayId).textContent = label.split(' (')[0];
                    if (type === 'doc') {
                        if(document.getElementById('tab-home').classList.contains('active')) checkTemplateVisibility();
                    }
                }
            );
        }

        // --- 7. THEME LOGIC (From app 11) ---
        function initTheme() {
            const saved = localStorage.getItem('theme_pref') || 'system';
            applyTheme(saved);
        }

        function applyTheme(theme) {
            const html = document.documentElement;
            const display = document.getElementById('display-theme');
            
            if(display) display.textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
            
            if (theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
            } else if (theme === 'light') {
                html.setAttribute('data-theme', 'light');
            } else {
                html.removeAttribute('data-theme');
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    html.setAttribute('data-theme', 'dark');
                } else {
                    html.removeAttribute('data-theme');
                }
            }
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if ((localStorage.getItem('theme_pref') || 'system') === 'system') {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        function openThemePicker() {
            const current = localStorage.getItem('theme_pref') || 'system';
            openPicker('Theme', [
                {label: 'System', value: 'system'},
                {label: 'Light', value: 'light'},
                {label: 'Dark', value: 'dark'}
            ], current, (val) => {
                localStorage.setItem('theme_pref', val);
                applyTheme(val);
            });
        }

        // --- 8. PAGE CACHING FUNCTIONALITY (NEW) ---
        async function cacheAllPages() {
            const statusEl = document.getElementById('setup-status');
            const progressBar = document.getElementById('progress-bar');
            const cachingIframe = document.getElementById('caching-iframe');
            const totalTools = toolsDB.length;
            let cachedCount = 0;
            
            // Collect all unique URLs to cache
            const urlsToCache = [];
            
            // Add all tool URLs
            toolsDB.forEach(tool => {
                if (!tool.onlineOnly) { // Only cache offline-capable tools
                    urlsToCache.push(tool.url);
                }
            });
            
            // Add core pages
            const corePages = [
                'document-writer.html',
                'image-editor.html',
                'code-playground.html',
                'sceditor.html',
                'atbedt.html',
                'frontend-ide.html'
            ];
            
            corePages.forEach(page => {
                if (!urlsToCache.includes(page)) {
                    urlsToCache.push(page);
                }
            });
            
            // Cache each page in the hidden iframe
            for (let i = 0; i < urlsToCache.length; i++) {
                const url = urlsToCache[i];
                cachedCount++;
                
                // Update progress
                const progressPercent = Math.round((cachedCount / urlsToCache.length) * 100);
                progressBar.style.width = `${progressPercent}%`;
                statusEl.textContent = `Caching: ${url} (${cachedCount}/${urlsToCache.length})`;
                
                // Load page in hidden iframe to trigger caching
                cachingIframe.src = url;
                
                // Wait for page to load (adjust timeout as needed)
                await new Promise(resolve => {
                    setTimeout(resolve, 300); // 300ms per page
                });
                
                // Clear iframe src to free memory
                cachingIframe.src = 'about:blank';
            }
            
            // Also try to cache templates if available
            try {
                const resp = await fetch(TEMPLATE_JSON_URL);
                const data = await resp.json();
                if (data.templates && data.templates.length > 0) {
                    statusEl.textContent = 'Caching templates...';
                    // Cache first few template pages
                    const templateLimit = Math.min(5, data.templates.length);
                    for (let i = 0; i < templateLimit; i++) {
                        const t = data.templates[i];
                        const linkUrl = t.Link.startsWith('http') ? t.Link : BASE_URL + t.Link;
                        cachingIframe.src = linkUrl;
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
            } catch (e) {
                console.log('Templates not available for caching');
            }
            
            // Final cleanup
            cachingIframe.src = 'about:blank';
            statusEl.textContent = 'All tools cached! App is ready for offline use.';
            progressBar.style.width = '100%';
            
            return true;
        }

        // --- 9. SETUP & INITIALIZATION ---
        function loadSettings() {
            // Editors
            for(let k in editorMap) {
                const map = editorMap[k];
                const val = localStorage.getItem(map.key) || 'default';
                const opt = map.options.find(o => o.value === val);
                document.getElementById(map.displayId).textContent = opt ? opt.label.split(' (')[0] : 'Default';
            }
            // Theme
            initTheme();
        }

        // New Item Buttons
        document.getElementById('btn-new-doc').onclick = () => {
            const val = localStorage.getItem('def_doc');
            openTool(val === 'sugarcane' ? 'sceditor.html' : 'document-writer.html', 'New Document');
        }
        document.getElementById('btn-new-img').onclick = () => {
            const val = localStorage.getItem('def_img');
            openTool(val === 'attribution' ? 'atbedt.html' : 'image-editor.html', 'New Image');
        }
        document.getElementById('btn-new-code').onclick = () => {
            const val = localStorage.getItem('def_code');
            openTool(val === 'ide' ? 'frontend-ide.html' : 'code-playground.html', 'New Code');
        }

        // UPDATE APP FUNCTION (from app 10)
        document.getElementById('btn-update-app').onclick = async () => {
            if(!confirm("Reset app and clear offline cache?")) return;
            localStorage.clear();
            if ('serviceWorker' in navigator) {
                const regs = await navigator.serviceWorker.getRegistrations();
                for (let r of regs) await r.unregister();
            }
            if ('caches' in window) {
                const keys = await caches.keys();
                await Promise.all(keys.map(k => caches.delete(k)));
            }
            location.reload();
        };

        // Setup Overlay (Enhanced with caching)
        const setupOverlay = document.getElementById('setup-overlay');
        if (localStorage.getItem('app_setup_done') === 'true') {
            setupOverlay.classList.add('hidden');
        }
        
        document.getElementById('start-setup-btn').addEventListener('click', async () => {
            const btn = document.getElementById('start-setup-btn');
            const status = document.getElementById('setup-status');
            btn.disabled = true;
            btn.textContent = "Caching...";
            
            // Step 1: Register Service Worker
            status.textContent = "Initializing Service Worker...";
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('sw.js');
                } catch (e) {
                    console.log('Service worker registration failed:', e);
                }
            }
            
            // Step 2: Cache all pages
            await cacheAllPages();
            
            // Step 3: Mark setup as complete
            localStorage.setItem('app_setup_done', 'true');
            
            // Step 4: Show completion and hide overlay
            status.textContent = "Setup complete! Launching app...";
            await new Promise(resolve => setTimeout(resolve, 1000));
            setupOverlay.classList.add('hidden');
            
            // Initialize app
            loadSettings();
            updateOnlineStatus();
            switchTab('home');
        });

        // --- 10. UTILS (From app 10) ---
        function showOfflinePopup() { document.getElementById('popup-overlay').style.display = 'flex'; }
        function dismissBanner() { setCookie('bannerDismissed', 'true', 365); updateOnlineStatus(); }
        function setCookie(n, v, d) { const date = new Date(); date.setTime(date.getTime() + (d*24*60*60*1000)); document.cookie = n + "=" + v + ";expires="+ date.toUTCString() + ";path=/"; }
        function getCookie(n) { const v = "; " + document.cookie; const p = v.split("; " + n + "="); if (p.length == 2) return p.pop().split(";").shift(); }

        // --- 11. RIPPLE EFFECT (From app 10) ---
        document.addEventListener('click', function(e) {
            const target = e.target.closest('.nav-item, .action-btn, .tool-card, .setup-btn, .template-card, .btn-danger, .setting-row');
            if (!target) return;

            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            target.style.position = (target.style.position === 'absolute' || target.style.position === 'fixed') ? target.style.position : 'relative';
            target.style.overflow = 'hidden';
            target.appendChild(ripple);
            
            const rect = target.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
            
            setTimeout(() => ripple.remove(), 600);
        });

        // --- 12. START APP ---
        if (localStorage.getItem('app_setup_done') === 'true') {
            loadSettings();
            updateOnlineStatus();
            switchTab('home');
        }

function openAboutApp() {
    // Uses your existing logic to open the iframe overlay
    // URL: https://mahi902.github.io/DocuWritePro/aboutapp.html
    const aboutUrl = BASE_URL + "aboutapp.html";
    openTool(aboutUrl, "About DocuWrite Pro");
}

    </script>
</body>
</html>
