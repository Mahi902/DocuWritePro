<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocuWrite Pro App</title>
    <meta name="description" content="DocuWrite Pro Offline App">
    <link rel="manifest" href="manifest.json">
    
    <!-- Mobile Web App Capable -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* --- CORE APP STYLES --- */
        :root {
            --primary-color: #1a73e8;
            --bg-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #202124;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            overflow: hidden; /* Prevent body scroll, handle inside views */
        }

        /* --- VIEWS --- */
        #dashboard-view {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            display: block;
            padding-bottom: 80px; /* Space for bottom content */
        }

        #tool-view {
            height: 100%;
            width: 100%;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            background: #fff;
            z-index: 1000;
        }

        /* --- IFRAME FOR TOOLS --- */
        #app-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* --- APP HEADER (Mobile Friendly) --- */
        .app-header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #dadce0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .app-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--text-color);
        }

        /* --- FLOATING HOME BUTTON (Visible in Tool View) --- */
        #home-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.2s;
        }
        #home-fab:active {
            transform: scale(0.95);
        }

        /* --- SETUP OVERLAY --- */
        #setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        
        #setup-overlay.hidden {
            display: none;
        }

        .setup-icon {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .setup-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 24px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .setup-progress {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
            min-height: 20px;
        }

        /* --- DASHBOARD GRIDS (Ported Styles) --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .tool-card {
            background: var(--surface-color);
            border: 1px solid #dadce0;
            border-radius: 12px;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tool-card:active {
            transform: scale(0.96);
        }

        .tool-card span.material-symbols-outlined {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .tool-name {
            font-size: 13px;
            color: var(--text-color);
            font-weight: 500;
            line-height: 1.2;
        }

        .section-title {
            padding: 20px 20px 0 20px;
            font-size: 18px;
            font-weight: 500;
            color: #5f6368;
        }

    </style>
</head>
<body>

    <!-- --- SETUP SCREEN --- -->
    <div id="setup-overlay">
        <span class="material-symbols-outlined setup-icon">cloud_download</span>
        <h2>App Setup</h2>
        <p>DocuWrite Pro needs to download tools for offline access.</p>
        <button id="start-setup-btn" class="setup-btn">Download & Install Tools</button>
        <div class="setup-progress" id="setup-progress"></div>
    </div>

    <!-- --- HOME FAB --- -->
    <div id="home-fab">
        <span class="material-symbols-outlined">home</span>
    </div>

    <!-- --- DASHBOARD VIEW --- -->
    <div id="dashboard-view">
        <div class="app-header">
            <span class="app-title">DocuWrite Pro</span>
            <span class="material-symbols-outlined" onclick="location.reload()">refresh</span>
        </div>

        <div class="section-title">Common Tools</div>
        <div class="grid-container" id="common-tools">
            <!-- Blank Document -->
            <div class="tool-card" data-url="document-writer.html">
                <span class="material-symbols-outlined">add</span>
                <div class="tool-name">New Document</div>
            </div>
            <!-- Collab -->
            <div class="tool-card" data-url="collab-document-editor.html">
                <span class="material-symbols-outlined">group</span>
                <div class="tool-name">Collab</div>
            </div>
             <!-- Code -->
             <div class="tool-card" data-url="code-playground.html">
                <span class="material-symbols-outlined">code</span>
                <div class="tool-name">Code Editor</div>
            </div>
        </div>

        <div class="section-title">All Tools</div>
        <!-- This container is scanned by JS to generate the cache list -->
        <div class="grid-container" id="tools-grid">
            
            <!-- Ported tools from dashboard -->
            <div class="tool-card" data-url="viewer.html"><span class="material-symbols-outlined">visibility</span><div class="tool-name">Viewer</div></div>
            <div class="tool-card" data-url="markup.html"><span class="material-symbols-outlined">ink_highlighter</span><div class="tool-name">Markup</div></div>
            <div class="tool-card" data-url="word-description-finder.html"><span class="material-symbols-outlined">menu_book</span><div class="tool-name">Word Finder</div></div>
            <div class="tool-card" data-url="translator.html"><span class="material-symbols-outlined">language</span><div class="tool-name">Translator</div></div>
            <div class="tool-card" data-url="document-signer.html"><span class="material-symbols-outlined">draw</span><div class="tool-name">Signer</div></div>
            <div class="tool-card" data-url="findandreplacer.html"><span class="material-symbols-outlined">find_replace</span><div class="tool-name">Find/Replace</div></div>
            <div class="tool-card" data-url="page-number-adder.html"><span class="material-symbols-outlined">format_list_numbered</span><div class="tool-name">Page Numbers</div></div>
            <div class="tool-card" data-url="spreadsheet.html"><span class="material-symbols-outlined">grid_view</span><div class="tool-name">Spreadsheet</div></div>
            <div class="tool-card" data-url="rm.html"><span class="material-symbols-outlined">layers</span><div class="tool-name">Reorder/Merge</div></div>
            <div class="tool-card" data-url="fe.html"><span class="material-symbols-outlined">shield</span><div class="tool-name">Encryptor</div></div>
            <div class="tool-card" data-url="chart-maker.html"><span class="material-symbols-outlined">bar_chart</span><div class="tool-name">Chart Maker</div></div>
            <div class="tool-card" data-url="graphmaker.html"><span class="material-symbols-outlined">query_stats</span><div class="tool-name">Graph Maker</div></div>
            <div class="tool-card" data-url="whiteboard.html"><span class="material-symbols-outlined">ad</span><div class="tool-name">Whiteboard</div></div>
            <div class="tool-card" data-url="mmm.html"><span class="material-symbols-outlined">graph_2</span><div class="tool-name">Mind Map</div></div>
            <div class="tool-card" data-url="table-maker.html"><span class="material-symbols-outlined">table_chart</span><div class="tool-name">Table Maker</div></div>
            <div class="tool-card" data-url="watermarker.html"><span class="material-symbols-outlined">filter_alt</span><div class="tool-name">Watermarker</div></div>
            <div class="tool-card" data-url="email-writer.html"><span class="material-symbols-outlined">email</span><div class="tool-name">Email Writer</div></div>
            <div class="tool-card" data-url="spell-checker.html"><span class="material-symbols-outlined">spellcheck</span><div class="tool-name">Spell Checker</div></div>
            <div class="tool-card" data-url="file-extractor.html"><span class="material-symbols-outlined">unarchive</span><div class="tool-name">Extractor</div></div>
            <div class="tool-card" data-url="qr-code-maker.html"><span class="material-symbols-outlined">qr_code</span><div class="tool-name">QR Maker</div></div>
            <div class="tool-card" data-url="id-card-maker.html"><span class="material-symbols-outlined">badge</span><div class="tool-name">ID Maker</div></div>
            <div class="tool-card" data-url="file-zipper.html"><span class="material-symbols-outlined">archive</span><div class="tool-name">Zipper</div></div>
            <div class="tool-card" data-url="converters.html"><span class="material-symbols-outlined">picture_as_pdf</span><div class="tool-name">PDF Convert</div></div>
            <div class="tool-card" data-url="pdfcompressor.html"><span class="material-symbols-outlined">compress</span><div class="tool-name">Compressor</div></div>
            <div class="tool-card" data-url="context-field.html"><span class="material-symbols-outlined">summarize</span><div class="tool-name">Context</div></div>
            <div class="tool-card" data-url="metadatainspector.html"><span class="material-symbols-outlined">movie_info</span><div class="tool-name">Metadata</div></div>
            <div class="tool-card" data-url="gift-card-maker.html"><span class="material-symbols-outlined">card_giftcard</span><div class="tool-name">Gift Card</div></div>
            <div class="tool-card" data-url="text-extractor.html"><span class="material-symbols-outlined">document_scanner</span><div class="tool-name">Text Scan</div></div>
            <div class="tool-card" data-url="keyboard-click-test.html"><span class="material-symbols-outlined">keyboard</span><div class="tool-name">Key Test</div></div>
            <div class="tool-card" data-url="frontend-ide.html"><span class="material-symbols-outlined">developer_mode</span><div class="tool-name">IDE</div></div>
            <div class="tool-card" data-url="html.html"><span class="material-symbols-outlined">html</span><div class="tool-name">HTML Write</div></div>
            <div class="tool-card" data-url="mdeditor.html"><span class="material-symbols-outlined">markdown</span><div class="tool-name">Markdown</div></div>
            <div class="tool-card" data-url="button-designer.html"><span class="material-symbols-outlined">smart_button</span><div class="tool-name">Button Dev</div></div>
            <div class="tool-card" data-url="html-splitter.html"><span class="material-symbols-outlined">integration_instructions</span><div class="tool-name">Splitter</div></div>
            <div class="tool-card" data-url="goto-code.html"><span class="material-symbols-outlined">merge</span><div class="tool-name">GoTo</div></div>
            <div class="tool-card" data-url="code-snipper.html"><span class="material-symbols-outlined">content_cut</span><div class="tool-name">Snipper</div></div>
            <div class="tool-card" data-url="image-editor.html"><span class="material-symbols-outlined">collections</span><div class="tool-name">Img Editor</div></div>
            <div class="tool-card" data-url="atbedt.html"><span class="material-symbols-outlined">display_settings</span><div class="tool-name">Attrib Edit</div></div>
            <div class="tool-card" data-url="draw.html"><span class="material-symbols-outlined">brush</span><div class="tool-name">Draw</div></div>

        </div>
    </div>

    <!-- --- TOOL VIEW (IFRAME) --- -->
    <div id="tool-view">
        <iframe id="app-frame" src="about:blank"></iframe>
    </div>

    <script>
        // --- 1. APP LOGIC ---
        const dashboardView = document.getElementById('dashboard-view');
        const toolView = document.getElementById('tool-view');
        const appFrame = document.getElementById('app-frame');
        const homeFab = document.getElementById('home-fab');

        // Handle Clicking a Tool
        document.querySelectorAll('.tool-card').forEach(card => {
            card.addEventListener('click', () => {
                const url = card.dataset.url;
                if(url) {
                    openTool(url);
                }
            });
        });

        // Open Tool Function (SPA Feel)
        function openTool(url) {
            // Construct full URL relative to this file
            const fullUrl = new URL(url, window.location.href).href;
            
            appFrame.src = fullUrl;
            dashboardView.style.display = 'none';
            toolView.style.display = 'block';
            homeFab.style.display = 'flex';
        }

        // Return Home Function
        homeFab.addEventListener('click', () => {
            appFrame.src = 'about:blank'; // Clear memory
            toolView.style.display = 'none';
            homeFab.style.display = 'none';
            dashboardView.style.display = 'block';
        });

        // --- 2. SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW Registered', reg))
                .catch(err => console.log('SW Failed', err));
        }

        // --- 3. FIRST TIME SETUP / CACHING LOGIC ---
        const setupOverlay = document.getElementById('setup-overlay');
        const startSetupBtn = document.getElementById('start-setup-btn');
        const setupProgress = document.getElementById('setup-progress');

        // Check if setup is already done
        if (localStorage.getItem('docuwrite_app_setup') === 'true') {
            setupOverlay.classList.add('hidden');
        }

        startSetupBtn.addEventListener('click', async () => {
            startSetupBtn.disabled = true;
            setupProgress.textContent = "Scanning tools...";
            
            // 1. Gather URLs from DOM
            const urlsToCache = new Set();
            
            // Add core app files
            urlsToCache.add(window.location.href); // app.html
            urlsToCache.add('manifest.json');
            
            // Add all tool URLs found in cards
            document.querySelectorAll('.tool-card').forEach(card => {
                const relativeUrl = card.dataset.url;
                if (relativeUrl) {
                    const fullUrl = new URL(relativeUrl, window.location.href).href;
                    urlsToCache.add(fullUrl);
                }
            });

            const urlArray = Array.from(urlsToCache);
            setupProgress.textContent = `Found ${urlArray.length} tools. Downloading...`;

            // 2. Send to Service Worker
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    action: 'CACHE_URLS',
                    urls: urlArray
                });
            } else {
                // If SW isn't ready yet (first ever load), reload page to activate SW then try again
                setupProgress.textContent = "Initializing System... Page will reload.";
                setTimeout(() => location.reload(), 1500);
            }
        });

        // Listen for SW completion
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'CACHE_COMPLETE') {
                setupProgress.textContent = "Setup Complete! You can now use the app offline.";
                localStorage.setItem('docuwrite_app_setup', 'true');
                setTimeout(() => {
                    setupOverlay.classList.add('hidden');
                }, 1000);
            }
        });

    </script>
</body>
</html>
