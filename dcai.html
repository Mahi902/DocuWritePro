<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DocuWrite AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<!-- Google Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">

<!-- Markdown Renderer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    /* Light Theme (Default) */
    --bg-color: #ffffff;
    --chat-bg: #f8f9fa;
    --header-bg: rgba(255, 255, 255, 0.9);
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --accent-color: #2563eb;
    --accent-hover: #1d4ed8;
    --user-msg-bg: #2563eb;
    --user-msg-text: #ffffff;
    --bot-msg-bg: #e5e7eb;
    --bot-msg-text: #1f2937;
    --input-bg: #ffffff;
    --border-color: #e5e7eb;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  [data-theme="dark"] {
    --bg-color: #111827;
    --chat-bg: #0f172a;
    --header-bg: rgba(17, 24, 39, 0.9);
    --text-primary: #f9fafb;
    --text-secondary: #9ca3af;
    --accent-color: #3b82f6;
    --accent-hover: #60a5fa;
    --user-msg-bg: #3b82f6;
    --user-msg-text: #ffffff;
    --bot-msg-bg: #374151;
    --bot-msg-text: #f3f4f6;
    --input-bg: #1f2937;
    --border-color: #374151;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
  }

  [data-theme="midnight"] {
    --bg-color: #0f0c29;
    --chat-bg: #0f0c29; 
    --header-bg: rgba(15, 12, 41, 0.9);
    --text-primary: #e0e7ff;
    --text-secondary: #a5b4fc;
    --accent-color: #6366f1;
    --accent-hover: #818cf8;
    --user-msg-bg: #6366f1;
    --user-msg-text: #ffffff;
    --bot-msg-bg: #1e1b4b;
    --bot-msg-text: #e0e7ff;
    --input-bg: #1e1b4b;
    --border-color: #312e81;
    --shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
  }
  
  [data-theme="midnight"] body {
    background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
  }

  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    margin: 0;
    font-family: 'Inter', system-ui, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-primary);
    height: 100dvh; 
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  header {
    height: 60px;
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--header-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  .brand .icon {
    color: var(--accent-color);
    font-size: 28px;
  }

  .theme-toggle {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-toggle:hover {
    background-color: var(--bot-msg-bg);
    color: var(--text-primary);
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 80px 20px 20px 20px; 
    scroll-behavior: smooth;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .messages-container::-webkit-scrollbar {
    width: 6px;
  }
  .messages-container::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.1);
    border-radius: 3px;
  }
  [data-theme="dark"] .messages-container::-webkit-scrollbar-thumb {
    background-color: rgba(255,255,255,0.1);
  }

  .msg-wrapper {
    display: flex;
    flex-direction: column;
    max-width: 85%;
    opacity: 0;
    /* Bot messages will be visible immediately so we can type in them. 
       Animation handles the 'pop' effect. */
    animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .msg-wrapper.user {
    align-self: flex-end;
    align-items: flex-end;
  }

  .msg-wrapper.bot {
    align-self: flex-start;
    align-items: flex-start;
  }

  @keyframes popIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 0.95rem;
    line-height: 1.5;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: background-color 0.3s, color 0.3s;
    min-height: 20px; /* Prevent collapse while typing */
  }

  .msg-wrapper.user .msg-bubble {
    background-color: var(--user-msg-bg);
    color: var(--user-msg-text);
    border-bottom-right-radius: 4px;
  }

  .msg-wrapper.bot .msg-bubble {
    background-color: var(--bot-msg-bg);
    color: var(--bot-msg-text);
    border-bottom-left-radius: 4px;
  }

  .msg-bubble p { margin: 0; }
  .msg-bubble ul, .msg-bubble ol { margin: 8px 0; padding-left: 20px; }
  .msg-bubble code { 
    font-family: monospace; 
    background: rgba(0,0,0,0.1); 
    padding: 2px 4px; 
    border-radius: 4px; 
  }
  .msg-wrapper.user .msg-bubble code { background: rgba(255,255,255,0.2); }
  .msg-bubble pre {
    background: rgba(0,0,0,0.1);
    padding: 10px;
    border-radius: 8px;
    overflow-x: auto;
  }

  /* Blinking cursor for typing effect */
  .typing-cursor::after {
    content: '|';
    animation: blink 1s step-end infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }

  .msg-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 4px;
    padding: 0 4px;
  }

  .input-area {
    padding: 16px 20px;
    background: var(--bg-color); 
    border-top: 1px solid var(--border-color);
    display: flex;
    align-items: flex-end; 
    gap: 12px;
    z-index: 10;
    transition: background-color 0.3s;
  }

  .input-wrapper {
    flex: 1;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 24px;
    padding: 4px 8px 4px 16px;
    display: flex;
    align-items: center;
    transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
  }

  .input-wrapper:focus-within {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  input {
    width: 100%;
    border: none;
    background: transparent;
    padding: 10px 0;
    font-size: 1rem;
    color: var(--text-primary);
    outline: none;
    font-family: inherit;
  }

  input::placeholder {
    color: var(--text-secondary);
  }

  .send-btn {
    background: var(--accent-color);
    color: white;
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.1s, background-color 0.2s;
    flex-shrink: 0;
  }

  .send-btn:hover {
    background: var(--accent-hover);
  }

  .send-btn:active {
    transform: scale(0.95);
  }

  /* Three dots loader (Only shown while 'thinking') */
  .typing-indicator {
    display: none; 
    padding: 12px 16px;
    background: var(--bot-msg-bg);
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    width: fit-content;
    align-self: flex-start;
    margin-bottom: 16px;
    animation: popIn 0.3s ease;
  }

  .typing-dots {
    display: flex;
    gap: 4px;
  }

  .dot {
    width: 8px;
    height: 8px;
    background: var(--text-secondary);
    border-radius: 50%;
    opacity: 0.6;
    animation: bounce 1.4s infinite ease-in-out both;
  }

  .dot:nth-child(1) { animation-delay: -0.32s; }
  .dot:nth-child(2) { animation-delay: -0.16s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }

  .theme-menu {
    position: absolute;
    top: 60px;
    right: 20px;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 8px;
    box-shadow: var(--shadow);
    display: none;
    flex-direction: column;
    gap: 4px;
    min-width: 150px;
    animation: fadeIn 0.2s ease;
    z-index: 20;
  }

  .theme-menu.active {
    display: flex;
  }

  .theme-option {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: background 0.2s;
  }

  .theme-option:hover {
    background: var(--bot-msg-bg);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }

</style>
</head>
<body>

<header>
  <div class="brand">
    <span class="material-symbols-rounded icon">smart_toy</span>
    DocuWrite AI
  </div>
  <button class="theme-toggle" id="themeBtn" aria-label="Change Theme">
    <span class="material-symbols-rounded">palette</span>
  </button>
  
  <div class="theme-menu" id="themeMenu">
    <div class="theme-option" onclick="setTheme('light')">
      <span class="material-symbols-rounded icon">light_mode</span> Light
    </div>
    <div class="theme-option" onclick="setTheme('dark')">
      <span class="material-symbols-rounded icon">dark_mode</span> Dark
    </div>
    <div class="theme-option" onclick="setTheme('midnight')">
      <span class="material-symbols-rounded icon">bedtime</span> Midnight
    </div>
  </div>
</header>

<div class="messages-container" id="messages">
  <div class="msg-wrapper bot">
    <div class="msg-bubble">
      Hello! I'm DocuWrite AI. Ask me anything about the documentation or project.
    </div>
    <div class="msg-meta">Now</div>
  </div>
</div>

<div class="typing-indicator" id="typingIndicator">
  <div class="typing-dots">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
</div>

<div class="input-area">
  <div class="input-wrapper">
    <input id="userInput" placeholder="Type a message..." autocomplete="off" />
  </div>
  <button class="send-btn" onclick="sendMessage()" aria-label="Send Message">
    <span class="material-symbols-rounded">arrow_upward</span>
  </button>
</div>

<script>
// --- State & Config ---
let knowledgeBase = [
  { q: "hi", a: "Hello! How can I help you today?" },
  { q: "hello", a: "Hi there! Ready to answer your questions." },
  { q: "hey", a: "Hey! What's on your mind?" },
  { q: "who are you", a: "I am DocuWrite AI, your virtual assistant." }
];
let currentTheme = localStorage.getItem('theme') || 'light';
let isTyping = false; // Prevent double sends while typing

// --- Initialization ---
document.documentElement.setAttribute('data-theme', currentTheme);

// Fetch AI Data
fetch("https://mahi902.github.io/DocuWritePro/aidata.json")
  .then(res => res.text())
  .then(text => {
    const matches = [...text.matchAll(/\[(.*?)\s*:\s*(.*?)\]/gs)];
    const fetchedData = matches.map(m => ({
      q: m[1].toLowerCase(),
      a: m[2]
    }));
    knowledgeBase = [...knowledgeBase, ...fetchedData];
    console.log("Knowledge base loaded:", knowledgeBase.length, "entries");
  })
  .catch(err => console.error("Failed to load knowledge base", err));

// --- Theme Logic ---
const themeBtn = document.getElementById('themeBtn');
const themeMenu = document.getElementById('themeMenu');

themeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  themeMenu.classList.toggle('active');
});

document.addEventListener('click', (e) => {
  if (!themeMenu.contains(e.target) && e.target !== themeBtn) {
    themeMenu.classList.remove('active');
  }
});

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
  themeMenu.classList.remove('active');
}

// --- Chat Logic ---

function similarity(input, question) {
  let score = 0;
  const inputWords = input.split(/\s+/);
  inputWords.forEach(word => {
    // Allows short words like "Hi"
    if (question.includes(word) && word.length > 1) { 
      score++;
    }
  });
  return score;
}

function getResponse(userText) {
  const input = userText.toLowerCase();
  let bestScore = 0;
  let matches = [];

  knowledgeBase.forEach(item => {
    const score = similarity(input, item.q);
    if (score > bestScore) {
      bestScore = score;
      matches = [item.a];
    } else if (score === bestScore && score > 0) {
      matches.push(item.a);
    }
  });

  if (matches.length === 0) {
    return "ðŸ¤– Iâ€™m not sure about that. Could you try rephrasing?";
  }
  return matches[Math.floor(Math.random() * matches.length)];
}

// Recursive Typing Function for DOM Elements
async function typeNode(node, container) {
  if (node.nodeType === Node.TEXT_NODE) {
    const text = node.textContent;
    for (let i = 0; i < text.length; i++) {
      container.append(text[i]);
      scrollToBottom();
      // Fast random delay for natural typing feel (5ms to 20ms)
      await new Promise(r => setTimeout(r, Math.random() * 15 + 5)); 
    }
  } else if (node.nodeType === Node.ELEMENT_NODE) {
    const el = document.createElement(node.tagName);
    // Copy Attributes
    Array.from(node.attributes).forEach(attr => {
      el.setAttribute(attr.name, attr.value);
    });
    container.appendChild(el);
    // Recurse
    if (node.childNodes.length > 0) {
      for (let child of node.childNodes) {
        await typeNode(child, el);
      }
    }
  }
}

async function addMessage(text, sender) {
  const container = document.getElementById("messages");
  const typingInd = document.getElementById("typingIndicator");
  
  // Remove typing indicator if it exists inside container
  if(typingInd.parentNode === container) {
      container.removeChild(typingInd);
  }

  const wrapper = document.createElement("div");
  wrapper.className = `msg-wrapper ${sender}`;
  
  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  
  // Create timestamp
  const meta = document.createElement("div");
  meta.className = "msg-meta";
  const now = new Date();
  meta.innerText = now.getHours() + ":" + String(now.getMinutes()).padStart(2, '0');

  wrapper.appendChild(bubble);
  wrapper.appendChild(meta);
  container.appendChild(wrapper);
  scrollToBottom();

  if (sender === "bot") {
    // 1. Parse Markdown to HTML string
    const htmlString = marked.parse(text);
    
    // 2. Create a temp div to hold the parsed DOM
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = htmlString;
    
    // 3. Add visual cursor class
    bubble.classList.add("typing-cursor");

    // 4. Recursively type out the content
    isTyping = true;
    for (let child of tempDiv.childNodes) {
      await typeNode(child, bubble);
    }
    isTyping = false;
    
    // 5. Remove cursor when done
    bubble.classList.remove("typing-cursor");
    
  } else {
    // User message: Show instantly, escape HTML for safety
    bubble.innerHTML = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }

  // Ensure typing indicator is at bottom for next time
  container.appendChild(typingInd);
}

function showTyping() {
  const container = document.getElementById("messages");
  const typingInd = document.getElementById("typingIndicator");
  typingInd.style.display = "flex";
  container.appendChild(typingInd);
  scrollToBottom();
}

function hideTyping() {
  const typingInd = document.getElementById("typingIndicator");
  typingInd.style.display = "none";
}

function scrollToBottom() {
  const container = document.getElementById("messages");
  container.scrollTop = container.scrollHeight;
}

function sendMessage() {
  if (isTyping) return; // Prevent interrupting the bot

  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  // Add user message instantly
  addMessage(text, "user");
  input.value = "";
  
  // Show loader "Thinking..."
  showTyping();

  // Wait a bit, then start typing the response
  setTimeout(() => {
    hideTyping();
    const reply = getResponse(text);
    addMessage(reply, "bot");
  }, 600 + Math.random() * 500); 
}

document.getElementById("userInput").addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

window.onload = () => document.getElementById("userInput").focus();

</script>

</body>
</html>
