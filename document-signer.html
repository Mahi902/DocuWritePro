<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Document Signer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#000000', // Pure black
                        darksurface: '#121212',
                        primary: '#3b82f6'
                    }
                }
            }
        }
    </script>

    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Prevent text selection while dragging */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Signature item styling */
        .signature-item {
            position: absolute;
            cursor: move;
            border: 2px dashed #3b82f6;
            touch-action: none; /* Crucial for mobile drag */
            z-index: 50;
        }
        .signature-item:hover, .signature-item.active {
            border-color: #2563eb;
            background-color: rgba(59, 130, 246, 0.1);
        }
        /* Resize handle */
        .resize-handle {
            width: 20px;
            height: 20px;
            background-color: #3b82f6;
            position: absolute;
            bottom: -10px;
            right: -10px;
            border-radius: 50%;
            cursor: nwse-resize;
            display: none;
            z-index: 51;
        }
        .signature-item:hover .resize-handle, .signature-item.active .resize-handle {
            display: block;
        }
        
        /* Loader */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Canvas drawing cursor */
        canvas.drawing-canvas {
            cursor: crosshair;
            touch-action: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-darkbg dark:text-gray-100 transition-colors duration-200 min-h-screen flex flex-col font-sans">

    <!-- Header Bar -->
    <header class="h-16 bg-white dark:bg-darkbg border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-primary text-3xl">ink_pen</span>
            <h1 class="text-xl font-bold tracking-tight">Document Signer</h1>
        </div>
        <div class="flex items-center gap-2">
            <!-- Theme Toggle -->
            <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-900 transition-colors" title="Toggle Theme">
                <span class="material-symbols-outlined dark:text-yellow-400">light_mode</span>
            </button>
            
            <!-- Import Button -->
            <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-800 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition font-medium text-sm">
                <span class="material-symbols-outlined text-lg">upload_file</span>
                Import
            </button>
            <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.jpg,.jpeg,.png">

            <!-- Export Button -->
            <button id="exportBtn" disabled class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-lg">download</span>
                Export
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow relative overflow-hidden flex flex-col" id="mainContainer">
        
        <!-- View 1: Initial Empty State -->
        <div id="view-initial" class="flex-grow flex flex-col items-center justify-center p-8 text-center text-gray-500 dark:text-gray-400">
            <span class="material-symbols-outlined text-6xl mb-4 text-gray-300 dark:text-gray-700">description</span>
            <p class="text-lg">Click "Import" to upload PDF, JPG, or PNG files.</p>
        </div>

        <!-- View 2: Page Selection -->
        <div id="view-selection" class="hidden flex-col h-full absolute inset-0 bg-gray-50 dark:bg-darkbg z-10">
            <div class="p-4 bg-white dark:bg-darkbg border-b dark:border-gray-800 flex justify-between items-center">
                <h2 class="text-lg font-semibold">Select pages to sign</h2>
                <div class="flex gap-2">
                    <button onclick="app.selectAllPages()" class="text-sm text-blue-500 hover:underline">Select All</button>
                    <button onclick="app.goToSignatureCreation()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">Next</button>
                </div>
            </div>
            <div id="selection-grid" class="flex-grow overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- Thumbnails injected here -->
            </div>
        </div>

        <!-- View 3: Create/Upload Signature -->
        <div id="view-create-sig" class="hidden flex-col h-full absolute inset-0 bg-gray-50 dark:bg-darkbg z-20">
            <div class="p-4 bg-white dark:bg-darkbg border-b dark:border-gray-800 flex justify-between items-center">
                <h2 class="text-lg font-semibold">Create your Signature</h2>
                <button onclick="app.goToPlacement()" id="btn-sig-next" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 disabled:opacity-50">Next</button>
            </div>
            
            <div class="flex-grow flex flex-col items-center justify-center p-4">
                <div class="w-full max-w-lg bg-white dark:bg-gray-900 rounded-xl shadow-lg border dark:border-gray-800 overflow-hidden">
                    
                    <!-- Tabs -->
                    <div class="flex border-b dark:border-gray-800">
                        <button onclick="app.switchSigTab('draw')" id="tab-draw" class="flex-1 py-3 font-medium text-center bg-blue-50 dark:bg-gray-800 text-blue-600 dark:text-blue-400 border-b-2 border-blue-600">Draw</button>
                        <button onclick="app.switchSigTab('upload')" id="tab-upload" class="flex-1 py-3 font-medium text-center text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800">Upload Image</button>
                    </div>

                    <!-- Draw Area -->
                    <div id="area-draw" class="p-4 flex flex-col items-center gap-4">
                        <div class="relative w-full h-64 border rounded bg-white touch-none" style="background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px;">
                            <canvas id="sigCanvas" class="w-full h-full drawing-canvas"></canvas>
                        </div>
                        <div class="flex items-center gap-4 w-full justify-between">
                            <div class="flex gap-2">
                                <button onclick="app.setPenColor('#000000')" class="w-8 h-8 rounded-full bg-black border-2 border-transparent hover:scale-110 transition"></button>
                                <button onclick="app.setPenColor('#0000FF')" class="w-8 h-8 rounded-full bg-blue-700 border-2 border-transparent hover:scale-110 transition"></button>
                                <button onclick="app.setPenColor('#FF0000')" class="w-8 h-8 rounded-full bg-red-600 border-2 border-transparent hover:scale-110 transition"></button>
                            </div>
                            <button onclick="app.clearCanvas()" class="flex items-center gap-1 text-sm text-red-500 hover:text-red-700">
                                <span class="material-symbols-outlined text-lg">delete</span> Clear
                            </button>
                        </div>
                    </div>

                    <!-- Upload Area -->
                    <div id="area-upload" class="hidden p-8 flex flex-col items-center gap-4">
                        <div class="w-full h-48 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition" onclick="document.getElementById('sigUploadInput').click()">
                            <span class="material-symbols-outlined text-4xl text-gray-400">image</span>
                            <span class="mt-2 text-sm text-gray-500">Click to upload signature</span>
                        </div>
                        <input type="file" id="sigUploadInput" class="hidden" accept="image/*" onchange="app.handleSigUpload(this)">
                        <img id="uploadedSigPreview" class="max-h-24 hidden border rounded p-1">
                    </div>

                </div>
            </div>
        </div>

        <!-- View 4: Placement (Sign the Docs) -->
        <div id="view-placement" class="hidden flex-col h-full absolute inset-0 bg-gray-100 dark:bg-black z-30">
            <!-- Toolbar -->
            <div class="p-2 bg-white dark:bg-darkbg border-b dark:border-gray-800 flex justify-between items-center shadow-sm z-40 sticky top-0">
                <button onclick="app.addSignatureToView()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition transform hover:scale-105">
                    <span class="material-symbols-outlined">add</span>
                    New Signature
                </button>
                <div class="flex items-center gap-4">
                     <span class="text-xs text-gray-500 hidden sm:inline">Drag off-page to delete</span>
                    <button onclick="app.finishSigning()" class="px-6 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 font-bold">Complete</button>
                </div>
            </div>

            <!-- Scrollable Page Container -->
            <div id="placement-container" class="flex-grow overflow-y-auto p-4 md:p-8 flex flex-col items-center gap-8 relative">
                <!-- Pages injected here -->
            </div>
        </div>

        <!-- View 5: Success -->
        <div id="view-success" class="hidden flex-col h-full absolute inset-0 bg-white dark:bg-darkbg z-40 items-center justify-center text-center p-8">
            <div class="w-20 h-20 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mb-6">
                <span class="material-symbols-outlined text-4xl text-green-600 dark:text-green-400">check_circle</span>
            </div>
            <h2 class="text-2xl font-bold mb-2">Document Ready!</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-8">Now use the Export icon in the top right to download your signed document.</p>
            <button onclick="location.reload()" class="text-blue-500 hover:underline">Start Over</button>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex flex-col items-center justify-center text-white">
            <div class="loader mb-4"></div>
            <p id="loadingText">Processing...</p>
        </div>

    </main>

    <script>
        /**
         * App Logic
         */
        const app = {
            // State
            pages: [], // { id, dataUrl, width, height, finalSignatures: [] }
            selectedPageIndices: new Set(),
            signatureDataUrl: null,
            isDrawing: false,
            
            // DOM Elements
            init: function() {
                this.setupTheme();
                this.setupEventListeners();
                this.setupCanvas();
            },

            setupTheme: function() {
                const theme = localStorage.getItem('docSignerTheme');
                const btn = document.getElementById('themeToggle');
                const icon = btn.querySelector('span');
                
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    icon.textContent = 'dark_mode';
                } else {
                    document.documentElement.classList.remove('dark');
                    icon.textContent = 'light_mode';
                }

                btn.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('docSignerTheme', isDark ? 'dark' : 'light');
                    icon.textContent = isDark ? 'dark_mode' : 'light_mode';
                });
            },

            setupEventListeners: function() {
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFiles(e.target.files));
                document.getElementById('exportBtn').addEventListener('click', () => this.exportDocument());
            },

            toggleLoading: function(show, text = "Loading...") {
                const el = document.getElementById('loadingOverlay');
                document.getElementById('loadingText').textContent = text;
                el.classList.toggle('hidden', !show);
            },

            /**
             * File Handling & Parsing
             */
            handleFiles: async function(files) {
                if (files.length === 0) return;
                this.toggleLoading(true, "Processing files...");
                this.pages = []; // Reset
                this.selectedPageIndices.clear();

                try {
                    for (let file of files) {
                        if (file.type === 'application/pdf') {
                            await this.processPDF(file);
                        } else if (file.type.startsWith('image/')) {
                            await this.processImage(file);
                        }
                    }
                    this.renderSelectionView();
                    this.switchView('view-selection');
                } catch (e) {
                    console.error(e);
                    alert("Error processing files.");
                } finally {
                    this.toggleLoading(false);
                }
            },

            processImage: function(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            this.pages.push({
                                id: crypto.randomUUID(),
                                dataUrl: e.target.result,
                                width: img.width,
                                height: img.height,
                                finalSignatures: []
                            });
                            resolve();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            },

            processPDF: async function(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 }); // High res for quality
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    this.pages.push({
                        id: crypto.randomUUID(),
                        dataUrl: canvas.toDataURL('image/jpeg', 0.8),
                        width: viewport.width,
                        height: viewport.height,
                        finalSignatures: []
                    });
                }
            },

            /**
             * View Management
             */
            switchView: function(viewId) {
                ['view-initial', 'view-selection', 'view-create-sig', 'view-placement', 'view-success'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                    document.getElementById(id).classList.remove('flex');
                });
                const el = document.getElementById(viewId);
                el.classList.remove('hidden');
                el.classList.add('flex');
            },

            /**
             * Selection Logic
             */
            renderSelectionView: function() {
                const grid = document.getElementById('selection-grid');
                grid.innerHTML = '';
                
                this.pages.forEach((page, index) => {
                    const div = document.createElement('div');
                    div.className = "relative group cursor-pointer border-2 rounded-lg overflow-hidden transition-all " + 
                                    (this.selectedPageIndices.has(index) ? "border-blue-500 ring-2 ring-blue-200" : "border-gray-200 dark:border-gray-700");
                    div.onclick = () => this.togglePageSelection(index, div);

                    const img = document.createElement('img');
                    img.src = page.dataUrl;
                    img.className = "w-full h-auto object-contain bg-white";
                    
                    const check = document.createElement('div');
                    check.className = "absolute top-2 right-2 w-6 h-6 rounded-full flex items-center justify-center " +
                                      (this.selectedPageIndices.has(index) ? "bg-blue-500 text-white" : "bg-gray-200 text-transparent");
                    check.innerHTML = '<span class="material-symbols-outlined text-sm">check</span>';

                    div.appendChild(img);
                    div.appendChild(check);
                    grid.appendChild(div);
                });
                // Auto select all initially
                if(this.selectedPageIndices.size === 0) this.selectAllPages();
            },

            togglePageSelection: function(index, element) {
                if (this.selectedPageIndices.has(index)) {
                    this.selectedPageIndices.delete(index);
                } else {
                    this.selectedPageIndices.add(index);
                }
                this.renderSelectionView(); // Re-render for simplicity
            },

            selectAllPages: function() {
                this.pages.forEach((_, i) => this.selectedPageIndices.add(i));
                this.renderSelectionView();
            },

            goToSignatureCreation: function() {
                if (this.selectedPageIndices.size === 0) {
                    alert("Please select at least one page.");
                    return;
                }
                this.switchView('view-create-sig');
                // Resize canvas correctly after visibility change
                setTimeout(() => {
                    const canvas = document.getElementById('sigCanvas');
                    const parent = canvas.parentElement;
                    canvas.width = parent.clientWidth;
                    canvas.height = parent.clientHeight;
                    // Reset context styles
                    const ctx = canvas.getContext('2d');
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = this.penColor || '#000000';
                }, 50);
            },

            /**
             * Signature Creation (Canvas & Upload)
             */
            switchSigTab: function(tab) {
                if (tab === 'draw') {
                    document.getElementById('tab-draw').classList.add('border-b-2', 'border-blue-600', 'bg-blue-50', 'dark:bg-gray-800', 'text-blue-600');
                    document.getElementById('tab-draw').classList.remove('text-gray-500');
                    document.getElementById('tab-upload').classList.remove('border-b-2', 'border-blue-600', 'bg-blue-50', 'dark:bg-gray-800', 'text-blue-600');
                    document.getElementById('tab-upload').classList.add('text-gray-500');
                    
                    document.getElementById('area-draw').classList.remove('hidden');
                    document.getElementById('area-upload').classList.add('hidden');
                } else {
                    document.getElementById('tab-upload').classList.add('border-b-2', 'border-blue-600', 'bg-blue-50', 'dark:bg-gray-800', 'text-blue-600');
                    document.getElementById('tab-upload').classList.remove('text-gray-500');
                    document.getElementById('tab-draw').classList.remove('border-b-2', 'border-blue-600', 'bg-blue-50', 'dark:bg-gray-800', 'text-blue-600');
                    document.getElementById('tab-draw').classList.add('text-gray-500');

                    document.getElementById('area-draw').classList.add('hidden');
                    document.getElementById('area-upload').classList.remove('hidden');
                }
            },

            setupCanvas: function() {
                const canvas = document.getElementById('sigCanvas');
                const ctx = canvas.getContext('2d');
                this.penColor = '#000000';
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;

                const getPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return {
                        x: clientX - rect.left,
                        y: clientY - rect.top
                    };
                };

                const start = (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    const pos = getPos(e);
                    lastX = pos.x;
                    lastY = pos.y;
                };

                const move = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault();
                    const pos = getPos(e);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    lastX = pos.x;
                    lastY = pos.y;
                };

                const end = () => { isDrawing = false; };

                canvas.addEventListener('mousedown', start);
                canvas.addEventListener('mousemove', move);
                canvas.addEventListener('mouseup', end);
                canvas.addEventListener('mouseout', end);

                canvas.addEventListener('touchstart', start, {passive: false});
                canvas.addEventListener('touchmove', move, {passive: false});
                canvas.addEventListener('touchend', end);
            },

            setPenColor: function(color) {
                this.penColor = color;
                const ctx = document.getElementById('sigCanvas').getContext('2d');
                ctx.strokeStyle = color;
            },

            clearCanvas: function() {
                const canvas = document.getElementById('sigCanvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            },

            handleSigUpload: function(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById('uploadedSigPreview');
                        img.src = e.target.result;
                        img.classList.remove('hidden');
                        this.signatureDataUrl = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            goToPlacement: function() {
                if (!document.getElementById('area-draw').classList.contains('hidden')) {
                    const canvas = document.getElementById('sigCanvas');
                    this.signatureDataUrl = canvas.toDataURL();
                } else {
                    if (!this.signatureDataUrl) {
                        alert("Please upload a signature or draw one.");
                        return;
                    }
                }

                this.renderPlacementView();
                this.switchView('view-placement');
            },

            /**
             * Placement View & Interaction
             */
            renderPlacementView: function() {
                const container = document.getElementById('placement-container');
                container.innerHTML = '';

                // Sort selected indices to maintain order
                const sortedIndices = Array.from(this.selectedPageIndices).sort((a, b) => a - b);

                sortedIndices.forEach(index => {
                    const page = this.pages[index];
                    
                    // Wrapper for Page
                    const wrapper = document.createElement('div');
                    wrapper.id = `page-wrapper-${index}`;
                    wrapper.className = "relative shadow-lg border border-gray-300 dark:border-gray-700 bg-white";
                    wrapper.style.maxWidth = "100%";
                    wrapper.setAttribute('data-page-index', index);

                    const img = document.createElement('img');
                    img.src = page.dataUrl;
                    img.className = "block max-w-full h-auto select-none no-select";
                    img.draggable = false;
                    
                    wrapper.appendChild(img);
                    container.appendChild(wrapper);

                    // Add click to deselect active signatures
                    wrapper.addEventListener('mousedown', (e) => {
                        if(e.target === img) this.deselectAllSignatures();
                    });
                });
            },

            addSignatureToView: function() {
                const container = document.getElementById('placement-container');
                const wrappers = container.querySelectorAll('[id^="page-wrapper-"]');
                
                // Find first wrapper currently in view
                let targetWrapper = wrappers[0];
                for(let w of wrappers) {
                    const rect = w.getBoundingClientRect();
                    if (rect.top > 0 && rect.top < window.innerHeight) {
                        targetWrapper = w;
                        break;
                    }
                }

                this.createSignatureElement(targetWrapper);
            },

            createSignatureElement: function(wrapper) {
                const sigId = 'sig-' + crypto.randomUUID();
                const sigEl = document.createElement('div');
                sigEl.className = 'signature-item';
                sigEl.id = sigId;
                
                const initialWidth = 150; 
                sigEl.style.width = initialWidth + 'px';
                sigEl.style.height = 'auto';
                sigEl.style.left = '50%';
                sigEl.style.top = '50%';
                sigEl.style.transform = 'translate(-50%, -50%)';

                const img = document.createElement('img');
                img.src = this.signatureDataUrl;
                img.className = 'w-full h-full pointer-events-none select-none';
                img.style.display = 'block'; 
                
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';

                sigEl.appendChild(img);
                sigEl.appendChild(resizeHandle);
                wrapper.appendChild(sigEl);

                this.makeDraggableAndResizable(sigEl, wrapper);
                this.selectSignature(sigEl);
            },

            makeDraggableAndResizable: function(el, wrapper) {
                let isDragging = false;
                let isResizing = false;
                let startX, startY, startLeft, startTop, startWidth, startHeight;
                let aspectRatio = 0;

                const getCoords = (e) => {
                    return {
                        x: e.touches ? e.touches[0].clientX : e.clientX,
                        y: e.touches ? e.touches[0].clientY : e.clientY
                    };
                };

                const onMouseDown = (e) => {
                    if (e.target.classList.contains('resize-handle')) {
                        isResizing = true;
                        e.stopPropagation();
                    } else {
                        isDragging = true;
                    }
                    
                    this.selectSignature(el);
                    
                    const coords = getCoords(e);
                    startX = coords.x;
                    startY = coords.y;
                    
                    startLeft = el.offsetLeft;
                    startTop = el.offsetTop;
                    const rect = el.getBoundingClientRect();
                    startWidth = rect.width;
                    startHeight = rect.height;
                    aspectRatio = startWidth / startHeight;

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                    document.addEventListener('touchmove', onMove, {passive: false});
                    document.addEventListener('touchend', onUp);
                };

                const onMove = (e) => {
                    if (!isDragging && !isResizing) return;
                    e.preventDefault();

                    const coords = getCoords(e);
                    const dx = coords.x - startX;
                    const dy = coords.y - startY;

                    if (isDragging) {
                        let newLeft = startLeft + dx;
                        let newTop = startTop + dy;
                        el.style.transform = 'none'; 
                        el.style.left = newLeft + 'px';
                        el.style.top = newTop + 'px';
                    } else if (isResizing) {
                        let newWidth = Math.max(30, startWidth + dx);
                        let newHeight = newWidth / aspectRatio;
                        el.style.width = newWidth + 'px';
                        el.style.height = newHeight + 'px';
                    }
                };

                const onUp = (e) => {
                    isDragging = false;
                    isResizing = false;
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onUp);

                    const rect = el.getBoundingClientRect();
                    const parentRect = wrapper.getBoundingClientRect();

                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;

                    if (centerX < parentRect.left || centerX > parentRect.right || 
                        centerY < parentRect.top || centerY > parentRect.bottom) {
                        el.style.transition = 'opacity 0.2s, transform 0.2s';
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.5)';
                        setTimeout(() => el.remove(), 200);
                    }
                };

                el.addEventListener('mousedown', onMouseDown);
                el.addEventListener('touchstart', onMouseDown, {passive: false});
            },

            selectSignature: function(el) {
                this.deselectAllSignatures();
                el.classList.add('active');
            },

            deselectAllSignatures: function() {
                document.querySelectorAll('.signature-item.active').forEach(el => el.classList.remove('active'));
            },

            finishSigning: function() {
                // CAPTURE STATE BEFORE HIDING VIEW
                this.captureFinalState();
                
                this.switchView('view-success');
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('themeToggle').scrollIntoView({ behavior: 'smooth' });
            },

            captureFinalState: function() {
                 const sortedIndices = Array.from(this.selectedPageIndices).sort((a, b) => a - b);
                 
                 sortedIndices.forEach(pageIndex => {
                     const wrapper = document.querySelector(`div[data-page-index="${pageIndex}"]`);
                     if (!wrapper) return;

                     const domImg = wrapper.querySelector('img');
                     const domRect = domImg.getBoundingClientRect();
                     const sigs = wrapper.querySelectorAll('.signature-item');
                     
                     // Reset previous signatures for this page
                     this.pages[pageIndex].finalSignatures = [];

                     sigs.forEach(sig => {
                         const sigRect = sig.getBoundingClientRect();
                         const sigImgSrc = sig.querySelector('img').src;

                         // Calculate percentages relative to the displayed image
                         const xPercent = (sigRect.left - domRect.left) / domRect.width;
                         const yPercent = (sigRect.top - domRect.top) / domRect.height;
                         const wPercent = sigRect.width / domRect.width;
                         const hPercent = sigRect.height / domRect.height;

                         this.pages[pageIndex].finalSignatures.push({
                             src: sigImgSrc,
                             xPercent,
                             yPercent,
                             wPercent,
                             hPercent
                         });
                     });
                 });
            },

            /**
             * Export Logic
             */
            exportDocument: async function() {
                this.toggleLoading(true, "Generating PDF...");
                
                await new Promise(r => setTimeout(r, 100));

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    const sortedIndices = Array.from(this.selectedPageIndices).sort((a, b) => a - b);

                    for (let i = 0; i < sortedIndices.length; i++) {
                        const pageIndex = sortedIndices[i];
                        const pageData = this.pages[pageIndex];
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = pageData.width;
                        canvas.height = pageData.height;
                        const ctx = canvas.getContext('2d');

                        // Draw background
                        const bgImg = new Image();
                        bgImg.src = pageData.dataUrl;
                        await new Promise(resolve => bgImg.onload = resolve);
                        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

                        // Draw Signatures from captured state
                        if (pageData.finalSignatures) {
                            for (let sig of pageData.finalSignatures) {
                                const sigObj = new Image();
                                sigObj.src = sig.src;
                                await new Promise(resolve => sigObj.onload = resolve);

                                const x = sig.xPercent * canvas.width;
                                const y = sig.yPercent * canvas.height;
                                const w = sig.wPercent * canvas.width;
                                const h = sig.hPercent * canvas.height;

                                ctx.drawImage(sigObj, x, y, w, h);
                            }
                        }

                        const imgData = canvas.toDataURL('image/jpeg', 0.85);
                        
                        const pdfW = pdf.internal.pageSize.getWidth();
                        const pdfH = (pageData.height * pdfW) / pageData.width;
                        
                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
                    }

                    pdf.save('signed_document.pdf');
                } catch (e) {
                    console.error(e);
                    alert("Error generating PDF.");
                } finally {
                    this.toggleLoading(false);
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>


