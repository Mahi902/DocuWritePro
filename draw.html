<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Draw</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 12px; background: #f0f0f0;
  display: flex; flex-direction: column;
  user-select: none; -webkit-user-select: none;
  touch-action: none;
}

/* ── Dark Theme ── */
body.dark { background: #1e1e1e; color: #ddd; }
body.dark #topbar { background: #2d2d2d; border-color: #3a3a3a; box-shadow: 0 1px 3px rgba(0,0,0,.4); }
body.dark .top-logo { color: #eee; }
body.dark .menu-trigger { color: #ccc; }
body.dark .menu-trigger:hover { background: #3a3a3a; }
body.dark .menu-trigger.open  { background: #444; }
body.dark .dropdown-menu { background: #2d2d2d; border-color: #3a3a3a; box-shadow: 0 8px 28px rgba(0,0,0,.5); }
body.dark .dd-item { color: #ccc; }
body.dark .dd-item:hover { background: #3a3a3a; }
body.dark .dd-sep { background: #3a3a3a; }
body.dark .qa-btn { color: #bbb; }
body.dark .qa-btn:hover { background: #3a3a3a; }
body.dark #win-title { color: #bbb; }
body.dark #win-title:hover { color: #ddd; }
body.dark #win-title-input { background: #3a3a3a; color: #eee; border-color: #555; }
body.dark #toolbar { background: #252525; border-color: #3a3a3a; }
body.dark .tool-btn { color: #aaa; }
body.dark .tool-btn:hover { background: #333; }
body.dark .tool-btn.active { background: #1a3a5c; color: #7ab4f5; }
body.dark .tool-btn.active .tl { color: #7ab4f5; }
body.dark .tsep { background: #3a3a3a; }
body.dark #canvas-area { background: #555; }
body.dark #right-panel { background: #252525; border-color: #3a3a3a; }
body.dark .plabel { color: #666; }
body.dark .sz-btn, body.dark .bs-btn, body.dark .sh-btn, body.dark .of-btn { background: #2d2d2d; border-color: #3a3a3a; color: #ccc; }
body.dark .sz-btn:hover, body.dark .bs-btn:hover, body.dark .sh-btn:hover, body.dark .of-btn:hover { background: #383838; }
body.dark .sz-btn.active, body.dark .bs-btn.active, body.dark .sh-btn.active, body.dark .of-btn.active { background: #1a3a5c; border-color: #5599dd; color: #7ab4f5; }
body.dark .sz-dot { background: #ccc; }
body.dark .color-current { background: #2a2a2a; }
body.dark .color-info { color: #666; }
body.dark .color-info strong { color: #ccc; }
body.dark .edit-col-btn { border-color: #444; color: #666; }
body.dark .edit-col-btn:hover { background: #333; color: #aaa; }
body.dark #statusbar { background: #252525; border-color: #3a3a3a; color: #666; }
body.dark #zoom-area button { background: #2d2d2d; border-color: #444; color: #aaa; }
body.dark #zoom-area button:hover { background: #383838; }
body.dark .dlg-box { background: #2d2d2d; }
body.dark .dlg-box h3 { color: #eee; }
body.dark .inp-row input, body.dark #hex-input, body.dark .form-row input[type=number] { background: #383838; border-color: #555; color: #eee; }
body.dark .btn-cancel { background: #383838; border-color: #555; color: #ccc; }
body.dark .btn-cancel:hover { background: #444; }
body.dark .form-sec { color: #ccc; }
body.dark .radio-row label, body.dark .chk-row { color: #aaa; }
body.dark #color-spectrum { border-color: #555; }
body.dark #color-preview { border-color: #555; }
body.dark .tt { background: #444; }
body.dark #dark-item { color: #7ab4f5; font-weight: 600; }

/* ── Top Bar ── */
#topbar {
  display: flex; align-items: center; height: 44px;
  background: #fff; border-bottom: 1px solid #e8e8e8;
  padding: 0 6px; gap: 2px; flex-shrink: 0; z-index: 200;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.top-logo {
  display: flex; align-items: center; gap: 7px;
  padding: 0 10px 0 4px; font-weight: 600; font-size: 13px;
  color: #1a1a1a; margin-right: 4px; flex-shrink: 0;
}
.top-logo svg { width: 22px; height: 22px; }
.menu-trigger {
  height: 34px; padding: 0 10px; border: none; background: transparent;
  border-radius: 7px; cursor: pointer; font-size: 12px; color: #333;
  display: flex; align-items: center; position: relative;
  transition: background .12s; flex-shrink: 0;
}
.menu-trigger:hover { background: #f0f0f0; }
.menu-trigger.open  { background: #e8e8e8; }
.dropdown-menu {
  display: none; position: absolute; top: calc(100% + 5px); left: 0;
  background: #fff; border: 1px solid #e4e4e4; border-radius: 10px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.13); min-width: 190px;
  z-index: 9999; padding: 5px; overflow: hidden;
}
.menu-trigger.open .dropdown-menu { display: block; }
.dd-item {
  display: flex; align-items: center; gap: 10px; padding: 8px 12px;
  border-radius: 6px; cursor: pointer; color: #222; white-space: nowrap; font-size: 12px;
}
.dd-item:hover { background: #f4f4f4; }
.dd-item svg { width: 14px; height: 14px; opacity: 0.5; flex-shrink: 0; }
.dd-item .kbd { margin-left: auto; color: #aaa; font-size: 11px; font-family: monospace; }
.dd-sep { height: 1px; background: #ebebeb; margin: 4px 0; }
.title-center { flex: 1; text-align: center; font-size: 12px; color: #666; display: flex; align-items: center; justify-content: center; }
#win-title { cursor: pointer; padding: 3px 6px; border-radius: 5px; transition: background .12s, color .12s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 260px; }
#win-title:hover { background: #f0f0f0; color: #222; }
#win-title-input {
  display: none; font-family: 'Segoe UI', system-ui, sans-serif; font-size: 12px;
  color: #222; background: #fff; border: 1.5px solid #1a5fb4; border-radius: 5px;
  padding: 3px 8px; outline: none; text-align: center; width: 200px; max-width: 260px;
}
.qa-btn {
  width: 36px; height: 36px; border: none; background: transparent;
  border-radius: 8px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; color: #444; transition: background .12s; flex-shrink: 0;
}
.qa-btn:hover { background: #f0f0f0; }
.qa-btn svg { width: 17px; height: 17px; }

/* ── Body Layout ── */
#body {
  flex: 1; display: flex; overflow: hidden; position: relative;
}

/* ── Left Toolbar ── */
#toolbar {
  width: 56px; background: #fafafa; border-right: 1px solid #e8e8e8;
  display: flex; flex-direction: column; align-items: center;
  padding: 8px 5px; gap: 2px; overflow-y: auto; overflow-x: hidden;
  flex-shrink: 0; scrollbar-width: none;
}
#toolbar::-webkit-scrollbar { display: none; }
.tool-btn {
  width: 46px; height: 46px; border: none; background: transparent;
  border-radius: 10px; cursor: pointer; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 2px;
  color: #555; transition: background .12s, color .12s; flex-shrink: 0;
}
.tool-btn svg { width: 20px; height: 20px; }
.tool-btn .tl { font-size: 9px; color: #999; line-height: 1; letter-spacing: 0.2px; }
.tool-btn:hover { background: #efefef; }
.tool-btn.active { background: #dbeafe; color: #1a5fb4; }
.tool-btn.active .tl { color: #1a5fb4; }
.tsep { width: 34px; height: 1px; background: #ebebeb; margin: 4px 0; flex-shrink: 0; }

/* ── Canvas Area ── */
#canvas-area {
  flex: 1; background: #787878;
  overflow: auto; display: flex;
  align-items: flex-start; justify-content: flex-start;
  padding: 20px; touch-action: none; position: relative;
}
#canvas-wrapper {
  position: relative; display: inline-block;
  box-shadow: 0 6px 24px rgba(0,0,0,0.4); flex-shrink: 0;
}
#main-canvas {
  display: block; cursor: crosshair; image-rendering: pixelated; touch-action: none;
}
#overlay-canvas {
  position: absolute; top: 0; left: 0; pointer-events: none; image-rendering: pixelated;
}
#sel-overlay {
  position: absolute; display: none;
  border: 1.5px dashed #fff; outline: 1.5px dashed #333; pointer-events: none;
}
#text-input-overlay {
  position: absolute; display: none; border: 1.5px dashed #1a5fb4;
  background: transparent; resize: none; outline: none; overflow: hidden;
  z-index: 10; min-width: 40px; min-height: 26px; padding: 3px;
  touch-action: manipulation; font-family: Arial, sans-serif; font-size: 16px;
}
.r-handle {
  position: absolute; width: 10px; height: 10px; background: #fff;
  border: 1.5px solid #1a5fb4; border-radius: 2px; z-index: 5;
}
#rh-se { bottom:-5px; right:-5px; cursor:se-resize; }
#rh-e  { right:-5px; top:50%; transform:translateY(-50%); cursor:e-resize; }
#rh-s  { bottom:-5px; left:50%; transform:translateX(-50%); cursor:s-resize; }

/* ── Right Panel ── */
#right-panel {
  width: 196px; background: #fafafa; border-left: 1px solid #e8e8e8;
  display: flex; flex-direction: column; padding: 10px 9px;
  overflow-y: auto; overflow-x: hidden; flex-shrink: 0;
  scrollbar-width: thin; scrollbar-color: #d8d8d8 transparent; gap: 0;
}
#right-panel::-webkit-scrollbar { width: 4px; }
#right-panel::-webkit-scrollbar-thumb { background: #d8d8d8; border-radius: 4px; }

.psec { margin-bottom: 14px; }
.plabel {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.6px; color: #aaa; margin-bottom: 7px; padding: 0 2px;
}

/* Size */
.size-row { display: flex; gap: 4px; }
.sz-btn {
  flex: 1; height: 34px; border: 1.5px solid #e8e8e8; background: #fff;
  border-radius: 8px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: background .12s, border-color .12s;
}
.sz-btn:hover { background: #f0f0f0; }
.sz-btn.active { background: #dbeafe; border-color: #1a5fb4; }
.sz-dot { background: #444; border-radius: 50%; flex-shrink: 0; }

/* Brush shapes */
.bsg { display: grid; grid-template-columns: repeat(4,1fr); gap: 4px; }
.bs-btn {
  height: 34px; border: 1.5px solid #e8e8e8; background: #fff;
  border-radius: 8px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: background .12s;
}
.bs-btn:hover { background: #f0f0f0; }
.bs-btn.active { background: #dbeafe; border-color: #1a5fb4; }

/* Shapes */
.shg { display: grid; grid-template-columns: repeat(4,1fr); gap: 4px; }
.sh-btn {
  height: 32px; border: 1.5px solid #e8e8e8; background: #fff;
  border-radius: 7px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: background .12s;
}
.sh-btn:hover { background: #f0f0f0; }
.sh-btn.active { background: #dbeafe; border-color: #1a5fb4; }
.sh-btn svg { width: 17px; height: 17px; }

/* Outline/Fill */
.of-row { display: flex; gap: 4px; margin-top: 6px; }
.of-btn {
  flex: 1; height: 30px; border: 1.5px solid #e8e8e8; background: #fff;
  border-radius: 7px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; font-size: 10px; font-weight: 600; gap: 3px;
  color: #666; transition: background .12s;
}
.of-btn:hover { background: #f0f0f0; }
.of-btn.active { background: #dbeafe; border-color: #1a5fb4; color: #1a5fb4; }

/* Colors */
.color-current {
  display: flex; align-items: center; gap: 10px; margin-bottom: 9px;
  padding: 8px; background: #f5f5f5; border-radius: 10px;
}
.color-stack { position: relative; width: 38px; height: 38px; flex-shrink: 0; }
.cc-bg {
  position: absolute; width: 24px; height: 24px; bottom: 0; right: 0;
  border: 1.5px solid #bbb; border-radius: 5px; cursor: pointer;
}
.cc-fg {
  position: absolute; width: 24px; height: 24px; top: 0; left: 0;
  border: 1.5px solid #555; border-radius: 5px; cursor: pointer; z-index: 1;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.color-info { font-size: 10px; color: #888; line-height: 1.6; }
.color-info strong { display: block; font-size: 12px; color: #222; font-weight: 600; font-family: monospace; }
.palette-grid { display: grid; grid-template-columns: repeat(6,1fr); gap: 4px; }
.p-sw {
  aspect-ratio: 1; border-radius: 5px; cursor: pointer;
  border: 1.5px solid rgba(0,0,0,0.08);
  transition: transform .1s, border-color .1s;
}
.p-sw:hover { transform: scale(1.18); border-color: rgba(0,0,0,0.3); z-index: 1; position: relative; }
.p-sw.sfg { border: 2px solid #1a5fb4; box-shadow: 0 0 0 1px #fff inset; }
.edit-col-btn {
  width: 100%; height: 30px; border: 1.5px dashed #ddd; background: transparent;
  border-radius: 8px; cursor: pointer; font-size: 11px; color: #888; margin-top: 6px;
  transition: background .12s, color .12s;
}
.edit-col-btn:hover { background: #f0f0f0; color: #444; }

/* ── Status Bar ── */
#statusbar {
  height: 26px; background: #f5f5f5; border-top: 1px solid #e8e8e8;
  display: flex; align-items: center; padding: 0 12px; gap: 16px;
  font-size: 11px; color: #888; flex-shrink: 0; z-index: 100;
}
#zoom-area { margin-left: auto; display: flex; align-items: center; gap: 6px; }
#zoom-area button {
  width: 22px; height: 22px; border: 1.5px solid #e0e0e0; background: #fff;
  border-radius: 5px; cursor: pointer; font-size: 15px; line-height: 1;
  display: flex; align-items: center; justify-content: center; color: #555;
}
#zoom-area button:hover { background: #efefef; }
#zoom-slider { width: 80px; accent-color: #1a5fb4; }

/* ── Dialogs ── */
.dlg-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,.35);
  z-index: 8000; align-items: center; justify-content: center;
}
.dlg-overlay.vis { display: flex; }
.dlg-box {
  background: #fff; border-radius: 14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.22);
  padding: 22px 22px 18px; width: min(430px,95vw);
  max-height: 92vh; overflow-y: auto;
}
.dlg-box h3 { font-size: 15px; font-weight: 700; margin-bottom: 18px; color: #111; }
.dlg-row { display: flex; gap: 18px; align-items: flex-start; }
.dlg-col { display: flex; flex-direction: column; gap: 7px; }
#color-spectrum { border-radius: 8px; border: 1px solid #e0e0e0; cursor: crosshair; touch-action: none; display: block; }
#hue-slider {
  width: 220px; height: 18px; -webkit-appearance:none; appearance:none;
  border-radius: 9px; outline: none; cursor: pointer; margin-top: 7px;
  background: linear-gradient(to right,
    hsl(0,100%,50%),hsl(30,100%,50%),hsl(60,100%,50%),hsl(90,100%,50%),
    hsl(120,100%,50%),hsl(150,100%,50%),hsl(180,100%,50%),hsl(210,100%,50%),
    hsl(240,100%,50%),hsl(270,100%,50%),hsl(300,100%,50%),hsl(330,100%,50%),hsl(360,100%,50%));
}
#hue-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:20px; height:20px; border-radius:50%;
  border:2px solid #fff; box-shadow:0 1px 5px rgba(0,0,0,.35); cursor:pointer;
  background: hsl(0,100%,50%);
}
#hue-slider::-moz-range-thumb {
  width:20px; height:20px; border-radius:50%; border:2px solid #fff;
  box-shadow:0 1px 5px rgba(0,0,0,.35); cursor:pointer;
}
#color-preview {
  width: 64px; height: 64px; border-radius: 10px;
  border: 1px solid #e0e0e0; display: block; flex-shrink: 0;
}
.inp-row { display: flex; align-items: center; gap: 6px; }
.inp-row label { width: 14px; font-size: 11px; color: #999; font-weight: 600; }
.inp-row input {
  width: 52px; padding: 5px 6px; border: 1.5px solid #e8e8e8;
  border-radius: 6px; font-size: 11px; outline: none; text-align: center;
}
.inp-row input:focus { border-color: #1a5fb4; }
.hex-row { display: flex; align-items: center; gap: 6px; margin-top: 3px; }
.hex-row label { font-size: 12px; color: #999; font-weight: 600; }
#hex-input {
  width: 96px; padding: 5px 8px; border: 1.5px solid #e8e8e8;
  border-radius: 6px; font-size: 13px; font-family: monospace; outline: none;
}
#hex-input:focus { border-color: #1a5fb4; }
.dlg-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }
.dlg-btns button {
  padding: 8px 20px; border-radius: 8px; font-size: 12px; font-weight: 600;
  cursor: pointer; border: 1.5px solid #e0e0e0; transition: background .12s;
}
.btn-ok { background: #1a5fb4; color: #fff; border-color: #1a5fb4; }
.btn-ok:hover { background: #144a8e; }
.btn-cancel { background: #fff; color: #333; }
.btn-cancel:hover { background: #f4f4f4; }

/* Resize Dialog */
.form-sec { font-size: 12px; font-weight: 700; color: #333; margin: 12px 0 7px; }
.form-row { display: flex; align-items: center; gap: 10px; margin-bottom: 7px; }
.form-row label { font-size: 12px; color: #666; width: 85px; flex-shrink: 0; }
.form-row input[type=number] {
  width: 76px; padding: 5px 8px; border: 1.5px solid #e8e8e8;
  border-radius: 6px; font-size: 12px; outline: none;
}
.form-row input[type=number]:focus { border-color: #1a5fb4; }
.radio-row { display: flex; gap: 18px; margin-bottom: 10px; }
.radio-row label { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #555; cursor: pointer; }
.chk-row { display: flex; align-items: center; gap: 7px; font-size: 12px; color: #555; cursor: pointer; margin-top: 4px; }

/* Mobile bottom toolbar */
@media (max-width: 600px) {
  #right-panel { display: none; }
  #toolbar {
    width: 100%; height: 60px; flex-direction: row;
    border-right: none; border-top: 1px solid #e8e8e8;
    padding: 5px 8px; overflow-x: auto; overflow-y: hidden;
    order: 3;
  }
  .tsep { width: 1px; height: 36px; margin: 0 3px; }
  .tool-btn { width: 48px; height: 48px; flex-shrink: 0; }
  .tool-btn .tl { display: none; }
  #body { flex-direction: column; }
  #canvas-area { order: 1; flex: 1; }
  #statusbar { order: 2; }
  #topbar { height: 48px; }
}
@media (max-width: 850px) and (min-width: 601px) {
  #right-panel { width: 162px; }
}

/* Tooltip */
.tt {
  position: fixed; background: #1a1a1a; color: #fff; padding: 5px 9px;
  border-radius: 6px; font-size: 11px; pointer-events: none; z-index: 99999;
  white-space: nowrap; display: none; box-shadow: 0 3px 10px rgba(0,0,0,.25);
}
</style>
</head>
<body>

<!-- Top Bar -->
<div id="topbar">
  <div class="top-logo">
    <svg viewBox="0 0 22 22" fill="none">
      <rect width="10" height="10" x="1" y="1" rx="2" fill="#e74c3c"/>
      <rect width="10" height="10" x="12" y="1" rx="2" fill="#3498db"/>
      <rect width="10" height="10" x="1" y="12" rx="2" fill="#2ecc71"/>
      <rect width="10" height="10" x="12" y="12" rx="2" fill="#f39c12"/>
    </svg>
    Draw
  </div>

  <button class="menu-trigger" id="mt-file" onclick="toggleMenu('mt-file')">File
    <div class="dropdown-menu">
      <div class="dd-item" onclick="newFile()"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 1h6l4 4v10H4z"/><path d="M10 1v4h4"/></svg>New<span class="kbd">Ctrl+N</span></div>
      <div class="dd-item" onclick="openFile()"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4h4l2 2h7v9H2z"/></svg>Open…<span class="kbd">Ctrl+O</span></div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="saveFile()"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="12" height="12" rx="1"/><rect x="5" y="2" width="6" height="4" fill="currentColor" stroke="none"/><rect x="4" y="9" width="8" height="5" rx="0.5"/></svg>Save<span class="kbd">Ctrl+S</span></div>
      <div class="dd-item" onclick="saveAs()">Save as…<span class="kbd">Ctrl⇧S</span></div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="printCanvas()">Print<span class="kbd">Ctrl+P</span></div>
    </div>
  </button>

  <button class="menu-trigger" id="mt-edit" onclick="toggleMenu('mt-edit')">Edit
    <div class="dropdown-menu">
      <div class="dd-item" onclick="doUndo()">Undo<span class="kbd">Ctrl+Z</span></div>
      <div class="dd-item" onclick="doRedo()">Redo<span class="kbd">Ctrl+Y</span></div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="doCut()">Cut<span class="kbd">Ctrl+X</span></div>
      <div class="dd-item" onclick="doCopy()">Copy<span class="kbd">Ctrl+C</span></div>
      <div class="dd-item" onclick="doPaste()">Paste<span class="kbd">Ctrl+V</span></div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="selectAll()">Select All<span class="kbd">Ctrl+A</span></div>
      <div class="dd-item" onclick="deleteSelection()">Delete<span class="kbd">Del</span></div>
    </div>
  </button>

  <button class="menu-trigger" id="mt-image" onclick="toggleMenu('mt-image')">Image
    <div class="dropdown-menu">
      <div class="dd-item" onclick="showResizeDlg()">Resize / Skew…</div>
      <div class="dd-item" onclick="cropToSelection()">Crop to selection</div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="flipH()">Flip horizontal</div>
      <div class="dd-item" onclick="flipV()">Flip vertical</div>
      <div class="dd-item" onclick="rotR()">Rotate 90° right</div>
      <div class="dd-item" onclick="rotL()">Rotate 90° left</div>
      <div class="dd-item" onclick="rot180()">Rotate 180°</div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="invertColors()">Invert colors<span class="kbd">Ctrl+I</span></div>
      <div class="dd-item" onclick="grayscale()">Grayscale</div>
    </div>
  </button>

  <button class="menu-trigger" id="mt-view" onclick="toggleMenu('mt-view')">View
    <div class="dropdown-menu">
      <div class="dd-item" onclick="zoomIn()">Zoom in<span class="kbd">Ctrl++</span></div>
      <div class="dd-item" onclick="zoomOut()">Zoom out<span class="kbd">Ctrl+−</span></div>
      <div class="dd-item" onclick="setZoom(1)">100%<span class="kbd">Ctrl+0</span></div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="toggleGrid()">Toggle grid<span class="kbd">G</span></div>
      <div class="dd-sep"></div>
      <div class="dd-item" onclick="toggleDark()" id="dark-item">Dark theme<span class="kbd">D</span></div>
    </div>
  </button>

  <span class="title-center" id="win-title-wrap">
    <span id="win-title" title="Double-click to rename" ondblclick="startRename()">Untitled — Draw</span>
    <input id="win-title-input" type="text" value="Untitled" spellcheck="false" onblur="commitRename()" onkeydown="titleKeydown(event)">
  </span>

  <button class="qa-btn" onclick="doUndo()" title="Undo (Ctrl+Z)">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M3 6H9a4 4 0 010 8H5"/><path d="M3 6l3-3M3 6l3 3"/></svg>
  </button>
  <button class="qa-btn" onclick="doRedo()" title="Redo (Ctrl+Y)">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M13 6H7a4 4 0 000 8h4"/><path d="M13 6l-3-3M13 6l-3 3"/></svg>
  </button>
</div>

<!-- Body -->
<div id="body">

  <!-- Toolbar -->
  <div id="toolbar">
    <button class="tool-btn active" id="tb-pencil"      onclick="setTool('pencil')"      data-tip="Pencil (P)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 3l4 4L8 20H4v-4L17 3z"/></svg>
      <span class="tl">Pencil</span>
    </button>
    <button class="tool-btn" id="tb-brush"       onclick="setTool('brush')"       data-tip="Brush (B)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 21s3-1 6-4l9-9a2 2 0 00-3-3L6 14c-3 3-3 7-3 7z"/></svg>
      <span class="tl">Brush</span>
    </button>
    <button class="tool-btn" id="tb-airbrush"    onclick="setTool('airbrush')"    data-tip="Spray can">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="8" y="8" width="8" height="11" rx="2"/><path d="M12 5v3M9 6.5h6M17 11h2M17 14h3M17 17h2"/><circle cx="4" cy="11" r="1" fill="currentColor"/><circle cx="4" cy="14.5" r="1" fill="currentColor"/><circle cx="5.5" cy="8.5" r="1" fill="currentColor"/></svg>
      <span class="tl">Spray</span>
    </button>
    <button class="tool-btn" id="tb-eraser"      onclick="setTool('eraser')"      data-tip="Eraser (E)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 20H8L4 16l13-13 7 7-4 4V20z"/><path d="M4 16l4 4"/></svg>
      <span class="tl">Eraser</span>
    </button>
    <button class="tool-btn" id="tb-fill"        onclick="setTool('fill')"        data-tip="Fill bucket (F)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M16 4l4 4-9 9-4-4 9-9z"/><path d="M3 17.5S5 16 7 18s4 1.5 4 1.5"/></svg>
      <span class="tl">Fill</span>
    </button>
    <button class="tool-btn" id="tb-eyedropper"  onclick="setTool('eyedropper')"  data-tip="Eyedropper (K)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M15 4l5 5-10 10-3 1-1-1 1-3L15 4z"/><circle cx="7" cy="17" r="2"/></svg>
      <span class="tl">Picker</span>
    </button>
    <button class="tool-btn" id="tb-text"        onclick="setTool('text')"        data-tip="Text (T)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 6h16M12 6v14M8 20h8"/></svg>
      <span class="tl">Text</span>
    </button>
    <div class="tsep"></div>
    <button class="tool-btn" id="tb-select-rect" onclick="setTool('select-rect')" data-tip="Rectangular select (S)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-dasharray="4 2"><rect x="3" y="3" width="18" height="18" rx="1.5"/></svg>
      <span class="tl">Select</span>
    </button>
    <button class="tool-btn" id="tb-select-free" onclick="setTool('select-free')" data-tip="Free-form select">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-dasharray="4 2"><path d="M4 12C6 6 12 4 16 8S18 18 12 20 2 18 4 12z"/></svg>
      <span class="tl">Free</span>
    </button>
    <div class="tsep"></div>
    <button class="tool-btn" id="tb-shape"       onclick="setTool('shape')"       data-tip="Shape tool">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><ellipse cx="12" cy="12" rx="8" ry="6"/></svg>
      <span class="tl">Shape</span>
    </button>
    <button class="tool-btn" id="tb-line"        onclick="setTool('line')"        data-tip="Line">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="4" y1="20" x2="20" y2="4"/></svg>
      <span class="tl">Line</span>
    </button>
    <button class="tool-btn" id="tb-zoom-tool"   onclick="setTool('zoom-tool')"   data-tip="Magnify">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="7"/><path d="M16 16l4 4M8 11h6M11 8v6"/></svg>
      <span class="tl">Zoom</span>
    </button>
  </div>

  <!-- Canvas -->
  <div id="canvas-area">
    <div id="canvas-wrapper">
      <canvas id="main-canvas" width="900" height="600"></canvas>
      <canvas id="overlay-canvas" width="900" height="600"></canvas>
      <div id="sel-overlay"></div>
      <div class="r-handle" id="rh-se"></div>
      <div class="r-handle" id="rh-e"></div>
      <div class="r-handle" id="rh-s"></div>
      <textarea id="text-input-overlay" spellcheck="false"></textarea>
    </div>
  </div>

  <!-- Right Panel -->
  <div id="right-panel">

    <div class="psec" id="sec-size">
      <div class="plabel">Size</div>
      <div class="size-row">
        <button class="sz-btn active" id="sz-1" onclick="setSize(1)"><div class="sz-dot" style="width:2px;height:2px"></div></button>
        <button class="sz-btn" id="sz-2" onclick="setSize(3)"><div class="sz-dot" style="width:5px;height:5px"></div></button>
        <button class="sz-btn" id="sz-3" onclick="setSize(6)"><div class="sz-dot" style="width:9px;height:9px"></div></button>
        <button class="sz-btn" id="sz-4" onclick="setSize(12)"><div class="sz-dot" style="width:14px;height:14px"></div></button>
      </div>
    </div>

    <div class="psec" id="sec-brush">
      <div class="plabel">Brush shape</div>
      <div class="bsg">
        <button class="bs-btn active" id="bs-circle" onclick="setBrushShape('circle')" title="Round">
          <svg width="16" height="16"><circle cx="8" cy="8" r="5" fill="#444"/></svg>
        </button>
        <button class="bs-btn" id="bs-square" onclick="setBrushShape('square')" title="Square">
          <svg width="16" height="16"><rect x="2" y="2" width="12" height="12" fill="#444"/></svg>
        </button>
        <button class="bs-btn" id="bs-diamond" onclick="setBrushShape('diamond')" title="Diamond">
          <svg width="16" height="16"><polygon points="8,2 14,8 8,14 2,8" fill="#444"/></svg>
        </button>
        <button class="bs-btn" id="bs-horiz" onclick="setBrushShape('horiz')" title="Horizontal">
          <svg width="16" height="16"><rect x="1" y="7" width="14" height="2" fill="#444"/></svg>
        </button>
        <button class="bs-btn" id="bs-vert" onclick="setBrushShape('vert')" title="Vertical">
          <svg width="16" height="16"><rect x="7" y="1" width="2" height="14" fill="#444"/></svg>
        </button>
        <button class="bs-btn" id="bs-diag1" onclick="setBrushShape('diag1')" title="Diagonal /">
          <svg width="16" height="16"><line x1="2" y1="14" x2="14" y2="2" stroke="#444" stroke-width="2"/></svg>
        </button>
        <button class="bs-btn" id="bs-diag2" onclick="setBrushShape('diag2')" title="Diagonal \">
          <svg width="16" height="16"><line x1="2" y1="2" x2="14" y2="14" stroke="#444" stroke-width="2"/></svg>
        </button>
      </div>
    </div>

    <div class="psec" id="sec-shapes" style="display:none">
      <div class="plabel">Shapes</div>
      <div class="shg">
        <button class="sh-btn active" id="sh-line"        onclick="setShape('line')"        title="Line"><svg viewBox="0 0 18 18"><line x1="3" y1="15" x2="15" y2="3" stroke="#444" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-rect"        onclick="setShape('rect')"        title="Rectangle"><svg viewBox="0 0 18 18"><rect x="2" y="4" width="14" height="10" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-roundrect"   onclick="setShape('roundrect')"   title="Rounded rect"><svg viewBox="0 0 18 18"><rect x="2" y="4" width="14" height="10" rx="3" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-ellipse"     onclick="setShape('ellipse')"     title="Ellipse"><svg viewBox="0 0 18 18"><ellipse cx="9" cy="9" rx="7" ry="5" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-triangle"    onclick="setShape('triangle')"    title="Triangle"><svg viewBox="0 0 18 18"><polygon points="9,2 16,16 2,16" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-rtriangle"   onclick="setShape('rtriangle')"   title="Right triangle"><svg viewBox="0 0 18 18"><polygon points="2,2 2,16 16,16" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-diamond"     onclick="setShape('diamond')"     title="Diamond"><svg viewBox="0 0 18 18"><polygon points="9,2 16,9 9,16 2,9" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-pentagon"    onclick="setShape('pentagon')"    title="Pentagon"><svg viewBox="0 0 18 18"><polygon points="9,1 17,7 14,17 4,17 1,7" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-hexagon"     onclick="setShape('hexagon')"     title="Hexagon"><svg viewBox="0 0 18 18"><polygon points="9,1 16,5 16,13 9,17 2,13 2,5" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-star4"       onclick="setShape('star4')"       title="4-pt star"><svg viewBox="0 0 18 18"><polygon points="9,1 10.5,7.5 17,9 10.5,10.5 9,17 7.5,10.5 1,9 7.5,7.5" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-star5"       onclick="setShape('star5')"       title="5-pt star"><svg viewBox="0 0 18 18"><polygon points="9,1 11,7 17,7 12,11 14,17 9,13 4,17 6,11 1,7 7,7" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-star6"       onclick="setShape('star6')"       title="6-pt star"><svg viewBox="0 0 18 18"><polygon points="9,1 11,6.5 17,6.5 12.5,10 14.5,16 9,12.5 3.5,16 5.5,10 1,6.5 7,6.5" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-arrow-right" onclick="setShape('arrow-right')" title="Arrow"><svg viewBox="0 0 18 18"><polygon points="2,7 11,7 11,4 16,9 11,14 11,11 2,11" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-heart"       onclick="setShape('heart')"       title="Heart"><svg viewBox="0 0 18 18"><path d="M9 15C9 15 2 10 2 5.5A4 4 0 0 1 9 4 4 4 0 0 1 16 5.5C16 10 9 15 9 15Z" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-callout"     onclick="setShape('callout')"     title="Callout"><svg viewBox="0 0 18 18"><rect x="1" y="2" width="16" height="11" rx="2" stroke="#444" fill="none" stroke-width="1.5"/><polygon points="4,13 4,17 8,13" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
        <button class="sh-btn"        id="sh-curve"       onclick="setShape('curve')"       title="Curve"><svg viewBox="0 0 18 18"><path d="M2 15 C5 3 13 3 16 15" stroke="#444" fill="none" stroke-width="1.5"/></svg></button>
      </div>
      <div class="of-row">
        <button class="of-btn active" id="of-outline" onclick="setOF('outline')">
          <svg width="12" height="9"><rect x="1" y="1" width="10" height="7" stroke="#555" fill="none" stroke-width="1.5"/></svg>Out
        </button>
        <button class="of-btn" id="of-fill" onclick="setOF('fill')">
          <svg width="12" height="9"><rect x="1" y="1" width="10" height="7" fill="#555"/></svg>Fill
        </button>
        <button class="of-btn" id="of-both" onclick="setOF('both')">
          <svg width="12" height="9"><rect x="1" y="1" width="10" height="7" fill="#7db4e8" stroke="#555" stroke-width="1.5"/></svg>Both
        </button>
      </div>
    </div>

    <div class="psec">
      <div class="plabel">Color</div>
      <div class="color-current">
        <div class="color-stack">
          <div class="cc-bg" id="cc-bg" title="Color 2 — right-click swatches to set"></div>
          <div class="cc-fg" id="cc-fg" title="Color 1 — click to edit" onclick="openColorDlg('fg')"></div>
        </div>
        <div class="color-info">
          <strong id="fg-hex">#000000</strong>
          Color 1
        </div>
      </div>
      <div class="palette-grid" id="palette-grid"></div>
      <button class="edit-col-btn" onclick="openColorDlg('fg')">+ Custom color</button>
    </div>

  </div>

</div><!-- /body -->

<!-- Status Bar -->
<div id="statusbar">
  <span id="status-pos">0, 0 px</span>
  <span id="status-sel"></span>
  <div id="zoom-area">
    <button onclick="zoomOut()">−</button>
    <input type="range" id="zoom-slider" min="10" max="800" value="100" oninput="setZoom(this.value/100)">
    <button onclick="zoomIn()">+</button>
    <span id="zoom-label">100%</span>
  </div>
</div>

<!-- Color Dialog -->
<div class="dlg-overlay" id="color-dlg">
  <div class="dlg-box">
    <h3>Edit Color</h3>
    <div class="dlg-row">
      <div class="dlg-col">
        <canvas id="color-spectrum" width="220" height="160"></canvas>
        <input type="range" id="hue-slider" min="0" max="360" value="0">
        <div class="hex-row">
          <label>#</label>
          <input type="text" id="hex-input" value="000000" maxlength="6">
        </div>
      </div>
      <div class="dlg-col">
        <canvas id="color-preview" width="64" height="64"></canvas>
        <div class="inp-row"><label>H</label><input type="number" id="ci-h" min="0" max="360" value="0"></div>
        <div class="inp-row"><label>S</label><input type="number" id="ci-s" min="0" max="100" value="0"></div>
        <div class="inp-row"><label>V</label><input type="number" id="ci-v" min="0" max="100" value="0"></div>
        <div class="inp-row"><label>R</label><input type="number" id="ci-r" min="0" max="255" value="0"></div>
        <div class="inp-row"><label>G</label><input type="number" id="ci-g" min="0" max="255" value="0"></div>
        <div class="inp-row"><label>B</label><input type="number" id="ci-b" min="0" max="255" value="0"></div>
      </div>
    </div>
    <div class="dlg-btns">
      <button class="btn-cancel" onclick="closeColorDlg()">Cancel</button>
      <button class="btn-ok"     onclick="applyColorDlg()">OK</button>
    </div>
  </div>
</div>

<!-- Resize Dialog -->
<div class="dlg-overlay" id="resize-dlg">
  <div class="dlg-box" style="max-width:320px">
    <h3>Resize and Skew</h3>
    <div class="form-sec">Resize</div>
    <div class="radio-row">
      <label><input type="radio" name="ru" value="px" checked> Pixels</label>
      <label><input type="radio" name="ru" value="pct"> Percentage</label>
    </div>
    <div class="form-row"><label>Horizontal</label><input id="rz-h" type="number" value="900"></div>
    <div class="form-row"><label>Vertical</label><input id="rz-v" type="number" value="600"></div>
    <label class="chk-row"><input type="checkbox" id="rz-asp" checked> Maintain aspect ratio</label>
    <div class="form-sec">Skew (degrees)</div>
    <div class="form-row"><label>Horizontal</label><input id="sk-h" type="number" value="0"></div>
    <div class="form-row"><label>Vertical</label><input id="sk-v" type="number" value="0"></div>
    <div class="dlg-btns">
      <button class="btn-cancel" onclick="closeResizeDlg()">Cancel</button>
      <button class="btn-ok"     onclick="doResize()">OK</button>
    </div>
  </div>
</div>

<div class="tt" id="tooltip"></div>

<script>
// ═══════════════════════════
// STATE
// ═══════════════════════════
const canvas  = document.getElementById('main-canvas');
const ctx     = canvas.getContext('2d');
const overlay = document.getElementById('overlay-canvas');
const octx    = overlay.getContext('2d');
const textEl  = document.getElementById('text-input-overlay');

let tool = 'pencil', shape = 'line', bShape = 'circle';
let bSize = 1, fgCol = '#000000', bgCol = '#ffffff';
let outFill = 'outline', zoom = 1, showGrid = false, modified = false;
let drawing = false, startX=0, startY=0, lastX=0, lastY=0;
let undos=[], redos=[], sel=null, selImg=null;
let movingSel=false, selMoveBase=null, freeSelPts=[];
let clipboard=null, curStep=0, curPts=[];
let dlgTarget='fg', dlgH=0, dlgS=100, dlgV=50;

// ═══════════════════════════
// PALETTE
// ═══════════════════════════
const PAL = [
  '#000000','#3d3d3d','#7a7a7a','#c0c0c0','#ffffff','#ff3b3b',
  '#ff7f00','#ffd000','#7dc400','#00a040','#00aaaa','#0066cc',
  '#6030c0','#c030a0','#ff6090','#ff9960','#ffd880','#b0f0b0',
  '#80e8ff','#aab0ff','#e8a0ff','#ff7755','#994400','#556600',
  '#004433','#003366','#2a0066','#660033','#1a1a2e','#16213e',
  '#0f3460','#533483','#e83050','#f5a423','#7ed321','#417505',
  '#8b572a','#888888','#333333','#cc0010','#e8d800','#50d020',
  '#cc00dd','#8800ee','#3388dd','#30d0b0','#90d850','#000080',
];

// Init
ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
buildPalette(); updateColors(); setTool('pencil'); setZoom(1);
function buildPalette() {
  const g = document.getElementById('palette-grid');
  PAL.forEach(c => {
    const s = document.createElement('div');
    s.className = 'p-sw'; s.style.background = c; s.title = c;
    s.addEventListener('click',        () => { fgCol = c; updateColors(); });
    s.addEventListener('contextmenu', e => { e.preventDefault(); bgCol = c; updateColors(); });
    s.addEventListener('touchstart', e => {
      if (e.touches.length === 1) { fgCol = c; updateColors(); }
    }, {passive:true});
    g.appendChild(s);
  });
}
function updateColors() {
  document.getElementById('cc-fg').style.background = fgCol;
  document.getElementById('cc-bg').style.background = bgCol;
  document.getElementById('fg-hex').textContent = fgCol.toUpperCase();
}

// ═══════════════════════════
// TOOLS
// ═══════════════════════════
function setTool(t) {
  if (tool === 'text') commitText();
  if (!t.startsWith('select')) clearSel();
  tool = t;
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tb-'+t)?.classList.add('active');
  const isBrush  = t==='pencil'||t==='brush'||t==='airbrush';
  const isShape  = t==='shape'||t==='line';
  document.getElementById('sec-brush').style.display  = isBrush ? '' : 'none';
  document.getElementById('sec-shapes').style.display = isShape ? '' : 'none';
  updateCursor();
}
function updateCursor() {
  const m = {pencil:'crosshair',brush:'crosshair',airbrush:'crosshair',
    eraser:'cell',fill:'cell',text:'text',eyedropper:'crosshair',
    'select-rect':'crosshair','select-free':'crosshair','zoom-tool':'zoom-in',
    shape:'crosshair',line:'crosshair'};
  canvas.style.cursor = m[tool]||'crosshair';
}
function setShape(s) {
  shape = s;
  document.querySelectorAll('.sh-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('sh-'+s)?.classList.add('active');
  setTool('shape');
}
function setBrushShape(s) {
  bShape = s;
  document.querySelectorAll('.bs-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('bs-'+s)?.classList.add('active');
}
function setSize(n) {
  bSize = n;
  document.querySelectorAll('.sz-btn').forEach(b=>b.classList.remove('active'));
  const m={1:'sz-1',3:'sz-2',6:'sz-3',12:'sz-4'};
  document.getElementById(m[n])?.classList.add('active');
}
function setOF(v) {
  outFill = v;
  document.querySelectorAll('.of-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('of-'+v)?.classList.add('active');
}

// ═══════════════════════════
// UNDO / REDO
// ═══════════════════════════
function saveState() {
  if (undos.length>=60) undos.shift();
  undos.push(ctx.getImageData(0,0,canvas.width,canvas.height));
  redos=[]; markMod();
}
function doUndo() { if(!undos.length)return; redos.push(ctx.getImageData(0,0,canvas.width,canvas.height)); ctx.putImageData(undos.pop(),0,0); }
function doRedo() { if(!redos.length)return; undos.push(ctx.getImageData(0,0,canvas.width,canvas.height)); ctx.putImageData(redos.pop(),0,0); }
function markMod() { modified=true; updateTitle(true); }

// ═══════════════════════════
// POINTER POSITION
// ═══════════════════════════
function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const src = e.touches ? e.touches[0] : (e.changedTouches ? e.changedTouches[0] : e);
  return { x:Math.round((src.clientX-rect.left)/zoom), y:Math.round((src.clientY-rect.top)/zoom) };
}
function isRight(e) { return e.button===2 || (e.buttons&2); }

// ═══════════════════════════
// CANVAS EVENTS — Mouse
// ═══════════════════════════
canvas.addEventListener('mousedown',  onDown,  {passive:false});
canvas.addEventListener('mousemove',  onMove,  {passive:false});
canvas.addEventListener('mouseup',    onUp,    {passive:false});
canvas.addEventListener('mouseleave', ()=>{});
canvas.addEventListener('contextmenu', e=>e.preventDefault());

// Touch
canvas.addEventListener('touchstart', onDown, {passive:false});
canvas.addEventListener('touchmove',  onMove, {passive:false});
canvas.addEventListener('touchend',   onUp,   {passive:false});

// Pinch zoom
let pinch0=null;
const ca = document.getElementById('canvas-area');
ca.addEventListener('touchstart', e=>{
  if (e.touches.length===2) pinch0=pdist(e);
}, {passive:true});
ca.addEventListener('touchmove', e=>{
  if (e.touches.length===2 && pinch0) {
    e.preventDefault();
    const d=pdist(e); setZoom(zoom*d/pinch0); pinch0=d;
  }
}, {passive:false});
ca.addEventListener('touchend', ()=>{pinch0=null;});
function pdist(e) {
  const dx=e.touches[0].clientX-e.touches[1].clientX, dy=e.touches[0].clientY-e.touches[1].clientY;
  return Math.sqrt(dx*dx+dy*dy);
}

function onDown(e) {
  e.preventDefault();
  if (e.touches && e.touches.length>1) return;
  const {x,y}=getPos(e), right=isRight(e), dc=right?bgCol:fgCol;

  if (tool==='text') { commitText(); startText(x,y); return; }
  if (tool==='zoom-tool') { right?zoomOut():zoomIn(); return; }
  if (tool==='eyedropper') {
    const px=ctx.getImageData(x,y,1,1).data;
    const h='#'+[px[0],px[1],px[2]].map(v=>v.toString(16).padStart(2,'0')).join('');
    if(right) bgCol=h; else fgCol=h;
    updateColors(); return;
  }
  if (tool==='fill') { saveState(); floodFill(x,y,dc); return; }
  if (tool==='select-rect') {
    if (sel && inSel(x,y)) { movingSel=true; selMoveBase={x,y,ox:sel.x,oy:sel.y}; return; }
    clearSel(); drawing=true; startX=x; startY=y; return;
  }
  if (tool==='select-free') { clearSel(); drawing=true; freeSelPts=[{x,y}]; return; }

  saveState(); drawing=true; startX=x; startY=y; lastX=x; lastY=y;
  if (tool==='pencil') {
    ctx.strokeStyle=dc; ctx.lineWidth=1; ctx.lineCap='square'; ctx.lineJoin='miter';
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+.1,y); ctx.stroke();
  } else if (tool==='brush') { doBrush(x,y,dc);
  } else if (tool==='eraser') { doErase(x,y);
  } else if (tool==='airbrush') { doSpray(x,y,dc); }
}

function onMove(e) {
  e.preventDefault();
  if (e.touches && e.touches.length>1) return;
  const {x,y}=getPos(e);
  document.getElementById('status-pos').textContent=`${x}, ${y} px`;

  if (movingSel && sel) {
    const dx=x-selMoveBase.x, dy=y-selMoveBase.y;
    sel.x=selMoveBase.ox+dx; sel.y=selMoveBase.oy+dy;
    renderSel();
    if (selImg) { octx.clearRect(0,0,overlay.width,overlay.height); octx.putImageData(selImg,sel.x,sel.y); }
    return;
  }

  if (!drawing) {
    if (tool==='select-rect'&&sel&&inSel(x,y)) canvas.style.cursor='move'; else updateCursor();
    if ((tool==='shape'&&shape==='curve')&&curStep===1) drawCurvePrev(x,y);
    return;
  }
  const right=(e.buttons&2)||(e.touches&&e.touches.length>1);
  const dc=right?bgCol:fgCol;

  if (tool==='select-rect') {
    const x0=Math.min(startX,x), y0=Math.min(startY,y), w=Math.abs(x-startX), h=Math.abs(y-startY);
    sel={x:x0,y:y0,w,h}; renderSel();
    document.getElementById('status-sel').textContent=`  ${w} × ${h} px`; return;
  }
  if (tool==='select-free') {
    freeSelPts.push({x,y});
    octx.clearRect(0,0,overlay.width,overlay.height);
    octx.strokeStyle='#333'; octx.lineWidth=1; octx.setLineDash([4,2]);
    octx.beginPath(); freeSelPts.forEach((p,i)=>i===0?octx.moveTo(p.x,p.y):octx.lineTo(p.x,p.y));
    octx.stroke(); octx.setLineDash([]); return;
  }
  if (tool==='pencil') {
    ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke();
    lastX=x; lastY=y;
  } else if (tool==='brush') {
    const dist=Math.hypot(x-lastX,y-lastY);
    for(let i=0;i<=dist;i++){const t=dist?i/dist:0;doBrush(lastX+(x-lastX)*t,lastY+(y-lastY)*t,dc);}
    lastX=x; lastY=y;
  } else if (tool==='eraser') { doErase(x,y); lastX=x; lastY=y;
  } else if (tool==='airbrush') { doSpray(x,y,dc);
  } else if (tool==='shape'||tool==='line') {
    octx.clearRect(0,0,overlay.width,overlay.height);
    drawShapePrev(octx,startX,startY,x,y,dc,right?fgCol:bgCol,!!e.shiftKey);
  }
}

function onUp(e) {
  if (e.touches && e.touches.length>0) return;
  const pos = e.changedTouches ? (()=>{
    const r=canvas.getBoundingClientRect(), t=e.changedTouches[0];
    return {x:Math.round((t.clientX-r.left)/zoom), y:Math.round((t.clientY-r.top)/zoom)};
  })() : getPos(e);
  const {x,y}=pos, right=e.button===2;
  const dc=right?bgCol:fgCol, fc=right?fgCol:bgCol;

  if (movingSel) { movingSel=false; commitSelMove(); return; }
  if (tool==='select-rect') { drawing=false; if(sel&&sel.w>2&&sel.h>2) selImg=ctx.getImageData(sel.x,sel.y,sel.w,sel.h); return; }
  if (tool==='select-free') {
    drawing=false; octx.clearRect(0,0,overlay.width,overlay.height);
    if(freeSelPts.length>3){const xs=freeSelPts.map(p=>p.x),ys=freeSelPts.map(p=>p.y);sel={x:Math.min(...xs),y:Math.min(...ys),w:Math.max(...xs)-Math.min(...xs),h:Math.max(...ys)-Math.min(...ys)};selImg=ctx.getImageData(sel.x,sel.y,sel.w,sel.h);renderSel();}
    return;
  }
  if (!drawing) return;
  drawing=false;
  if (tool==='shape'||tool==='line') {
    octx.clearRect(0,0,overlay.width,overlay.height);
    if(shape==='curve'){handleCurve(x,y,dc);return;}
    drawShapePrev(ctx,startX,startY,x,y,dc,fc,!!e.shiftKey);
  }
}

// ═══════════════════════════
// DRAWING
// ═══════════════════════════
function doBrush(x,y,c) {
  ctx.fillStyle=c; ctx.strokeStyle=c;
  const r=Math.max(1,bSize)/2;
  ctx.beginPath();
  switch(bShape){
    case 'circle': ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); break;
    case 'square': ctx.fillRect(x-r,y-r,r*2,r*2); break;
    case 'diamond': ctx.moveTo(x,y-r);ctx.lineTo(x+r,y);ctx.lineTo(x,y+r);ctx.lineTo(x-r,y);ctx.closePath();ctx.fill(); break;
    case 'horiz': ctx.fillRect(x-r*2.5,y-1.2,r*5,2.4); break;
    case 'vert':  ctx.fillRect(x-1.2,y-r*2.5,2.4,r*5); break;
    case 'diag1': ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(x-r,y+r);ctx.lineTo(x+r,y-r);ctx.stroke();break;
    case 'diag2': ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(x-r,y-r);ctx.lineTo(x+r,y+r);ctx.stroke();break;
  }
}
function doErase(x,y) {
  const s=Math.max(6,bSize*5);
  ctx.fillStyle=bgCol; ctx.fillRect(x-s/2,y-s/2,s,s);
}
function doSpray(x,y,c) {
  const r=bSize*6+6; ctx.fillStyle=c;
  for(let i=0;i<45;i++){const a=Math.random()*Math.PI*2,d=Math.random()*r;ctx.fillRect(x+Math.cos(a)*d,y+Math.sin(a)*d,1,1);}
}

function drawShapePrev(c,x1,y1,x2,y2,fg,bg,constrain) {
  if(constrain){const s=Math.min(Math.abs(x2-x1),Math.abs(y2-y1));x2=x1+(x2>x1?s:-s);y2=y1+(y2>y1?s:-s);}
  applyShape(c,x1,y1,x2,y2,shape,fg,bg,outFill,bSize);
}

function applyShape(c,x1,y1,x2,y2,sh,fg,bg,of,lw) {
  const x=Math.min(x1,x2),y=Math.min(y1,y2),w=Math.abs(x2-x1),h=Math.abs(y2-y1);
  const cx=(x1+x2)/2, cy=(y1+y2)/2;
  c.strokeStyle=fg; c.fillStyle=bg; c.lineWidth=lw||1; c.lineCap='round'; c.lineJoin='round';
  const F=()=>{if(of==='fill'||of==='both')c.fill();};
  const S=()=>{if(of==='outline'||of==='both')c.stroke();};
  switch(sh){
    case 'line': c.beginPath();c.moveTo(x1,y1);c.lineTo(x2,y2);c.strokeStyle=fg;c.stroke();return;
    case 'rect': c.beginPath();c.rect(x,y,w,h);F();S();return;
    case 'roundrect': c.beginPath();c.roundRect?c.roundRect(x,y,w,h,8):c.rect(x,y,w,h);F();S();return;
    case 'ellipse': c.beginPath();c.ellipse(cx,cy,w/2||1,h/2||1,0,0,Math.PI*2);F();S();return;
    case 'triangle': c.beginPath();c.moveTo(cx,y1);c.lineTo(x2,y2);c.lineTo(x1,y2);c.closePath();F();S();return;
    case 'rtriangle': c.beginPath();c.moveTo(x1,y1);c.lineTo(x1,y2);c.lineTo(x2,y2);c.closePath();F();S();return;
    case 'diamond': c.beginPath();c.moveTo(cx,y);c.lineTo(x2,cy);c.lineTo(cx,y2);c.lineTo(x,cy);c.closePath();F();S();return;
    case 'pentagon': c.beginPath();nGon(c,cx,cy,Math.min(w,h)/2,5,-Math.PI/2);F();S();return;
    case 'hexagon': c.beginPath();nGon(c,cx,cy,Math.min(w,h)/2,6,0);F();S();return;
    case 'star4': c.beginPath();starPts(c,cx,cy,Math.min(w,h)/2,Math.min(w,h)/2*.42,4);F();S();return;
    case 'star5': c.beginPath();starPts(c,cx,cy,Math.min(w,h)/2,Math.min(w,h)/2*.38,5);F();S();return;
    case 'star6': c.beginPath();starPts(c,cx,cy,Math.min(w,h)/2,Math.min(w,h)/2*.5,6);F();S();return;
    case 'arrow-right': { const ay=h*.32,sw=w*.55,my=cy;
      c.beginPath();c.moveTo(x,my-ay);c.lineTo(x+sw,my-ay);c.lineTo(x+sw,y);
      c.lineTo(x+w,my);c.lineTo(x+sw,y+h);c.lineTo(x+sw,my+ay);c.lineTo(x,my+ay);c.closePath();F();S();return; }
    case 'heart': {
      const tx=cx,ty=y+h*.35;
      c.beginPath();c.moveTo(tx,ty+h*.55);
      c.bezierCurveTo(tx,ty+h*.55,x,ty+h*.25,x,ty);
      c.bezierCurveTo(x,ty-h*.35,tx,ty-h*.1,tx,ty+h*.2);
      c.bezierCurveTo(tx,ty-h*.1,x+w,ty-h*.35,x+w,ty);
      c.bezierCurveTo(x+w,ty+h*.25,tx,ty+h*.55,tx,ty+h*.55);
      c.closePath();F();S();return;
    }
    case 'callout': {
      c.beginPath();
      c.roundRect?c.roundRect(x,y,w,h*.72,6):c.rect(x,y,w,h*.72);
      const by=y+h*.72;
      c.moveTo(x+w*.2,by);c.lineTo(x+w*.13,y+h);c.lineTo(x+w*.38,by);
      F();S();return;
    }
    case 'curve': return;
  }
}
function nGon(c,cx,cy,r,n,off){for(let i=0;i<n;i++){const a=Math.PI*2*i/n+off;i===0?c.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):c.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));}c.closePath();}
function starPts(c,cx,cy,r1,r2,n){for(let i=0;i<n*2;i++){const a=Math.PI*i/n-Math.PI/2,r=i%2===0?r1:r2;i===0?c.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):c.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));}c.closePath();}

// Curve
function handleCurve(x,y,color){
  if(curStep===0){curPts=[{x:startX,y:startY},{x,y}];curStep=1;drawing=false;}
  else if(curStep===1){
    ctx.strokeStyle=color;ctx.lineWidth=bSize;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(curPts[0].x,curPts[0].y);
    ctx.quadraticCurveTo(x,y,curPts[1].x,curPts[1].y);ctx.stroke();
    octx.clearRect(0,0,overlay.width,overlay.height);curStep=0;curPts=[];
  }
}
function drawCurvePrev(x,y){
  octx.clearRect(0,0,overlay.width,overlay.height);
  if(!curPts[0]||!curPts[1])return;
  octx.strokeStyle=fgCol;octx.lineWidth=bSize;octx.lineCap='round';
  octx.beginPath();octx.moveTo(curPts[0].x,curPts[0].y);
  octx.quadraticCurveTo(x,y,curPts[1].x,curPts[1].y);octx.stroke();
}

// ═══════════════════════════
// FLOOD FILL
// ═══════════════════════════
function floodFill(sx,sy,fillStr){
  const img=ctx.getImageData(0,0,canvas.width,canvas.height),d=img.data,w=canvas.width,h=canvas.height;
  const idx=(x,y)=>(y*w+x)*4, si=idx(sx,sy);
  const [sr,sg,sb,sa]=[d[si],d[si+1],d[si+2],d[si+3]];
  const tmp=document.createElement('canvas').getContext('2d');
  tmp.fillStyle=fillStr;tmp.fillRect(0,0,1,1);const fc=tmp.getImageData(0,0,1,1).data;
  const[fr,fg2,fb,fa]=fc;
  if(sr===fr&&sg===fg2&&sb===fb&&sa===fa)return;
  const match=i=>d[i]===sr&&d[i+1]===sg&&d[i+2]===sb&&d[i+3]===sa;
  const paint=i=>{d[i]=fr;d[i+1]=fg2;d[i+2]=fb;d[i+3]=fa;};
  const stack=[[sx,sy]],vis=new Uint8Array(w*h);vis[sy*w+sx]=1;
  while(stack.length){const[x,y]=stack.pop(),i=idx(x,y);if(!match(i))continue;paint(i);
    for(const[nx,ny]of[[x+1,y],[x-1,y],[x,y+1],[x,y-1]])if(nx>=0&&nx<w&&ny>=0&&ny<h&&!vis[ny*w+nx]){vis[ny*w+nx]=1;stack.push([nx,ny]);}}
  ctx.putImageData(img,0,0);
}

// ═══════════════════════════
// SELECTION
// ═══════════════════════════
function inSel(x,y){return sel&&x>=sel.x&&x<=sel.x+sel.w&&y>=sel.y&&y<=sel.y+sel.h;}
function renderSel(){
  if(!sel)return;
  const el=document.getElementById('sel-overlay');
  el.style.display='block';el.style.left=(sel.x*zoom)+'px';el.style.top=(sel.y*zoom)+'px';
  el.style.width=(sel.w*zoom)+'px';el.style.height=(sel.h*zoom)+'px';
}
function clearSel(){
  if(selImg&&sel)commitSelMove();
  sel=null;selImg=null;
  document.getElementById('sel-overlay').style.display='none';
  document.getElementById('status-sel').textContent='';
  octx.clearRect(0,0,overlay.width,overlay.height);
}
function commitSelMove(){
  octx.clearRect(0,0,overlay.width,overlay.height);
  if(selImg&&sel)ctx.putImageData(selImg,sel.x,sel.y);
}
function selectAll(){setTool('select-rect');sel={x:0,y:0,w:canvas.width,h:canvas.height};selImg=ctx.getImageData(0,0,canvas.width,canvas.height);renderSel();}
function deleteSelection(){if(!sel)return;saveState();ctx.fillStyle=bgCol;ctx.fillRect(sel.x,sel.y,sel.w,sel.h);clearSel();}
function doCopy(){if(!sel)selectAll();if(sel)clipboard=ctx.getImageData(sel.x,sel.y,sel.w,sel.h);}
function doCut(){doCopy();deleteSelection();}
function doPaste(){if(!clipboard)return;saveState();clearSel();sel={x:10,y:10,w:clipboard.width,h:clipboard.height};selImg=clipboard;ctx.putImageData(clipboard,10,10);setTool('select-rect');renderSel();}
function cropToSelection(){if(!sel)return;saveState();const img=ctx.getImageData(sel.x,sel.y,sel.w,sel.h);canvas.width=sel.w;canvas.height=sel.h;overlay.width=sel.w;overlay.height=sel.h;ctx.fillStyle='#fff';ctx.fillRect(0,0,sel.w,sel.h);ctx.putImageData(img,0,0);clearSel();setZoom(zoom);}

// ═══════════════════════════
// TEXT
// ═══════════════════════════
function startText(x,y){
  textEl.style.display='block';textEl.style.left=(x*zoom)+'px';textEl.style.top=(y*zoom)+'px';
  textEl.style.fontSize=(16*zoom)+'px';textEl.style.color=fgCol;
  textEl.style.width='200px';textEl._x=x;textEl._y=y;textEl.value='';
  setTimeout(()=>textEl.focus(),30);
}
function commitText(){
  if(textEl.style.display==='none')return;
  const t=textEl.value.trim();
  if(t){saveState();ctx.font=`16px Arial,sans-serif`;ctx.fillStyle=fgCol;ctx.textBaseline='top';
    t.split('\n').forEach((l,i)=>ctx.fillText(l,textEl._x,textEl._y+i*20));}
  textEl.style.display='none';textEl.value='';
}
textEl.addEventListener('keydown',e=>{if(e.key==='Escape'){textEl.style.display='none';textEl.value='';}});

// ═══════════════════════════
// IMAGE TRANSFORMS
// ═══════════════════════════
function withT(fn){saveState();const t=document.createElement('canvas');t.width=canvas.width;t.height=canvas.height;fn(t.getContext('2d'),t);ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(t,0,0);}
function withTR(fn){saveState();const t=document.createElement('canvas');[t.width,t.height]=[canvas.height,canvas.width];fn(t.getContext('2d'),t);canvas.width=t.width;canvas.height=t.height;overlay.width=t.width;overlay.height=t.height;ctx.drawImage(t,0,0);setZoom(zoom);}
function flipH(){withT((c,t)=>{c.translate(t.width,0);c.scale(-1,1);c.drawImage(canvas,0,0);});}
function flipV(){withT((c,t)=>{c.translate(0,t.height);c.scale(1,-1);c.drawImage(canvas,0,0);});}
function rotR(){withTR((c,t)=>{c.translate(t.width,0);c.rotate(Math.PI/2);c.drawImage(canvas,0,0);});}
function rotL(){withTR((c,t)=>{c.translate(0,t.height);c.rotate(-Math.PI/2);c.drawImage(canvas,0,0);});}
function rot180(){withT((c,t)=>{c.translate(t.width,t.height);c.rotate(Math.PI);c.drawImage(canvas,0,0);});}
function invertColors(){saveState();const id=ctx.getImageData(0,0,canvas.width,canvas.height);for(let i=0;i<id.data.length;i+=4){id.data[i]=255-id.data[i];id.data[i+1]=255-id.data[i+1];id.data[i+2]=255-id.data[i+2];}ctx.putImageData(id,0,0);}
function grayscale(){saveState();const id=ctx.getImageData(0,0,canvas.width,canvas.height);for(let i=0;i<id.data.length;i+=4){const g=.299*id.data[i]+.587*id.data[i+1]+.114*id.data[i+2];id.data[i]=id.data[i+1]=id.data[i+2]=g;}ctx.putImageData(id,0,0);}
function showResizeDlg(){document.getElementById('rz-h').value=canvas.width;document.getElementById('rz-v').value=canvas.height;document.getElementById('resize-dlg').classList.add('vis');}
function closeResizeDlg(){document.getElementById('resize-dlg').classList.remove('vis');}
function doResize(){
  const pct=document.querySelector('[name=ru][value=pct]').checked;
  let rh=parseFloat(document.getElementById('rz-h').value)||100, rv=parseFloat(document.getElementById('rz-v').value)||100;
  const sh=parseFloat(document.getElementById('sk-h').value)||0, sv=parseFloat(document.getElementById('sk-v').value)||0;
  const asp=document.getElementById('rz-asp').checked;
  let nw,nh;
  if(pct){nw=Math.round(canvas.width*rh/100);nh=Math.round(canvas.height*rv/100);}
  else{nw=Math.round(rh);nh=Math.round(rv);}
  if(asp){nh=Math.round(nw/canvas.width*canvas.height);}
  saveState();const t=document.createElement('canvas');t.width=nw;t.height=nh;
  const tc=t.getContext('2d');tc.setTransform(1,Math.tan(sv*Math.PI/180),Math.tan(sh*Math.PI/180),1,0,0);
  tc.drawImage(canvas,0,0,nw,nh);canvas.width=nw;canvas.height=nh;overlay.width=nw;overlay.height=nh;
  ctx.fillStyle='#fff';ctx.fillRect(0,0,nw,nh);ctx.drawImage(t,0,0);closeResizeDlg();setZoom(zoom);
}

// ═══════════════════════════
// ZOOM
// ═══════════════════════════
function setZoom(z){
  zoom=Math.min(8,Math.max(.1,z));
  const pct=Math.round(zoom*100);
  canvas.style.width=(canvas.width*zoom)+'px'; canvas.style.height=(canvas.height*zoom)+'px';
  overlay.style.width=canvas.style.width; overlay.style.height=canvas.style.height;
  document.getElementById('zoom-label').textContent=pct+'%';
  document.getElementById('zoom-slider').value=pct;
  if(sel)renderSel();
}
function zoomIn(){setZoom(zoom*1.25);}
function zoomOut(){setZoom(zoom/1.25);}
function toggleGrid(){
  showGrid=!showGrid;
  canvas.style.backgroundImage=showGrid?`url("data:image/svg+xml,%3Csvg width='10' height='10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M 10 0 L 0 0 0 10' fill='none' stroke='%23bbb' stroke-width='0.5'/%3E%3C/svg%3E")`:'none';
}

// ═══════════════════════════
// FILE
// ═══════════════════════════
function newFile(){if(modified&&!confirm('Discard changes?'))return;saveState();ctx.fillStyle='#fff';ctx.fillRect(0,0,canvas.width,canvas.height);modified=false;artName='Untitled';updateTitle(false);setCookie('paintName',artName,365);}
function openFile(){const i=document.createElement('input');i.type='file';i.accept='image/*';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const img=new Image();img.onload=()=>{saveState();canvas.width=img.width;canvas.height=img.height;overlay.width=img.width;overlay.height=img.height;ctx.drawImage(img,0,0);setZoom(zoom);artName=f.name.replace(/\.[^.]+$/,'');modified=false;updateTitle(false);setCookie('paintName',artName,365);};img.src=ev.target.result;};r.readAsDataURL(f);};i.click();}
function saveFile(){const a=document.createElement('a');a.download=artName+'.png';a.href=canvas.toDataURL('image/png');a.click();modified=false;updateTitle(false);}
function saveAs(){const fmt=prompt('Format: png, jpeg, webp','png')||'png';const a=document.createElement('a');a.download=artName+'.'+fmt;a.href=canvas.toDataURL('image/'+fmt);a.click();}
function printCanvas(){window.print();}

// ═══════════════════════════
// MENU
// ═══════════════════════════
function toggleMenu(id){
  const el=document.getElementById(id), was=el.classList.contains('open');
  document.querySelectorAll('.menu-trigger').forEach(m=>m.classList.remove('open'));
  if(!was)el.classList.add('open');
}
document.addEventListener('click',e=>{if(!e.target.closest('.menu-trigger'))document.querySelectorAll('.menu-trigger').forEach(m=>m.classList.remove('open'));});
document.addEventListener('touchstart',e=>{if(!e.target.closest('.menu-trigger')&&!e.target.closest('.dropdown-menu'))document.querySelectorAll('.menu-trigger').forEach(m=>m.classList.remove('open'));},{passive:true});

// ═══════════════════════════
// COLOR DIALOG
// ═══════════════════════════
function openColorDlg(target){
  dlgTarget=target;
  const hex=(target==='fg'?fgCol:bgCol).replace('#','');
  const r=parseInt(hex.slice(0,2),16)||0,g=parseInt(hex.slice(2,4),16)||0,b=parseInt(hex.slice(4,6),16)||0;
  const h=rgbToHsv(r,g,b); dlgH=h.h;dlgS=h.s;dlgV=h.v;
  document.getElementById('hue-slider').value=dlgH;
  updateDlgUI(); document.getElementById('color-dlg').classList.add('vis');
}
function closeColorDlg(){document.getElementById('color-dlg').classList.remove('vis');}
function applyColorDlg(){const hex='#'+document.getElementById('hex-input').value.padStart(6,'0');if(dlgTarget==='fg')fgCol=hex;else bgCol=hex;updateColors();closeColorDlg();}

function updateDlgUI(){
  const rgb=hsvToRgb(dlgH,dlgS,dlgV);
  ['h','s','v'].forEach((k,i)=>document.getElementById('ci-'+k).value=Math.round([dlgH,dlgS,dlgV][i]));
  document.getElementById('ci-r').value=rgb.r;document.getElementById('ci-g').value=rgb.g;document.getElementById('ci-b').value=rgb.b;
  document.getElementById('hex-input').value=[rgb.r,rgb.g,rgb.b].map(v=>v.toString(16).padStart(2,'0')).join('');
  drawSpec();
}
function drawSpec(){
  const sc=document.getElementById('color-spectrum'),sc2=sc.getContext('2d');
  const W=sc.width,H=sc.height;
  const imgd=sc2.createImageData(W,H);
  for(let sx=0;sx<W;sx++)for(let sy=0;sy<H;sy++){const s=sx/W*100,v=(1-sy/H)*100,rgb=hsvToRgb(dlgH,s,v),i=(sy*W+sx)*4;imgd.data[i]=rgb.r;imgd.data[i+1]=rgb.g;imgd.data[i+2]=rgb.b;imgd.data[i+3]=255;}
  sc2.putImageData(imgd,0,0);
  const cx=dlgS/100*W,cy=(1-dlgV/100)*H;
  sc2.strokeStyle=dlgV>50?'#000':'#fff';sc2.lineWidth=1.5;sc2.beginPath();sc2.arc(cx,cy,6,0,Math.PI*2);sc2.stroke();
  const pv=document.getElementById('color-preview'),pc=pv.getContext('2d');
  const rgb=hsvToRgb(dlgH,dlgS,dlgV);pc.fillStyle=`rgb(${rgb.r},${rgb.g},${rgb.b})`;pc.fillRect(0,0,pv.width,pv.height);
}

const specC=document.getElementById('color-spectrum');
function updSpec(e){
  e.preventDefault();
  const r=specC.getBoundingClientRect(),src=e.touches?e.touches[0]:e;
  dlgS=Math.max(0,Math.min(100,(src.clientX-r.left)/r.width*100));
  dlgV=Math.max(0,Math.min(100,(1-(src.clientY-r.top)/r.height)*100));
  updateDlgUI();
}
specC.addEventListener('mousedown',updSpec);
specC.addEventListener('mousemove',e=>{if(e.buttons)updSpec(e);});
specC.addEventListener('touchstart',updSpec,{passive:false});
specC.addEventListener('touchmove',updSpec,{passive:false});
document.getElementById('hue-slider').addEventListener('input',e=>{dlgH=+e.target.value;updateDlgUI();});
['ci-h','ci-s','ci-v'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{dlgH=+document.getElementById('ci-h').value;dlgS=+document.getElementById('ci-s').value;dlgV=+document.getElementById('ci-v').value;updateDlgUI();}));
['ci-r','ci-g','ci-b'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{const r=+document.getElementById('ci-r').value,g=+document.getElementById('ci-g').value,b=+document.getElementById('ci-b').value;const h=rgbToHsv(r,g,b);dlgH=h.h;dlgS=h.s;dlgV=h.v;updateDlgUI();}));
document.getElementById('hex-input').addEventListener('change',e=>{const h=e.target.value.replace('#','');if(/^[0-9a-fA-F]{6}$/.test(h)){const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16);const hv=rgbToHsv(r,g,b);dlgH=hv.h;dlgS=hv.s;dlgV=hv.v;updateDlgUI();}});
document.getElementById('color-dlg').addEventListener('click',e=>{if(e.target===e.currentTarget)closeColorDlg();});
document.getElementById('resize-dlg').addEventListener('click',e=>{if(e.target===e.currentTarget)closeResizeDlg();});

// ═══════════════════════════
// COLOR MATH
// ═══════════════════════════
function hsvToRgb(h,s,v){h/=360;s/=100;v/=100;const i=Math.floor(h*6),f=h*6-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s);let r,g,b;switch(i%6){case 0:r=v,g=t,b=p;break;case 1:r=q,g=v,b=p;break;case 2:r=p,g=v,b=t;break;case 3:r=p,g=q,b=v;break;case 4:r=t,g=p,b=v;break;case 5:r=v,g=p,b=q;break;}return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)};}
function rgbToHsv(r,g,b){r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b),d=mx-mn;let h=0,s=mx?d/mx:0,v=mx;if(d){switch(mx){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return{h:h*360,s:s*100,v:v*100};}

// ═══════════════════════════
// RESIZE HANDLES
// ═══════════════════════════
let rzActive=null,rzW,rzH,rzX,rzY,rzSnap;
['rh-se','rh-e','rh-s'].forEach(id=>{
  const el=document.getElementById(id);
  const start=e=>{e.preventDefault();e.stopPropagation();rzActive=id;rzW=canvas.width;rzH=canvas.height;const src=e.touches?e.touches[0]:e;rzX=src.clientX;rzY=src.clientY;rzSnap=ctx.getImageData(0,0,rzW,rzH);};
  el.addEventListener('mousedown',start);
  el.addEventListener('touchstart',start,{passive:false});
});
function rzMove(e){
  if(!rzActive)return;
  const src=e.touches?e.touches[0]:e;
  const dx=(src.clientX-rzX)/zoom, dy=(src.clientY-rzY)/zoom;
  let nw=rzW,nh=rzH;
  if(rzActive==='rh-se'||rzActive==='rh-e')nw=Math.max(10,Math.round(rzW+dx));
  if(rzActive==='rh-se'||rzActive==='rh-s')nh=Math.max(10,Math.round(rzH+dy));
  canvas.width=nw;canvas.height=nh;overlay.width=nw;overlay.height=nh;
  ctx.fillStyle='#fff';ctx.fillRect(0,0,nw,nh);if(rzSnap)ctx.putImageData(rzSnap,0,0);setZoom(zoom);
}
document.addEventListener('mousemove',rzMove);
document.addEventListener('touchmove',rzMove,{passive:false});
document.addEventListener('mouseup',()=>{rzActive=null;});
document.addEventListener('touchend',()=>{rzActive=null;});

// ═══════════════════════════
// KEYBOARD
// ═══════════════════════════
document.addEventListener('keydown',e=>{
  const ctrl=e.ctrlKey||e.metaKey;
  if(ctrl){switch(e.key){case 'z':e.preventDefault();doUndo();return;case 'y':e.preventDefault();doRedo();return;case 's':e.preventDefault();saveFile();return;case 'n':e.preventDefault();newFile();return;case 'o':e.preventDefault();openFile();return;case 'a':e.preventDefault();selectAll();return;case 'x':e.preventDefault();doCut();return;case 'c':e.preventDefault();doCopy();return;case 'v':e.preventDefault();doPaste();return;case 'i':e.preventDefault();invertColors();return;case '=':case '+':e.preventDefault();zoomIn();return;case '-':e.preventDefault();zoomOut();return;case '0':e.preventDefault();setZoom(1);return;}}
  if(e.key==='Delete')deleteSelection();
  if(e.key==='Escape'){clearSel();commitText();curStep=0;curPts=[];octx.clearRect(0,0,overlay.width,overlay.height);}
  if(document.activeElement===textEl)return;
  if(!ctrl){switch(e.key){case 'p':setTool('pencil');break;case 'b':setTool('brush');break;case 'e':setTool('eraser');break;case 'f':setTool('fill');break;case 't':setTool('text');break;case 'k':setTool('eyedropper');break;case 's':setTool('select-rect');break;case 'g':toggleGrid();break;}}
});

// ═══════════════════════════
// TOOLTIPS
// ═══════════════════════════
const tt=document.getElementById('tooltip');
document.querySelectorAll('[data-tip]').forEach(el=>{
  el.addEventListener('mouseenter',e=>{tt.textContent=el.dataset.tip;tt.style.display='block';tt.style.left=(e.clientX+14)+'px';tt.style.top=(e.clientY+18)+'px';});
  el.addEventListener('mousemove',e=>{tt.style.left=(e.clientX+14)+'px';tt.style.top=(e.clientY+18)+'px';});
  el.addEventListener('mouseleave',()=>{tt.style.display='none';});
});

// cc-bg right-click opens color dialog
document.getElementById('cc-bg').addEventListener('click',()=>openColorDlg('bg'));
document.getElementById('cc-bg').addEventListener('contextmenu',e=>{e.preventDefault();openColorDlg('bg');});

// ═══════════════════════════
// RENAME
// ═══════════════════════════
let artName = 'Untitled';
function startRename() {
  const inp = document.getElementById('win-title-input');
  const lbl = document.getElementById('win-title');
  inp.value = artName;
  lbl.style.display = 'none';
  inp.style.display = 'inline-block';
  inp.focus();
  inp.select();
}
function commitRename() {
  const inp = document.getElementById('win-title-input');
  const lbl = document.getElementById('win-title');
  const val = inp.value.trim() || 'Untitled';
  artName = val;
  updateTitle();
  inp.style.display = 'none';
  lbl.style.display = 'inline';
  setCookie('paintName', artName, 365);
}
function titleKeydown(e) {
  if (e.key === 'Enter') { e.preventDefault(); commitRename(); }
  if (e.key === 'Escape') {
    const inp = document.getElementById('win-title-input');
    const lbl = document.getElementById('win-title');
    inp.style.display = 'none';
    lbl.style.display = 'inline';
  }
}
function updateTitle(isDirty) {
  const prefix = (isDirty !== undefined ? isDirty : modified) ? '* ' : '';
  document.getElementById('win-title').textContent = `${prefix}${artName} — Draw`;
  document.title = `${artName} — Draw`;
}

// ═══════════════════════════
// DARK THEME
// ═══════════════════════════
let darkMode = false;
function toggleDark() {
  darkMode = !darkMode;
  applyTheme();
  setCookie('paintDark', darkMode ? '1' : '0', 365);
}
function applyTheme() {
  document.body.classList.toggle('dark', darkMode);
  const item = document.getElementById('dark-item');
  if (item) item.textContent = (darkMode ? '✓ ' : '') + 'Dark theme';
  // Keep kbd span
  const kbd = item?.querySelector?.('.kbd');
  if (!item) return;
  item.innerHTML = (darkMode ? '✓ ' : '') + 'Dark theme<span class="kbd">D</span>';
}

// ═══════════════════════════
// COOKIES
// ═══════════════════════════
function setCookie(name, value, days) {
  const exp = new Date(Date.now() + days * 864e5).toUTCString();
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${exp};path=/;SameSite=Lax`;
}
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(?:^|;)\\s*' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[1]) : null;
}

// ═══════════════════════════
// RESTORE PREFERENCES
// ═══════════════════════════
(function restorePrefs() {
  const savedName = getCookie('paintName');
  if (savedName) { artName = savedName; updateTitle(false); }
  const savedDark = getCookie('paintDark');
  if (savedDark === '1') { darkMode = true; applyTheme(); }
})();

// Patch keyboard shortcut for D = dark theme
document.addEventListener('keydown', e => {
  if (document.activeElement === textEl) return;
  if (!e.ctrlKey && !e.metaKey && e.key === 'd') toggleDark();
}, true); // capture phase so it runs before the existing keydown listener

// ═══════════════════════════
// END
// ═══════════════════════════

</script>
</body>
</html>
