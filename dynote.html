<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DyNote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" id="google-fonts-link">
    
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-main);
            overflow: hidden;
            user-select: none;
            -webkit-touch-callout: none;
            overscroll-behavior: none;
        }

        /* Custom text selection color */
        ::selection {
            background-color: #facc15;
            color: #000;
        }
        ::-moz-selection {
            background-color: #facc15;
            color: #000;
        }

        /* Sidebar transitions for mobile */
        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (max-width: 768px) {
    #sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 50;
        transform: translateX(-100%);
    }
    #sidebar.mobile-open {
        transform: translateX(0);
    }
    /* The overlay visibility will now be handled by the 'hidden' class in your HTML/JS */
}
        
        @media (min-width: 769px) {
            #mobile-sidebar-overlay {
                display: none !important;
            }
        }

        #editor-view { 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s ease; 
        }
        .editor-open { transform: translateX(0) !important; }

        /* Rich Text Editor Styling */
        #note-body {
            outline: none;
            min-height: 200px;
            color: var(--text-main);
            line-height: 1.6;
            z-index: 1;
            position: relative;
        }
        #note-body b, #note-body strong { font-weight: bold; color: var(--text-main); }
        #note-body i, #note-body em { font-style: italic; }
        #note-body u { text-decoration: underline; }
        #note-body strike { text-decoration: line-through; }
        #note-body mark { background-color: #facc15; color: #000; border-radius: 2px; padding: 0 2px; }
        
        #note-body h1 { font-size: 2em; font-weight: bold; margin: 0.67em 0; color: var(--text-main); }
        #note-body h2 { font-size: 1.5em; font-weight: bold; margin: 0.75em 0; color: var(--text-main); }
        #note-body h3 { font-size: 1.17em; font-weight: bold; margin: 0.83em 0; color: var(--text-main); }
        
        #note-body ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
        #note-body ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
        
        /* Checkbox styling */
        .todo-item { display: flex; align-items: flex-start; gap: 8px; margin: 4px 0; }
        .todo-checkbox { 
            appearance: none; width: 18px; height: 18px; border: 2px solid var(--border); 
            border-radius: 4px; cursor: pointer; position: relative; top: 3px; flex-shrink: 0;
        }
        .todo-checkbox:checked { background-color: #eab308; border-color: #eab308; }
        .todo-checkbox:checked::after {
            content: 'âœ“'; color: black; font-size: 12px; position: absolute; 
            top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;
        }

        /* Resizable Image Styling */
        .resizable-img-container {
            position: relative; display: inline-block; margin: 10px 0; max-width: 100%;
        }
        .resizable-img-container img { display: block; border-radius: 8px; max-width: 100%; }
        .img-subtitle {
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-dim);
            margin-top: 4px;
            font-style: italic;
        }
        .resizer {
            width: 12px; height: 12px; background: #eab308; position: absolute;
            right: -6px; bottom: -6px; cursor: nwse-resize; border-radius: 50%;
            display: none; border: 2px solid var(--bg-primary);
        }
        .resizable-img-container:hover .resizer, .resizable-img-container.selected .resizer { display: block; }

        #user-folders-list.collapsed { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* DRAWING TOOLS STYLES */
        .marker-scroll::-webkit-scrollbar { height: 4px; }
        .marker-scroll::-webkit-scrollbar-track { background: transparent; }
        .marker-scroll::-webkit-scrollbar-thumb { background-color: var(--border); border-radius: 20px; }

        .marker-item {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }
        
        .marker-item.active {
            transform: translateY(-20px) scale(1.15);
            z-index: 10;
            filter: drop-shadow(0 15px 12px rgb(0 0 0 / 0.5));
        }

        .marker-item:not(.active):hover { transform: translateY(-4px); }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #eab308; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px;
        }
        
        /* Canvas Layer */
        #drawing-layer {
            touch-action: none;
            position: absolute;
            top: 0; left: 0;
            z-index: 20;
            pointer-events: none;
        }
        .drawing-active #drawing-layer { pointer-events: auto; cursor: crosshair; }
        .drawing-active #note-body { user-select: none; pointer-events: none; }

        /* Drawing UI transitions */
        #drawing-ui-rack {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #drawing-ui-rack.visible { transform: translateY(0); }

        /* Color picker grid */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #eab308;
            box-shadow: 0 0 0 2px var(--bg-secondary), 0 0 0 4px #eab308;
        }

        /* Inline folder rename */
        #current-folder-title.editing {
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 4px 8px;
            outline: none;
        }

        /* Draft badge */
        .draft-badge {
            background: #fbbf24;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Multi-select notes */
        .note-card {
            position: relative;
            user-select: none;
        }
        .note-card.selected {
            border-color: #eab308 !important;
            box-shadow: 0 0 0 2px #eab308;
        }
        .note-card .select-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .note-card.selected .select-indicator {
            opacity: 1;
            background: #eab308;
            border-color: #eab308;
        }
        .note-card.selecting .select-indicator {
            opacity: 1;
        }

        /* Selection context menu scrollable */
        #selection-context-menu {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden font-sans" oncontextmenu="return false;">

    <!-- Mobile Sidebar Overlay -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden" onclick="toggleMobileSidebar()"></div>

    <!-- Global Overlay for Modals -->
    <div id="global-overlay" class="fixed inset-0 bg-black/60 z-[60] hidden transition-opacity opacity-0" onclick="closeAllModals()"></div>

    <!-- CONTEXT MENU (Folder) -->
    <div id="context-menu" class="fixed z-[70] hidden rounded-2xl shadow-2xl p-2 w-48" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <button onclick="handleRenameClick()" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
            Rename
        </button>
        <button onclick="handleDeleteFolderClick()" class="w-full flex items-center gap-3 px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 rounded-xl">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="10" x2="10" y2="16"/><line x1="14" y1="10" x2="14" y2="16"/></svg>
            Delete
        </button>
    </div>

    <!-- IMAGE CONTEXT MENU -->
    <div id="image-context-menu" class="fixed z-[70] hidden rounded-2xl shadow-2xl p-2 w-48" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <button onclick="resizeImage()" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
            Resize
        </button>
        <button onclick="addSubtitle()" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 15L10 7"/><path d="M14 15L10 7"/><line x1="18" y1="15" x2="18" y2="7"/><line x1="22" y1="7" x2="22" y2="15"/><rect x="2" y="15" width="20" height="4" rx="1" ry="1"/></svg>
            Subtitle
        </button>
        <button onclick="deleteImage()" class="w-full flex items-center gap-3 px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 rounded-xl">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="10" x2="10" y2="16"/><line x1="14" y1="10" x2="14" y2="16"/></svg>
            Delete
        </button>
    </div>

    <!-- SELECTION CONTEXT MENU (Scrollable) -->
    <div id="selection-context-menu" class="fixed z-[70] hidden rounded-2xl shadow-2xl p-2 w-48" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <button onclick="execTextCommand('cut')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="18" r="2"/><circle cx="6" cy="6" r="2"/><line x1="8.12" y1="8.12" x2="15.88" y2="15.88"/><line x1="15.88" y1="8.12" x2="8.12" y2="15.88"/></svg>
            Cut
        </button>
        <button onclick="execTextCommand('copy')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"/><rect x="2" y="2" width="14" height="14" rx="2" ry="2"/></svg>
            Copy
        </button>
        <button onclick="execTextCommand('paste')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
            Paste
        </button>
        <button onclick="execTextCommand('selectAll')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2" ry="2"/><line x1="8" y1="2" x2="8" y2="22"/><line x1="16" y1="2" x2="16" y2="22"/><line x1="2" y1="8" x2="22" y2="8"/><line x1="2" y1="16" x2="22" y2="16"/></svg>
            Select All
        </button>
        <div class="w-full h-px my-2" style="background: var(--border);"></div>
        <button id="highlight-toggle-btn" onclick="toggleHighlight()" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-highlighter" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M11.096.644a2 2 0 0 1 2.791.036l1.433 1.433a2 2 0 0 1 .035 2.791l-.413.435-8.07 8.995a.5.5 0 0 1-.372.166h-3a.5.5 0 0 1-.234-.058l-.412.412A.5.5 0 0 1 2.5 15h-2a.5.5 0 0 1-.354-.854l1.412-1.412A.5.5 0 0 1 1.5 12.5v-3a.5.5 0 0 1 .166-.372l8.995-8.07zm-.115 1.47L2.727 9.52l3.753 3.753 7.406-8.254zm3.585 2.17.064-.068a1 1 0 0 0-.017-1.396L13.18 1.387a1 1 0 0 0-1.396-.018l-.068.065zM5.293 13.5 2.5 10.707v1.586L3.707 13.5z"/>
    </svg>
    <span id="highlight-toggle-text">Highlight</span>
</button>
        <button onclick="setAlignment('left')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
            Align Left
        </button>
        <button onclick="setAlignment('center')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            Align Center
        </button>
        <button onclick="setAlignment('right')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>
            Align Right
        </button>
        <button onclick="setAlignment('justify')" class="w-full flex items-center gap-3 px-4 py-3 text-sm hover:bg-opacity-80 rounded-xl" style="color: var(--text-main); background: var(--bg-primary);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            Justify
        </button>
    </div>

    <!-- MULTI-SELECT ACTION POPUP -->
    <div id="multi-select-popup" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[70] hidden rounded-2xl shadow-2xl p-4 flex items-center gap-4" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <span id="selected-count" class="text-sm font-medium" style="color: var(--text-main);">0 selected</span>
        <div class="w-px h-6" style="background: var(--border);"></div>
        <button onclick="moveSelectedNotes()" class="flex items-center gap-2 px-4 py-2 rounded-xl transition-all" style="background: var(--bg-primary); color: var(--text-main);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 7h18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4l2 2h4a2 2 0 0 1 2 2v1"/></svg>
            Move
        </button>
        <button onclick="deleteSelectedNotes()" class="flex items-center gap-2 px-4 py-2 rounded-xl text-red-400 hover:bg-red-500/10 transition-all">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
    </svg>
    Delete
</button>
        <button onclick="clearSelection()" class="p-2 rounded-xl transition-all" style="background: var(--bg-primary); color: var(--text-dim);">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
    </div>

    <!-- FOLDER SELECTION MODAL -->
    <div id="folder-select-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[80] hidden rounded-3xl shadow-2xl p-6 w-[90%] max-w-sm" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <h3 class="text-xl font-bold mb-4" style="color: var(--text-main);">Move to Folder</h3>
        <div id="folder-list" class="space-y-2 mb-6 max-h-64 overflow-y-auto">
            <!-- Folders will be populated here -->
        </div>
        <button onclick="closeAllModals()" class="w-full px-5 py-2.5 rounded-xl" style="background: var(--bg-primary); color: var(--text-dim);">Cancel</button>
    </div>

    <!-- DIALOG MODAL -->
    <div id="dialog-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[80] hidden rounded-3xl shadow-2xl p-6 w-[90%] max-w-sm" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <h3 id="dialog-title" class="text-xl font-bold mb-4" style="color: var(--text-main);">Title</h3>
        <div id="dialog-input-wrapper" class="mb-6">
            <input type="text" id="dialog-input" class="w-full rounded-xl py-3 px-4 focus:border-yellow-500 transition-colors" style="background-color: var(--bg-primary); border: 1px solid var(--border); color: var(--text-main);">
        </div>
        <p id="dialog-message" class="mb-6 hidden" style="color: var(--text-dim);"></p>
        <div class="flex gap-3 justify-end">
            <button onclick="closeAllModals()" class="px-5 py-2.5 rounded-xl hover:bg-opacity-80" style="color: var(--text-dim); background: var(--bg-primary);">Cancel</button>
            <button id="dialog-confirm-btn" class="px-5 py-2.5 rounded-xl bg-yellow-500 text-black">Confirm</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[80] hidden rounded-3xl shadow-2xl p-6 w-[90%] max-w-md" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold" style="color: var(--text-main);">Settings</h3>
            <button onclick="closeAllModals()" class="p-2 rounded-xl hover:bg-opacity-80" style="background: var(--bg-primary);">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>

        <div class="space-y-6">
            <!-- Theme -->
            <div>
                <label class="block text-sm font-medium mb-3" style="color: var(--text-main);">Theme</label>
                <div class="flex gap-3">
                    <button id="theme-dark-btn" onclick="applyTheme('dark')" class="flex-1 py-3 px-4 rounded-xl transition-all" style="background: var(--bg-primary); border: 2px solid var(--border);">
                        <svg class="w-6 h-6 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                        <div class="text-sm font-medium">Dark</div>
                    </button>
                    <button id="theme-light-btn" onclick="applyTheme('light')" class="flex-1 py-3 px-4 rounded-xl transition-all" style="background: var(--bg-primary); border: 2px solid var(--border);">
                        <svg class="w-6 h-6 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                        <div class="text-sm font-medium">Light</div>
                    </button>
                </div>
            </div>

            <!-- Font Size -->
            <div>
                <label class="block text-sm font-medium mb-3" style="color: var(--text-main);">Font Size: <span id="font-size-value">16px</span></label>
                <input type="range" id="font-size-slider" min="12" max="24" value="16" step="1" class="w-full">
            </div>

            <!-- Custom Font -->
            <div>
                <label class="block text-sm font-medium mb-3" style="color: var(--text-main);">Font Family</label>
                <select id="font-family-select" class="w-full py-3 px-4 rounded-xl transition-colors" style="background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-main);">
                    <option value="Inter">Inter (Default)</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Open Sans">Open Sans</option>
                    <option value="Lato">Lato</option>
                    <option value="Montserrat">Montserrat</option>
                    <option value="Poppins">Poppins</option>
                </select>
            </div>
        </div>
    </div>

    <!-- SIZE POPOVER (For Drawing) -->
    <div id="size-popover" class="fixed z-[70] hidden rounded-2xl shadow-2xl p-4 w-64" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium" style="color: var(--text-main);">Brush Size</span>
            <span id="size-value" class="text-sm font-bold text-yellow-500">5px</span>
        </div>
        <input type="range" id="size-slider" min="1" max="50" value="5" class="w-full">
    </div>

    <!-- COLOR PICKER POPOVER -->
    <div id="color-picker-popover" class="fixed z-[70] hidden rounded-2xl shadow-2xl p-4 w-64" style="background-color: var(--bg-secondary); border: 1px solid var(--border);">
        <div class="mb-3">
            <span class="text-sm font-medium" style="color: var(--text-main);">Select Color</span>
        </div>
        <div class="color-grid mb-3" id="color-grid">
            <!-- Colors will be populated by JS -->
        </div>
        <div class="mt-3 pt-3" style="border-top: 1px solid var(--border);">
            <label class="text-sm font-medium mb-2 block" style="color: var(--text-main);">Custom Color</label>
            <div class="flex gap-2">
                <input type="color" id="custom-color-picker" class="w-12 h-12 rounded-lg cursor-pointer" value="#ffffff">
                <button onclick="addCustomColor()" class="flex-1 py-2 px-4 rounded-lg bg-yellow-500 text-black font-medium hover:bg-yellow-600 transition">
                    Add Color
                </button>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-80 h-full flex flex-col border-r" style="background-color: var(--bg-primary); border-color: var(--border);">
        <div class="p-6 flex items-center justify-between border-b" style="border-color: var(--border);">
            <h1 class="text-2xl font-bold tracking-tight" style="color: var(--text-main);">DyNote</h1>
            <div class="flex gap-2">
                <button onclick="openSettings()" class="p-2 rounded-xl hover:bg-opacity-80 transition" style="background: var(--bg-secondary);">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
    </svg>
</button>
                <button onclick="toggleMobileSidebar()" class="p-2 rounded-xl hover:bg-opacity-80 transition md:hidden" style="background: var(--bg-secondary);">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
        </div>

        <div class="px-4 py-3">
            <div class="relative">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="search-input" placeholder="Search notes..." 
                       class="w-full pl-11 pr-4 py-3 rounded-2xl transition-all" 
                       style="background-color: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-main);"
                       oninput="filterNotes(this.value)">
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto px-4 py-2 no-scrollbar">
            <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-2xl cursor-pointer mb-1 transition-all" 
                 style="color: var(--text-main);"
                 onclick="setActiveFolder('folder-notes')">
                <svg class="w-6 h-6 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>
                <span class="flex-1 font-medium">All Notes</span>
                <span class="text-xs px-2 py-1 rounded-full" style="background: var(--bg-secondary); color: var(--text-dim);" id="all-notes-count">0</span>
            </div>

            <div class="nav-item flex items-center gap-3 px-4 py-3 rounded-2xl cursor-pointer mb-1 transition-all" 
     style="color: var(--text-main);"
     onclick="setActiveFolder('folder-trash')">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
    </svg>
    <span class="flex-1 font-medium">Trash</span>
    <span class="text-xs px-2 py-1 rounded-full" style="background: var(--bg-secondary); color: var(--text-dim);" id="trash-count">0</span>
</div>

            <div class="flex items-center justify-between px-4 py-3 mt-4 mb-2">
                <span class="text-xs font-bold uppercase tracking-wider" style="color: var(--text-dim);">Folders</span>
                <button onclick="toggleFoldersList()" class="p-1 rounded hover:bg-opacity-80" style="color: var(--text-dim); background: var(--bg-secondary);">
                    <svg id="folders-chevron" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
            </div>

            <div id="user-folders-list"></div>

            <button onclick="openFolderCreateDialog()" 
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl mt-2 transition-all" 
                    style="color: var(--text-dim); background: var(--bg-secondary);">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                <span class="font-medium">New Folder</span>
            </button>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden" style="background-color: var(--bg-primary);">
        <!-- NOTE LIST VIEW -->
        <section id="note-list-view" class="flex-1 flex flex-col overflow-hidden">
            <header class="px-4 md:px-8 py-6 flex items-center justify-between border-b" style="border-color: var(--border);">
                <div class="flex items-center gap-3">
                    <button onclick="toggleMobileSidebar()" class="p-2 rounded-xl hover:bg-opacity-80 transition md:hidden" style="background: var(--bg-secondary);">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <h2 id="current-folder-title" 
                        class="text-2xl md:text-3xl font-bold tracking-tight cursor-text" 
                        style="color: var(--text-main);"
                        contenteditable="false"
                        onkeydown="handleFolderTitleKeydown(event)"
                        onblur="saveFolderTitleInline()">All Notes</h2>
                </div>
                <button onclick="createNewNote()" 
                        class="flex items-center gap-2 px-4 md:px-5 py-2.5 md:py-3 rounded-2xl bg-yellow-500 text-black font-semibold transition-all hover:bg-yellow-600 active:scale-95">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span class="hidden md:inline">New Note</span>
                </button>
            </header>

            <div id="notes-container" class="flex-1 overflow-y-auto px-4 md:px-8 py-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 content-start">
                <!-- Notes rendered here -->
            </div>
        </section>

        <!-- EDITOR VIEW -->
        <div id="editor-view" class="absolute inset-0 transform translate-x-full transition-transform flex flex-col" style="background-color: var(--bg-primary);">
            <div class="px-4 md:px-8 py-4 flex items-center gap-2 md:gap-4 border-b overflow-x-auto" style="border-color: var(--border);">
                <button onclick="closeEditor()" class="p-2 rounded-xl transition-all hover:bg-opacity-80 flex-shrink-0" style="background: var(--bg-secondary); color: var(--text-main);">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 5 5 12 12 19"/></svg>
                </button>

                <div id="main-toolbar" class="flex items-center gap-2 flex-nowrap">
                    <button class="tool-btn" onclick="toggleFormat('bold')" title="Bold">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg>
                    </button>
                    <button class="tool-btn" onclick="toggleFormat('italic')" title="Italic">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4h-8z"/>
    </svg>
</button>
                    <button class="tool-btn" onclick="toggleFormat('underline')" title="Underline">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V4"/><line x1="4" y1="20" x2="20" y2="20"/></svg>
                    </button>
                    <button class="tool-btn" onclick="toggleFormat('strikeThrough')" title="Strikethrough">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path d="M10 19h4v-3h-4v3zM5 4v3h5v3h4V7h5V4H5zM3 11v2h18v-2H3z"/>
    </svg>
</button>
                    <div class="w-px h-6 mx-1 flex-shrink-0" style="background: var(--border);"></div>
                    <button class="tool-btn" onclick="applyHeading('h1')" title="Heading 1"><span style="font-weight: bold; font-size: 1.1em;">H1</span></button>
                    <button class="tool-btn" onclick="applyHeading('h2')" title="Heading 2"><span style="font-weight: bold; font-size: 1em;">H2</span></button>
                    <button class="tool-btn" onclick="applyHeading('h3')" title="Heading 3"><span style="font-weight: bold; font-size: 0.9em;">H3</span></button>
                    <div class="w-px h-6 mx-1 flex-shrink-0" style="background: var(--border);"></div>
                    <button class="tool-btn" onclick="setAlignment('left')" title="Align Left">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
                    </button>
                    <button class="tool-btn" onclick="setAlignment('center')" title="Align Center">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <button class="tool-btn" onclick="setAlignment('right')" title="Align Right">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="6" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <button class="tool-btn" onclick="setAlignment('justify')" title="Justify">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <div class="w-px h-6 mx-1 flex-shrink-0" style="background: var(--border);"></div>
                    <button class="tool-btn" onclick="toggleFormat('insertUnorderedList')" title="Bullet List">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1"/><circle cx="4" cy="12" r="1"/><circle cx="4" cy="18" r="1"/></svg>
                    </button>
                    <button class="tool-btn" onclick="toggleFormat('insertOrderedList')" title="Numbered List">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4v-2c0-1 1-2 2-2"/></svg>
                    </button>
                    <button class="tool-btn" onclick="insertCheckbox()" title="Checkbox">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-square" viewBox="0 0 16 16">
        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
        <path d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/>
    </svg>
</button>
                    <div class="w-px h-6 mx-1 flex-shrink-0" style="background: var(--border);"></div>
                    <button class="tool-btn" onclick="toggleHighlight()" title="Highlight">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-highlighter" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M11.096.644a2 2 0 0 1 2.791.036l1.433 1.433a2 2 0 0 1 .035 2.791l-.413.435-8.07 8.995a.5.5 0 0 1-.372.166h-3a.5.5 0 0 1-.234-.058l-.412.412A.5.5 0 0 1 2.5 15h-2a.5.5 0 0 1-.354-.854l1.412-1.412A.5.5 0 0 1 1.5 12.5v-3a.5.5 0 0 1 .166-.372l8.995-8.07zm-.115 1.47L2.727 9.52l3.753 3.753 7.406-8.254zm3.585 2.17.064-.068a1 1 0 0 0-.017-1.396L13.18 1.387a1 1 0 0 0-1.396-.018l-.068.065zM5.293 13.5 2.5 10.707v1.586L3.707 13.5z"/>
    </svg>
</button>
                    <button class="tool-btn" onclick="document.getElementById('image-upload').click()" title="Image">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    </button>
                    <input type="file" id="image-upload" accept="image/*" style="display:none" onchange="insertImage(event)">
                    <div class="w-px h-6 mx-1 flex-shrink-0" style="background: var(--border);"></div>
                    <button class="tool-btn" onclick="toggleDrawingMode()" title="Draw" id="draw-toggle-btn">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                    </button>
                </div>

                <div class="ml-auto flex gap-2 flex-shrink-0">
                    <button onclick="exportNote()" class="p-2 rounded-xl transition-all hover:bg-opacity-80" style="background: var(--bg-secondary); color: var(--text-main);" title="Export">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
    </svg>
</button>
                    <button onclick="deleteNote()" class="p-2 rounded-xl text-red-400 transition-all hover:bg-red-500/10" title="Delete">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
    </svg>
</button>
                </div>
            </div>

            <div id="editor-content" class="flex-1 overflow-y-auto px-4 md:px-8 py-6 relative" style="background-color: var(--bg-primary);">
                <input type="text" id="note-title" placeholder="Note Title" 
                       class="w-full text-3xl md:text-4xl font-bold mb-6 bg-transparent border-none outline-none" 
                       style="color: var(--text-main);"
                       oninput="saveCurrentNote()">
                
                <div id="canvas-wrapper" class="relative">
                    <div id="note-body" contenteditable="true" 
                         data-placeholder="Start typing..."
                         oninput="saveCurrentNote()"
                         style="color: var(--text-main);"></div>
                    <canvas id="drawing-layer"></canvas>
                </div>
            </div>

            <!-- DRAWING UI RACK -->
            <div id="drawing-ui-rack" class="fixed bottom-0 left-0 right-0 px-4 md:px-8 py-4 md:py-6 border-t z-30" style="background-color: var(--bg-primary); border-color: var(--border);">
                <div class="max-w-4xl mx-auto flex items-center gap-2 md:gap-4">
                    <button onclick="setDrawingTool('pen')" id="tool-pen" class="p-2 md:p-3 rounded-xl transition-all" style="background: var(--bg-secondary);">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                    </button>
                    <button onclick="setDrawingTool('eraser')" id="tool-eraser" class="p-2 md:p-3 rounded-xl transition-all" style="background: var(--bg-secondary);">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eraser" viewBox="0 0 16 16">
        <path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm2.121.707a1 1 0 0 0-1.414 0L4.16 7.547l5.293 5.293 4.633-4.633a1 1 0 0 0 0-1.414zM8.746 13.547 3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/>
    </svg>
</button>

                    <div class="flex-1 flex gap-2 overflow-x-auto marker-scroll pb-2" id="marker-container">
                        <!-- Markers populated by JS -->
                    </div>

                    <button onclick="toggleSizePopover(event)" class="p-2 md:p-3 rounded-xl transition-all" style="background: var(--bg-secondary);">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>
                    </button>

                    <button onclick="clearDrawing()" class="p-2 md:p-3 rounded-xl transition-all hover:bg-red-500/10 text-red-400">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
    </svg>
</button>

                    <button onclick="toggleDrawingMode()" class="px-3 md:px-4 py-2 md:py-3 rounded-xl bg-yellow-500 text-black font-semibold">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- EXPORT CONTAINER -->
    <div id="export-container" class="hidden"></div>

    <script>
        let db; 
        const state = { 
            notes: [], 
            folders: [], 
            activeNoteId: null, 
            activeFolderId: 'folder-notes', 
            contextTargetFolder: null, 
            searchQuery: '', 
            isDrawing: false, 
            currentTool: 'pen', 
            currentColor: '#ffffff', 
            currentSize: 5, 
            drawingHistory: [], 
            isDrawingActive: false, 
            customColors: [], 
            settings: { theme: 'dark', fontSize: 16, fontFamily: 'Inter' },
            selectedNotes: new Set(),
            longPressTimer: null,
            currentImageTarget: null
        };
        const DRAFT_KEY_PREFIX = 'draft_';

        async function initApp() {
            db = await new Promise((res, rej) => { 
                const r = indexedDB.open('DyNoteDB', 3); 
                r.onsuccess = () => res(r.result); 
                r.onerror = () => rej(r.error); 
                r.onupgradeneeded = (e) => { 
                    const d = e.target.result; 
                    if(!d.objectStoreNames.contains('notes')) d.createObjectStore('notes', {keyPath:'id'}); 
                    if(!d.objectStoreNames.contains('folders')) d.createObjectStore('folders', {keyPath:'id'}); 
                }; 
            });
            await loadData();
            loadSettings();
            initDefaultFolders();
            renderSidebar();
            renderNoteList();
            initDrawingCanvas();
            setupAutoSaveDrafts();
            loadCustomColors();
            renderColorGrid();
            setupSelectionMenu();
            checkMobileView();
        }

        function checkMobileView() {
            const isMobile = window.innerWidth < 769;
            if (isMobile) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-sidebar-overlay');
            
            if (sidebar.classList.contains('mobile-open')) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.add('hidden');
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.remove('hidden');
            }
        }

        function loadSettings() {
            const saved = localStorage.getItem('dynote-settings');
            if (saved) {
                state.settings = { ...state.settings, ...JSON.parse(saved) };
            }
            applyTheme(state.settings.theme);
            applyFontSize(state.settings.fontSize);
            applyFontFamily(state.settings.fontFamily);
        }

        function saveSettings() {
            localStorage.setItem('dynote-settings', JSON.stringify(state.settings));
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('global-overlay').classList.remove('hidden', 'opacity-0');
            document.getElementById('global-overlay').classList.add('opacity-100');
            
            updateThemeButtons();
            document.getElementById('font-size-slider').value = state.settings.fontSize;
            document.getElementById('font-size-value').textContent = state.settings.fontSize + 'px';
            document.getElementById('font-family-select').value = state.settings.fontFamily;
        }

        function updateThemeButtons() {
            const darkBtn = document.getElementById('theme-dark-btn');
            const lightBtn = document.getElementById('theme-light-btn');
            if (state.settings.theme === 'dark') {
                darkBtn.style.borderColor = '#eab308';
                lightBtn.style.borderColor = 'var(--border)';
            } else {
                lightBtn.style.borderColor = '#eab308';
                darkBtn.style.borderColor = 'var(--border)';
            }
        }

        function applyTheme(theme) {
            state.settings.theme = theme;
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
            saveSettings();
            updateThemeButtons();
        }

        function applyFontSize(size) {
            state.settings.fontSize = size;
            if (document.getElementById('note-body')) {
                document.getElementById('note-body').style.fontSize = size + 'px';
            }
            if (document.getElementById('note-title')) {
                document.getElementById('note-title').style.fontSize = (size * 1.5) + 'px';
            }
            saveSettings();
        }

        function applyFontFamily(family) {
            state.settings.fontFamily = family;
            document.body.style.fontFamily = family + ', sans-serif';
            saveSettings();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.getElementById('font-size-slider');
            const valueDisplay = document.getElementById('font-size-value');
            if (slider) {
                slider.addEventListener('input', (e) => {
                    const size = parseInt(e.target.value);
                    valueDisplay.textContent = size + 'px';
                    applyFontSize(size);
                });
            }

            const fontSelect = document.getElementById('font-family-select');
            if (fontSelect) {
                fontSelect.addEventListener('change', (e) => {
                    applyFontFamily(e.target.value);
                });
            }

            window.addEventListener('resize', checkMobileView);
        });

        async function dbOp(store, mode, fn) { const tx = db.transaction(store, mode); return fn(tx.objectStore(store)); }
        async function loadData() {
            state.notes = await dbOp('notes', 'readonly', s => new Promise(r => { const req = s.getAll(); req.onsuccess = () => r(req.result); })) || [];
            state.folders = await dbOp('folders', 'readonly', s => new Promise(r => { const req = s.getAll(); req.onsuccess = () => r(req.result); })) || [];
        }

        function initDefaultFolders() {
            const defaults = [{id:'folder-notes', name:'All Notes', type:'default'},{id:'folder-trash', name:'Trash', type:'default'}];
            defaults.forEach(d => { if(!state.folders.find(f => f.id === d.id)) state.folders.push(d); });
        }

        function renderSidebar() {
            const allCount = state.notes.filter(n => n.folderId !== 'folder-trash').length;
            const trashCount = state.notes.filter(n => n.folderId === 'folder-trash').length;
            document.getElementById('all-notes-count').innerText = allCount;
            document.getElementById('trash-count').innerText = trashCount;

            const userFolders = state.folders.filter(f => f.type === 'user');
            const container = document.getElementById('user-folders-list');
            container.innerHTML = userFolders.map(f => {
                const count = state.notes.filter(n => n.folderId === f.id).length;
                const isActive = state.activeFolderId === f.id ? 'background: var(--bg-secondary);' : '';
                return `<div class="nav-item flex items-center gap-3 px-4 py-3 rounded-2xl cursor-pointer mb-1 transition-all" style="color: var(--text-main); ${isActive}" onclick="setActiveFolder('${f.id}')" oncontextmenu="showContextMenu(event, '${f.id}')">
                    <svg class="w-6 h-6 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 7h18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4l2 2h4a2 2 0 0 1 2 2v1"/></svg>
                    <span class="flex-1 font-medium">${f.name}</span>
                    <span class="text-xs px-2 py-1 rounded-full" style="background: var(--bg-primary); color: var(--text-dim);">${count}</span>
                </div>`;
            }).join('');
        }

        function setActiveFolder(fid) {
            state.activeFolderId = fid;
            const folder = state.folders.find(f => f.id === fid);
            const titleEl = document.getElementById('current-folder-title');
            titleEl.innerText = folder ? folder.name : 'All Notes';
            
            if (folder && folder.type === 'user') {
                titleEl.onclick = () => enableFolderTitleEdit();
            } else {
                titleEl.onclick = null;
            }
            
            clearSelection();
            renderSidebar();
            renderNoteList();
            
            if (window.innerWidth < 769) {
                toggleMobileSidebar();
            }
        }

        function enableFolderTitleEdit() {
            const titleEl = document.getElementById('current-folder-title');
            titleEl.contentEditable = true;
            titleEl.classList.add('editing');
            titleEl.focus();
            
            const range = document.createRange();
            range.selectNodeContents(titleEl);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        function handleFolderTitleKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveFolderTitleInline();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                const folder = state.folders.find(f => f.id === state.activeFolderId);
                e.target.innerText = folder.name;
                e.target.contentEditable = false;
                e.target.classList.remove('editing');
            }
        }

        async function saveFolderTitleInline() {
            const titleEl = document.getElementById('current-folder-title');
            const folder = state.folders.find(f => f.id === state.activeFolderId);
            
            if (folder && folder.type === 'user') {
                const newName = titleEl.innerText.trim();
                if (newName && newName !== folder.name) {
                    folder.name = newName;
                    await dbOp('folders', 'readwrite', s => s.put(folder));
                    renderSidebar();
                } else {
                    titleEl.innerText = folder.name;
                }
            }
            
            titleEl.contentEditable = false;
            titleEl.classList.remove('editing');
        }

        function renderNoteList() {
            let notes = state.activeFolderId === 'folder-notes' 
                ? state.notes.filter(n => n.folderId !== 'folder-trash')
                : state.notes.filter(n => n.folderId === state.activeFolderId);
            
            if(state.searchQuery) notes = notes.filter(n => n.title.toLowerCase().includes(state.searchQuery) || n.body.toLowerCase().includes(state.searchQuery));
            
            const container = document.getElementById('notes-container');
            if(notes.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20" style="color: var(--text-dim);"><svg class="w-20 h-20 mx-auto mb-4 opacity-30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="20" rx="2" ry="2"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="12" x2="12" y2="12"/><line x1="8" y1="16" x2="10" y2="16"/></svg><p class="text-lg">No notes yet</p></div>`;
                return;
            }
            
            container.innerHTML = notes.map(n => {
                const preview = n.body.replace(/<[^>]*>/g, '').slice(0, 150);
                const draftKey = DRAFT_KEY_PREFIX + n.id;
                const draft = localStorage.getItem(draftKey);
                const isDraft = draft && draft !== JSON.stringify({ title: n.title, body: n.body });
                const isSelected = state.selectedNotes.has(n.id);
                
                return `<div class="note-card p-6 rounded-2xl cursor-pointer transition-all hover:scale-[1.02] ${isSelected ? 'selected' : ''}" 
                             style="background: var(--bg-secondary); border: 1px solid var(--border);" 
                             data-note-id="${n.id}"
                             onclick="handleNoteClick(event, '${n.id}')"
                             onmousedown="startLongPress(event, '${n.id}')"
                             onmouseup="endLongPress()"
                             onmouseleave="endLongPress()"
                             ontouchstart="startLongPress(event, '${n.id}')"
                             ontouchend="endLongPress()"
                             ontouchcancel="endLongPress()">
                    <div class="select-indicator">
                        <svg class="w-4 h-4 text-black" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                    </div>
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="text-xl font-bold flex-1 line-clamp-2" style="color: var(--text-main);">
                            ${n.title || 'Untitled'}
                            ${isDraft ? '<span class="draft-badge">DRAFT</span>' : ''}
                        </h3>
                    </div>
                    <p class="text-sm mb-4 line-clamp-3" style="color: var(--text-dim);">${preview || 'No content'}</p>
                    <div class="flex items-center gap-2 text-xs" style="color: var(--text-dim);">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        <span>${new Date(n.modified).toLocaleDateString()}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function startLongPress(e, noteId) {
            if (state.selectedNotes.size > 0) return;
            
            state.longPressTimer = setTimeout(() => {
                toggleNoteSelection(noteId);
                const card = document.querySelector(`[data-note-id="${noteId}"]`);
                if (card) card.classList.add('selecting');
            }, 500);
        }

        function endLongPress() {
            if (state.longPressTimer) {
                clearTimeout(state.longPressTimer);
                state.longPressTimer = null;
            }
        }

        function handleNoteClick(e, noteId) {
            e.stopPropagation();
            e.preventDefault();
            
            if (state.selectedNotes.size > 0) {
                toggleNoteSelection(noteId);
            } else {
                endLongPress();
                openNote(noteId);
            }
        }

        function toggleNoteSelection(noteId) {
            if (state.selectedNotes.has(noteId)) {
                state.selectedNotes.delete(noteId);
            } else {
                state.selectedNotes.add(noteId);
            }
            updateMultiSelectUI();
        }

        function updateMultiSelectUI() {
            const popup = document.getElementById('multi-select-popup');
            const count = document.getElementById('selected-count');
            
            if (state.selectedNotes.size > 0) {
                popup.classList.remove('hidden');
                count.textContent = `${state.selectedNotes.size} selected`;
            } else {
                popup.classList.add('hidden');
            }
            
            document.querySelectorAll('.note-card').forEach(card => {
                const noteId = card.dataset.noteId;
                if (state.selectedNotes.has(noteId)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function clearSelection() {
            state.selectedNotes.clear();
            updateMultiSelectUI();
        }

        function moveSelectedNotes() {
            const folders = state.folders.filter(f => f.type !== 'default' || f.id === 'folder-notes');
            const modal = document.getElementById('folder-select-modal');
            const list = document.getElementById('folder-list');
            
            list.innerHTML = folders.map(f => 
                `<button onclick="executeMoveToFolder('${f.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-opacity-80" style="background: var(--bg-primary); color: var(--text-main);">
                    <svg class="w-6 h-6 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 7h18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4l2 2h4a2 2 0 0 1 2 2v1"/></svg>
                    <span class="font-medium">${f.name}</span>
                </button>`
            ).join('');
            
            modal.classList.remove('hidden');
            document.getElementById('global-overlay').classList.remove('hidden', 'opacity-0');
            document.getElementById('global-overlay').classList.add('opacity-100');
        }

        async function executeMoveToFolder(folderId) {
            for (const noteId of state.selectedNotes) {
                const note = state.notes.find(n => n.id === noteId);
                if (note) {
                    note.folderId = folderId;
                    await dbOp('notes', 'readwrite', s => s.put(note));
                }
            }
            
            clearSelection();
            closeAllModals();
            renderSidebar();
            renderNoteList();
        }

        function deleteSelectedNotes() {
            const count = state.selectedNotes.size;
            const message = state.activeFolderId === 'folder-trash' 
                ? `Permanently delete ${count} note${count > 1 ? 's' : ''}?`
                : `Move ${count} note${count > 1 ? 's' : ''} to trash?`;
            
            openDialog(
                'Delete Notes',
                message,
                null,
                true,
                async () => {
                    for (const noteId of state.selectedNotes) {
                        const note = state.notes.find(n => n.id === noteId);
                        if (note) {
                            if (state.activeFolderId === 'folder-trash') {
                                await dbOp('notes', 'readwrite', s => s.delete(noteId));
                                state.notes = state.notes.filter(n => n.id !== noteId);
                            } else {
                                note.folderId = 'folder-trash';
                                await dbOp('notes', 'readwrite', s => s.put(note));
                            }
                        }
                    }
                    
                    clearSelection();
                    renderSidebar();
                    renderNoteList();
                }
            );
        }

        function filterNotes(q) { state.searchQuery = q.toLowerCase(); renderNoteList(); }
        
        function toggleFoldersList() {
            const list = document.getElementById('user-folders-list');
            const chevron = document.getElementById('folders-chevron');
            list.classList.toggle('collapsed');
            chevron.innerHTML = list.classList.contains('collapsed') 
                ? '<polyline points="9 6 15 12 9 18"/>' 
                : '<polyline points="6 9 12 15 18 9"/>';
        }

        async function createNewNote() {
            const note = { 
                id: 'note-'+Date.now(), 
                title: '', 
                body: '', 
                folderId: state.activeFolderId === 'folder-trash' ? 'folder-notes' : state.activeFolderId, 
                created: Date.now(), 
                modified: Date.now(), 
                drawing: null 
            };
            state.notes.push(note);
            await dbOp('notes', 'readwrite', s => s.put(note));
            openNote(note.id);
        }

        function openNote(id) {
            state.activeNoteId = id;
            const note = state.notes.find(n => n.id === id);
            if(!note) return;
            
            const draftKey = DRAFT_KEY_PREFIX + id;
            const draft = localStorage.getItem(draftKey);
            
            if (draft) {
                const draftData = JSON.parse(draft);
                if (draftData.title !== note.title || draftData.body !== note.body) {
                    if (confirm('You have an unsaved draft for this note. Load the draft?')) {
                        document.getElementById('note-title').value = draftData.title;
                        document.getElementById('note-body').innerHTML = draftData.body;
                    } else {
                        document.getElementById('note-title').value = note.title;
                        document.getElementById('note-body').innerHTML = note.body;
                        localStorage.removeItem(draftKey);
                    }
                } else {
                    document.getElementById('note-title').value = note.title;
                    document.getElementById('note-body').innerHTML = note.body;
                }
            } else {
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-body').innerHTML = note.body;
            }
            
            if(note.drawing) loadDrawing(note.drawing);
            else clearDrawingCanvas();
            
            document.getElementById('editor-view').classList.add('editor-open');
            applyFontSize(state.settings.fontSize);
            setupCheckboxListeners();
            setupImageLongPress();
        }

        function closeEditor() {
            saveCurrentNote();
            state.activeNoteId = null;
            document.getElementById('editor-view').classList.remove('editor-open');
            if(state.isDrawingActive) toggleDrawingMode();
            renderNoteList();
        }

        const saveCurrentNote = debounce(async () => {
            if(!state.activeNoteId) return;
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if(!note) return;
            
            const title = document.getElementById('note-title').value;
            const body = document.getElementById('note-body').innerHTML;
            
            note.title = title;
            note.body = body;
            note.modified = Date.now();
            note.drawing = getDrawingData();
            
            await dbOp('notes', 'readwrite', s => s.put(note));
            
            const draftKey = DRAFT_KEY_PREFIX + note.id;
            localStorage.removeItem(draftKey);
        }, 500);

        function setupAutoSaveDrafts() {
            setInterval(() => {
                if (state.activeNoteId) {
                    const note = state.notes.find(n => n.id === state.activeNoteId);
                    if (note) {
                        const title = document.getElementById('note-title').value;
                        const body = document.getElementById('note-body').innerHTML;
                        const draftKey = DRAFT_KEY_PREFIX + note.id;
                        localStorage.setItem(draftKey, JSON.stringify({ title, body }));
                    }
                }
            }, 3000);
        }

        async function deleteNote() {
            if(!state.activeNoteId) return;
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if(!note) return;
            
            if(note.folderId === 'folder-trash') {
                openDialog(
                    'Permanently Delete',
                    'This note will be permanently deleted. This action cannot be undone.',
                    null,
                    true,
                    async () => {
                        await dbOp('notes', 'readwrite', s => s.delete(note.id));
                        state.notes = state.notes.filter(n => n.id !== note.id);
                        closeEditor();
                    }
                );
            } else {
                note.folderId = 'folder-trash';
                await dbOp('notes', 'readwrite', s => s.put(note));
                closeEditor();
            }
        }

        function toggleFormat(cmd) { document.execCommand(cmd, false, null); saveCurrentNote(); }
        
        function applyHeading(level) {
            document.execCommand('formatBlock', false, level);
            saveCurrentNote();
        }

        function setAlignment(align) {
            const alignMap = {
                'left': 'justifyLeft',
                'center': 'justifyCenter',
                'right': 'justifyRight',
                'justify': 'justifyFull'
            };
            document.execCommand(alignMap[align], false, null);
            
            // Close the selection menu
            document.getElementById('selection-context-menu').classList.add('hidden');
            saveCurrentNote();
        }
        
        function toggleHighlight() {
            const sel = window.getSelection();
            if(!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            if(range.collapsed) return;
            
            // Check if already highlighted
            let node = range.commonAncestorContainer;
            if (node.nodeType === 3) node = node.parentNode;
            
            if (node.tagName === 'MARK' || node.closest('mark')) {
                // Remove highlight
                document.execCommand('removeFormat', false, null);
            } else {
                // Add highlight
                const mark = document.createElement('mark');
                try { 
                    range.surroundContents(mark); 
                } catch(e) { 
                    document.execCommand('hiliteColor', false, '#facc15'); 
                }
            }
            
            // Close the selection menu
            document.getElementById('selection-context-menu').classList.add('hidden');
            saveCurrentNote();
        }

        function insertCheckbox() {
            // Get cursor position
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            
            // Create checkbox at cursor
            const div = document.createElement('div');
            div.className = 'todo-item';
            div.innerHTML = '<input type="checkbox" class="todo-checkbox"><span contenteditable="true">Task</span>';
            
            range.insertNode(div);
            
            // Move cursor to the task text
            const taskSpan = div.querySelector('span');
            taskSpan.focus();
            
            setupCheckboxListeners();
            saveCurrentNote();
        }

        function setupCheckboxListeners() {
            document.querySelectorAll('.todo-checkbox').forEach(cb => {
                cb.onclick = saveCurrentNote;
            });
        }

        function insertImage(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const id = 'img-container-'+Date.now();
                const html = `<div class="resizable-img-container" id="${id}" data-container-id="${id}">
                    <img src="${ev.target.result}" style="max-width:500px">
                    <div class="resizer" onmousedown="initResize(event, '${id}')" ontouchstart="initResize(event, '${id}')"></div>
                </div>`;
                document.getElementById('note-body').insertAdjacentHTML('beforeend', html);
                setupImageLongPress();
                saveCurrentNote();
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function setupImageLongPress() {
            document.querySelectorAll('.resizable-img-container img').forEach(img => {
                let timer = null;
                
                const startPress = (e) => {
                    timer = setTimeout(() => {
                        const container = img.closest('.resizable-img-container');
                        showImageContextMenu(e, container);
                    }, 500);
                };
                
                const endPress = () => {
                    if (timer) {
                        clearTimeout(timer);
                        timer = null;
                    }
                };
                
                img.addEventListener('mousedown', startPress);
                img.addEventListener('mouseup', endPress);
                img.addEventListener('mouseleave', endPress);
                img.addEventListener('touchstart', startPress);
                img.addEventListener('touchend', endPress);
                img.addEventListener('touchcancel', endPress);
            });
        }

        function showImageContextMenu(e, container) {
            e.preventDefault();
            e.stopPropagation();
            
            state.currentImageTarget = container;
            const menu = document.getElementById('image-context-menu');
            
            const x = e.clientX || (e.touches && e.touches[0].clientX);
            const y = e.clientY || (e.touches && e.touches[0].clientY);
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.remove('hidden');
            
            document.getElementById('global-overlay').classList.remove('hidden', 'opacity-0');
            document.getElementById('global-overlay').classList.add('opacity-100');
        }

        function resizeImage() {
            closeAllModals();
            if (!state.currentImageTarget) return;
            
            const img = state.currentImageTarget.querySelector('img');
            const currentWidth = img.style.width || img.clientWidth + 'px';
            
            openDialog(
                'Resize Image',
                null,
                parseInt(currentWidth),
                false,
                (width) => {
                    if (width && !isNaN(width)) {
                        img.style.width = width + 'px';
                        saveCurrentNote();
                    }
                }
            );
        }

        function addSubtitle() {
            closeAllModals();
            if (!state.currentImageTarget) return;
            
            const existingSubtitle = state.currentImageTarget.querySelector('.img-subtitle');
            const currentText = existingSubtitle ? existingSubtitle.textContent : '';
            
            openDialog(
                'Add Subtitle',
                null,
                currentText,
                false,
                (text) => {
                    if (existingSubtitle) {
                        if (text) {
                            existingSubtitle.textContent = text;
                        } else {
                            existingSubtitle.remove();
                        }
                    } else if (text) {
                        const subtitle = document.createElement('div');
                        subtitle.className = 'img-subtitle';
                        subtitle.textContent = text;
                        state.currentImageTarget.appendChild(subtitle);
                    }
                    saveCurrentNote();
                }
            );
        }

        function deleteImage() {
            closeAllModals();
            if (!state.currentImageTarget) return;
            
            state.currentImageTarget.remove();
            state.currentImageTarget = null;
            saveCurrentNote();
        }

        function setupSelectionMenu() {
            const noteBody = document.getElementById('note-body');
            
            noteBody.addEventListener('mouseup', showSelectionMenu);
            noteBody.addEventListener('touchend', showSelectionMenu);
        }

        function showSelectionMenu(e) {
            const selection = window.getSelection();
            const menu = document.getElementById('selection-context-menu');
            
            if (selection.toString().length > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // Check if selection is highlighted
                let node = range.commonAncestorContainer;
                if (node.nodeType === 3) node = node.parentNode;
                const isHighlighted = node.tagName === 'MARK' || node.closest('mark');
                
                // Update button text
                const highlightBtn = document.getElementById('highlight-toggle-text');
                if (highlightBtn) {
                    highlightBtn.textContent = isHighlighted ? 'Remove Highlight' : 'Highlight';
                }
                
                const menuHeight = 400; // Approximate max height
                let topPos = rect.top - menuHeight - 10;
                
                // If menu would go off top of screen, position below selection
                if (topPos < 0) {
                    topPos = rect.bottom + 10;
                }
                
                menu.style.left = Math.max(10, rect.left) + 'px';
                menu.style.top = topPos + 'px';
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        }

        async function execTextCommand(cmd) {
            const menu = document.getElementById('selection-context-menu');
            
            if (cmd === 'cut') {
                document.execCommand('cut');
            } else if (cmd === 'copy') {
                document.execCommand('copy');
            } else if (cmd === 'paste') {
                try {
                    const text = await navigator.clipboard.readText();
                    document.execCommand('insertText', false, text);
                } catch (err) {
                    console.error('Paste failed:', err);
                }
            } else if (cmd === 'selectAll') {
                document.execCommand('selectAll');
            }
            
            menu.classList.add('hidden');
            saveCurrentNote();
        }

        function exportNote() {
            if(!state.activeNoteId) return;
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if(!note) return;
            
            const container = document.getElementById('export-container');
            container.innerHTML = `<div style="padding: 40px; max-width: 800px; margin: 0 auto; font-family: ${state.settings.fontFamily}, sans-serif; background: white; color: black;"><h1 style="font-size: 2.5em; font-weight: bold; margin-bottom: 20px;">${note.title || 'Untitled'}</h1><div style="font-size: ${state.settings.fontSize}px; line-height: 1.6;">${note.body}</div></div>`;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(container.innerHTML);
            printWindow.document.close();
            printWindow.print();
        }

        /* --- DRAWING FUNCTIONALITY --- */
        let canvas, ctx;
        const DEFAULT_COLORS = ['#ffffff', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#800080', '#008000'];

        function initDrawingCanvas() {
            canvas = document.getElementById('drawing-layer');
            ctx = canvas.getContext('2d');
            
            const wrapper = document.getElementById('canvas-wrapper');
            const resizeCanvas = () => {
                canvas.width = wrapper.offsetWidth;
                canvas.height = wrapper.offsetHeight;
                if(state.activeNoteId) {
                    const note = state.notes.find(n => n.id === state.activeNoteId);
                    if(note && note.drawing) loadDrawing(note.drawing);
                }
            };
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            let isDrawing = false, lastX, lastY;
            
            const startDraw = (e) => {
                if(!state.isDrawingActive) return;
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = (e.clientX || e.touches[0].clientX) - rect.left;
                lastY = (e.clientY || e.touches[0].clientY) - rect.top;
            };
            
            const draw = (e) => {
                if(!isDrawing || !state.isDrawingActive) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.strokeStyle = state.currentTool === 'eraser' ? 'transparent' : state.currentColor;
                ctx.lineWidth = state.currentSize;
                ctx.lineCap = 'round';
                ctx.globalCompositeOperation = state.currentTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            };
            
            const endDraw = () => {
                isDrawing = false;
                if(state.isDrawingActive) saveCurrentNote();
            };
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('touchstart', startDraw, {passive:false});
            canvas.addEventListener('touchmove', draw, {passive:false});
            canvas.addEventListener('touchend', endDraw);
            
            renderMarkers();
        }

        function renderMarkers() {
            const colors = [...DEFAULT_COLORS, ...state.customColors];
            const container = document.getElementById('marker-container');
            container.innerHTML = colors.map((c, i) => 
                `<div class="marker-item ${state.currentColor === c ? 'active' : ''}" onclick="selectColor('${c}')" style="width: 40px; height: 40px; background: ${c}; border-radius: 12px; border: 2px solid var(--border); flex-shrink: 0;"></div>`
            ).join('') + 
            `<button onclick="toggleColorPicker(event)" class="p-2 md:p-3 rounded-xl transition-all flex-shrink-0" style="width: 40px; height: 40px; background: var(--bg-secondary); border: 2px dashed var(--border);">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>`;
        }

        function renderColorGrid() {
            const colors = [...DEFAULT_COLORS, ...state.customColors];
            const grid = document.getElementById('color-grid');
            grid.innerHTML = colors.map(c => 
                `<div class="color-option ${state.currentColor === c ? 'selected' : ''}" style="background-color: ${c};" onclick="selectColorFromPicker('${c}')"></div>`
            ).join('');
        }

        function selectColor(color) {
            state.currentColor = color;
            state.currentTool = 'pen';
            renderMarkers();
            updateToolButtons();
        }

        function selectColorFromPicker(color) {
            state.currentColor = color;
            state.currentTool = 'pen';
            renderColorGrid();
            renderMarkers();
            updateToolButtons();
        }

        function loadCustomColors() {
            const saved = localStorage.getItem('dynote-custom-colors');
            if (saved) {
                state.customColors = JSON.parse(saved);
            }
        }

        function saveCustomColors() {
            localStorage.setItem('dynote-custom-colors', JSON.stringify(state.customColors));
        }

        function addCustomColor() {
            const picker = document.getElementById('custom-color-picker');
            const color = picker.value;
            if (!state.customColors.includes(color) && !DEFAULT_COLORS.includes(color)) {
                state.customColors.push(color);
                saveCustomColors();
                renderColorGrid();
                renderMarkers();
                selectColor(color);
            }
        }

        function toggleColorPicker(e) {
            e.stopPropagation();
            const popover = document.getElementById('color-picker-popover');
            const btn = e.currentTarget;
            const rect = btn.getBoundingClientRect();
            
            if (popover.classList.contains('hidden')) {
                popover.style.left = rect.left + 'px';
                popover.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                popover.classList.remove('hidden');
            } else {
                popover.classList.add('hidden');
            }
        }

        function setDrawingTool(tool) {
            state.currentTool = tool;
            updateToolButtons();
        }

        function updateToolButtons() {
            ['pen', 'eraser'].forEach(t => {
                const btn = document.getElementById('tool-'+t);
                if(state.currentTool === t) {
                    btn.style.background = '#eab308';
                    btn.style.color = '#000';
                } else {
                    btn.style.background = 'var(--bg-secondary)';
                    btn.style.color = 'var(--text-main)';
                }
            });
        }

        function toggleDrawingMode() {
            state.isDrawingActive = !state.isDrawingActive;
            const rack = document.getElementById('drawing-ui-rack');
            const btn = document.getElementById('draw-toggle-btn');
            
            if(state.isDrawingActive) {
                rack.classList.add('visible');
                document.getElementById('editor-content').classList.add('drawing-active');
                btn.style.background = '#eab308';
                btn.style.color = '#000';
            } else {
                rack.classList.remove('visible');
                document.getElementById('editor-content').classList.remove('drawing-active');
                btn.style.background = 'var(--bg-secondary)';
                btn.style.color = 'var(--text-main)';
                document.getElementById('color-picker-popover').classList.add('hidden');
            }
        }

        function toggleSizePopover(e) {
            e.stopPropagation();
            const popover = document.getElementById('size-popover');
            const btn = e.currentTarget;
            const rect = btn.getBoundingClientRect();
            
            if(popover.classList.contains('hidden')) {
                popover.style.left = rect.left + 'px';
                popover.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                popover.classList.remove('hidden');
                
                const slider = document.getElementById('size-slider');
                slider.value = state.currentSize;
                document.getElementById('size-value').innerText = state.currentSize + 'px';
                
                slider.oninput = (ev) => {
                    state.currentSize = parseInt(ev.target.value);
                    document.getElementById('size-value').innerText = state.currentSize + 'px';
                };
            } else {
                popover.classList.add('hidden');
            }
        }

        function clearDrawing() {
            if(confirm('Clear all drawings?')) {
                clearDrawingCanvas();
                saveCurrentNote();
            }
        }

        function clearDrawingCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function getDrawingData() {
            return canvas.toDataURL();
        }

        function loadDrawing(data) {
            const img = new Image();
            img.onload = () => {
                clearDrawingCanvas();
                ctx.drawImage(img, 0, 0);
            };
            img.src = data;
        }

        /* --- CONTEXT MENU & MODALS --- */
        function showContextMenu(e, folderId) {
            e.preventDefault();
            e.stopPropagation();
            state.contextTargetFolder = folderId;
            const menu = document.getElementById('context-menu');
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.remove('hidden');
            document.getElementById('global-overlay').classList.remove('hidden', 'opacity-0');
            document.getElementById('global-overlay').classList.add('opacity-100');
        }

        function closeAllModals() {
            ['context-menu', 'dialog-modal', 'settings-modal', 'size-popover', 'color-picker-popover', 'global-overlay', 'folder-select-modal', 'image-context-menu', 'selection-context-menu'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.getElementById('global-overlay').classList.remove('opacity-100');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#size-popover') && !e.target.closest('button[onclick*="toggleSizePopover"]')) {
                document.getElementById('size-popover').classList.add('hidden');
            }
            if (!e.target.closest('#color-picker-popover') && !e.target.closest('button[onclick*="toggleColorPicker"]')) {
                document.getElementById('color-picker-popover').classList.add('hidden');
            }
            if (!e.target.closest('#selection-context-menu')) {
                document.getElementById('selection-context-menu').classList.add('hidden');
            }
        });

        function openDialog(title, msg, inputVal, isDanger, onConfirm) {
            document.getElementById('dialog-title').innerText = title;
            const input = document.getElementById('dialog-input');
            const message = document.getElementById('dialog-message');
            if(inputVal !== null && inputVal !== undefined) { 
                input.value = inputVal; 
                input.parentElement.classList.remove('hidden'); 
                message.classList.add('hidden'); 
            }
            else { 
                message.innerText = msg; 
                message.classList.remove('hidden'); 
                input.parentElement.classList.add('hidden'); 
            }
            const btn = document.getElementById('dialog-confirm-btn');
            btn.className = isDanger ? "px-5 py-2.5 rounded-xl bg-red-600 text-white" : "px-5 py-2.5 rounded-xl bg-yellow-500 text-black";
            btn.onclick = () => { onConfirm(input.value); closeAllModals(); };
            document.getElementById('dialog-modal').classList.remove('hidden');
            document.getElementById('global-overlay').classList.remove('hidden', 'opacity-0');
            document.getElementById('global-overlay').classList.add('opacity-100');
        }

        function handleRenameClick() {
            const folder = state.folders.find(f => f.id === state.contextTargetFolder);
            closeAllModals();
            openDialog("Rename", null, folder.name, false, async (n) => { 
                folder.name = n; 
                await dbOp('folders', 'readwrite', s => s.put(folder)); 
                renderSidebar(); 
                if(state.activeFolderId === folder.id) setActiveFolder(folder.id); 
            });
        }

        function handleDeleteFolderClick() {
            closeAllModals();
            openDialog("Delete Folder", "Remove folder and move contents to All Notes?", null, true, async () => {
                await dbOp('folders', 'readwrite', s => s.delete(state.contextTargetFolder));
                state.folders = state.folders.filter(f => f.id !== state.contextTargetFolder);
                state.notes.forEach(async n => { 
                    if(n.folderId === state.contextTargetFolder) { 
                        n.folderId = 'folder-notes'; 
                        await dbOp('notes', 'readwrite', s => s.put(n)); 
                    } 
                });
                state.activeFolderId = 'folder-notes'; 
                renderSidebar(); 
                renderNoteList();
            });
        }

        function openFolderCreateDialog() {
            openDialog("New Folder", null, "", false, async (n) => {
                if(!n) return;
                const f = { id: 'folder-'+Date.now(), name: n, type: 'user' };
                state.folders.push(f);
                await dbOp('folders', 'readwrite', s => s.put(f)); 
                renderSidebar();
            });
        }

        /* --- UTILS --- */
        function debounce(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f(...a), w); }; }
        
        function initResize(e, containerId) {
            e.preventDefault(); 
            e.stopPropagation();
            const container = document.getElementById(containerId);
            const img = container.querySelector('img');
            const startX = e.clientX || e.touches[0].clientX;
            const startWidth = img.clientWidth;
            const onMove = (mv) => { 
                img.style.width = Math.max(50, startWidth + ((mv.clientX||mv.touches[0].clientX) - startX)) + 'px'; 
            };
            const onEnd = () => { 
                ['mousemove','mouseup','touchmove','touchend'].forEach(ev => window.removeEventListener(ev, onMove)); 
                window.removeEventListener('mouseup', onEnd); 
                window.removeEventListener('touchend', onEnd); 
                saveCurrentNote(); 
            };
            window.addEventListener('mousemove', onMove); 
            window.addEventListener('touchmove', onMove, {passive:false});
            window.addEventListener('mouseup', onEnd); 
            window.addEventListener('touchend', onEnd);
        }

        window.onload = initApp;

        const style = document.createElement('style');
        style.innerHTML = `
            .tool-btn { 
                padding: 10px; border-radius: 12px; color: var(--text-dim); transition: all 0.2s;
                display: flex; align-items: center; justify-content: center; font-size: 1.25rem;
                min-width: 44px; height: 44px; background: var(--bg-secondary); flex-shrink: 0;
            }
            .tool-btn:hover { background-color: var(--border); color: var(--text-main); }
            .tool-btn:active { transform: scale(0.95); }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- Theme CSS Variables -->
    <style>
        :root { 
            --bg-primary: #000; 
            --bg-secondary: #0a0a0a; 
            --text-main: #e5e5e5; 
            --text-dim: #a3a3a3; 
            --border: #262626; 
            --accent: #eab308; 
        }
        .light-theme { 
            --bg-primary: #fff; 
            --bg-secondary: #f5f5f5; 
            --text-main: #171717; 
            --text-dim: #737373; 
            --border: #d4d4d4; 
            --accent: #ca8a04; 
        }

        body, aside, main, section, #editor-view, #editor-content, #note-list-view, #export-container {
            background-color: var(--bg-primary) !important;
            color: var(--text-main) !important;
        }

        .nav-item:hover {
            background-color: var(--bg-secondary) !important;
        }

        input, textarea, [contenteditable] {
            color: var(--text-main) !important;
        }

        ::placeholder {
            color: var(--text-dim) !important;
            opacity: 0.5;
        }

        #note-body:empty:before {
            content: attr(data-placeholder);
            color: var(--text-dim);
            opacity: 0.5;
        }

        #note-body mark {
            background-color: #facc15;
            color: #000 !important;
        }

        .border, .border-r, .border-b, .border-t, .border-l,
        [class*="border-"] {
            border-color: var(--border) !important;
        }
    </style>
<script>
/**
 * Prevents accidental selection while scrolling.
 * Requires a "hold" (long press) to enable selection.
 */
(function() {
    const noteBody = document.getElementById('note-body');
    let touchTimeout;
    let isScrolling = false;

    // Start with selection disabled
    noteBody.style.userSelect = 'none';
    noteBody.style.webkitUserSelect = 'none';

    noteBody.addEventListener('touchstart', (e) => {
        isScrolling = false;
        // If user holds for 500ms without moving, enable selection
        touchTimeout = setTimeout(() => {
            if (!isScrolling) {
                noteBody.style.userSelect = 'text';
                noteBody.style.webkitUserSelect = 'text';
            }
        }, 500); 
    }, { passive: true });

    noteBody.addEventListener('touchmove', () => {
        isScrolling = true;
        clearTimeout(touchTimeout);
        // Re-disable selection if they start moving/scrolling
        noteBody.style.userSelect = 'none';
        noteBody.style.webkitUserSelect = 'none';
    }, { passive: true });

    noteBody.addEventListener('touchend', () => {
        clearTimeout(touchTimeout);
        // Reset to none after finger is lifted so the next tap/scroll is protected
        setTimeout(() => {
            noteBody.style.userSelect = 'none';
            noteBody.style.webkitUserSelect = 'none';
        }, 300);
    });
})();
</script>



<script>
/**
 * DyNote Hash Handler
 * Supports: 
 * #quickl - New note + Light mode
 * #quickd - New note + Dark mode
 * #l      - Light mode
 * #d      - Dark mode
 */
(function() {
    function handleHashAction() {
        const hash = window.location.hash.toLowerCase();
        if (!hash) return;

        // Determine actions based on hash
        switch (hash) {
            case '#quickl':
                if (typeof createNewNote === 'function') createNewNote();
                if (typeof applyTheme === 'function') applyTheme('light');
                break;
            case '#quickd':
                if (typeof createNewNote === 'function') createNewNote();
                if (typeof applyTheme === 'function') applyTheme('dark');
                break;
            case '#l':
                if (typeof applyTheme === 'function') applyTheme('light');
                break;
            case '#d':
                if (typeof applyTheme === 'function') applyTheme('dark');
                break;
        }

        // Optional: Clear hash after action to prevent re-triggering on refresh
        // history.replaceState(null, null, ' ');
    }

    // Run on initial load
    window.addEventListener('load', handleHashAction);
    
    // Run if the hash changes while the page is open
    window.addEventListener('hashchange', handleHashAction);
})();
</script>




    
</body>
</html>
