<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor | Sugercane | DocuWrite Pro</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%);
            overflow: auto;
        }

        /* Loading Screen */
        #loadingScreen {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 24px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e3f2fd;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #666;
        }

        /* Editor Container */
        #editorContainer {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            background: #f5f5f5;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            flex-shrink: 0;
        }

        #docTitle {
            font-size: 20px;
            border: none;
            outline: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            max-width: 400px;
            font-family: Arial, sans-serif;
        }

        #docTitle:hover {
            background: #f5f5f5;
        }

        .export-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #1565c0;
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 12px 24px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 0 8px;
            border-right: 1px solid #e0e0e0;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: transparent;
            border: none;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: #e3f2fd;
        }

        .toolbar-btn.active {
            background: #bbdefb;
        }

        .toolbar-btn .material-symbols-outlined {
            font-size: 20px;
            color: #333;
        }

        select, input[type="number"] {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 6px 10px;
            outline: none;
            font-size: 14px;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #fontSize {
            width: 50px;
            text-align: center;
        }

        /* Custom Font Dropdown */
        .font-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-selector {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            min-width: 120px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .font-selector:hover {
            background: #f5f5f5;
        }

        .font-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 150px;
            margin-top: 4px;
        }

        .font-menu.active {
            display: block;
        }

        .font-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .font-option:hover {
            background: #e3f2fd;
        }

        .font-option.selected {
            background: #bbdefb;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, width 0.3s ease, min-width 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
            width: 0;
            min-width: 0;
            padding: 0;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-control {
            margin-bottom: 12px;
        }

        .sidebar-control label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .sidebar-control input, .sidebar-control select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
            background: #fafafa;
        }

        .sidebar-control input:focus, .sidebar-control select:focus {
            outline: none;
            border-color: #1976d2;
            background: white;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .collapse-btn {
            width: 100%;
            padding: 10px;
            background: #e3f2fd;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .collapse-btn:hover {
            background: #bbdefb;
        }

        .expand-btn {
            position: fixed;
            left: 20px;
            top: 180px;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 50;
            display: none;
        }

        .expand-btn .material-symbols-outlined {
            font-size: 24px;
        }

        /* Editor Area - CRITICAL: Always maintain A4 size */
        .editor-area-wrapper {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            background: #f5f5f5;
            min-width: 0;
        }

        .editor-area {
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transform-origin: top center;
            transition: transform 0.3s ease;
            min-width: fit-content;
        }

        /* Page - ABSOLUTE A4 SIZE - NEVER SHRINK */
        .page {
            width: 21cm;
            min-width: 21cm;
            max-width: 21cm;
            height: 29.7cm;
            min-height: 29.7cm;
            max-height: 29.7cm;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            position: relative;
            padding: 2cm;
            flex-shrink: 0;
            overflow: hidden;
        }

        .page-content {
            height: 25.7cm;
            min-height: 25.7cm;
            max-height: 25.7cm;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            font-family: Arial, sans-serif;
            word-wrap: break-word;
            overflow: visible;
        }

        .page-content img {
            max-width: 100%;
            cursor: move;
            border: 2px solid transparent;
            transition: border 0.2s;
        }

        .page-content img:hover {
            border-color: #1976d2;
        }

        .page-content img.selected {
            border-color: #1976d2;
            outline: 2px dashed #1976d2;
            outline-offset: 4px;
        }

        .page-content img.dragging {
            opacity: 0.7;
            z-index: 1000;
        }

        .image-resize-handle {
            position: fixed;
            width: 12px;
            height: 12px;
            background: #1976d2;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            display: none;
            z-index: 10000;
            pointer-events: auto;
        }

        .add-page-btn {
            background: white;
            border: 2px dashed #1976d2;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
            color: #1976d2;
            transition: all 0.2s;
            margin-top: 20px;
            width: 21cm;
        }

        .add-page-btn:hover {
            background: #e3f2fd;
            transform: scale(1.02);
        }

        /* Page Indicator */
        .page-indicator {
            position: fixed;
            top: 130px;
            right: 40px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #666;
            z-index: 50;
        }

        /* Overflow Alert */
        .overflow-alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #d32f2f;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            z-index: 10001;
            display: none;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 500;
            color: #333;
        }

        .close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: #f5f5f5;
        }

        .close-btn .material-symbols-outlined {
            font-size: 24px;
            color: #666;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .drop-zone {
            border: 2px dashed #1976d2;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f5f5f5;
        }

        .drop-zone:hover {
            background: #e3f2fd;
        }

        .drop-zone.dragover {
            background: #bbdefb;
            border-color: #1565c0;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .modal-btn-primary {
            background: #1976d2;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #1565c0;
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background: #d0d0d0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: #1976d2;
            transition: width 0.3s;
        }

        .color-picker-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .upload-font-btn {
            background: #e3f2fd;
            border: none;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-font-btn:hover {
            background: #bbdefb;
        }

        .gradient-controls {
            display: none;
            margin-top: 12px;
        }

        .gradient-controls.active {
            display: block;
        }

        .zoom-display {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #1976d2;
            margin: 12px 0;
        }

        .zoom-buttons {
            display: flex;
            gap: 8px;
        }

        .zoom-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 13px;
        }

        .zoom-btn:hover {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        table td, table th {
            border: 1px solid #ddd;
            padding: 8px;
            min-width: 50px;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 72px;
            color: rgba(0,0,0,0.1);
            pointer-events: none;
            white-space: nowrap;
            z-index: 1;
        }

        @media print {
            .page {
                box-shadow: none;
                margin: 0;
                page-break-after: always;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">Creating Canvas...</div>
    </div>

    <!-- Editor Container -->
    <div id="editorContainer">
        <!-- Top Bar -->
        <div class="top-bar">
            <input type="text" id="docTitle" value="Untitled Document" />
            <button class="export-btn" onclick="exportDocument()">
                <span class="material-symbols-outlined">download</span>
                Export
            </button>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="document.execCommand('undo')" title="Undo">
                    <span class="material-symbols-outlined">undo</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('redo')" title="Redo">
                    <span class="material-symbols-outlined">redo</span>
                </button>
            </div>

            <div class="toolbar-group">
                <select id="formatBlock" onchange="changeFormat(this.value)">
                    <option value="p">Paragraph</option>
                    <option value="h1">Heading 1</option>
                    <option value="h2">Heading 2</option>
                    <option value="h3">Heading 3</option>
                    <option value="h4">Heading 4</option>
                    <option value="h5">Heading 5</option>
                    <option value="h6">Heading 6</option>
                    <option value="blockquote">Blockquote</option>
                    <option value="pre">Preformatted</option>
                </select>
            </div>

            <div class="toolbar-group size-control">
                <button class="toolbar-btn" onclick="decreaseFontSize()" title="Decrease Size">
                    <span class="material-symbols-outlined">remove</span>
                </button>
                <input type="number" id="fontSize" value="16" min="8" max="72" onchange="changeFontSize(this.value)" />
                <button class="toolbar-btn" onclick="increaseFontSize()" title="Increase Size">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="toggleFormat('bold')" title="Bold">
                    <span class="material-symbols-outlined">format_bold</span>
                </button>
                <button class="toolbar-btn" onclick="toggleFormat('italic')" title="Italic">
                    <span class="material-symbols-outlined">format_italic</span>
                </button>
                <button class="toolbar-btn" onclick="toggleFormat('underline')" title="Underline">
                    <span class="material-symbols-outlined">format_underlined</span>
                </button>
                <button class="toolbar-btn" onclick="toggleFormat('strikeThrough')" title="Strikethrough">
                    <span class="material-symbols-outlined">strikethrough_s</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="document.execCommand('justifyLeft')" title="Align Left">
                    <span class="material-symbols-outlined">format_align_left</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('justifyCenter')" title="Align Center">
                    <span class="material-symbols-outlined">format_align_center</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('justifyRight')" title="Align Right">
                    <span class="material-symbols-outlined">format_align_right</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('justifyFull')" title="Justify">
                    <span class="material-symbols-outlined">format_align_justify</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="document.execCommand('insertUnorderedList')" title="Bulleted List">
                    <span class="material-symbols-outlined">format_list_bulleted</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('insertOrderedList')" title="Numbered List">
                    <span class="material-symbols-outlined">format_list_numbered</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="openImageModal()" title="Insert Image">
                    <span class="material-symbols-outlined">image</span>
                </button>
                <button class="toolbar-btn" onclick="openTableModal()" title="Insert Table">
                    <span class="material-symbols-outlined">table</span>
                </button>
                <button class="toolbar-btn" onclick="openLinkModal()" title="Insert Link">
                    <span class="material-symbols-outlined">link</span>
                </button>
            </div>

            <div class="toolbar-group font-dropdown">
                <div class="font-selector" onclick="toggleFontMenu()" id="fontSelector">
                    <span id="selectedFont">Arial</span>
                    <span class="material-symbols-outlined" style="font-size: 18px;">expand_more</span>
                </div>
                <div class="font-menu" id="fontMenu">
                    <div class="font-option selected" onclick="selectFont('Arial')" style="font-family: Arial;">Arial</div>
                </div>
                <button class="upload-font-btn" onclick="document.getElementById('fontUpload').click()" title="Upload Font">
                    <span class="material-symbols-outlined">add</span>
                </button>
                <input type="file" id="fontUpload" accept=".ttf,.otf,.woff,.woff2" style="display:none" onchange="uploadFont(this)" />
            </div>

            <div class="toolbar-group">
                <input type="color" id="textColor" value="#000000" onchange="changeTextColor(this.value)" title="Text Color" />
                <input type="color" id="highlightColor" value="#ffff00" onchange="changeHighlight(this.value)" title="Highlight" />
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">
                    <span class="material-symbols-outlined">format_clear</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Viewing Adjustment</div>
                    <div class="sidebar-control">
                        <label>Zoom Level</label>
                        <div class="zoom-display" id="zoomDisplay">100%</div>
                        <div class="zoom-buttons">
                            <button class="zoom-btn" onclick="adjustZoom(-10)">
                                <span class="material-symbols-outlined" style="font-size: 18px;">remove</span>
                                Zoom Out
                            </button>
                            <button class="zoom-btn" onclick="adjustZoom(10)">
                                <span class="material-symbols-outlined" style="font-size: 18px;">add</span>
                                Zoom In
                            </button>
                        </div>
                        <button class="zoom-btn" onclick="resetZoom()" style="margin-top: 8px; width: 100%;">
                            <span class="material-symbols-outlined" style="font-size: 18px;">refresh</span>
                            Reset
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Watermark</div>
                    <div class="sidebar-control">
                        <label>Text</label>
                        <input type="text" id="watermarkText" oninput="updateWatermark()" placeholder="Enter watermark text" />
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Line Spacing</div>
                    <div class="sidebar-control">
                        <select id="lineSpacing" onchange="updateLineSpacing(this.value)">
                            <option value="1">Single</option>
                            <option value="1.15">1.15</option>
                            <option value="1.5">1.5</option>
                            <option value="2">Double</option>
                            <option value="2.5">2.5</option>
                            <option value="3">Triple</option>
                        </select>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Page Background</div>
                    <div class="sidebar-control">
                        <label>Type</label>
                        <select id="bgType" onchange="toggleGradient(this.value)">
                            <option value="solid">Solid Color</option>
                            <option value="gradient">Gradient</option>
                        </select>
                    </div>
                    <div class="sidebar-control">
                        <label>Color</label>
                        <input type="color" id="bgColor" value="#ffffff" onchange="updateBackground()" />
                    </div>
                    <div class="gradient-controls" id="gradientControls">
                        <div class="sidebar-control">
                            <label>Second Color</label>
                            <input type="color" id="bgColor2" value="#e3f2fd" onchange="updateBackground()" />
                        </div>
                        <div class="sidebar-control">
                            <label>Angle (deg)</label>
                            <input type="number" id="gradientAngle" value="135" min="0" max="360" onchange="updateBackground()" />
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Page Margins</div>
                    <div class="sidebar-control">
                        <label>All Sides (cm)</label>
                        <input type="number" id="pageMargin" value="2" min="0" max="5" step="0.5" onchange="updateMargins(this.value)" />
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Word Count</div>
                    <div id="wordCount" style="font-size: 14px; color: #666;">0 words</div>
                </div>

                <button class="collapse-btn" onclick="toggleSidebar()">
                    <span class="material-symbols-outlined">chevron_left</span>
                    Collapse
                </button>
            </div>

            <button class="expand-btn" id="expandBtn" onclick="toggleSidebar()">
                <span class="material-symbols-outlined">chevron_right</span>
            </button>

            <!-- Editor Area -->
            <div class="editor-area-wrapper" id="editorAreaWrapper">
                <div class="editor-area" id="editorArea">
                    <div class="page" id="page1">
                        <div class="watermark" id="watermark"></div>
                        <div class="page-content" contenteditable="true" id="pageContent1"></div>
                    </div>
                    <button class="add-page-btn" onclick="addNewPage()">
                        <span class="material-symbols-outlined">add</span>
                        Add New Page
                    </button>
                </div>
            </div>

            <!-- Page Indicator -->
            <div class="page-indicator" id="pageIndicator">1/1</div>
        </div>
    </div>

    <!-- Overflow Alert -->
    <div class="overflow-alert" id="overflowAlert">Page size exceeded!</div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Insert Image</h2>
                <button class="close-btn" onclick="closeModal('imageModal')">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="drop-zone" id="imageDropZone">
                    <p>Drag & Drop image here or click to select</p>
                    <input type="file" id="imageFile" accept="image/*" style="display:none" onchange="handleImageSelect(this)" />
                </div>
                <img id="imagePreview" style="max-width: 100%; margin-top: 16px; display: none; border-radius: 8px;" />
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('imageModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="insertImage()">Insert</button>
            </div>
        </div>
    </div>

    <!-- Table Modal -->
    <div class="modal" id="tableModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Insert Table</h2>
                <button class="close-btn" onclick="closeModal('tableModal')">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="sidebar-control">
                    <label>Rows</label>
                    <input type="number" id="tableRows" value="3" min="1" max="20" class="modal-input" />
                </div>
                <div class="sidebar-control">
                    <label>Columns</label>
                    <input type="number" id="tableCols" value="3" min="1" max="10" class="modal-input" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('tableModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="insertTable()">Insert</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Insert Link</h2>
                <button class="close-btn" onclick="closeModal('linkModal')">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="sidebar-control">
                    <label>Display Text</label>
                    <input type="text" id="linkText" class="modal-input" placeholder="Link text" />
                </div>
                <div class="sidebar-control">
                    <label>URL</label>
                    <input type="url" id="linkUrl" class="modal-input" placeholder="https://example.com" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('linkModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="insertLink()">Insert</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Exporting Document</h2>
            </div>
            <div class="modal-body">
                <p id="exportProgress">Preparing document...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer" id="exportActions" style="display: none;">
                <button class="modal-btn modal-btn-secondary" onclick="downloadPDF()">
                    <span class="material-symbols-outlined">download</span>
                    Download
                </button>
                <button class="modal-btn modal-btn-primary" onclick="sharePDF()">
                    <span class="material-symbols-outlined">share</span>
                    Share
                </button>
            </div>
        </div>
    </div>

    <div class="image-resize-handle" id="resizeHandle"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Global variables
        let pageCount = 1;
        let lastCursorPosition = null;
        let selectedImage = null;
        let uploadedFonts = {};
        let currentImageData = null;
        let exportedPDFBlob = null;
        let currentZoom = 100;
        let isResizing = false;
        let isDragging = false;
        let startX, startY, startWidth, startHeight;
        let currentFont = 'Arial';
        let overflowCheckInterval = null;

        // Auto-start on load
        window.onload = function() {
            showLoading();
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('editorContainer').style.display = 'flex';
                
                setupPageContentEditable();
                updatePageIndicator();
                updateWordCount();
                startOverflowCheck();
                
                document.execCommand('fontName', false, 'Arial');
                document.getElementById('editorAreaWrapper').addEventListener('scroll', updateCurrentPageNumber);
                document.addEventListener('click', handleDocumentClick);
            }, 1000);
        };

        function showLoading() {
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        function setupPageContentEditable() {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => {
                page.addEventListener('input', handleContentInput);
                page.addEventListener('paste', handlePaste);
                page.addEventListener('keyup', updateFontSizeDisplay);
                page.addEventListener('click', updateFontSizeDisplay);
            });
        }

        // Overflow Detection
        function startOverflowCheck() {
            overflowCheckInterval = setInterval(checkPageOverflow, 500);
        }

        function checkPageOverflow() {
            const pages = document.querySelectorAll('.page-content');
            let hasOverflow = false;
            
            pages.forEach(page => {
                if (page.scrollHeight > page.clientHeight) {
                    hasOverflow = true;
                }
            });
            
            const alert = document.getElementById('overflowAlert');
            if (hasOverflow) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }

        // Custom Font Dropdown Functions
        function toggleFontMenu(e) {
            if (e) e.stopPropagation();
            const menu = document.getElementById('fontMenu');
            menu.classList.toggle('active');
        }

        function selectFont(fontName, e) {
            if (e) e.stopPropagation();
            currentFont = fontName;
            document.getElementById('selectedFont').textContent = fontName;
            document.getElementById('fontMenu').classList.remove('active');
            
            document.querySelectorAll('.font-option').forEach(opt => opt.classList.remove('selected'));
            if (event && event.target) event.target.classList.add('selected');
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                changeFont(fontName);
            }
        }

        function handleDocumentClick(e) {
            if (!e.target.closest('.font-dropdown')) {
                document.getElementById('fontMenu').classList.remove('active');
            }
            
            if (e.target.tagName !== 'IMG' && !e.target.closest('.image-resize-handle')) {
                deselectImage();
            }
        }

        // Toolbar Functions
        function changeFormat(format) {
            document.execCommand('formatBlock', false, format);
        }

        function toggleFormat(command) {
            document.execCommand(command);
        }

        function changeFontSize(size) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.fontSize = size + 'px';
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    document.execCommand('fontSize', false, '7');
                    const fontElements = document.querySelectorAll('font[size="7"]');
                    fontElements.forEach(el => {
                        el.removeAttribute('size');
                        el.style.fontSize = size + 'px';
                    });
                }
            }
        }

        function increaseFontSize() {
            const current = parseInt(document.getElementById('fontSize').value);
            const newSize = Math.min(current + 2, 72);
            document.getElementById('fontSize').value = newSize;
            changeFontSize(newSize);
        }

        function decreaseFontSize() {
            const current = parseInt(document.getElementById('fontSize').value);
            const newSize = Math.max(current - 2, 8);
            document.getElementById('fontSize').value = newSize;
            changeFontSize(newSize);
        }

        function updateFontSizeDisplay() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const element = range.startContainer.parentElement;
                const fontSize = window.getComputedStyle(element).fontSize;
                document.getElementById('fontSize').value = parseInt(fontSize);
            }
        }

        function changeFont(fontFamily) {
            if (fontFamily) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontFamily = fontFamily;
                    
                    try {
                        range.surroundContents(span);
                    } catch (e) {
                        document.execCommand('fontName', false, fontFamily);
                    }
                }
            }
        }

        function uploadFont(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fontName = file.name.split('.')[0];
                    const fontFace = new FontFace(fontName, `url(${e.target.result})`);
                    
                    fontFace.load().then(loadedFont => {
                        document.fonts.add(loadedFont);
                        uploadedFonts[fontName] = e.target.result;
                        
                        const menu = document.getElementById('fontMenu');
                        const option = document.createElement('div');
                        option.className = 'font-option';
                        option.textContent = fontName;
                        option.style.fontFamily = fontName;
                        option.onclick = (e) => selectFont(fontName, e);
                        menu.appendChild(option);
                        
                        selectFont(fontName);
                    }).catch(err => {
                        console.error('Font loading failed:', err);
                        alert('Font imported and added to list.');
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        function changeTextColor(color) {
            document.execCommand('foreColor', false, color);
        }

        function changeHighlight(color) {
            document.execCommand('hiliteColor', false, color);
        }

        function clearFormatting() {
            document.execCommand('removeFormat');
            document.execCommand('unlink');
        }

        // Modal Functions
        function openImageModal() {
            saveCursorPosition();
            document.getElementById('imageModal').style.display = 'flex';
            setupImageDropZone();
        }

        function setupImageDropZone() {
            const dropZone = document.getElementById('imageDropZone');
            const fileInput = document.getElementById('imageFile');

            dropZone.onclick = () => fileInput.click();

            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            };

            dropZone.ondragleave = () => {
                dropZone.classList.remove('dragover');
            };

            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    displayImagePreview(file);
                }
            };
        }

        function handleImageSelect(input) {
            const file = input.files[0];
            if (file) {
                displayImagePreview(file);
            }
        }

        function displayImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                const preview = document.getElementById('imagePreview');
                preview.src = currentImageData;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function insertImage() {
            if (currentImageData) {
                restoreCursorPosition();
                const img = document.createElement('img');
                img.src = currentImageData;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.cursor = 'move';
                img.draggable = false;
                
                img.addEventListener('mousedown', (e) => startImageDrag(e, img));
                img.addEventListener('touchstart', (e) => startImageDrag(e, img));
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectImage(img);
                });
                
                insertAtCursor(img);
                
                closeModal('imageModal');
                currentImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imageFile').value = '';
            }
        }

        function selectImage(img) {
            if (selectedImage) {
                selectedImage.classList.remove('selected');
            }
            selectedImage = img;
            img.classList.add('selected');
            showResizeHandle(img);
        }

        function deselectImage() {
            if (selectedImage) {
                selectedImage.classList.remove('selected');
                selectedImage = null;
                hideResizeHandle();
            }
        }

        function showResizeHandle(img) {
            const handle = document.getElementById('resizeHandle');
            const rect = img.getBoundingClientRect();
            handle.style.display = 'block';
            handle.style.left = (rect.right - 6) + 'px';
            handle.style.top = (rect.bottom - 6) + 'px';
            
            handle.onmousedown = (e) => startResize(e, img);
            handle.ontouchstart = (e) => startResize(e, img);
        }

        function hideResizeHandle() {
            document.getElementById('resizeHandle').style.display = 'none';
        }

        function updateResizeHandle() {
            if (selectedImage) {
                const rect = selectedImage.getBoundingClientRect();
                const handle = document.getElementById('resizeHandle');
                handle.style.left = (rect.right - 6) + 'px';
                handle.style.top = (rect.bottom - 6) + 'px';
            }
        }

        function startResize(e, img) {
            e.preventDefault();
            e.stopPropagation();
            isResizing = true;
            
            const touch = e.touches ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            startWidth = img.offsetWidth;
            startHeight = img.offsetHeight;
            
            const moveHandler = (e) => resizeImage(e, img);
            const endHandler = () => {
                isResizing = false;
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', endHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', endHandler);
            };
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', endHandler);
            document.addEventListener('touchmove', moveHandler);
            document.addEventListener('touchend', endHandler);
        }

        function resizeImage(e, img) {
            if (!isResizing) return;
            
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - startX;
            const deltaY = touch.clientY - startY;
            
            const newWidth = startWidth + deltaX;
            
            if (newWidth > 50) {
                img.style.width = newWidth + 'px';
                img.style.height = 'auto';
            }
            
            updateResizeHandle();
        }

        function startImageDrag(e, img) {
            e.preventDefault();
            e.stopPropagation();
            
            selectImage(img);
            isDragging = true;
            
            const touch = e.touches ? e.touches[0] : e;
            const rect = img.getBoundingClientRect();
            
            startX = touch.clientX;
            startY = touch.clientY;
            
            const initialLeft = img.offsetLeft;
            const initialTop = img.offsetTop;
            
            img.classList.add('dragging');
            img.style.position = 'absolute';
            img.style.left = initialLeft + 'px';
            img.style.top = initialTop + 'px';
            img.style.zIndex = '1000';
            
            const moveHandler = (e) => dragImage(e, img, startX, startY, initialLeft, initialTop);
            const endHandler = () => {
                isDragging = false;
                img.classList.remove('dragging');
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', endHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', endHandler);
            };
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', endHandler);
            document.addEventListener('touchmove', moveHandler);
            document.addEventListener('touchend', endHandler);
        }

        function dragImage(e, img, origStartX, origStartY, origLeft, origTop) {
            if (!isDragging) return;
            
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            
            const deltaX = touch.clientX - origStartX;
            const deltaY = touch.clientY - origStartY;
            
            img.style.left = (origLeft + deltaX) + 'px';
            img.style.top = (origTop + deltaY) + 'px';
            
            updateResizeHandle();
        }

        document.addEventListener('scroll', updateResizeHandle, true);

        function openTableModal() {
            saveCursorPosition();
            document.getElementById('tableModal').style.display = 'flex';
        }

        function insertTable() {
            const rows = parseInt(document.getElementById('tableRows').value);
            const cols = parseInt(document.getElementById('tableCols').value);
            
            let tableHTML = '<table><tbody>';
            for (let i = 0; i < rows; i++) {
                tableHTML += '<tr>';
                for (let j = 0; j < cols; j++) {
                    tableHTML += '<td>&nbsp;</td>';
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table>';
            
            restoreCursorPosition();
            document.execCommand('insertHTML', false, tableHTML);
            closeModal('tableModal');
        }

        function openLinkModal() {
            saveCursorPosition();
            const selection = window.getSelection();
            if (selection.toString()) {
                document.getElementById('linkText').value = selection.toString();
            }
            document.getElementById('linkModal').style.display = 'flex';
        }

        function insertLink() {
            const text = document.getElementById('linkText').value;
            const url = document.getElementById('linkUrl').value;
            
            if (text && url) {
                restoreCursorPosition();
                const link = `<a href="${url}" target="_blank">${text}</a>`;
                document.execCommand('insertHTML', false, link);
                closeModal('linkModal');
                document.getElementById('linkText').value = '';
                document.getElementById('linkUrl').value = '';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Cursor position management
        function saveCursorPosition() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                lastCursorPosition = selection.getRangeAt(0).cloneRange();
            }
        }

        function restoreCursorPosition() {
            if (lastCursorPosition) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(lastCursorPosition);
            }
        }

        function insertAtCursor(element) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.insertNode(element);
                range.setStartAfter(element);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        // Paste handling
        function handlePaste(e) {
            const items = e.clipboardData.items;
            
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.maxWidth = '100%';
                        img.style.cursor = 'move';
                        img.draggable = false;
                        
                        img.addEventListener('mousedown', (e) => startImageDrag(e, img));
                        img.addEventListener('touchstart', (e) => startImageDrag(e, img));
                        img.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectImage(img);
                        });
                        
                        insertAtCursor(img);
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        }

        // Sidebar Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                expandBtn.style.display = 'none';
            } else {
                sidebar.classList.add('collapsed');
                expandBtn.style.display = 'block';
            }
        }

        function updateWatermark() {
            const text = document.getElementById('watermarkText').value;
            const watermarks = document.querySelectorAll('.watermark');
            watermarks.forEach(w => w.textContent = text);
        }

        function updateLineSpacing(value) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.style.lineHeight = value);
        }

        function toggleGradient(type) {
            const controls = document.getElementById('gradientControls');
            if (type === 'gradient') {
                controls.classList.add('active');
            } else {
                controls.classList.remove('active');
            }
            updateBackground();
        }

        function updateBackground() {
            const type = document.getElementById('bgType').value;
            const color1 = document.getElementById('bgColor').value;
            const pages = document.querySelectorAll('.page');
            
            if (type === 'solid') {
                pages.forEach(page => page.style.background = color1);
            } else {
                const color2 = document.getElementById('bgColor2').value;
                const angle = document.getElementById('gradientAngle').value;
                pages.forEach(page => {
                    page.style.background = `linear-gradient(${angle}deg, ${color1}, ${color2})`;
                });
            }
        }

        function updateMargins(value) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.padding = value + 'cm');
        }

        // Page Management
        function addNewPage() {
            pageCount++;
            const editorArea = document.getElementById('editorArea');
            const addBtn = editorArea.querySelector('.add-page-btn');
            
            const newPage = document.createElement('div');
            newPage.className = 'page';
            newPage.id = 'page' + pageCount;
            newPage.innerHTML = `
                <div class="watermark" id="watermark${pageCount}"></div>
                <div class="page-content" contenteditable="true" id="pageContent${pageCount}"></div>
            `;
            
            editorArea.insertBefore(newPage, addBtn);
            setupPageContentEditable();
            updatePageIndicator();
            updateWatermark();
            updateBackground();
            updateMargins(document.getElementById('pageMargin').value);
            updateLineSpacing(document.getElementById('lineSpacing').value);
        }

        function updatePageIndicator() {
            updateCurrentPageNumber();
        }

        function updateCurrentPageNumber() {
            const wrapper = document.getElementById('editorAreaWrapper');
            const pages = document.querySelectorAll('.page');
            const scrollTop = wrapper.scrollTop;
            const viewportMiddle = scrollTop + (wrapper.clientHeight / 2);
            
            let currentPage = 1;
            let accumulatedHeight = 40;
            
            for (let i = 0; i < pages.length; i++) {
                const pageHeight = pages[i].offsetHeight + 20;
                accumulatedHeight += pageHeight;
                
                if (viewportMiddle < accumulatedHeight) {
                    currentPage = i + 1;
                    break;
                }
            }
            
            document.getElementById('pageIndicator').textContent = `${currentPage}/${pageCount}`;
        }

        // Word Count
        function handleContentInput() {
            updateWordCount();
        }

        function updateWordCount() {
            const pages = document.querySelectorAll('.page-content');
            let totalText = '';
            pages.forEach(page => {
                totalText += page.textContent + ' ';
            });
            const words = totalText.trim().split(/\s+/).filter(w => w.length > 0);
            document.getElementById('wordCount').textContent = words.length + ' words';
        }

        // Zoom Functions
        function adjustZoom(delta) {
            currentZoom = Math.max(30, Math.min(200, currentZoom + delta));
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 100;
            applyZoom();
        }

        function applyZoom() {
            const editorArea = document.getElementById('editorArea');
            editorArea.style.transform = `scale(${currentZoom / 100})`;
            document.getElementById('zoomDisplay').textContent = currentZoom + '%';
            updateResizeHandle();
        }

        // Export to PDF - Convert pages to images first
        async function exportDocument() {
            document.getElementById('exportModal').style.display = 'flex';
            document.getElementById('exportActions').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('exportProgress').textContent = 'Preparing document...';

            setTimeout(generatePDF, 300);
        }

async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    const pages = document.querySelectorAll('.page');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('exportProgress');

    // Temporarily reset zoom for consistent rendering
    const originalZoom = currentZoom;
    currentZoom = 100;
    applyZoom();

    // Give the browser time to repaint at 100% zoom
    await new Promise(resolve => setTimeout(resolve, 200));

    for (let i = 0; i < pages.length; i++) {
        progressText.textContent = `Rendering page ${i + 1} of ${pages.length}...`;
        progressFill.style.width = ((i / pages.length) * 100) + '%';

        // Render directly from the live page element (no cloning off-screen)
        // html2canvas captures the element as-is; cloning broke multi-page exports
        const canvas = await html2canvas(pages[i], {
            scale: 3,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            logging: false,
            imageTimeout: 0,
            letterRendering: true
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        // A4 dimensions in mm
        const pdfWidth = 210;
        const pdfHeight = 297;

        if (i > 0) pdf.addPage();
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, '', 'SLOW');
    }

    // Restore original zoom
    currentZoom = originalZoom;
    applyZoom();

    progressFill.style.width = '100%';
    progressText.textContent = 'Export complete!';

    exportedPDFBlob = pdf.output('blob');
    document.getElementById('exportActions').style.display = 'flex';
}

    function downloadPDF() {
        if (!exportedPDFBlob) return;

        const url = URL.createObjectURL(exportedPDFBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = document.getElementById('docTitle').value + '.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        // Delay revoke so the browser has time to start the download
        setTimeout(() => URL.revokeObjectURL(url), 10000);
        closeModal('exportModal');
    }

    async function sharePDF() {
        if (exportedPDFBlob && navigator.share) {
            const file = new File([exportedPDFBlob], document.getElementById('docTitle').value + '.pdf', { 
                type: 'application/pdf' 
            });

            try {
                await navigator.share({
                    title: document.getElementById('docTitle').value,
                    text: 'Shared from Sugercane',
                    files: [file]
                });
                closeModal('exportModal');
            } catch (err) {
                console.warn('Share cancelled or failed:', err);
            }
        } else {
            alert('Sharing is not supported on this device. Please download the PDF instead.');
        }
    }

    // Close modal on Escape key
    window.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }
    });

    // Close export modal on outside click
    document.addEventListener('click', e => {
        const modal = document.getElementById('exportModal');
        if (modal.style.display !== 'none' && 
            !e.target.closest('#exportModal .modal-content') && 
            !e.target.closest('[onclick*="exportDocument"]')) {
            modal.style.display = 'none';
        }
    });

    // Global font sync
    setInterval(() => {
        document.querySelectorAll('.page-content').forEach(p => {
            p.style.fontFamily = document.getElementById('selectedFont').textContent;
        });
    }, 1000);

    // Error handling
    window.onerror = function (msg, url, line) {
        console.error('Sugercane error:', msg, 'at', line);
    };
</script>
<script>window.onbeforeunload=()=>true;</script>
<script>
(() => {
  // Updated Storage Key for Sugercane Editor
  const STORAGE_KEY = "docuwritepro_sugercane_editor_guide_seen";
  if (localStorage.getItem(STORAGE_KEY)) return;

  const tips = [
    "Welcome to Sugercane Editor! This tool features a sleek, paginated interface designed for focused document creation.",
    "The floating 'Magic Toolbar' at the top gives you quick access to text formatting, font selection, and page management.",
    "Need more space? Click '+ Add New Page' in the floating menu to create a fresh A4-sized canvas instantly.",
    "Hide the sidebar by clicking the collapse button, or want to open it again? Click the expand icon.",
    "To customize your typography, click the Font name in the toolbar to cycle through available fonts. Or click the '+' icon to upload a font of your own.",
    "Use the 'Alignment' buttons to switch between Left, Center, and Right-aligned text for headers or body copy.",
    "The editor tracks your progress automatically; notice the 'Page Count' in the sidebar to keep an eye on your document length.",
    "When you're ready to share, click the 'Export' icon. You can choose to download a PDF or use the mobile-friendly 'Share' option.",
    "Use the 'Document Title' field at the top to name your project. This title will be used as the filename when you export.",
    "Sugercane is designed as a light version of the default DocuWrite Pro Editor, for all features, use the default editor."
  ];

  let index = 0;
  let direction = 1;

  /* Container */
  const box = document.createElement("div");
  box.id = "dwp-tip-box";
  box.innerHTML = `
    <div class="dwp-progress">
      <div class="dwp-progress-bar"></div>
    </div>

    <div class="dwp-tip-wrapper">
      <div class="dwp-tip-text"></div>
    </div>

    <div class="dwp-actions">
      <button class="dwp-prev">Back</button>
      <button class="dwp-next">Next</button>
    </div>
  `;
  document.body.appendChild(box);

  const textEl = box.querySelector(".dwp-tip-text");
  const nextBtn = box.querySelector(".dwp-next");
  const prevBtn = box.querySelector(".dwp-prev");
  const progressBar = box.querySelector(".dwp-progress-bar");

  function updateTip(animate = true) {
    if (animate) {
      textEl.classList.remove("slide-in-left", "slide-in-right");
      void textEl.offsetWidth;
      textEl.classList.add(direction > 0 ? "slide-in-right" : "slide-in-left");
    }

    textEl.textContent = tips[index];
    progressBar.style.width = `${((index + 1) / tips.length) * 100}%`;

    prevBtn.style.visibility = index === 0 ? "hidden" : "visible";
    nextBtn.textContent = index === tips.length - 1 ? "Got it" : "Next";
  }

  nextBtn.onclick = () => {
    if (index === tips.length - 1) {
      localStorage.setItem(STORAGE_KEY, "true");
      box.classList.add("fade-out");
      setTimeout(() => box.remove(), 300);
    } else {
      direction = 1;
      index++;
      updateTip();
    }
  };

  prevBtn.onclick = () => {
    if (index > 0) {
      direction = -1;
      index--;
      updateTip();
    }
  };

  setTimeout(() => {
    box.classList.add("show");
    updateTip(false);
  }, 1000);

  /* Styles */
  const style = document.createElement("style");
  style.textContent = `
    #dwp-tip-box {
      position: fixed;
      bottom: 100px; /* Positioned above the Sugercane floating toolbar */
      right: 25px;
      width: 300px;
      background: #1976d2; /* Matched to Sugercane's primary blue */
      color: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(25, 118, 210, 0.3);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      z-index: 10001;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .3s ease, transform .3s ease;
      border: 1px solid rgba(255,255,255,0.2);
    }

    #dwp-tip-box.show {
      opacity: 1;
      transform: translateY(0);
    }

    #dwp-tip-box.fade-out {
      opacity: 0;
      transform: translateY(10px);
    }

    .dwp-progress {
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 99px;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .dwp-progress-bar {
      height: 100%;
      width: 0%;
      background: #ffffff;
      transition: width .35s ease;
    }

    .dwp-tip-wrapper {
      overflow: hidden;
      min-height: 70px;
      display: flex;
      align-items: center;
    }

    .dwp-tip-text {
      font-size: 14px;
      line-height: 1.5;
      font-weight: 500;
    }

    .slide-in-right {
      animation: slideRight .25s ease;
    }

    .slide-in-left {
      animation: slideLeft .25s ease;
    }

    @keyframes slideRight {
      from { opacity: 0; transform: translateX(12px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideLeft {
      from { opacity: 0; transform: translateX(-12px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .dwp-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      gap: 10px;
    }

    .dwp-actions button {
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      flex: 1;
      transition: background 0.2s, transform 0.1s;
    }

    .dwp-actions button:active {
      transform: scale(0.96);
    }

    .dwp-prev {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .dwp-next {
      background: #ffffff;
      color: #1976d2;
    }
  `;
  document.head.appendChild(style);
})();
</script>
<script>
/**
 * Template Serialization & Hydration Logic
 */

// 1. Add the UI components to the sidebar dynamically
function injectTemplateUI() {
    const sidebar = document.getElementById('sidebar');
    const templateSection = document.createElement('div');
    templateSection.className = 'sidebar-section';
    templateSection.innerHTML = `
        <div class="sidebar-title">Template Sharing</div>
        <div class="sidebar-control">
            <button class="zoom-btn" onclick="shareTemplate('open')" style="width: 100%; margin-bottom: 8px;">
                <span class="material-symbols-outlined" style="font-size: 18px;">open_in_new</span>
                Open Template Link
            </button>
            <button class="zoom-btn" onclick="shareTemplate('copy')" style="width: 100%;">
                <span class="material-symbols-outlined" style="font-size: 18px;">content_copy</span>
                Copy Template Link
            </button>
        </div>
    `;
    // Insert before the Word Count section
    const wordCountSection = document.getElementById('wordCount').parentElement;
    sidebar.insertBefore(templateSection, wordCountSection);
}

// 2. Encode the Editor state into a Base64 string
function generateTemplateURL() {
    const templateData = {
        title: document.getElementById('docTitle').value,
        settings: {
            margin: document.getElementById('pageMargin').value,
            bgType: document.getElementById('bgType').value,
            bgColor: document.getElementById('bgColor').value,
            bgColor2: document.getElementById('bgColor2').value,
            angle: document.getElementById('gradientAngle').value,
            spacing: document.getElementById('lineSpacing').value,
            font: document.getElementById('selectedFont').textContent
        },
        // Capture innerHTML of all pages
        pages: Array.from(document.querySelectorAll('.page-content')).map(p => p.innerHTML)
    };

    const jsonStr = JSON.stringify(templateData);
    // Use b64 with UTF-8 support to handle special characters/emojis in text
    const encoded = btoa(unescape(encodeURIComponent(jsonStr)));
    const baseUrl = window.location.origin + window.location.pathname;
    return `${baseUrl}#TMP=${encoded}`;
}

// 3. UI Handler for the buttons
function shareTemplate(mode) {
    const url = generateTemplateURL();
    if (url.length > 8000) {
        alert("Warning: This template is very large (likely due to images). It may not work in all browsers.");
    }
    
    if (mode === 'open') {
        window.open(url, '_blank');
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert("Template link copied to clipboard!");
        });
    }
}

// 4. Decode the URL and overwrite editor state
function loadTemplateFromHash() {
    const hash = window.location.hash;
    if (!hash.startsWith('#TMP=')) return;

    try {
        const encodedData = hash.substring(5);
        // Proper UTF-8 aware base64 decode (replaces deprecated escape/unescape pattern)
        const bytes = Uint8Array.from(atob(encodedData), c => c.charCodeAt(0));
        const jsonStr = new TextDecoder().decode(bytes);
        const data = JSON.parse(jsonStr);

        // Restore Document Title
        document.getElementById('docTitle').value = data.title;

        // Restore Sidebar Settings
        document.getElementById('pageMargin').value = data.settings.margin;
        document.getElementById('bgType').value = data.settings.bgType;
        document.getElementById('bgColor').value = data.settings.bgColor;
        document.getElementById('bgColor2').value = data.settings.bgColor2;
        document.getElementById('gradientAngle').value = data.settings.angle;
        document.getElementById('lineSpacing').value = data.settings.spacing;
        document.getElementById('selectedFont').textContent = data.settings.font;

        // Clear existing pages and rebuild from template
        const editorArea = document.getElementById('editorArea');
        document.querySelectorAll('.page').forEach(p => p.remove());
        
        // Reset global pageCount from original script
        pageCount = 0; 

        data.pages.forEach((content, index) => {
            addNewPage(); // Existing function in sceditor.html
            const newContentArea = document.getElementById(`pageContent${index + 1}`);
            newContentArea.innerHTML = content;
        });

        // Trigger visual updates
        updateMargins(data.settings.margin);
        updateBackground();
        updateLineSpacing(data.settings.spacing);
        updateWordCount();
        
        // Clear the hash to prevent re-loading on refresh
        window.history.replaceState(null, null, ' ');
        
    } catch (e) {
        console.error("Template Load Error:", e);
        alert("Failed to load template. The link may be corrupted.");
    }
}

// Initialize on load
(function initTemplateSystem() {
    // Wait for the main sceditor app to finish its internal loading
    const checkReady = setInterval(() => {
        if (document.getElementById('sidebar')) {
            clearInterval(checkReady);
            injectTemplateUI();
            loadTemplateFromHash();
        }
    }, 100);
})();
</script>
<script>
(function() {
    // 1. Define Pure Black (OLED) Theme CSS
    const pureBlackStyles = `
        /* Main UI Backgrounds */
        body.dark-mode, 
        body.dark-mode #editorContainer, 
        body.dark-mode .editor-area-wrapper { background: #000000 !important; }
        
        body.dark-mode .top-bar, 
        body.dark-mode .toolbar, 
        body.dark-mode .sidebar { 
            background: #000000; 
            border-bottom: 1px solid #333; 
            border-right: 1px solid #333; 
            color: #ffffff; 
        }

        /* Inputs & Page Background Selector Fix */
        body.dark-mode #docTitle,
        body.dark-mode select, 
        body.dark-mode input:not([type="color"]), 
        body.dark-mode .font-selector { 
            background: #111 !important; 
            color: #fff !important; 
            border: 1px solid #444 !important; 
        }
        
        /* Sidebar Titles and Labels */
        body.dark-mode .sidebar-title,
        body.dark-mode .sidebar-control label,
        body.dark-mode .loading-text,
        body.dark-mode #wordCount { color: #aaa !important; }

        /* Buttons: Toolbar & Sidebar Collapse/Expand */
        body.dark-mode .toolbar-btn .material-symbols-outlined,
        body.dark-mode .collapse-btn .material-symbols-outlined,
        body.dark-mode .expand-btn .material-symbols-outlined { color: #fff; }

        body.dark-mode .collapse-btn, 
        body.dark-mode .expand-btn,
        body.dark-mode .zoom-btn,
        body.dark-mode .upload-font-btn { 
            background: #111 !important; 
            color: #fff !important; 
            border: 1px solid #444 !important; 
        }

        /* Hover States - Fixed to dark gray so text remains visible */
        body.dark-mode .toolbar-btn:hover,
        body.dark-mode .collapse-btn:hover,
        body.dark-mode .zoom-btn:hover,
        body.dark-mode .upload-font-btn:hover,
        body.dark-mode .font-option:hover { 
            background: #333 !important; 
        }

        /* Add New Page Button - Pure Black Style */
        body.dark-mode .add-page-btn { 
            background: #000 !important; 
            border: 2px dashed #444 !important; 
            color: #888 !important; 
        }
        body.dark-mode .add-page-btn:hover { background: #111 !important; border-color: #1976d2 !important; color: #fff !important; }

        /* Modals & Drop Zones */
        body.dark-mode .modal-content { background: #000; border: 1px solid #333; color: #fff; }
        body.dark-mode .drop-zone { background: #111 !important; border-color: #444 !important; color: #888; }
        body.dark-mode .drop-zone:hover { border-color: #1976d2 !important; color: #fff; }
        body.dark-mode .modal-input { background: #111; color: #fff; border: 1px solid #444; }
        
        /* Dropdown Menus */
        body.dark-mode .font-menu { background: #111; border: 1px solid #444; }
        
        /* Theme Icon Button (No BG) */
        .theme-toggle-icon {
            background: none !important;
            border: none !important;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            margin-right: 12px;
            color: #1976d2; /* Primary blue for light mode visibility */
        }
        body.dark-mode .theme-toggle-icon { color: #ffffff; }
    `;

    const styleSheet = document.createElement("style");
    styleSheet.textContent = pureBlackStyles;
    document.head.appendChild(styleSheet);

    // 2. Inject the Theme Icon Button
    const topBar = document.querySelector('.top-bar');
    const docTitle = document.getElementById('docTitle');
    
    // Create a container for title + theme toggle
    const titleGroup = document.createElement('div');
    titleGroup.style.display = 'flex';
    titleGroup.style.alignItems = 'center';
    
    const themeBtn = document.createElement('button');
    themeBtn.className = 'theme-toggle-icon';
    themeBtn.innerHTML = `<span class="material-symbols-outlined">dark_mode</span>`;
    
    // Position it besides the Export button area
    const exportBtn = document.querySelector('.export-btn');
    topBar.insertBefore(themeBtn, exportBtn);

    // 3. Theme Toggle & Memory Logic
    const themeIcon = themeBtn.querySelector('.material-symbols-outlined');
    
    const applyTheme = (isDark) => {
        if (isDark) {
            document.body.classList.add('dark-mode');
            themeIcon.textContent = 'light_mode';
        } else {
            document.body.classList.remove('dark-mode');
            themeIcon.textContent = 'dark_mode';
        }
    };

    const toggleTheme = () => {
        const isCurrentlyDark = document.body.classList.contains('dark-mode');
        const newState = !isCurrentlyDark;
        localStorage.setItem('sceditor-theme', newState ? 'dark' : 'light');
        applyTheme(newState);
    };

    // Load saved preference on startup
    const savedTheme = localStorage.getItem('sceditor-theme');
    applyTheme(savedTheme === 'dark');

    themeBtn.addEventListener('click', toggleTheme);
})();
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

    // These are the only elements that must scroll instead of compress/wrap
    const horizontalScrollElements = [
        ".top-bar",
        ".toolbar"
    ];

    horizontalScrollElements.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            el.style.overflowX = "auto";
            el.style.overflowY = "hidden";
            el.style.flexWrap = "nowrap";   // prevents multi-line issues
            el.style.display = "flex";      // keeps original layout
            el.style.alignItems = "center"; // fixes stretched elements
        });
    });

});
                </script>
    <script>
(function() {
    // 1. Add the Searchable Font Modal to the body
    const fontModalHTML = `
    <div class="modal" id="searchableFontModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select Font</h2>
                <button class="close-btn" onclick="closeModal('searchableFontModal')">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="sidebar-control">
                    <input type="text" id="fontSearchInput" class="modal-input" placeholder="Search fonts..." style="margin-bottom: 15px;">
                </div>
                <div id="fontListContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                    </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('searchableFontModal')">Cancel</button>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', fontModalHTML);

    // 2. Override the existing toggleFontMenu function
    window.toggleFontMenu = function(e) {
        if (e) e.stopPropagation();
        openFontModal();
    };

    function openFontModal() {
        const modal = document.getElementById('searchableFontModal');
        const container = document.getElementById('fontListContainer');
        const searchInput = document.getElementById('fontSearchInput');
        
        // Clear search
        searchInput.value = '';
        modal.style.display = 'flex';
        
        renderFontList();
        searchInput.focus();

        // Add search listener
        searchInput.oninput = function() {
            renderFontList(this.value.toLowerCase());
        };
    }

    function renderFontList(filter = '') {
        const container = document.getElementById('fontListContainer');
        container.innerHTML = '';
        
        // Combine default fonts with uploaded ones
        const defaultFonts = ['Arial'];
        const customFonts = Object.keys(uploadedFonts || {});
        const allFonts = [...new Set([...defaultFonts, ...customFonts])].sort();

        allFonts.forEach(font => {
            if (font.toLowerCase().includes(filter)) {
                const item = document.createElement('div');
                item.className = 'font-option';
                item.style.fontFamily = font;
                item.style.padding = '12px 16px';
                item.style.cursor = 'pointer';
                item.style.borderBottom = '1px solid #f0f0f0';
                item.textContent = font;
                
                if (document.getElementById('selectedFont').textContent === font) {
                    item.style.background = '#bbdefb';
                    item.style.fontWeight = 'bold';
                }

                item.onclick = function() {
                    selectFont(font);
                    closeModal('searchableFontModal');
                };
                
                container.appendChild(item);
            }
        });

        if (container.innerHTML === '') {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No fonts found</div>';
        }
    }

    // 3. Optional: Add hover styling for the list items via JS if not in CSS
    const style = document.createElement('style');
    style.textContent = `
        #fontListContainer .font-option:hover {
            background-color: #e3f2fd !important;
        }
        body.dark-mode #fontListContainer {
            border-color: #444;
        }
        body.dark-mode #fontListContainer .font-option {
            border-bottom: 1px solid #222;
            color: #fff;
        }
        body.dark-mode #fontListContainer .font-option:hover {
            background-color: #333 !important;
        }
    `;
    document.head.appendChild(style);
})();
</script>
    <script>document.head.insertAdjacentHTML('beforeend', '<style>body.dark-mode #selectedFont, body.dark-mode .font-option, body.dark-mode .modal-title { color: #ffffff !important; }</style>');</script>
    <script>
(function() {
    //  State 
    let exportFormat = 'pdf'; // 'pdf' | 'scd'

    //  Inject styles (dynamic values handled at runtime, not bake-time) 
    const style = document.createElement('style');
    style.textContent = `
        .import-btn { transition: all 0.2s; }
        .import-btn:hover { background: #1976D2 !important; transform: translateY(-1px); }
        #formatBtn:hover { background: #00ACC1 !important; transform: translateY(-1px); }
        body.dark-mode .import-btn { background: #1565C0 !important; }
        body.dark-mode .import-btn:hover { background: #0D47A1 !important; }
        body.dark-mode #formatBtn { background: #0097A7 !important; }
        body.dark-mode #formatBtn:hover { background: #00838F !important; }
        .format-option-btn { transition: all 0.2s; }
        .format-option-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        body.dark-mode .format-option-btn { background: #222 !important; color: #fff !important; border-color: #444 !important; }
        body.dark-mode .toast-notification { background: #333 !important; border: 1px solid #444; }
    `;
    document.head.appendChild(style);

    //  Init on page load 
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initImportExportUI, 500);
    });

    //  UI Init 
    function initImportExportUI() {
        const topBar = document.querySelector('.top-bar');
        const exportBtn = document.querySelector('.export-btn');

        const container = document.createElement('div');
        container.style.cssText = 'display:flex;align-items:center;gap:12px;margin-right:12px;';

        // Import button  always visible so users can always import
        const importBtn = document.createElement('button');
        importBtn.id = 'importBtn';
        importBtn.className = 'import-btn';
        importBtn.style.cssText = 'background:#1E88E5;color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;';
        importBtn.innerHTML = '<span class="material-symbols-outlined">upload</span>Import';
        importBtn.onclick = openImportModal;

        // Format button  shown when there is content
        const formatBtn = document.createElement('button');
        formatBtn.id = 'formatBtn';
        formatBtn.className = 'import-btn';
        formatBtn.style.cssText = 'background:#00BCD4;color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;display:none;align-items:center;gap:8px;font-size:14px;';
        formatBtn.onclick = openFormatModal;

        container.appendChild(importBtn);
        container.appendChild(formatBtn);
        topBar.insertBefore(container, exportBtn);

        updateFormatButton();
        checkContentState();

        // Observe the whole editor area for any content changes
        const editorArea = document.getElementById('editorArea');
        if (editorArea) {
            const observer = new MutationObserver(checkContentState);
            observer.observe(editorArea, { childList: true, subtree: true, characterData: true });
        }
    }

    function hasRealContent() {
        const pages = document.querySelectorAll('.page-content');
        for (const page of pages) {
            const text = page.textContent.trim();
            if (text.length > 0) return true;
            if (page.querySelector('img, table')) return true;
        }
        return false;
    }

    function checkContentState() {
        const formatBtn = document.getElementById('formatBtn');
        if (!formatBtn) return;
        formatBtn.style.display = hasRealContent() ? 'flex' : 'none';
    }

    // Keep format button text in sync with current selection
    function updateFormatButton() {
        const formatBtn = document.getElementById('formatBtn');
        if (formatBtn) {
            formatBtn.innerHTML = `<span class="material-symbols-outlined">file_present</span>Format: ${exportFormat.toUpperCase()}`;
        }
    }

    //  Format Modal 
    function openFormatModal() {
        // Remove any existing format modal
        const existing = document.getElementById('formatModal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'formatModal';
        modal.style.display = 'flex';

        function btnStyle(fmt) {
            const active = exportFormat === fmt;
            return `background:${active ? '#1976d2' : '#f5f5f5'};color:${active ? 'white' : '#333'};
                    padding:16px;border-radius:12px;border:2px solid ${active ? '#1565c0' : '#e0e0e0'};
                    font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;
                    justify-content:center;gap:12px;width:100%;`;
        }

        modal.innerHTML = `
            <div class="modal-content" style="max-width:400px;text-align:center;">
                <div class="modal-header">
                    <h2 class="modal-title">Choose Export Format</h2>
                    <button class="close-btn" id="formatModalClose">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="display:flex;flex-direction:column;gap:16px;margin:24px 0;">
                        <button class="format-option-btn" data-format="pdf" style="${btnStyle('pdf')}">
                            <span class="material-symbols-outlined">picture_as_pdf</span>
                            PDF Document
                            <span style="font-size:14px;opacity:0.8;">(Standard)</span>
                        </button>
                        <button class="format-option-btn" data-format="scd" style="${btnStyle('scd')}">
                            <span class="material-symbols-outlined">description</span>
                            Sugercane Document
                            <span style="font-size:14px;opacity:0.8;">(.scd)</span>
                        </button>
                    </div>
                    <div style="margin-top:24px;padding-top:16px;border-top:1px solid #e0e0e0;">
                        <p id="formatDesc" style="color:#666;font-size:14px;margin-bottom:16px;"></p>
                        <div style="display:flex;gap:12px;justify-content:center;">
                            <button class="modal-btn modal-btn-secondary" id="formatCancelBtn" style="padding:10px 24px;">Cancel</button>
                            <button class="modal-btn modal-btn-primary" id="formatConfirmBtn" style="padding:10px 24px;">Confirm &amp; Export</button>
                        </div>
                    </div>
                </div>
            </div>`;

        document.body.appendChild(modal);

        const descEl = modal.querySelector('#formatDesc');
        function refreshDesc() {
            descEl.textContent = exportFormat === 'pdf'
                ? 'PDF: Best for printing and sharing. Cannot be re-edited.'
                : 'SCD: Save your work in Sugercane format for future editing.';
        }
        refreshDesc();

        modal.querySelectorAll('.format-option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                exportFormat = this.getAttribute('data-format');
                modal.querySelectorAll('.format-option-btn').forEach(b => {
                    const active = b.getAttribute('data-format') === exportFormat;
                    b.style.background = active ? '#1976d2' : '#f5f5f5';
                    b.style.color = active ? 'white' : '#333';
                    b.style.borderColor = active ? '#1565c0' : '#e0e0e0';
                });
                updateFormatButton();
                refreshDesc();
            });
        });

        modal.querySelector('#formatModalClose').onclick = () => modal.remove();
        modal.querySelector('#formatCancelBtn').onclick = () => modal.remove();
        modal.querySelector('#formatConfirmBtn').onclick = () => {
            modal.remove();
            triggerExport();
        };

        modal.addEventListener('keydown', e => {
            if (e.key === 'Escape') modal.remove();
            if (e.key === 'Enter') { modal.remove(); triggerExport(); }
        });
    }

    //  Export dispatch 
    // triggerExport is called when the user confirms in the format modal,
    // OR directly when clicking the main Export button (which may bypass the modal).
    function triggerExport() {
        if (exportFormat === 'scd') {
            exportSCD();
        } else {
            // Call the original PDF export that was defined earlier in the page
            if (typeof window._originalExportDocument === 'function') {
                window._originalExportDocument();
            } else {
                // Fallback: store original and call it
                window._originalExportDocument = window.exportDocument;
                window._originalExportDocument();
            }
        }
    }

    // Patch the global exportDocument so the top-bar Export button routes through
    // our format dispatch. We save the original once and never overwrite again.
    (function patchExportDocument() {
        const orig = window.exportDocument;
        if (typeof orig !== 'function') {
            // Not yet defined  try again shortly
            setTimeout(patchExportDocument, 200);
            return;
        }
        window._originalExportDocument = orig;
        window.exportDocument = function() {
            // If SCD is selected, go straight to SCD export
            if (exportFormat === 'scd') {
                exportSCD();
            } else {
                orig();
            }
        };
    })();

    //  SCD Export 
    function exportSCD() {
        const exportBtn = document.querySelector('.export-btn');
        const originalHTML = exportBtn ? exportBtn.innerHTML : '';

        try {
            if (exportBtn) {
                exportBtn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span> Exporting...';
                exportBtn.disabled = true;
            }

            const templateData = {
                title: document.getElementById('docTitle').value || 'Untitled Document',
                settings: {
                    margin: document.getElementById('pageMargin')?.value ?? '2',
                    bgType: document.getElementById('bgType')?.value ?? 'solid',
                    bgColor: document.getElementById('bgColor')?.value ?? '#ffffff',
                    bgColor2: document.getElementById('bgColor2')?.value ?? '#ffffff',
                    angle: document.getElementById('gradientAngle')?.value ?? '135',
                    spacing: document.getElementById('lineSpacing')?.value ?? '1.6',
                    font: document.getElementById('selectedFont')?.textContent ?? 'Arial',
                    zoom: typeof currentZoom !== 'undefined' ? currentZoom : 100,
                    watermark: document.getElementById('watermarkText')?.value ?? ''
                },
                pages: Array.from(document.querySelectorAll('.page-content')).map(p => p.innerHTML),
                metadata: {
                    exportedAt: new Date().toISOString(),
                    version: '1.1',
                    app: 'Sugercane Editor',
                    pageCount: document.querySelectorAll('.page').length
                }
            };

            const jsonStr = JSON.stringify(templateData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/x-sugercane-document' });

            const fileName = (templateData.title)
                .replace(/[<>:"/\\|?*\x00-\x1f]/g, '_')
                .replace(/\s+/g, '_') + '.scd';

            // Create URL, trigger download, then revoke AFTER download starts
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            // Delay revoke so the browser has time to initiate the download
            setTimeout(() => URL.revokeObjectURL(url), 10000);

            showToast('Document exported as .scd file!', 'success');
        } catch (error) {
            console.error('SCD Export Error:', error);
            showToast('Export failed: ' + error.message, 'error');
        } finally {
            if (exportBtn) {
                exportBtn.innerHTML = originalHTML;
                exportBtn.disabled = false;
            }
        }
    }

    //  Import Modal 
    function openImportModal() {
        const existing = document.getElementById('importModal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'importModal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Import Sugercane Document</h2>
                    <button class="close-btn" id="importModalClose">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="drop-zone" id="scdDropZone"
                         style="margin-bottom:20px;min-height:200px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;">
                        <div style="text-align:center;margin-bottom:20px;">
                            <span class="material-symbols-outlined" style="font-size:64px;color:#1976d2;display:block;margin-bottom:16px;">upload_file</span>
                            <h3 style="margin-bottom:8px;color:#333;">Drag &amp; Drop .scd file here</h3>
                            <p style="color:#666;">or click to browse</p>
                            <p style="color:#999;font-size:12px;margin-top:8px;">(Select any .scd file you've exported)</p>
                        </div>
                        <input type="file" id="scdFileInput" accept=".scd,application/x-sugercane-document" style="display:none" />
                    </div>
                    <div class="progress-bar" id="scdProgressBar" style="display:none;">
                        <div class="progress-fill" id="scdProgressFill" style="width:0%;"></div>
                    </div>
                    <p id="scdStatus" style="color:#666;font-size:14px;margin-top:10px;text-align:center;">
                        Import .scd files created with Sugercane Editor
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" id="importCancelBtn">Cancel</button>
                </div>
            </div>`;

        document.body.appendChild(modal);

        modal.querySelector('#importModalClose').onclick = () => modal.remove();
        modal.querySelector('#importCancelBtn').onclick = () => modal.remove();

        const dropZone = modal.querySelector('#scdDropZone');
        const fileInput = modal.querySelector('#scdFileInput');

        dropZone.onclick = () => fileInput.click();

        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.style.borderColor = '#1976d2';
            dropZone.style.background = '#e3f2fd';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '';
            dropZone.style.background = '';
        });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.style.borderColor = '';
            dropZone.style.background = '';
            const file = e.dataTransfer.files[0];
            if (file) handleSCDFile(file);
        });

        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) handleSCDFile(file);
            // Reset so same file can be re-selected
            fileInput.value = '';
        });
    }

    //  SCD File Handler 
    function handleSCDFile(file) {
        const progressBar = document.getElementById('scdProgressBar');
        const progressFill = document.getElementById('scdProgressFill');
        const status = document.getElementById('scdStatus');

        function setStatus(msg, color, pct, bgColor) {
            if (status) { status.textContent = msg; status.style.color = color; }
            if (progressBar) progressBar.style.display = 'block';
            if (progressFill) {
                progressFill.style.width = pct + '%';
                if (bgColor) progressFill.style.background = bgColor;
            }
        }

        // Accept .scd by extension (browsers may not pass MIME correctly for custom types)
        if (!file.name.toLowerCase().endsWith('.scd')) {
            setStatus('Error: Please select a valid .scd file.', '#d32f2f', 100, '#d32f2f');
            return;
        }

        setStatus('Reading file...', '#1976d2', 20, '#1976d2');

        const reader = new FileReader();

        reader.onprogress = e => {
            if (e.lengthComputable) {
                setStatus('Reading file...', '#1976d2', Math.round((e.loaded / e.total) * 50), '#1976d2');
            }
        };

        reader.onload = function(e) {
            setStatus('Parsing document...', '#1976d2', 70, '#1976d2');
            try {
                const content = e.target.result;

                // Handle template-link format (#TMP=...)
                if (content.includes('#TMP=')) {
                    const match = content.match(/#TMP=([A-Za-z0-9+/=]+)/);
                    if (match) {
                        // Proper UTF-8 aware base64 decode
                        const bytes = Uint8Array.from(atob(match[1]), c => c.charCodeAt(0));
                        const jsonStr = new TextDecoder().decode(bytes);
                        const data = JSON.parse(jsonStr);
                        finishLoad(data);
                        return;
                    }
                    throw new Error('Malformed template link in file');
                }

                const data = JSON.parse(content);

                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid JSON structure');
                }

                const hasExpectedFields = data.pages || data.title !== undefined || data.settings;
                if (!hasExpectedFields) {
                    throw new Error('Missing required SCD fields (pages/title/settings)');
                }

                finishLoad(data);

            } catch (err) {
                console.error('SCD Import Error:', err);
                setStatus('Import failed: ' + err.message, '#d32f2f', 100, '#d32f2f');
            }
        };

        reader.onerror = () => setStatus('Could not read the file.', '#d32f2f', 100, '#d32f2f');

        reader.readAsText(file, 'UTF-8');

        function finishLoad(data) {
            setStatus('Loading into editor...', '#1976d2', 90, '#1976d2');
            try {
                loadSCDData(data);
                setStatus('Import successful!', '#4CAF50', 100, '#4CAF50');
                setTimeout(() => {
                    const modal = document.getElementById('importModal');
                    if (modal) modal.remove();
                    checkContentState();
                    showToast('Document imported successfully!', 'success');
                }, 1200);
            } catch (err) {
                console.error('loadSCDData error:', err);
                setStatus('Failed to apply document: ' + err.message, '#d32f2f', 100, '#d32f2f');
            }
        }
    }

    //  SCD Load into Editor 
    function loadSCDData(data) {
        // Title
        if (data.title) {
            const titleEl = document.getElementById('docTitle');
            if (titleEl) titleEl.value = data.title;
        }

        // Settings
        const s = data.settings || {};

        if (s.margin && document.getElementById('pageMargin')) {
            document.getElementById('pageMargin').value = s.margin;
            if (typeof updateMargins === 'function') updateMargins(s.margin);
        }
        if (s.bgType && document.getElementById('bgType')) {
            document.getElementById('bgType').value = s.bgType;
            if (s.bgColor && document.getElementById('bgColor')) document.getElementById('bgColor').value = s.bgColor;
            if (s.bgColor2 && document.getElementById('bgColor2')) document.getElementById('bgColor2').value = s.bgColor2;
            if (s.angle && document.getElementById('gradientAngle')) document.getElementById('gradientAngle').value = s.angle;
            if (typeof updateBackground === 'function') updateBackground();
        }
        if (s.spacing && document.getElementById('lineSpacing')) {
            document.getElementById('lineSpacing').value = s.spacing;
            if (typeof updateLineSpacing === 'function') updateLineSpacing(s.spacing);
        }
        if (s.font) {
            const fontEl = document.getElementById('selectedFont');
            if (fontEl) fontEl.textContent = s.font;
            if (typeof currentFont !== 'undefined') window.currentFont = s.font;
            document.querySelectorAll('.font-option').forEach(opt => {
                opt.classList.toggle('selected', opt.textContent.trim() === s.font);
            });
        }
        if (s.zoom && typeof currentZoom !== 'undefined') {
            window.currentZoom = s.zoom;
            if (typeof applyZoom === 'function') applyZoom();
        }
        if (s.watermark !== undefined && document.getElementById('watermarkText')) {
            document.getElementById('watermarkText').value = s.watermark;
            if (typeof updateWatermark === 'function') updateWatermark();
        }

        // Clear all existing pages except first, reset first page
        const allPages = document.querySelectorAll('.page');
        for (let i = allPages.length - 1; i > 0; i--) allPages[i].remove();

        const firstPageContent = document.getElementById('pageContent1');
        if (firstPageContent) firstPageContent.innerHTML = '';

        if (typeof pageCount !== 'undefined') window.pageCount = 1;

        // Load pages
        const pages = Array.isArray(data.pages) ? data.pages : [];
        pages.forEach((html, i) => {
            if (i === 0) {
                if (firstPageContent) firstPageContent.innerHTML = html || '';
            } else {
                if (typeof addNewPage === 'function') addNewPage();
                const el = document.getElementById(`pageContent${i + 1}`);
                if (el) el.innerHTML = html || '';
            }
        });

        // Reattach event listeners
        if (typeof setupPageContentEditable === 'function') setupPageContentEditable();

        // Reinitialize images
        setTimeout(() => {
            document.querySelectorAll('.page-content img').forEach(img => {
                if (typeof startImageDrag === 'function') {
                    img.addEventListener('mousedown', e => startImageDrag(e, img));
                    img.addEventListener('touchstart', e => startImageDrag(e, img));
                }
                if (typeof selectImage === 'function') {
                    img.addEventListener('click', e => { e.stopPropagation(); selectImage(img); });
                }
            });
            // Ensure tables look right
            document.querySelectorAll('.page-content table').forEach(table => {
                table.style.borderCollapse = 'collapse';
                table.style.width = '100%';
                table.querySelectorAll('td,th').forEach(cell => {
                    cell.style.border = '1px solid #ddd';
                    cell.style.padding = '8px';
                    cell.style.minWidth = '50px';
                });
            });
        }, 100);

        if (typeof updatePageIndicator === 'function') updatePageIndicator();
        if (typeof updateWordCount === 'function') updateWordCount();
    }

    //  Toast 
    function showToast(message, type = 'info') {
        const colours = { success: '#4CAF50', error: '#d32f2f', info: '#1976d2' };
        const icons   = { success: 'check_circle', error: 'error', info: 'info' };

        const toast = document.createElement('div');
        toast.style.cssText = `position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);
            background:${colours[type] || colours.info};color:white;padding:14px 24px;border-radius:8px;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10002;font-weight:500;display:flex;
            align-items:center;gap:10px;opacity:0;transition:all 0.3s ease;`;
        toast.innerHTML = `<span class="material-symbols-outlined" style="font-size:20px;">${icons[type] || 'info'}</span>
                           <span>${message}</span>`;
        document.body.appendChild(toast);

        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });
        });

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-50%) translateY(-20px)';
            setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 350);
        }, 3200);
    }

    // Expose showToast globally so other parts of the app can use it
    window.showToast = showToast;

})();
</script>



                
                


    
</body>
</html>
