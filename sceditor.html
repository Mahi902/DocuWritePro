<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sugercane Editor</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  /* Hide ALL scrollbars */
* {
    scrollbar-width: none;      /* Firefox */
}

*::-webkit-scrollbar {
    display: none;              /* Chrome, Edge, Safari */
}
/* ── Reset ─────────────────────────────────────────────────────────── */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:#f0f4f8;overflow:hidden;height:100vh;}

/* ── Loading ───────────────────────────────────────────────────────── */
#loadingScreen{
  display:flex;position:fixed;inset:0;background:#fff;z-index:10000;
  align-items:center;justify-content:center;flex-direction:column;gap:20px;
}
.spinner{width:56px;height:56px;border:4px solid #e3f2fd;border-top-color:#1976d2;border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:17px;color:#666;}

/* ── Editor Container ──────────────────────────────────────────────── */
#editorContainer{display:none;flex-direction:column;height:100vh;overflow:hidden;}

/* ── Top Bar ───────────────────────────────────────────────────────── */
.top-bar{
  background:#fff;padding:10px 16px;display:flex;align-items:center;gap:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);z-index:200;flex-shrink:0;
  overflow-x:auto;overflow-y:hidden;white-space:nowrap;
}
.top-bar::-webkit-scrollbar{height:3px;}
.top-bar::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}
#docTitle{
  font-size:17px;border:none;outline:none;padding:6px 10px;border-radius:8px;
  font-family:inherit;min-width:140px;max-width:340px;transition:background .2s;flex-shrink:0;
}
#docTitle:hover,#docTitle:focus{background:#f5f5f5;}
.top-spacer{flex:1;min-width:8px;}
.icon-btn{
  background:none;border:none;cursor:pointer;padding:7px;border-radius:8px;
  display:flex;align-items:center;color:#1976d2;transition:background .2s;flex-shrink:0;
}
.icon-btn:hover{background:#e3f2fd;}
.action-btn{
  background:#1976d2;color:#fff;border:none;padding:8px 18px;border-radius:8px;
  cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px;
  transition:background .2s;white-space:nowrap;font-family:inherit;flex-shrink:0;
}
.action-btn:hover{background:#1565c0;}
.action-btn:disabled{opacity:.45;cursor:not-allowed;}
.action-btn.secondary{background:#546e7a;}
.action-btn.secondary:hover{background:#37474f;}

/* ── Toolbar ───────────────────────────────────────────────────────── */
.toolbar{
  background:#fff;padding:6px 12px;display:flex;align-items:center;gap:3px;
  box-shadow:0 2px 4px rgba(0,0,0,.06);flex-shrink:0;
  overflow-x:auto;overflow-y:hidden;white-space:nowrap;
}
.toolbar::-webkit-scrollbar{height:3px;}
.toolbar::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}
.toolbar-sep{width:1px;height:26px;background:#e0e0e0;margin:0 4px;flex-shrink:0;}
.tbtn{
  background:transparent;border:none;border-radius:6px;padding:6px 7px;cursor:pointer;
  display:inline-flex;align-items:center;justify-content:center;transition:background .15s;flex-shrink:0;
}
.tbtn:hover{background:#e3f2fd;}
.tbtn.active{background:#bbdefb;}
.tbtn .material-symbols-outlined{font-size:19px;color:#333;}

/* font size */
.size-group{display:inline-flex;align-items:center;gap:2px;flex-shrink:0;}
#fontSize{
  width:46px;text-align:center;border:1px solid #e0e0e0;border-radius:6px;
  padding:4px 5px;font-size:13px;outline:none;font-family:inherit;
}

/* format select */
#formatBlock{
  border:1px solid #e0e0e0;border-radius:6px;padding:4px 7px;font-size:13px;
  outline:none;cursor:pointer;font-family:inherit;flex-shrink:0;
}

/* ── Font Chooser Button (toolbar) ──────────────────────────────── */
.font-chooser-btn{
  background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:5px 10px;
  cursor:pointer;min-width:110px;display:inline-flex;justify-content:space-between;
  align-items:center;font-size:13px;gap:4px;transition:background .15s;flex-shrink:0;
}
.font-chooser-btn:hover{background:#f5f5f5;}
.upload-font-btn{
  background:#e3f2fd;border:none;border-radius:6px;padding:5px 6px;cursor:pointer;
  display:inline-flex;align-items:center;transition:background .15s;flex-shrink:0;
}
.upload-font-btn:hover{background:#bbdefb;}

/* ── Font Chooser Modal ──────────────────────────────────────────── */
#fontChooserModal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9000;
  align-items:center;justify-content:center;
}
#fontChooserModal.open{display:flex;}
.fc-box{
  background:#fff;border-radius:18px;padding:0;width:360px;max-height:70vh;
  display:flex;flex-direction:column;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:hidden;
}
.fc-header{
  padding:18px 20px 14px;border-bottom:1px solid #f0f0f0;display:flex;
  align-items:center;justify-content:space-between;flex-shrink:0;
}
.fc-title{font-size:17px;font-weight:600;color:#333;}
.fc-close{background:none;border:none;cursor:pointer;padding:4px;border-radius:50%;display:flex;align-items:center;}
.fc-close:hover{background:#f5f5f5;}
.fc-scope{padding:12px 20px 0;flex-shrink:0;}
.fc-scope-btns{display:flex;gap:7px;}
.fc-scope-btn{
  flex:1;padding:7px;border:2px solid #e0e0e0;border-radius:8px;background:#fafafa;
  cursor:pointer;font-size:12px;font-weight:600;transition:all .15s;font-family:inherit;
}
.fc-scope-btn.active{border-color:#1976d2;background:#e3f2fd;color:#1976d2;}
.fc-list{flex:1;overflow-y:auto;padding:10px 14px;}
.fc-list::-webkit-scrollbar{width:5px;}
.fc-list::-webkit-scrollbar-thumb{background:#ddd;border-radius:3px;}
.fc-font-item{
  padding:11px 14px;border-radius:10px;cursor:pointer;transition:background .13s;
  display:flex;align-items:center;justify-content:space-between;gap:8px;
}
.fc-font-item:hover{background:#e8f4fd;}
.fc-font-item.selected{background:#bbdefb;}
.fc-font-name{font-size:15px;color:#333;}
.fc-font-preview{font-size:13px;color:#999;}
.fc-upload-row{padding:12px 20px 16px;flex-shrink:0;border-top:1px solid #f0f0f0;}
.fc-upload-btn{
  width:100%;padding:9px;border:2px dashed #1976d2;border-radius:10px;background:#e3f2fd;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;
  font-size:13px;font-weight:600;color:#1976d2;transition:background .15s;font-family:inherit;
}
.fc-upload-btn:hover{background:#bbdefb;}
.fc-empty{padding:20px;text-align:center;color:#bbb;font-size:13px;}

/* ── Context Popups (text / hr / image) ─────────────────────────── */
.ctx-popup{
  position:fixed;background:#fff;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.18);
  z-index:9500;display:none;padding:6px;border:1px solid #e8e8e8;
  min-width:180px;
}
.ctx-popup.open{display:block;}
.ctx-popup-row{display:flex;flex-wrap:wrap;gap:3px;padding:3px 0;}
.ctx-popup-sep{height:1px;background:#f0f0f0;margin:3px 0;}
.cpp-btn{
  background:none;border:none;border-radius:7px;padding:7px 9px;cursor:pointer;
  display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:500;
  color:#333;transition:background .13s;white-space:nowrap;font-family:inherit;
}
.cpp-btn:hover{background:#e3f2fd;color:#1976d2;}
.cpp-btn.danger{color:#d32f2f;}
.cpp-btn.danger:hover{background:#fce4ec;}
.cpp-btn .material-symbols-outlined{font-size:16px;}
.cpp-icon-btn{
  background:none;border:none;border-radius:7px;padding:7px;cursor:pointer;
  display:inline-flex;align-items:center;justify-content:center;transition:background .13s;
}
.cpp-icon-btn:hover{background:#e3f2fd;}
.cpp-icon-btn .material-symbols-outlined{font-size:18px;color:#333;}
.cpp-icon-btn.active{background:#bbdefb;}
.cpp-color-row{display:flex;align-items:center;gap:7px;padding:5px 6px;}
.cpp-color-label{font-size:11px;color:#888;flex-shrink:0;}
.cpp-color-inp{width:26px;height:26px;border:1px solid #e0e0e0;border-radius:50%;cursor:pointer;padding:2px;flex-shrink:0;}
.cpp-color-inp::-webkit-color-swatch-wrapper{padding:0;}
.cpp-color-inp::-webkit-color-swatch{border:none;border-radius:50%;}
.cpp-size-row{display:flex;align-items:center;gap:4px;padding:3px 6px;}
.cpp-size-inp{width:44px;text-align:center;border:1px solid #e0e0e0;border-radius:6px;padding:4px 4px;font-size:12px;outline:none;font-family:inherit;}
.cpp-font-mini{
  background:none;border:1px solid #e0e0e0;border-radius:7px;padding:5px 8px;cursor:pointer;
  font-size:11px;display:flex;align-items:center;gap:4px;transition:background .13s;
  white-space:nowrap;font-family:inherit;flex-shrink:0;
}
.cpp-font-mini:hover{background:#e3f2fd;}

/* color pickers */
input[type="color"]{width:30px;height:30px;border:1px solid #e0e0e0;border-radius:50%;cursor:pointer;padding:2px;flex-shrink:0;}
input[type="color"]::-webkit-color-swatch-wrapper{padding:0;}
input[type="color"]::-webkit-color-swatch{border:none;border-radius:50%;}

/* ── Main Content ──────────────────────────────────────────────────── */
.main-content{display:flex;flex:1;overflow:hidden;min-height:0;}

/* ── Sidebar ───────────────────────────────────────────────────────── */
.sidebar{
  width:255px;min-width:255px;background:#fff;padding:14px;overflow-y:auto;
  box-shadow:2px 0 8px rgba(0,0,0,.06);transition:transform .3s,width .3s,min-width .3s,padding .3s;
  flex-shrink:0;
}
.sidebar.collapsed{transform:translateX(-255px);width:0;min-width:0;padding:0;overflow:hidden;}
.sidebar::-webkit-scrollbar{width:5px;}
.sidebar::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}
.sb-section{margin-bottom:18px;}
.sb-title{font-size:11px;font-weight:700;color:#888;margin-bottom:9px;text-transform:uppercase;letter-spacing:.6px;}
.sb-label{display:block;font-size:12px;color:#777;margin-bottom:3px;}
.sb-input{
  width:100%;padding:7px 9px;border:1px solid #e0e0e0;border-radius:8px;font-size:13px;
  background:#fafafa;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s;
}
.sb-input:focus{border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,.1);background:#fff;}
.sb-row{margin-bottom:9px;}
.gradient-controls{display:none;}
.gradient-controls.active{display:block;}
.zoom-display{text-align:center;font-size:20px;font-weight:700;color:#1976d2;margin:5px 0;}
.zoom-row{display:flex;gap:6px;}
.zoom-btn{
  flex:1;padding:7px;border:1px solid #e0e0e0;border-radius:7px;background:#fff;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:4px;font-size:12px;
  transition:background .15s,border-color .15s;font-family:inherit;
}
.zoom-btn:hover{background:#e3f2fd;border-color:#1976d2;}
.collapse-btn{
  width:100%;padding:8px;background:#e3f2fd;border:none;border-radius:8px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:6px;font-size:13px;
  margin-top:6px;transition:background .15s;font-family:inherit;
}
.collapse-btn:hover{background:#bbdefb;}
.expand-btn{
  position:fixed;left:10px;top:50%;transform:translateY(-50%);background:#fff;
  border:none;border-radius:8px;padding:10px 5px;cursor:pointer;
  box-shadow:0 2px 10px rgba(0,0,0,.15);z-index:50;display:none;
}

/* ── Editor Area ───────────────────────────────────────────────────── */
.editor-area-wrapper{flex:1;overflow:auto;display:flex;justify-content:center;background:#f0f4f8;min-width:0;}
.editor-area-wrapper::-webkit-scrollbar{width:8px;height:8px;}
.editor-area-wrapper::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px;}
.editor-area{padding:36px 20px;display:flex;flex-direction:column;align-items:center;transform-origin:top center;transition:transform .25s;min-width:fit-content;}

/* A4 Page */
.page{
  width:21cm;min-width:21cm;max-width:21cm;height:29.7cm;min-height:29.7cm;max-height:29.7cm;
  background:#fff;box-shadow:0 4px 16px rgba(0,0,0,.12);margin-bottom:20px;
  position:relative;padding:2cm;flex-shrink:0;overflow:hidden;
}
.page-content{
  height:25.7cm;min-height:25.7cm;max-height:25.7cm;outline:none;font-size:16px;
  line-height:1.6;color:#333;font-family:Arial,sans-serif;word-wrap:break-word;overflow:visible;
}
.page-content img{max-width:100%;cursor:move;border:2px solid transparent;transition:border-color .15s;}
.page-content img:hover{border-color:#1976d2;}
.page-content img.selected{border-color:#1976d2;outline:2px dashed #1976d2;outline-offset:3px;}
.watermark{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);
  font-size:72px;color:rgba(0,0,0,.07);pointer-events:none;white-space:nowrap;z-index:1;user-select:none;
}

/* Tables */
.page-content table{border-collapse:collapse;margin:10px 0;}
.page-content table td,.page-content table th{border:1px solid #ccc;padding:6px 8px;min-width:40px;position:relative;}
.page-content table.sc-selected{outline:2px solid #1976d2;outline-offset:2px;}

/* Image resize handle */
.image-resize-handle{
  position:fixed;width:12px;height:12px;background:#1976d2;border:2px solid #fff;
  border-radius:50%;cursor:nwse-resize;display:none;z-index:10000;
}

/* Add page btn */
.add-page-btn{
  background:#fff;border:2px dashed #1976d2;border-radius:12px;padding:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:10px;font-size:14px;
  color:#1976d2;width:21cm;transition:background .15s,transform .15s;font-family:inherit;
}
.add-page-btn:hover{background:#e3f2fd;transform:scale(1.01);}

/* Page indicator */
.page-indicator{
  position:fixed;top:110px;right:20px;background:#fff;padding:5px 13px;
  border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);font-size:13px;color:#666;z-index:50;
}

/* Overflow alert */
.overflow-alert{
  position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#d32f2f;
  color:#fff;padding:9px 20px;border-radius:8px;font-weight:600;font-size:13px;
  z-index:10001;display:none;box-shadow:0 4px 12px rgba(211,47,47,.4);pointer-events:none;
}

/* ── Table Context Menu ────────────────────────────────────────────── */
#tableCtxMenu{
  position:fixed;background:#fff;border:1px solid #e0e0e0;border-radius:10px;
  box-shadow:0 6px 20px rgba(0,0,0,.15);z-index:9999;min-width:200px;
  display:none;padding:6px 0;overflow:hidden;
}
.ctx-item{
  padding:9px 16px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:9px;
  transition:background .12s;color:#333;white-space:nowrap;
}
.ctx-item:hover{background:#e3f2fd;color:#1976d2;}
.ctx-item .material-symbols-outlined{font-size:17px;}
.ctx-sep{height:1px;background:#f0f0f0;margin:4px 0;}
.ctx-item.danger{color:#d32f2f;}
.ctx-item.danger:hover{background:#fce4ec;}

/* ── Toast ─────────────────────────────────────────────────────────── */
.toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(60px);
  padding:11px 20px;border-radius:8px;color:#fff;font-size:13px;font-weight:500;
  display:flex;align-items:center;gap:8px;box-shadow:0 4px 14px rgba(0,0,0,.15);
  z-index:10002;opacity:0;transition:transform .3s,opacity .3s;pointer-events:none;
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast.success{background:#43a047;}.toast.error{background:#d32f2f;}.toast.info{background:#1976d2;}

/* ── Modals ─────────────────────────────────────────────────────────── */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:8000;align-items:center;justify-content:center;}
.modal.open{display:flex;}
.mbox{background:#fff;border-radius:16px;padding:26px;width:90%;max-height:88vh;overflow-y:auto;position:relative;}
.mbox.narrow{max-width:400px;}.mbox.wide{max-width:520px;}
.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.mtitle{font-size:19px;font-weight:500;color:#333;}
.mclose{background:none;border:none;cursor:pointer;padding:4px;border-radius:50%;display:flex;align-items:center;transition:background .15s;}
.mclose:hover{background:#f5f5f5;}
.mclose .material-symbols-outlined{font-size:21px;color:#666;}
.mfooter{display:flex;gap:9px;justify-content:flex-end;margin-top:18px;}
.mbtn{padding:8px 18px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-family:inherit;transition:background .15s;}
.mbtn.primary{background:#1976d2;color:#fff;}.mbtn.primary:hover{background:#1565c0;}
.mbtn.sec{background:#e0e0e0;color:#333;}.mbtn.sec:hover{background:#d0d0d0;}
.drop-zone{border:2px dashed #1976d2;border-radius:12px;padding:32px 16px;text-align:center;cursor:pointer;background:#fafafa;transition:background .15s,border-color .15s;}
.drop-zone:hover,.drop-zone.dragover{background:#e3f2fd;border-color:#1565c0;}
.prog-track{width:100%;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;margin:12px 0;}
.prog-fill{height:100%;background:#1976d2;transition:width .3s;}
.frow{margin-bottom:13px;}.frow label{display:block;font-size:12px;color:#777;margin-bottom:3px;}
.finput{width:100%;padding:8px 10px;border:1px solid #e0e0e0;border-radius:7px;font-size:13px;font-family:inherit;outline:none;transition:border-color .2s;}
.finput:focus{border-color:#1976d2;}

/* Export format grid */
.fmt-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin:14px 0;}
.fmt-opt{
  padding:13px 8px;border:2px solid #e0e0e0;border-radius:10px;background:#fafafa;
  cursor:pointer;text-align:center;transition:all .15s;display:flex;flex-direction:column;
  align-items:center;gap:5px;font-family:inherit;
}
.fmt-opt:hover{border-color:#90caf9;background:#e8f4fd;}
.fmt-opt.selected{border-color:#1976d2;background:#e3f2fd;color:#1976d2;}
.fmt-opt .material-symbols-outlined{font-size:26px;}
.fmt-opt .flabel{font-size:12px;font-weight:700;}
.fmt-opt .fsub{font-size:11px;opacity:.7;}
.fmt-wide{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:11px;border:2px solid #e0e0e0;border-radius:10px;background:#fafafa;cursor:pointer;font-size:13px;font-weight:600;margin-bottom:8px;transition:all .15s;font-family:inherit;}
.fmt-wide:hover{border-color:#1976d2;background:#e3f2fd;color:#1976d2;}
.fmt-print{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:11px;border:2px dashed #78909c;border-radius:10px;background:#fafafa;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;font-family:inherit;}
.fmt-print:hover{border-color:#546e7a;background:#eceff1;color:#37474f;}

/* PDF progress modal */
#pdfMdl .mbox{max-width:380px;}

/* ── Tips ─────────────────────────────────────────────────────────── */
#tipBox{
  position:fixed;bottom:80px;right:18px;width:284px;background:#1976d2;color:#fff;
  border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(25,118,210,.3);z-index:9990;
  opacity:0;transform:translateY(8px);transition:opacity .3s,transform .3s;font-family:inherit;
}
#tipBox.show{opacity:1;transform:translateY(0);}
#tipBox.hide{opacity:0;transform:translateY(8px);}
.tip-prog{height:3px;background:rgba(255,255,255,.2);border-radius:99px;overflow:hidden;margin-bottom:11px;}
.tip-bar{height:100%;background:#fff;transition:width .3s;}
.tip-text{font-size:13px;line-height:1.5;min-height:58px;}
.tip-actions{display:flex;gap:7px;margin-top:11px;}
.tip-btn{flex:1;border:none;padding:6px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;}
.tip-prev{background:rgba(255,255,255,.15);color:#fff;}
.tip-next{background:#fff;color:#1976d2;}

/* ── Dark Mode ─────────────────────────────────────────────────────── */
body.dark{background:#111;}
body.dark .top-bar,body.dark .toolbar,body.dark .sidebar{background:#1a1a1a;border-color:#333;}
body.dark .top-bar{box-shadow:0 2px 8px rgba(0,0,0,.5);}
body.dark #docTitle,body.dark #formatBlock,body.dark #fontSize,body.dark .sb-input,body.dark .finput{background:#252525!important;color:#ddd!important;border-color:#444!important;}
body.dark .font-selector{background:#252525!important;color:#ddd!important;border-color:#444!important;}
body.dark .font-menu{background:#1e1e1e;border-color:#444;}
body.dark .font-opt{color:#ddd;}
body.dark .font-opt:hover{background:#2a3a4a;}
body.dark .font-opt.selected{background:#1a3a5a;color:#90caf9;}
body.dark .tbtn .material-symbols-outlined{color:#bbb;}
body.dark .tbtn:hover{background:#2a2a2a;}
body.dark .toolbar-sep,body.dark .ctx-sep{background:#333;}
body.dark .sb-title{color:#777;}
body.dark .sb-label,body.dark #wordCount{color:#666;}
body.dark .zoom-btn,.collapse-btn{color:#ccc!important;}
body.dark .zoom-btn{background:#222!important;border-color:#444!important;}
body.dark .collapse-btn{background:#222!important;}
body.dark .editor-area-wrapper{background:#111;}
body.dark .add-page-btn{background:#1a1a1a;border-color:#444;color:#777;}
body.dark .add-page-btn:hover{background:#222;border-color:#1976d2;color:#90caf9;}
body.dark .expand-btn{background:#1a1a1a;box-shadow:0 2px 10px rgba(0,0,0,.5);}
body.dark .mbox{background:#1a1a1a;color:#ddd;border:1px solid #333;}
body.dark .mtitle,body.dark .ctx-item{color:#ddd;}
body.dark .mclose .material-symbols-outlined{color:#aaa;}
body.dark .mclose:hover{background:#252525;}
body.dark .drop-zone{background:#222;border-color:#555;color:#aaa;}
body.dark .drop-zone:hover{background:#1a2a3a;border-color:#1976d2;}
body.dark .mbtn.sec{background:#333;color:#bbb;}
body.dark .mbtn.sec:hover{background:#3a3a3a;}
body.dark .fmt-opt{background:#222;border-color:#444;color:#bbb;}
body.dark .fmt-opt:hover{background:#1a2a3a;border-color:#1976d2;}
body.dark .fmt-opt.selected{background:#0d2a4a;color:#90caf9;}
body.dark .fmt-wide,.dark .fmt-print{background:#222;border-color:#444;color:#bbb;}
body.dark .page-indicator{background:#1a1a1a;color:#aaa;box-shadow:0 2px 8px rgba(0,0,0,.4);}
body.dark #tableCtxMenu{background:#1e1e1e;border-color:#333;}
body.dark .ctx-item:hover{background:#1a2a3a;}
body.dark .ctx-item.danger{color:#ef9a9a;}
body.dark .ctx-item.danger:hover{background:#3a1a1a;}
body.dark .upload-font-btn{background:#252525;}
body.dark .upload-font-btn:hover{background:#333;}
body.dark #tipBox{background:#0d47a1;}
body.dark .font-chooser-btn{background:#252525!important;color:#ddd!important;border-color:#444!important;}
body.dark .fc-box{background:#1e1e1e;color:#ddd;}
body.dark .fc-header{border-color:#333;}
body.dark .fc-title{color:#ddd;}
body.dark .fc-font-item{color:#ddd;}
body.dark .fc-font-item:hover{background:#1a2a3a;}
body.dark .fc-font-item.selected{background:#0d2a4a;}
body.dark .fc-font-name{color:#ddd;}
body.dark .fc-upload-row{border-color:#333;}
body.dark .ctx-popup{background:#1e1e1e;border-color:#333;box-shadow:0 8px 28px rgba(0,0,0,.5);}
body.dark .cpp-btn{color:#ddd;}
body.dark .cpp-btn:hover{background:#1a2a3a;color:#90caf9;}
body.dark .cpp-icon-btn .material-symbols-outlined{color:#bbb;}
body.dark .cpp-icon-btn:hover{background:#2a2a2a;}
body.dark .cpp-color-label{color:#777;}
body.dark .cpp-size-inp{background:#252525;color:#ddd;border-color:#444;}
body.dark .cpp-font-mini{border-color:#444;color:#bbb;}
body.dark .cpp-font-mini:hover{background:#1a2a3a;}

/* ── Print ─────────────────────────────────────────────────────────── */
@media print{
  .top-bar,.toolbar,.sidebar,.page-indicator,.expand-btn,.add-page-btn,
  #tableCtxMenu,.image-resize-handle,.overflow-alert,#tipBox{display:none!important;}
  body,#editorContainer{overflow:visible;height:auto;}
  .main-content{overflow:visible;}
  .editor-area-wrapper{overflow:visible;}
  .editor-area{padding:0;transform:none!important;}
  .page{box-shadow:none;margin:0;page-break-after:always;}
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingScreen">
  <div class="spinner"></div>
  <p class="loading-text">Loading Sugercane…</p>
</div>

<!-- Editor -->
<div id="editorContainer">

  <!-- Top Bar -->
  <div class="top-bar">
    <input type="text" id="docTitle" value="Untitled Document" title="Click to rename"/>
    <div class="top-spacer"></div>
    <button class="icon-btn" id="themeBtn" title="Toggle dark mode">
      <span class="material-symbols-outlined">dark_mode</span>
    </button>
    <button class="action-btn secondary" id="importBtn" onclick="openImportModal()" title="Import .scd file">
      <span class="material-symbols-outlined">upload_file</span>Import
    </button>
    <button class="action-btn" onclick="openExportModal()">
      <span class="material-symbols-outlined">download</span>Export
    </button>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="tbtn" onclick="document.execCommand('undo')" title="Undo"><span class="material-symbols-outlined">undo</span></button>
    <button class="tbtn" onclick="document.execCommand('redo')" title="Redo"><span class="material-symbols-outlined">redo</span></button>
    <div class="toolbar-sep"></div>

    <select id="formatBlock" onchange="document.execCommand('formatBlock',false,this.value)" title="Paragraph style">
      <option value="p">Paragraph</option>
      <option value="h1">Heading 1</option>
      <option value="h2">Heading 2</option>
      <option value="h3">Heading 3</option>
      <option value="h4">Heading 4</option>
      <option value="h5">Heading 5</option>
      <option value="h6">Heading 6</option>
      <option value="blockquote">Blockquote</option>
      <option value="pre">Preformatted</option>
    </select>
    <div class="toolbar-sep"></div>

    <div class="size-group">
      <button class="tbtn" onclick="stepFont(-2)" title="Smaller"><span class="material-symbols-outlined">remove</span></button>
      <input type="number" id="fontSize" value="16" min="8" max="144" onchange="applyFontSize(+this.value)"/>
      <button class="tbtn" onclick="stepFont(2)" title="Larger"><span class="material-symbols-outlined">add</span></button>
    </div>
    <div class="toolbar-sep"></div>

    <button class="tbtn" onclick="document.execCommand('bold')" title="Bold"><span class="material-symbols-outlined">format_bold</span></button>
    <button class="tbtn" onclick="document.execCommand('italic')" title="Italic"><span class="material-symbols-outlined">format_italic</span></button>
    <button class="tbtn" onclick="document.execCommand('underline')" title="Underline"><span class="material-symbols-outlined">format_underlined</span></button>
    <button class="tbtn" onclick="document.execCommand('strikeThrough')" title="Strikethrough"><span class="material-symbols-outlined">strikethrough_s</span></button>
    <div class="toolbar-sep"></div>

    <button class="tbtn" onclick="document.execCommand('justifyLeft')" title="Left"><span class="material-symbols-outlined">format_align_left</span></button>
    <button class="tbtn" onclick="document.execCommand('justifyCenter')" title="Center"><span class="material-symbols-outlined">format_align_center</span></button>
    <button class="tbtn" onclick="document.execCommand('justifyRight')" title="Right"><span class="material-symbols-outlined">format_align_right</span></button>
    <button class="tbtn" onclick="document.execCommand('justifyFull')" title="Justify"><span class="material-symbols-outlined">format_align_justify</span></button>
    <div class="toolbar-sep"></div>

    <button class="tbtn" onclick="document.execCommand('insertUnorderedList')" title="Bullet list"><span class="material-symbols-outlined">format_list_bulleted</span></button>
    <button class="tbtn" onclick="document.execCommand('insertOrderedList')" title="Numbered list"><span class="material-symbols-outlined">format_list_numbered</span></button>
    <button class="tbtn" onclick="insertHR()" title="Insert horizontal line"><span class="material-symbols-outlined">horizontal_rule</span></button>
    <div class="toolbar-sep"></div>

    <button class="tbtn" onclick="openImageModal()" title="Insert image"><span class="material-symbols-outlined">image</span></button>
    <button class="tbtn" onclick="openTableModal()" title="Insert table"><span class="material-symbols-outlined">table</span></button>
    <button class="tbtn" onclick="openLinkModal()" title="Insert link"><span class="material-symbols-outlined">link</span></button>
    <div class="toolbar-sep"></div>

    <!-- Font Chooser -->
    <button class="font-chooser-btn" onclick="openFontChooser('document')" id="fontChooserToolbarBtn" title="Choose font">
      <span id="selectedFont">Default</span>
      <span class="material-symbols-outlined" style="font-size:16px">text_fields</span>
    </button>
    <input type="file" id="fontUpload" accept=".ttf,.otf,.woff,.woff2" style="display:none" onchange="handleFontUpload(this)"/>
    <div class="toolbar-sep"></div>

    <input type="color" id="textColor" value="#000000" onchange="document.execCommand('foreColor',false,this.value)" title="Text color"/>
    <input type="color" id="highlightColor" value="#ffff00" onchange="document.execCommand('hiliteColor',false,this.value)" title="Highlight"/>
    <div class="toolbar-sep"></div>
    <button class="tbtn" onclick="document.execCommand('removeFormat');document.execCommand('unlink')" title="Clear formatting"><span class="material-symbols-outlined">format_clear</span></button>
  </div>

  <!-- Main -->
  <div class="main-content">
    <div class="sidebar" id="sidebar">

      <div class="sb-section">
        <div class="sb-title">Zoom</div>
        <div class="zoom-display" id="zoomDisplay">100%</div>
        <div class="zoom-row">
          <button class="zoom-btn" onclick="adjustZoom(-10)"><span class="material-symbols-outlined" style="font-size:15px">remove</span>Out</button>
          <button class="zoom-btn" onclick="adjustZoom(10)"><span class="material-symbols-outlined" style="font-size:15px">add</span>In</button>
        </div>
        <button class="zoom-btn" style="width:100%;margin-top:5px" onclick="resetZoom()">
          <span class="material-symbols-outlined" style="font-size:15px">refresh</span>Reset
        </button>
      </div>

      <div class="sb-section">
        <div class="sb-title">Watermark</div>
        <div class="sb-row"><input type="text" class="sb-input" id="watermarkText" oninput="updateWatermark()" placeholder="Watermark text…"/></div>
      </div>

      <div class="sb-section">
        <div class="sb-title">Line Spacing</div>
        <div class="sb-row">
          <select class="sb-input" id="lineSpacing" onchange="updateLineSpacing(this.value)">
            <option value="1">Single</option>
            <option value="1.15">1.15</option>
            <option value="1.5" selected>1.5</option>
            <option value="2">Double</option>
            <option value="2.5">2.5</option>
            <option value="3">Triple</option>
          </select>
        </div>
      </div>

      <div class="sb-section">
        <div class="sb-title">Page Background</div>
        <div class="sb-row">
          <label class="sb-label">Type</label>
          <select class="sb-input" id="bgType" onchange="toggleGradientUI(this.value)">
            <option value="solid">Solid Color</option>
            <option value="gradient">Gradient</option>
          </select>
        </div>
        <div class="sb-row"><label class="sb-label">Color</label><input type="color" id="bgColor" value="#ffffff" onchange="updateBackground()"/></div>
        <div class="gradient-controls" id="gradientControls">
          <div class="sb-row"><label class="sb-label">Second Color</label><input type="color" id="bgColor2" value="#e3f2fd" onchange="updateBackground()"/></div>
          <div class="sb-row"><label class="sb-label">Angle (°)</label><input type="number" class="sb-input" id="gradientAngle" value="135" min="0" max="360" onchange="updateBackground()"/></div>
        </div>
      </div>

      <div class="sb-section">
        <div class="sb-title">Page Margins</div>
        <div class="sb-row"><label class="sb-label">All sides (cm)</label><input type="number" class="sb-input" id="pageMargin" value="2" min="0" max="5" step="0.5" onchange="updateMargins(this.value)"/></div>
      </div>

      <div class="sb-section">
        <div class="sb-title">Template Sharing</div>
        <div class="sb-row">
          <button class="zoom-btn" style="width:100%;margin-bottom:5px" onclick="shareTemplate('copy')"><span class="material-symbols-outlined" style="font-size:15px">content_copy</span>Copy Link</button>
          <button class="zoom-btn" style="width:100%" onclick="shareTemplate('open')"><span class="material-symbols-outlined" style="font-size:15px">open_in_new</span>Open Link</button>
        </div>
      </div>

      <div class="sb-section">
        <div class="sb-title">Word Count</div>
        <div id="wordCount" style="font-size:13px;color:#666">0 words</div>
      </div>

      <button class="collapse-btn" onclick="toggleSidebar()">
        <span class="material-symbols-outlined">chevron_left</span>Collapse
      </button>
    </div>

    <button class="expand-btn" id="expandBtn" onclick="toggleSidebar()" title="Expand sidebar">
      <span class="material-symbols-outlined">chevron_right</span>
    </button>

    <!-- Editor -->
    <div class="editor-area-wrapper" id="editorAreaWrapper">
      <div class="editor-area" id="editorArea">
        <div class="page" id="page1">
          <div class="watermark" id="watermark1"></div>
          <div class="page-content" contenteditable="true" id="pageContent1"></div>
        </div>
        <button class="add-page-btn" onclick="addNewPage()">
          <span class="material-symbols-outlined">add</span>Add New Page
        </button>
      </div>
    </div>
  </div>

  <div class="page-indicator" id="pageIndicator">1/1</div>
</div>

<div class="overflow-alert" id="overflowAlert">⚠ Content exceeds page — add a new page</div>
<div class="image-resize-handle" id="resizeHandle"></div>

<!-- ── Table Context Menu ─────────────────────────────────────────── -->
<div id="tableCtxMenu">
  <div class="ctx-item" onclick="tableAction('addRowAbove')"><span class="material-symbols-outlined">add</span>Insert row above</div>
  <div class="ctx-item" onclick="tableAction('addRowBelow')"><span class="material-symbols-outlined">add</span>Insert row below</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="tableAction('addColLeft')"><span class="material-symbols-outlined">add</span>Insert column left</div>
  <div class="ctx-item" onclick="tableAction('addColRight')"><span class="material-symbols-outlined">add</span>Insert column right</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="tableAction('deleteRow')"><span class="material-symbols-outlined">remove</span>Delete row</div>
  <div class="ctx-item" onclick="tableAction('deleteCol')"><span class="material-symbols-outlined">remove</span>Delete column</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" onclick="tableAction('deleteTable')"><span class="material-symbols-outlined">delete</span>Delete table</div>
</div>

<!-- ── Modals ─────────────────────────────────────────────────────── -->

<!-- Image -->
<div class="modal" id="imageMdl">
  <div class="mbox wide">
    <div class="mhdr"><h2 class="mtitle">Insert Image</h2><button class="mclose" onclick="closeMdl('imageMdl')"><span class="material-symbols-outlined">close</span></button></div>
    <div class="drop-zone" id="imgDZ">
      <span class="material-symbols-outlined" style="font-size:44px;color:#1976d2">image</span>
      <p style="margin-top:7px;color:#555">Drag & drop or click to browse</p>
      <input type="file" id="imageFile" accept="image/*" style="display:none" onchange="previewImg(this)"/>
    </div>
    <img id="imagePreview" style="display:none;max-width:100%;margin-top:12px;border-radius:8px"/>
    <div class="mfooter"><button class="mbtn sec" onclick="closeMdl('imageMdl')">Cancel</button><button class="mbtn primary" onclick="insertImage()">Insert</button></div>
  </div>
</div>

<!-- Table -->
<div class="modal" id="tableMdl">
  <div class="mbox narrow">
    <div class="mhdr"><h2 class="mtitle">Insert Table</h2><button class="mclose" onclick="closeMdl('tableMdl')"><span class="material-symbols-outlined">close</span></button></div>
    <div class="frow"><label>Rows</label><input type="number" class="finput" id="tableRows" value="3" min="1" max="50"/></div>
    <div class="frow"><label>Columns</label><input type="number" class="finput" id="tableCols" value="3" min="1" max="20"/></div>
    <div class="mfooter"><button class="mbtn sec" onclick="closeMdl('tableMdl')">Cancel</button><button class="mbtn primary" onclick="insertTable()">Insert</button></div>
  </div>
</div>

<!-- Link -->
<div class="modal" id="linkMdl">
  <div class="mbox narrow">
    <div class="mhdr"><h2 class="mtitle">Insert Link</h2><button class="mclose" onclick="closeMdl('linkMdl')"><span class="material-symbols-outlined">close</span></button></div>
    <div class="frow"><label>Display text</label><input type="text" class="finput" id="linkText" placeholder="Link text"/></div>
    <div class="frow"><label>URL</label><input type="url" class="finput" id="linkUrl" placeholder="https://example.com"/></div>
    <div class="mfooter"><button class="mbtn sec" onclick="closeMdl('linkMdl')">Cancel</button><button class="mbtn primary" onclick="insertLink()">Insert</button></div>
  </div>
</div>

<!-- Export -->
<div class="modal" id="exportMdl">
  <div class="mbox narrow">
    <div class="mhdr"><h2 class="mtitle">Export Document</h2><button class="mclose" onclick="closeMdl('exportMdl')"><span class="material-symbols-outlined">close</span></button></div>
    <p style="color:#777;font-size:13px;margin-bottom:10px">Choose a format:</p>
    <div class="fmt-grid">
      <button class="fmt-opt" onclick="doExport('pdf')"><span class="material-symbols-outlined">picture_as_pdf</span><span class="flabel">PDF</span><span class="fsub">Best for sharing</span></button>
      <button class="fmt-opt" onclick="doExport('scd')"><span class="material-symbols-outlined">description</span><span class="flabel">SCD</span><span class="fsub">Re-editable</span></button>
      <button class="fmt-opt" onclick="doExport('docx')"><span class="material-symbols-outlined">article</span><span class="flabel">DOCX</span><span class="fsub">Word-compatible</span></button>
      <button class="fmt-opt" onclick="doExport('txt')"><span class="material-symbols-outlined">text_snippet</span><span class="flabel">TXT</span><span class="fsub">Plain text</span></button>
    </div>
    <button class="fmt-wide" onclick="doExport('jpg')"><span class="material-symbols-outlined">photo_library</span>JPG Images<span style="font-size:11px;opacity:.7">(one per page)</span></button>
    <button class="fmt-print" onclick="printDoc()"><span class="material-symbols-outlined">print</span>Print Document</button>
  </div>
</div>

<!-- Import -->
<div class="modal" id="importMdl">
  <div class="mbox wide">
    <div class="mhdr"><h2 class="mtitle">Import .scd File</h2><button class="mclose" onclick="closeMdl('importMdl')"><span class="material-symbols-outlined">close</span></button></div>
    <div class="drop-zone" id="importDZ">
      <span class="material-symbols-outlined" style="font-size:44px;color:#1976d2">upload_file</span>
      <p style="margin-top:7px;color:#555">Drag & drop or click to browse</p>
      <p style="font-size:12px;color:#999;margin-top:5px">Only .scd files supported</p>
      <input type="file" id="importFile" accept=".scd" style="display:none" onchange="handleImport(this.files[0])"/>
    </div>
    <div class="prog-track" id="importProg" style="display:none"><div class="prog-fill" id="importFill" style="width:0%"></div></div>
    <p id="importStatus" style="font-size:13px;color:#666;margin-top:7px;text-align:center"></p>
    <div class="mfooter"><button class="mbtn sec" onclick="closeMdl('importMdl')">Cancel</button></div>
  </div>
</div>

<!-- PDF progress -->
<div class="modal" id="pdfMdl">
  <div class="mbox narrow">
    <div class="mhdr"><h2 class="mtitle" id="pdfTitle">Generating PDF…</h2></div>
    <p id="pdfStatus" style="color:#777;font-size:13px">Preparing…</p>
    <div class="prog-track"><div class="prog-fill" id="pdfFill" style="width:0%"></div></div>
    <div id="pdfActions" style="display:none" class="mfooter">
      <button class="mbtn sec" onclick="closeMdl('pdfMdl')">Close</button>
      <button class="mbtn primary" id="pdfDlBtn"><span class="material-symbols-outlined" style="font-size:16px">download</span>Download</button>
    </div>
  </div>
</div>

<!-- ── Font Chooser Modal ──────────────────────────────────────────── -->
<div id="fontChooserModal">
  <div class="fc-box">
    <div class="fc-header">
      <span class="fc-title">Choose Font</span>
      <button class="fc-close" onclick="closeFontChooser()"><span class="material-symbols-outlined" style="font-size:20px;color:#666">close</span></button>
    </div>
    <div class="fc-scope" id="fcScopeRow" style="display:none">
      <div class="fc-scope-btns">
        <button class="fc-scope-btn active" id="fcScopeDoc" onclick="setFcScope('document')">Whole Document</button>
        <button class="fc-scope-btn" id="fcScopeSel" onclick="setFcScope('selection')">Selection Only</button>
      </div>
    </div>
    <div class="fc-list" id="fcList">
      <div class="fc-font-item selected" data-font="Default" onclick="fcSelectFont('Default')">
        <span class="fc-font-name" style="font-family:inherit">Default</span>
        <span class="fc-font-preview">Aa</span>
      </div>
    </div>
    <div class="fc-upload-row">
      <button class="fc-upload-btn" onclick="document.getElementById('fontUploadFc').click()">
        <span class="material-symbols-outlined" style="font-size:18px">upload</span>Upload Font (.ttf/.otf/.woff)
      </button>
      <input type="file" id="fontUploadFc" accept=".ttf,.otf,.woff,.woff2" style="display:none" onchange="handleFontUploadFc(this)"/>
    </div>
  </div>
</div>

<!-- ── Text Selection Popup ──────────────────────────────────────── -->
<div class="ctx-popup" id="textPopup">
  <div class="ctx-popup-row">
    <button class="cpp-btn" onclick="textPopupAction('cut')"><span class="material-symbols-outlined">content_cut</span>Cut</button>
    <button class="cpp-btn" onclick="textPopupAction('copy')"><span class="material-symbols-outlined">content_copy</span>Copy</button>
    <button class="cpp-btn" onclick="textPopupAction('paste')"><span class="material-symbols-outlined">content_paste</span>Paste</button>
    <button class="cpp-btn" onclick="textPopupAction('selectAll')"><span class="material-symbols-outlined">select_all</span>Select All</button>
    <button class="cpp-btn danger" onclick="textPopupAction('delete')"><span class="material-symbols-outlined">delete</span>Delete</button>
  </div>
  <div class="ctx-popup-sep"></div>
  <div class="ctx-popup-row">
    <button class="cpp-icon-btn" id="tpBold" onclick="textPopupFormat('bold')" title="Bold"><span class="material-symbols-outlined">format_bold</span></button>
    <button class="cpp-icon-btn" id="tpItalic" onclick="textPopupFormat('italic')" title="Italic"><span class="material-symbols-outlined">format_italic</span></button>
    <button class="cpp-icon-btn" id="tpUnder" onclick="textPopupFormat('underline')" title="Underline"><span class="material-symbols-outlined">format_underlined</span></button>
    <button class="cpp-icon-btn" id="tpStrike" onclick="textPopupFormat('strikeThrough')" title="Strikethrough"><span class="material-symbols-outlined">strikethrough_s</span></button>
    <button class="cpp-font-mini" onclick="openFontChooser('selection')" title="Font for selection">
      <span class="material-symbols-outlined" style="font-size:14px">text_fields</span>Font
    </button>
  </div>
  <div class="ctx-popup-sep"></div>
  <div class="cpp-size-row">
    <span class="material-symbols-outlined" style="font-size:15px;color:#888">format_size</span>
    <button class="cpp-icon-btn" onclick="textPopupStepSize(-2)" style="padding:4px"><span class="material-symbols-outlined" style="font-size:14px">remove</span></button>
    <input type="number" class="cpp-size-inp" id="tpSizeInp" value="16" min="8" max="144" onchange="textPopupApplySize(+this.value)"/>
    <button class="cpp-icon-btn" onclick="textPopupStepSize(2)" style="padding:4px"><span class="material-symbols-outlined" style="font-size:14px">add</span></button>
  </div>
  <div class="cpp-color-row">
    <span class="cpp-color-label">Color</span>
    <input type="color" class="cpp-color-inp" id="tpTextColor" value="#000000" onchange="document.execCommand('foreColor',false,this.value)" title="Text color"/>
    <span class="cpp-color-label">Highlight</span>
    <input type="color" class="cpp-color-inp" id="tpHighlight" value="#ffff00" onchange="document.execCommand('hiliteColor',false,this.value)" title="Highlight"/>
  </div>
</div>

<!-- ── HR Popup ───────────────────────────────────────────────────── -->
<div class="ctx-popup" id="hrPopup">
  <div class="ctx-popup-row">
    <button class="cpp-btn" onclick="hrPopupAction('top')"><span class="material-symbols-outlined">vertical_align_top</span>Cursor Above</button>
    <button class="cpp-btn" onclick="hrPopupAction('bottom')"><span class="material-symbols-outlined">vertical_align_bottom</span>Cursor Below</button>
  </div>
  <div class="cpp-color-row">
    <span class="cpp-color-label">Line Color</span>
    <input type="color" class="cpp-color-inp" id="hrColorInp" value="#cccccc" onchange="hrPopupSetColor(this.value)" title="HR color"/>
  </div>
  <div class="ctx-popup-sep"></div>
  <div class="ctx-popup-row">
    <button class="cpp-btn danger" onclick="hrPopupAction('delete')"><span class="material-symbols-outlined">delete</span>Delete</button>
  </div>
</div>

<!-- ── Image Popup ────────────────────────────────────────────────── -->
<div class="ctx-popup" id="imgPopup">
  <div class="ctx-popup-row">
    <button class="cpp-btn danger" onclick="imgPopupDelete()"><span class="material-symbols-outlined">delete</span>Delete Image</button>
  </div>
</div>
  <div class="tip-prog"><div class="tip-bar" id="tipBar"></div></div>
  <div class="tip-text" id="tipText"></div>
  <div class="tip-actions">
    <button class="tip-btn tip-prev" id="tipPrev" onclick="tipNav(-1)">Back</button>
    <button class="tip-btn tip-next" onclick="tipNav(1)" id="tipNext">Next</button>
  </div>
</div>

<script>
'use strict';

/* ═══════════════════════════════════════════════════════
   STATE
═══════════════════════════════════════════════════════ */
const S = {
  pageCount: 1,
  zoom: 100,
  font: 'Default',
  fonts: {},          // uploaded fonts
  imgData: null,
  selImg: null,
  lastRange: null,
  isResizing: false,
  isDragging: false,
  dx:{},              // drag state
  pdfBlob: null,
  hasContent: false,
  ctxTable: null,     // table currently right-clicked
  ctxCell: null,      // cell currently right-clicked
};

/* ═══════════════════════════════════════════════════════
   INIT
═══════════════════════════════════════════════════════ */
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('editorContainer').style.display = 'flex';
    initEditor();
  }, 900);
});

function initEditor() {
  bindPages();
  updatePageIndicator();
  updateWordCount();
  startOverflowCheck();
  initTheme();
  initTips();
  loadTemplateFromHash();
  document.getElementById('editorAreaWrapper').addEventListener('scroll', updatePageIndicator);
  document.addEventListener('click', onDocClick);
  document.addEventListener('scroll', syncResizeHandle, true);
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeAllMdl();
      closeFontChooser();
      hideTextPopup(); hideHrPopup(); hideImgPopup();
    }
  });
  document.addEventListener('contextmenu', onContextMenu);
  // Prevent browser's native print dialog (Ctrl+P / Cmd+P)
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
      e.preventDefault();
      openExportModal();
    }
  });
  // Prevent browser share dialog (mobile)
  window.addEventListener('beforeprint', e => e.stopImmediatePropagation(), true);
}

/* ═══════════════════════════════════════════════════════
   CONTENT TRACKING (disables Import when editing)
═══════════════════════════════════════════════════════ */
function checkContent() {
  const found = [...document.querySelectorAll('.page-content')]
    .some(p => p.textContent.trim() || p.querySelector('img,table'));
  S.hasContent = found;
  const btn = document.getElementById('importBtn');
  btn.disabled = found;
  btn.title = found ? 'Importing is disabled while you have content. Clear the document first.' : 'Import .scd file';
}

/* ═══════════════════════════════════════════════════════
   PAGE BINDING
═══════════════════════════════════════════════════════ */
function bindPages() {
  document.querySelectorAll('.page-content').forEach(el => {
    if (el._bound) return;
    el._bound = true;
    el.addEventListener('input', () => { updateWordCount(); checkContent(); document.querySelectorAll('.page-content hr').forEach(wireHr); });
    el.addEventListener('paste', onPaste);
    el.addEventListener('keyup', syncFontSz);
    el.addEventListener('mouseup', syncFontSz);
    el.querySelectorAll('img').forEach(wireImg);
  });
  initHoldDetection();
}

/* ═══════════════════════════════════════════════════════
   OVERFLOW CHECK
═══════════════════════════════════════════════════════ */
function startOverflowCheck() {
  setInterval(() => {
    const over = [...document.querySelectorAll('.page-content')].some(p => p.scrollHeight > p.clientHeight + 6);
    document.getElementById('overflowAlert').style.display = over ? 'block' : 'none';
  }, 900);
}

/* ═══════════════════════════════════════════════════════
   FONT CHOOSER (center-screen modal, upload-only)
═══════════════════════════════════════════════════════ */
const FC = {
  scope: 'document',       // 'document' | 'selection'
  selected: 'Default',
  fonts: [],               // [{name, family}]
  savedRange: null,
};

function openFontChooser(scope) {
  // save selection before opening
  const sel = window.getSelection();
  FC.savedRange = (sel && sel.rangeCount) ? sel.getRangeAt(0).cloneRange() : null;
  FC.scope = scope || 'document';

  // scope row visibility
  const scopeRow = document.getElementById('fcScopeRow');
  if (scope === 'selection' && FC.savedRange && !FC.savedRange.collapsed) {
    scopeRow.style.display = 'block';
    document.getElementById('fcScopeDoc').classList.remove('active');
    document.getElementById('fcScopeSel').classList.add('active');
    FC.scope = 'selection';
  } else {
    scopeRow.style.display = 'none';
    FC.scope = 'document';
  }

  document.getElementById('fontChooserModal').classList.add('open');
  hideTextPopup();
}

function closeFontChooser() {
  document.getElementById('fontChooserModal').classList.remove('open');
}

function setFcScope(scope) {
  FC.scope = scope;
  document.getElementById('fcScopeDoc').classList.toggle('active', scope === 'document');
  document.getElementById('fcScopeSel').classList.toggle('active', scope === 'selection');
}

function fcSelectFont(name) {
  FC.selected = name;
  // highlight selected
  document.querySelectorAll('.fc-font-item').forEach(el => el.classList.toggle('selected', el.dataset.font === name));

  const family = name === 'Default' ? '' : name;

  if (FC.scope === 'document') {
    S.font = name;
    document.getElementById('selectedFont').textContent = name;
    // apply to all page-content
    document.querySelectorAll('.page-content').forEach(p => {
      p.style.fontFamily = family;
    });
  } else {
    // apply only to saved selection
    if (FC.savedRange) {
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(FC.savedRange);
      if (family) {
        try {
          const span = document.createElement('span');
          span.style.fontFamily = family;
          FC.savedRange.surroundContents(span);
        } catch {
          document.execCommand('fontName', false, family);
        }
      } else {
        document.execCommand('removeFormat');
      }
    }
  }
  closeFontChooser();
}

function addFcFontOption(name) {
  const list = document.getElementById('fcList');
  if ([...list.querySelectorAll('.fc-font-item')].some(el => el.dataset.font === name)) return;
  const item = document.createElement('div');
  item.className = 'fc-font-item';
  item.dataset.font = name;
  item.onclick = () => fcSelectFont(name);
  item.innerHTML = `<span class="fc-font-name" style="font-family:'${name}'">${name}</span><span class="fc-font-preview" style="font-family:'${name}'">Aa</span>`;
  list.appendChild(item);
}

function handleFontUpload(input) {
  const file = input.files[0];
  if (!file) return;
  _loadFontFile(file);
  input.value = '';
}

function handleFontUploadFc(input) {
  const file = input.files[0];
  if (!file) return;
  _loadFontFile(file, true);
  input.value = '';
}

function _loadFontFile(file, autoSelect) {
  const reader = new FileReader();
  reader.onload = e => {
    const name = file.name.replace(/\.[^.]+$/, '');
    const face = new FontFace(name, `url(${e.target.result})`);
    const finish = () => {
      S.fonts[name] = e.target.result;
      addFcFontOption(name);
      if (autoSelect) fcSelectFont(name);
      showToast(`Font "${name}" loaded`, 'success');
    };
    face.load().then(f => { document.fonts.add(f); finish(); }).catch(() => finish());
  };
  reader.readAsDataURL(file);
}

// legacy — kept for SCD load compat
function selectFont(name) {
  S.font = name;
  document.getElementById('selectedFont').textContent = name;
  document.querySelectorAll('.page-content').forEach(p => { p.style.fontFamily = name === 'Default' ? '' : name; });
}

function addFontOption(name) { addFcFontOption(name); }

/* ═══════════════════════════════════════════════════════
   TEXT SELECTION POPUP
═══════════════════════════════════════════════════════ */
let _tpHoldTimer = null, _tpTarget = null, _hrPopupTarget = null, _imgPopupTarget = null;

function showTextPopup(x, y) {
  const pop = document.getElementById('textPopup');
  pop.classList.add('open');
  positionPopup(pop, x, y);
  // sync size input
  const sel = window.getSelection();
  if (sel && sel.rangeCount) {
    const el = sel.getRangeAt(0).startContainer.parentElement;
    if (el) { const fs = parseInt(getComputedStyle(el).fontSize); if (!isNaN(fs)) document.getElementById('tpSizeInp').value = fs; }
  }
}
function hideTextPopup() { document.getElementById('textPopup').classList.remove('open'); }

function textPopupAction(action) {
  hideTextPopup();
  if (action === 'cut') document.execCommand('cut');
  else if (action === 'copy') document.execCommand('copy');
  else if (action === 'paste') navigator.clipboard.readText().then(t => document.execCommand('insertText', false, t)).catch(() => document.execCommand('paste'));
  else if (action === 'selectAll') document.execCommand('selectAll');
  else if (action === 'delete') document.execCommand('delete');
}
function textPopupFormat(cmd) {
  document.execCommand(cmd);
}
function textPopupStepSize(d) {
  const inp = document.getElementById('tpSizeInp');
  const v = Math.min(144, Math.max(8, (+inp.value || 16) + d));
  inp.value = v;
  textPopupApplySize(v);
}
function textPopupApplySize(size) {
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  const span = document.createElement('span');
  span.style.fontSize = size + 'px';
  try { range.surroundContents(span); }
  catch {
    document.execCommand('fontSize', false, '7');
    document.querySelectorAll('font[size="7"]').forEach(f => { f.removeAttribute('size'); f.style.fontSize = size+'px'; });
  }
}

/* ═══════════════════════════════════════════════════════
   HR POPUP
═══════════════════════════════════════════════════════ */
function showHrPopup(hr, x, y) {
  _hrPopupTarget = hr;
  const pop = document.getElementById('hrPopup');
  // sync colour input
  const cur = hr.style.borderTopColor || '#cccccc';
  document.getElementById('hrColorInp').value = rgbToHex(cur);
  pop.classList.add('open');
  positionPopup(pop, x, y);
}
function hideHrPopup() { document.getElementById('hrPopup').classList.remove('open'); _hrPopupTarget = null; }

function hrPopupAction(action) {
  const hr = _hrPopupTarget;
  hideHrPopup();
  if (!hr) return;
  if (action === 'delete') { hr.remove(); checkContent(); }
  else if (action === 'top') {
    const range = document.createRange();
    range.setStartBefore(hr); range.collapse(true);
    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
    hr.closest('[contenteditable]').focus();
  } else if (action === 'bottom') {
    const range = document.createRange();
    range.setStartAfter(hr); range.collapse(false);
    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
    hr.closest('[contenteditable]').focus();
  }
}
function hrPopupSetColor(color) {
  if (_hrPopupTarget) { _hrPopupTarget.style.borderTopColor = color; _hrPopupTarget.style.borderColor = color; }
}

/* ═══════════════════════════════════════════════════════
   IMAGE POPUP
═══════════════════════════════════════════════════════ */
function showImgPopup(img, x, y) {
  _imgPopupTarget = img;
  const pop = document.getElementById('imgPopup');
  pop.classList.add('open');
  positionPopup(pop, x, y);
}
function hideImgPopup() { document.getElementById('imgPopup').classList.remove('open'); _imgPopupTarget = null; }

function imgPopupDelete() {
  if (_imgPopupTarget) { _imgPopupTarget.remove(); checkContent(); }
  hideImgPopup();
  depickImg();
}

/* ── Popup positioning helper ─────────────────────────────────────── */
function positionPopup(pop, x, y) {
  pop.style.left = x + 'px'; pop.style.top = y + 'px';
  requestAnimationFrame(() => {
    const r = pop.getBoundingClientRect();
    if (r.right > window.innerWidth - 10) pop.style.left = (window.innerWidth - r.width - 10) + 'px';
    if (r.bottom > window.innerHeight - 10) pop.style.top = (y - r.height - 10) + 'px';
  });
}

/* ── Colour util ──────────────────────────────────────────────────── */
function rgbToHex(rgb) {
  if (!rgb || rgb.startsWith('#')) return rgb || '#cccccc';
  const m = rgb.match(/\d+/g);
  if (!m || m.length < 3) return '#cccccc';
  return '#' + m.slice(0,3).map(n => parseInt(n).toString(16).padStart(2,'0')).join('');
}

/* ── Long-press / hold detection on page content ─────────────────── */
function initHoldDetection() {
  document.querySelectorAll('.page-content').forEach(pc => {
    if (pc._holdBound) return;
    pc._holdBound = true;

    // touch hold for text popup
    pc.addEventListener('touchstart', e => {
      clearTimeout(_tpHoldTimer);
      const t = e.touches[0];
      const target = e.target;
      if (target.tagName === 'HR') {
        _tpHoldTimer = setTimeout(() => { showHrPopup(target, t.clientX, t.clientY - 10); }, 500);
        return;
      }
      if (target.tagName === 'IMG') {
        _tpHoldTimer = setTimeout(() => { showImgPopup(target, t.clientX, t.clientY - 10); }, 500);
        return;
      }
      _tpHoldTimer = setTimeout(() => {
        const sel = window.getSelection();
        if (sel && !sel.isCollapsed) showTextPopup(t.clientX, t.clientY - 10);
      }, 500);
    }, {passive:true});

    pc.addEventListener('touchend', () => clearTimeout(_tpHoldTimer));
    pc.addEventListener('touchmove', () => clearTimeout(_tpHoldTimer));

    // desktop: show text popup on mouseup with selection
    pc.addEventListener('mouseup', e => {
      setTimeout(() => {
        const sel = window.getSelection();
        if (sel && !sel.isCollapsed && sel.toString().trim()) {
          showTextPopup(e.clientX, e.clientY + 10);
        } else {
          hideTextPopup();
        }
      }, 10);
    });
  });

  // HR: right-click and touch hold (already covered above for touch)
  // HR desktop right-click → context menu superseded; use long press only on touch,
  // on desktop show on right-click
  document.querySelectorAll('.page-content hr').forEach(hr => wireHr(hr));
}

function wireHr(hr) {
  if (hr._hrBound) return; hr._hrBound = true;
  hr.style.cursor = 'pointer';
  hr.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); showHrPopup(hr, e.clientX, e.clientY); });
  hr.addEventListener('touchstart', e => {
    clearTimeout(_tpHoldTimer);
    const t = e.touches[0];
    _tpHoldTimer = setTimeout(() => showHrPopup(hr, t.clientX, t.clientY - 10), 500);
  }, {passive:true});
  hr.addEventListener('touchend', () => clearTimeout(_tpHoldTimer));
  hr.addEventListener('touchmove', () => clearTimeout(_tpHoldTimer));
}


function stepFont(d) {
  const el = document.getElementById('fontSize');
  const v = Math.min(144, Math.max(8, (+el.value || 16) + d));
  el.value = v;
  applyFontSize(v);
}

function applyFontSize(size) {
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  const span = document.createElement('span');
  span.style.fontSize = size + 'px';
  try { range.surroundContents(span); }
  catch {
    document.execCommand('fontSize', false, '7');
    document.querySelectorAll('font[size="7"]').forEach(f => {
      f.removeAttribute('size'); f.style.fontSize = size + 'px';
    });
  }
}

function syncFontSz() {
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount) return;
  const el = sel.getRangeAt(0).startContainer.parentElement;
  if (el) { const fs = parseInt(getComputedStyle(el).fontSize); if (!isNaN(fs)) document.getElementById('fontSize').value = fs; }
}

function insertHR() {
  const hr = document.createElement('hr');
  hr.style.cssText = 'border:none;border-top:2px solid #ccc;margin:12px 0';
  document.execCommand('insertHTML', false, hr.outerHTML);
  // wire any newly created HRs
  document.querySelectorAll('.page-content hr').forEach(wireHr);
}

/* ═══════════════════════════════════════════════════════
   IMAGE
═══════════════════════════════════════════════════════ */
function openImageModal() {
  saveRange();
  setupDZ('imgDZ', 'imageFile', f => readImgFile(f));
  openMdl('imageMdl');
}

function previewImg(input) { if (input.files[0]) readImgFile(input.files[0]); }

function readImgFile(file) {
  const r = new FileReader();
  r.onload = e => {
    S.imgData = e.target.result;
    const prev = document.getElementById('imagePreview');
    prev.src = e.target.result; prev.style.display = 'block';
  };
  r.readAsDataURL(file);
}

function insertImage() {
  if (!S.imgData) return;
  restoreRange();
  insertAtCursor(makeImg(S.imgData));
  S.imgData = null;
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('imageFile').value = '';
  closeMdl('imageMdl');
}

function makeImg(src) {
  const img = document.createElement('img');
  img.src = src; img.style.maxWidth = '100%'; img.style.height = 'auto'; img.draggable = false;
  wireImg(img); return img;
}

function wireImg(img) {
  img.addEventListener('mousedown', e => startImgDrag(e, img));
  img.addEventListener('touchstart', e => {
    clearTimeout(_tpHoldTimer);
    const t = e.touches[0];
    _tpHoldTimer = setTimeout(() => { e.preventDefault(); showImgPopup(img, t.clientX, t.clientY - 10); }, 500);
    startImgDrag(e, img);
  }, {passive:false});
  img.addEventListener('touchend', () => clearTimeout(_tpHoldTimer));
  img.addEventListener('touchmove', () => clearTimeout(_tpHoldTimer));
  img.addEventListener('click', e => { e.stopPropagation(); pickImg(img); });
  // Desktop right-click for image popup
  img.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); showImgPopup(img, e.clientX, e.clientY); });
}

function pickImg(img) {
  if (S.selImg) S.selImg.classList.remove('selected');
  S.selImg = img; img.classList.add('selected'); showResizeH(img);
}

function depickImg() {
  if (S.selImg) { S.selImg.classList.remove('selected'); S.selImg = null; }
  hideResizeH();
}

function showResizeH(img) {
  const h = document.getElementById('resizeHandle');
  const rect = img.getBoundingClientRect();
  h.style.display = 'block';
  h.style.left = (rect.right - 6) + 'px';
  h.style.top = (rect.bottom - 6) + 'px';
  h.onmousedown = h.ontouchstart = ev => startResize(ev, img);
}
function hideResizeH() { document.getElementById('resizeHandle').style.display = 'none'; }
function syncResizeHandle() { if (S.selImg) showResizeH(S.selImg); }

function startResize(e, img) {
  e.preventDefault(); e.stopPropagation();
  S.isResizing = true;
  const t = e.touches ? e.touches[0] : e;
  S.dx = {sx: t.clientX, sw: img.offsetWidth};
  const move = ev => {
    if (!S.isResizing) return;
    const t2 = ev.touches ? ev.touches[0] : ev;
    const w = S.dx.sw + (t2.clientX - S.dx.sx);
    if (w > 40) { img.style.width = w + 'px'; img.style.height = 'auto'; }
    syncResizeHandle();
  };
  const end = () => {
    S.isResizing = false;
    document.removeEventListener('mousemove', move);
    document.removeEventListener('mouseup', end);
    document.removeEventListener('touchmove', move);
    document.removeEventListener('touchend', end);
  };
  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', end);
  document.addEventListener('touchmove', move, {passive:false});
  document.addEventListener('touchend', end);
}

function startImgDrag(e, img) {
  e.preventDefault(); e.stopPropagation(); pickImg(img); S.isDragging = true;
  const t = e.touches ? e.touches[0] : e;
  S.dx = {sx: t.clientX, sy: t.clientY, ol: img.offsetLeft, ot: img.offsetTop};
  img.style.position = 'absolute';
  img.style.left = S.dx.ol + 'px'; img.style.top = S.dx.ot + 'px'; img.style.zIndex = '1000';
  const move = ev => {
    if (!S.isDragging) return;
    ev.preventDefault();
    const t2 = ev.touches ? ev.touches[0] : ev;
    img.style.left = (S.dx.ol + t2.clientX - S.dx.sx) + 'px';
    img.style.top = (S.dx.ot + t2.clientY - S.dx.sy) + 'px';
    syncResizeHandle();
  };
  const end = () => {
    S.isDragging = false;
    document.removeEventListener('mousemove', move);
    document.removeEventListener('mouseup', end);
    document.removeEventListener('touchmove', move);
    document.removeEventListener('touchend', end);
  };
  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', end);
  document.addEventListener('touchmove', move, {passive:false});
  document.addEventListener('touchend', end);
}

/* ═══════════════════════════════════════════════════════
   TABLE INSERT
═══════════════════════════════════════════════════════ */
function openTableModal() { saveRange(); openMdl('tableMdl'); }

function insertTable() {
  const rows = Math.max(1, +document.getElementById('tableRows').value || 3);
  const cols = Math.max(1, +document.getElementById('tableCols').value || 3);
  let h = '<table style="border-collapse:collapse;width:100%;margin:10px 0"><tbody>';
  for (let r = 0; r < rows; r++) {
    h += '<tr>';
    for (let c = 0; c < cols; c++) h += '<td style="border:1px solid #ccc;padding:6px 8px;min-width:40px">&nbsp;</td>';
    h += '</tr>';
  }
  h += '</tbody></table><p></p>';
  restoreRange();
  document.execCommand('insertHTML', false, h);
  closeMdl('tableMdl');
}

/* ═══════════════════════════════════════════════════════
   TABLE CONTEXT MENU
═══════════════════════════════════════════════════════ */
function onContextMenu(e) {
  // HR and IMG have their own right-click handlers
  if (e.target.tagName === 'HR' || e.target.tagName === 'IMG') return;
  const cell = e.target.closest('td,th');
  const table = e.target.closest('table');
  if (!cell || !table) { hideCtxMenu(); return; }
  e.preventDefault();
  S.ctxTable = table; S.ctxCell = cell;
  const menu = document.getElementById('tableCtxMenu');
  menu.style.display = 'block';
  // position
  let x = e.clientX, y = e.clientY;
  menu.style.left = x + 'px'; menu.style.top = y + 'px';
  // keep on screen
  requestAnimationFrame(() => {
    const rect = menu.getBoundingClientRect();
    if (rect.right > window.innerWidth) menu.style.left = (x - rect.width) + 'px';
    if (rect.bottom > window.innerHeight) menu.style.top = (y - rect.height) + 'px';
  });
}

function hideCtxMenu() {
  document.getElementById('tableCtxMenu').style.display = 'none';
}

function tableAction(action) {
  hideCtxMenu();
  const table = S.ctxTable, cell = S.ctxCell;
  if (!table || !cell) return;

  const row = cell.closest('tr');
  const tbody = table.querySelector('tbody') || table;
  const rows = [...tbody.querySelectorAll('tr')];
  const rowIdx = rows.indexOf(row);
  const cells = [...row.querySelectorAll('td,th')];
  const colIdx = cells.indexOf(cell);
  const numCols = rows[0] ? rows[0].querySelectorAll('td,th').length : 1;

  const makeCell = (tag='td') => {
    const c = document.createElement(tag);
    c.style.cssText = 'border:1px solid #ccc;padding:6px 8px;min-width:40px';
    c.innerHTML = '&nbsp;';
    return c;
  };
  const makeRow = (cols) => {
    const tr = document.createElement('tr');
    for (let i = 0; i < cols; i++) tr.appendChild(makeCell());
    return tr;
  };

  switch (action) {
    case 'addRowAbove':
      tbody.insertBefore(makeRow(numCols), row);
      break;
    case 'addRowBelow':
      row.after(makeRow(numCols));
      break;
    case 'addColLeft':
      rows.forEach((r, ri) => {
        const cs = [...r.querySelectorAll('td,th')];
        const ref = cs[colIdx] || null;
        r.insertBefore(makeCell(ri === 0 ? (cs[0].tagName.toLowerCase()) : 'td'), ref);
      });
      break;
    case 'addColRight':
      rows.forEach((r, ri) => {
        const cs = [...r.querySelectorAll('td,th')];
        const ref = cs[colIdx];
        if (ref) ref.after(makeCell(ri === 0 ? ref.tagName.toLowerCase() : 'td'));
        else r.appendChild(makeCell('td'));
      });
      break;
    case 'deleteRow':
      if (rows.length > 1) row.remove();
      else showToast('Cannot delete the only row', 'error');
      break;
    case 'deleteCol':
      if (numCols > 1) {
        rows.forEach(r => {
          const cs = [...r.querySelectorAll('td,th')];
          if (cs[colIdx]) cs[colIdx].remove();
        });
      } else showToast('Cannot delete the only column', 'error');
      break;
    case 'deleteTable':
      table.remove();
      break;
  }
  checkContent();
}

/* ═══════════════════════════════════════════════════════
   LINK
═══════════════════════════════════════════════════════ */
function openLinkModal() {
  saveRange();
  const sel = window.getSelection();
  document.getElementById('linkText').value = sel ? sel.toString() : '';
  document.getElementById('linkUrl').value = '';
  openMdl('linkMdl');
}

function insertLink() {
  const txt = document.getElementById('linkText').value.trim();
  const url = document.getElementById('linkUrl').value.trim();
  if (!txt || !url) return showToast('Fill in both fields', 'error');
  restoreRange();
  document.execCommand('insertHTML', false,
    `<a href="${esc(url)}" target="_blank" rel="noopener noreferrer">${esc(txt)}</a>`);
  closeMdl('linkMdl');
}

/* ═══════════════════════════════════════════════════════
   PASTE
═══════════════════════════════════════════════════════ */
function onPaste(e) {
  const items = e.clipboardData && e.clipboardData.items;
  if (!items) return;
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      const r = new FileReader();
      r.onload = ev => insertAtCursor(makeImg(ev.target.result));
      r.readAsDataURL(item.getAsFile());
      return;
    }
  }
}

/* ═══════════════════════════════════════════════════════
   CURSOR
═══════════════════════════════════════════════════════ */
function saveRange() {
  const sel = window.getSelection();
  S.lastRange = sel && sel.rangeCount ? sel.getRangeAt(0).cloneRange() : null;
}
function restoreRange() {
  if (!S.lastRange) return;
  const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(S.lastRange);
}
function insertAtCursor(node) {
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount) return;
  const r = sel.getRangeAt(0); r.insertNode(node); r.setStartAfter(node); r.collapse(true);
  sel.removeAllRanges(); sel.addRange(r);
}

/* ═══════════════════════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════════════════════ */
function toggleSidebar() {
  const sb = document.getElementById('sidebar'), exp = document.getElementById('expandBtn');
  sb.classList.toggle('collapsed');
  exp.style.display = sb.classList.contains('collapsed') ? 'block' : 'none';
}
function updateWatermark() {
  const t = document.getElementById('watermarkText').value;
  document.querySelectorAll('.watermark').forEach(w => w.textContent = t);
}
function updateLineSpacing(v) { document.querySelectorAll('.page-content').forEach(p => p.style.lineHeight = v); }
function toggleGradientUI(t) { document.getElementById('gradientControls').classList.toggle('active', t === 'gradient'); updateBackground(); }
function updateBackground() {
  const type = document.getElementById('bgType').value, c1 = document.getElementById('bgColor').value;
  document.querySelectorAll('.page').forEach(pg => {
    pg.style.background = type === 'gradient'
      ? `linear-gradient(${document.getElementById('gradientAngle').value}deg,${c1},${document.getElementById('bgColor2').value})`
      : c1;
  });
}
function updateMargins(v) { document.querySelectorAll('.page').forEach(p => p.style.padding = v + 'cm'); }

/* ═══════════════════════════════════════════════════════
   PAGES
═══════════════════════════════════════════════════════ */
function addNewPage() {
  S.pageCount++;
  const n = S.pageCount, area = document.getElementById('editorArea'), btn = area.querySelector('.add-page-btn');
  const page = document.createElement('div');
  page.className = 'page'; page.id = 'page' + n;
  page.innerHTML = `<div class="watermark" id="watermark${n}"></div><div class="page-content" contenteditable="true" id="pageContent${n}"></div>`;
  area.insertBefore(page, btn);
  bindPages(); updatePageIndicator(); updateWatermark(); updateBackground();
  updateMargins(document.getElementById('pageMargin').value);
  updateLineSpacing(document.getElementById('lineSpacing').value);
}

function updatePageIndicator() {
  const wrap = document.getElementById('editorAreaWrapper');
  const pages = document.querySelectorAll('.page');
  const mid = wrap.scrollTop + wrap.clientHeight / 2;
  let cur = 1, acc = 36;
  for (let i = 0; i < pages.length; i++) {
    acc += pages[i].offsetHeight + 20;
    if (mid < acc) { cur = i + 1; break; }
  }
  document.getElementById('pageIndicator').textContent = `${cur}/${S.pageCount}`;
}

function updateWordCount() {
  const t = [...document.querySelectorAll('.page-content')].map(p => p.textContent).join(' ');
  const w = t.trim().split(/\s+/).filter(Boolean).length;
  document.getElementById('wordCount').textContent = `${w} word${w !== 1 ? 's' : ''}`;
}

/* ═══════════════════════════════════════════════════════
   ZOOM
═══════════════════════════════════════════════════════ */
function adjustZoom(d) { S.zoom = Math.max(30, Math.min(200, S.zoom + d)); applyZoom(); }
function resetZoom() { S.zoom = 100; applyZoom(); }
function applyZoom() {
  document.getElementById('editorArea').style.transform = `scale(${S.zoom / 100})`;
  document.getElementById('zoomDisplay').textContent = S.zoom + '%';
  syncResizeHandle();
}

/* ═══════════════════════════════════════════════════════
   CLICKS
═══════════════════════════════════════════════════════ */
function onDocClick(e) {
  if (!e.target.closest('#fontChooserModal')) {
    // don't close font chooser if clicking within it
  }
  if (!e.target.closest('#textPopup') && !e.target.closest('.page-content')) hideTextPopup();
  if (!e.target.closest('#hrPopup') && e.target.tagName !== 'HR') hideHrPopup();
  if (!e.target.closest('#imgPopup') && e.target.tagName !== 'IMG') hideImgPopup();
  if (e.target.tagName !== 'IMG' && !e.target.closest('#resizeHandle')) depickImg();
  if (!e.target.closest('#tableCtxMenu')) hideCtxMenu();
}

/* ═══════════════════════════════════════════════════════
   MODALS
═══════════════════════════════════════════════════════ */
function openMdl(id) { const m = document.getElementById(id); if (m) m.classList.add('open'); }
function closeMdl(id) { const m = document.getElementById(id); if (m) m.classList.remove('open'); }
function closeAllMdl() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }

function setupDZ(zoneId, inputId, onFile) {
  const z = document.getElementById(zoneId), inp = document.getElementById(inputId);
  if (!z || !inp) return;
  z.onclick = () => inp.click();
  z.ondragover = e => { e.preventDefault(); z.classList.add('dragover'); };
  z.ondragleave = () => z.classList.remove('dragover');
  z.ondrop = e => { e.preventDefault(); z.classList.remove('dragover'); const f = e.dataTransfer.files[0]; if (f) onFile(f); };
}

/* ═══════════════════════════════════════════════════════
   EXPORT
═══════════════════════════════════════════════════════ */
function openExportModal() { openMdl('exportMdl'); }

function doExport(fmt) {
  closeMdl('exportMdl');
  ({pdf: exportPDF, scd: exportSCD, docx: exportDOCX, txt: exportTXT, jpg: exportJPG}[fmt] || (() => {}))();
}

/* PDF */
async function exportPDF() {
  openMdl('pdfMdl');
  document.getElementById('pdfTitle').textContent = 'Generating PDF…';
  document.getElementById('pdfStatus').textContent = 'Preparing…';
  document.getElementById('pdfFill').style.width = '0%';
  document.getElementById('pdfActions').style.display = 'none';

  const {jsPDF} = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const pages = document.querySelectorAll('.page');
  const origZ = S.zoom; S.zoom = 100; applyZoom();
  await delay(120);

  for (let i = 0; i < pages.length; i++) {
    document.getElementById('pdfStatus').textContent = `Rendering page ${i+1} of ${pages.length}…`;
    document.getElementById('pdfFill').style.width = ((i / pages.length) * 90) + '%';
    const clone = pages[i].cloneNode(true);
    clone.style.cssText += ';position:absolute;left:-9999px;top:0';
    document.body.appendChild(clone);
    await delay(80);
    const canvas = await html2canvas(clone, {scale:3,useCORS:true,allowTaint:true,backgroundColor:'#fff',logging:false});
    document.body.removeChild(clone);
    if (i > 0) pdf.addPage();
    pdf.addImage(canvas.toDataURL('image/jpeg',0.92),'JPEG',0,0,210,297,'','SLOW');
  }

  S.zoom = origZ; applyZoom();
  S.pdfBlob = pdf.output('blob');
  document.getElementById('pdfFill').style.width = '100%';
  document.getElementById('pdfStatus').textContent = 'Done!';
  document.getElementById('pdfActions').style.display = 'flex';
  document.getElementById('pdfDlBtn').onclick = () => {
    dlBlob(S.pdfBlob, safeFile(getTitle()) + '.pdf');
    closeMdl('pdfMdl');
    showToast('PDF downloaded', 'success');
  };
}

/* SCD */
function exportSCD() {
  try {
    dlBlob(new Blob([JSON.stringify(collectData(), null, 2)], {type:'application/x-sugercane-document'}), safeFile(getTitle()) + '.scd');
    showToast('Exported as .scd', 'success');
  } catch(err) { showToast('Export failed: ' + err.message, 'error'); }
}

/* DOCX */
function exportDOCX() {
  try {
    const pages = [...document.querySelectorAll('.page-content')];
    const body = pages.map(p => p.innerHTML).join('<hr/>');
    const html = `<!DOCTYPE html><html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
<head><meta charset="UTF-8"><title>${esc(getTitle())}</title>
<style>body{font-family:Arial;font-size:12pt;margin:2cm}table{border-collapse:collapse}td,th{border:1px solid #ccc;padding:6px}</style>
</head><body>${body}</body></html>`;
    dlBlob(new Blob([html], {type:'application/msword'}), safeFile(getTitle()) + '.doc');
    showToast('Exported as .doc (Word-compatible)', 'success');
  } catch(err) { showToast('Export failed: ' + err.message, 'error'); }
}

/* TXT */
function exportTXT() {
  const text = [...document.querySelectorAll('.page-content')].map(p => p.innerText).join('\n\n---\n\n');
  dlBlob(new Blob([text], {type:'text/plain;charset=utf-8'}), safeFile(getTitle()) + '.txt');
  showToast('Exported as .txt', 'success');
}

/* JPG */
async function exportJPG() {
  const pages = document.querySelectorAll('.page');
  const title = safeFile(getTitle());
  const origZ = S.zoom; S.zoom = 100; applyZoom();
  await delay(120);
  showToast(`Exporting ${pages.length} page(s) as JPG…`, 'info');
  for (let i = 0; i < pages.length; i++) {
    const clone = pages[i].cloneNode(true);
    clone.style.cssText += ';position:absolute;left:-9999px;top:0';
    document.body.appendChild(clone);
    await delay(80);
    const canvas = await html2canvas(clone, {scale:3,useCORS:true,allowTaint:true,backgroundColor:'#fff',logging:false});
    document.body.removeChild(clone);
    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.92));
    dlBlob(blob, `${title}_page${i+1}.jpg`);
    await delay(50);
  }
  S.zoom = origZ; applyZoom();
  showToast(`${pages.length} JPG(s) downloaded`, 'success');
}

function printDoc() {
  closeMdl('exportMdl');
  // Collect page HTML
  const pages = [...document.querySelectorAll('.page')];
  const origZ = S.zoom; S.zoom = 100; applyZoom();
  const styles = [...document.styleSheets].map(ss => {
    try { return [...ss.cssRules].map(r => r.cssText).join('\n'); } catch { return ''; }
  }).join('\n');
  const body = pages.map(p => p.outerHTML).join('');
  const win = window.open('', '_blank', 'width=900,height=700');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(getTitle())}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#fff;}
.page{width:21cm;min-width:21cm;max-width:21cm;height:29.7cm;background:#fff;padding:2cm;page-break-after:always;overflow:hidden;position:relative;}
.page-content{height:25.7cm;font-size:16px;line-height:1.6;word-wrap:break-word;}
.watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);font-size:72px;color:rgba(0,0,0,.07);pointer-events:none;white-space:nowrap;}
table{border-collapse:collapse;}td,th{border:1px solid #ccc;padding:6px 8px;}
hr{border:none;border-top:2px solid #ccc;margin:12px 0;}
img{max-width:100%;}
@media print{.page{box-shadow:none;margin:0;}}
</style></head><body>${body}<script>window.onload=()=>{window.print();window.onafterprint=()=>window.close();}<\/script></body></html>`);
  win.document.close();
  S.zoom = origZ; applyZoom();
}

/* ═══════════════════════════════════════════════════════
   IMPORT (SCD only)
═══════════════════════════════════════════════════════ */
function openImportModal() {
  document.getElementById('importStatus').textContent = '';
  document.getElementById('importProg').style.display = 'none';
  document.getElementById('importFill').style.width = '0%';
  document.getElementById('importFill').style.background = '#1976d2';
  setupDZ('importDZ', 'importFile', f => handleImport(f));
  openMdl('importMdl');
}

function handleImport(file) {
  if (!file) return;
  const status = document.getElementById('importStatus');
  const prog = document.getElementById('importProg');
  const fill = document.getElementById('importFill');

  if (!file.name.toLowerCase().endsWith('.scd')) {
    status.style.color = '#d32f2f';
    status.textContent = 'Only .scd files can be imported.';
    return;
  }

  prog.style.display = 'block'; fill.style.width = '20%';
  status.style.color = '#1976d2'; status.textContent = 'Reading file…';

  const r = new FileReader();
  r.onload = e => {
    fill.style.width = '70%';
    try {
      const data = JSON.parse(e.target.result);
      if (!data.pages) throw new Error('Not a valid SCD file');
      fill.style.width = '90%'; status.textContent = 'Loading…';
      loadData(data);
      fill.style.width = '100%'; fill.style.background = '#43a047';
      status.style.color = '#43a047'; status.textContent = 'Import successful!';
      setTimeout(() => { closeMdl('importMdl'); showToast('Document imported', 'success'); }, 1200);
    } catch(err) {
      fill.style.background = '#d32f2f'; fill.style.width = '100%';
      status.style.color = '#d32f2f'; status.textContent = 'Error: ' + err.message;
    }
  };
  r.onerror = () => { status.style.color = '#d32f2f'; status.textContent = 'Failed to read file.'; };
  r.readAsText(file);
}

/* ═══════════════════════════════════════════════════════
   SCD DATA
═══════════════════════════════════════════════════════ */
function collectData() {
  return {
    title: getTitle(),
    settings: {
      margin: document.getElementById('pageMargin').value,
      bgType: document.getElementById('bgType').value,
      bgColor: document.getElementById('bgColor').value,
      bgColor2: document.getElementById('bgColor2').value,
      angle: document.getElementById('gradientAngle').value,
      spacing: document.getElementById('lineSpacing').value,
      font: S.font,
      zoom: S.zoom,
      watermark: document.getElementById('watermarkText').value,
    },
    pages: [...document.querySelectorAll('.page-content')].map(p => p.innerHTML),
    meta: {exportedAt: new Date().toISOString(), version: '2.1', app: 'Sugercane Editor', pageCount: S.pageCount},
  };
}

function loadData(data) {
  if (data.title) document.getElementById('docTitle').value = data.title;
  if (data.settings) {
    const s = data.settings;
    if (s.margin)    { document.getElementById('pageMargin').value = s.margin; updateMargins(s.margin); }
    if (s.bgType)    { document.getElementById('bgType').value = s.bgType; toggleGradientUI(s.bgType); }
    if (s.bgColor)   document.getElementById('bgColor').value = s.bgColor;
    if (s.bgColor2)  document.getElementById('bgColor2').value = s.bgColor2;
    if (s.angle)     document.getElementById('gradientAngle').value = s.angle;
    if (s.spacing)   { document.getElementById('lineSpacing').value = s.spacing; updateLineSpacing(s.spacing); }
    if (s.font)      { S.font = s.font; document.getElementById('selectedFont').textContent = s.font; }
    if (s.zoom)      { S.zoom = s.zoom; applyZoom(); }
    if (s.watermark) { document.getElementById('watermarkText').value = s.watermark; }
    updateBackground();
  }
  resetPages();
  if (data.pages && Array.isArray(data.pages)) {
    data.pages.forEach((html, i) => {
      if (i === 0) {
        document.getElementById('pageContent1').innerHTML = html;
      } else {
        addNewPage();
        const pc = document.getElementById(`pageContent${i+1}`);
        if (pc) pc.innerHTML = html;
      }
    });
  }
  bindPages(); updatePageIndicator(); updateWordCount(); updateWatermark();
  setTimeout(() => {
    document.querySelectorAll('.page-content img').forEach(wireImg);
    document.querySelectorAll('.page-content table').forEach(t => {
      t.style.borderCollapse = 'collapse';
      t.querySelectorAll('td,th').forEach(c => { c.style.border = '1px solid #ccc'; c.style.padding = '6px 8px'; });
    });
  }, 100);
  checkContent();
}

function resetPages() {
  const area = document.getElementById('editorArea');
  [...area.querySelectorAll('.page')].forEach((p, i) => { if (i > 0) p.remove(); });
  document.getElementById('pageContent1').innerHTML = '';
  S.pageCount = 1;
  document.getElementById('pageIndicator').textContent = '1/1';
}

/* ═══════════════════════════════════════════════════════
   TEMPLATE SHARING
═══════════════════════════════════════════════════════ */
function shareTemplate(mode) {
  const data = collectData();
  const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  const url = `${location.origin}${location.pathname}#TMP=${encoded}`;
  if (url.length > 8000) showToast('Warning: link may be too large for some browsers', 'info');
  if (mode === 'open') { window.open(url, '_blank'); }
  else { navigator.clipboard.writeText(url).then(() => showToast('Link copied!', 'success')).catch(() => showToast('Could not copy link', 'error')); }
}

function loadTemplateFromHash() {
  const hash = location.hash;
  if (!hash.startsWith('#TMP=')) return;
  try {
    const data = JSON.parse(decodeURIComponent(escape(atob(hash.slice(5)))));
    setTimeout(() => { loadData(data); history.replaceState(null, '', ' '); showToast('Template loaded!', 'success'); }, 300);
  } catch(e) { console.error(e); showToast('Failed to load template', 'error'); }
}

/* ═══════════════════════════════════════════════════════
   THEME
═══════════════════════════════════════════════════════ */
function initTheme() {
  const btn = document.getElementById('themeBtn');
  const icon = btn.querySelector('.material-symbols-outlined');
  const apply = dark => { document.body.classList.toggle('dark', dark); icon.textContent = dark ? 'light_mode' : 'dark_mode'; };
  apply(localStorage.getItem('sc-theme') === 'dark');
  btn.addEventListener('click', () => {
    const d = document.body.classList.toggle('dark');
    localStorage.setItem('sc-theme', d ? 'dark' : 'light');
    icon.textContent = d ? 'light_mode' : 'dark_mode';
  });
}

/* ═══════════════════════════════════════════════════════
   TIPS
═══════════════════════════════════════════════════════ */
const TIPS = [
  'Welcome to Sugercane Editor! A focused A4 document editor.',
  'The toolbar and top bar are scrollable — all tools are accessible on any screen size.',
  'Right-click any table cell to insert/delete rows, columns, or the whole table.',
  'Click "Export" to download as PDF, SCD, DOCX, TXT, or JPG — or print directly.',
  'Import saves are .scd files only. The import button is disabled while you have content.',
  'Use the font dropdown to pick a font, or click + to upload a custom .ttf/.otf/.woff font.',
  'The horizontal rule button inserts a styled divider line into your document.',
  'Zoom in/out from the sidebar — it only affects your view, not the actual document size.',
  'Set a watermark in the sidebar — it appears on every page behind your content.',
  'Dark mode is in the top bar. Your preference is saved between sessions.',
];

function initTips() {
  const KEY = 'sc-tips-v2';
  if (localStorage.getItem(KEY)) return;
  let idx = 0;
  const box = document.getElementById('tipBox');
  const render = () => {
    document.getElementById('tipText').textContent = TIPS[idx];
    document.getElementById('tipBar').style.width = `${((idx+1)/TIPS.length)*100}%`;
    document.getElementById('tipPrev').style.visibility = idx === 0 ? 'hidden' : 'visible';
    document.getElementById('tipNext').textContent = idx === TIPS.length - 1 ? 'Got it' : 'Next';
  };
  window.tipNav = dir => {
    if (dir === 1 && idx === TIPS.length - 1) {
      localStorage.setItem(KEY, '1'); box.classList.add('hide');
      setTimeout(() => box.remove(), 350); return;
    }
    idx = Math.max(0, Math.min(TIPS.length-1, idx+dir)); render();
  };
  render();
  setTimeout(() => box.classList.add('show'), 1500);
}

/* ═══════════════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════════════ */
function showToast(msg, type = 'info') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = {success:'check_circle', error:'error', info:'info'};
  t.innerHTML = `<span class="material-symbols-outlined" style="font-size:17px">${icons[type]||'info'}</span><span>${esc(msg)}</span>`;
  document.body.appendChild(t);
  requestAnimationFrame(() => requestAnimationFrame(() => t.classList.add('show')));
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 350); }, 3300);
}

/* ═══════════════════════════════════════════════════════
   UTILS
═══════════════════════════════════════════════════════ */
function getTitle() { return document.getElementById('docTitle').value || 'Untitled'; }
function safeFile(n) { return n.replace(/[<>:"/\\|?*]/g,'_').replace(/\s+/g,'_').slice(0,80); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
function dlBlob(blob, name) {
  const u = URL.createObjectURL(blob), a = document.createElement('a');
  a.href = u; a.download = name; document.body.appendChild(a); a.click();
  document.body.removeChild(a); setTimeout(() => URL.revokeObjectURL(u), 500);
}

/* Unload warning */
window.addEventListener('beforeunload', e => {
  const has = [...document.querySelectorAll('.page-content')].some(p => p.textContent.trim());
  if (has) { e.preventDefault(); e.returnValue = ''; }
});
window.addEventListener('error', e => console.error('[Sugercane]', e.message));
</script>
</body>
</html>
