<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugercane</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%);
            overflow: auto;
        }

        /* Loading Screen */
        #loadingScreen {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 24px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e3f2fd;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #666;
        }

        /* Editor Container */
        #editorContainer {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            background: #f5f5f5;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
            flex-shrink: 0;
        }

        #docTitle {
            font-size: 20px;
            border: none;
            outline: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            max-width: 400px;
            font-family: Arial, sans-serif;
        }

        #docTitle:hover {
            background: #f5f5f5;
        }

        .export-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .export-btn:hover {
            background: #1565c0;
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 12px 24px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 0 8px;
            border-right: 1px solid #e0e0e0;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: transparent;
            border: none;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: #e3f2fd;
        }

        .toolbar-btn.active {
            background: #bbdefb;
        }

        .toolbar-btn .material-symbols-outlined {
            font-size: 20px;
            color: #333;
        }

        select, input[type="number"] {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 6px 10px;
            outline: none;
            font-size: 14px;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #fontSize {
            width: 50px;
            text-align: center;
        }

        /* Custom Font Dropdown */
        .font-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-selector {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            min-width: 120px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .font-selector:hover {
            background: #f5f5f5;
        }

        .font-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 150px;
            margin-top: 4px;
        }

        .font-menu.active {
            display: block;
        }

        .font-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .font-option:hover {
            background: #e3f2fd;
        }

        .font-option.selected {
            background: #bbdefb;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, width 0.3s ease, min-width 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
            width: 0;
            min-width: 0;
            padding: 0;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-control {
            margin-bottom: 12px;
        }

        .sidebar-control label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .sidebar-control input, .sidebar-control select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
            background: #fafafa;
        }

        .sidebar-control input:focus, .sidebar-control select:focus {
            outline: none;
            border-color: #1976d2;
            background: white;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .collapse-btn {
            width: 100%;
            padding: 10px;
            background: #e3f2fd;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .collapse-btn:hover {
            background: #bbdefb;
        }

        .expand-btn {
            position: fixed;
            left: 20px;
            top: 180px;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 50;
            display: none;
        }

        .expand-btn .material-symbols-outlined {
            font-size: 24px;
        }

        /* Editor Area - CRITICAL: Always maintain A4 size */
        .editor-area-wrapper {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            background: #f5f5f5;
            min-width: 0;
        }

        .editor-area {
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transform-origin: top center;
            transition: transform 0.3s ease;
            min-width: fit-content;
        }

        /* Page - ABSOLUTE A4 SIZE - NEVER SHRINK */
        .page {
            width: 21cm;
            min-width: 21cm;
            max-width: 21cm;
            min-height: 29.7cm;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            position: relative;
            padding: 2cm;
            flex-shrink: 0;
        }

        .page-content {
            min-height: 25.7cm;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            font-family: Arial, sans-serif;
            word-wrap: break-word;
        }

        .page-content img {
            max-width: 100%;
            cursor: move;
            border: 2px solid transparent;
            transition: border 0.2s;
        }

        .page-content img:hover {
            border-color: #1976d2;
        }

        .page-content img.selected {
            border-color: #1976d2;
            outline: 2px dashed #1976d2;
            outline-offset: 4px;
        }

        .page-content img.dragging {
            opacity: 0.7;
            z-index: 1000;
        }

        .image-resize-handle {
            position: fixed;
            width: 12px;
            height: 12px;
            background: #1976d2;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            display: none;
            z-index: 10000;
            pointer-events: auto;
        }

        .add-page-btn {
            background: white;
            border: 2px dashed #1976d2;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
            color: #1976d2;
            transition: all 0.2s;
            margin-top: 20px;
            width: 21cm;
        }

        .add-page-btn:hover {
            background: #e3f2fd;
            transform: scale(1.02);
        }

        /* Page Indicator */
        .page-indicator {
            position: fixed;
            top: 130px;
            right: 40px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #666;
            z-index: 50;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 500;
            color: #333;
        }

        .close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: #f5f5f5;
        }

        .close-btn .material-symbols-outlined {
            font-size: 24px;
            color: #666;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .drop-zone {
            border: 2px dashed #1976d2;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f5f5f5;
        }

        .drop-zone:hover {
            background: #e3f2fd;
        }

        .drop-zone.dragover {
            background: #bbdefb;
            border-color: #1565c0;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .modal-btn-primary {
            background: #1976d2;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #1565c0;
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background: #d0d0d0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: #1976d2;
            transition: width 0.3s;
        }

        .color-picker-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .upload-font-btn {
            background: #e3f2fd;
            border: none;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-font-btn:hover {
            background: #bbdefb;
        }

        .gradient-controls {
            display: none;
            margin-top: 12px;
        }

        .gradient-controls.active {
            display: block;
        }

        .zoom-display {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #1976d2;
            margin: 12px 0;
        }

        .zoom-buttons {
            display: flex;
            gap: 8px;
        }

        .zoom-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 13px;
        }

        .zoom-btn:hover {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        table td, table th {
            border: 1px solid #ddd;
            padding: 8px;
            min-width: 50px;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 72px;
            color: rgba(0,0,0,0.1);
            pointer-events: none;
            white-space: nowrap;
            z-index: 1;
        }

        @media print {
            .page {
                box-shadow: none;
                margin: 0;
                page-break-after: always;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">Creating Canvas...</div>
    </div>

    <!-- Editor Container -->
    <div id="editorContainer">
        <!-- Top Bar -->
        <div class="top-bar">
            <input type="text" id="docTitle" value="Untitled Document" />
            <button class="export-btn" onclick="exportDocument()">
                <span class="material-symbols-outlined">download</span>
                Export
            </button>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="document.execCommand('undo')" title="Undo">
                    <span class="material-symbols-outlined">undo</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('redo')" title="Redo">
                    <span class="material-symbols-outlined">redo</span>
                </button>
            </div>

            <div class="toolbar-group">
                <select id="formatBlock" onchange="changeFormat(this.value)">
                    <option value="p">Paragraph</option>
                    <option value="h1">Heading 1</option>
                    <option value="h2">Heading 2</option>
                    <option value="h3">Heading 3</option>
                    <option value="h4">Heading 4</option>
                    <option value="h5">Heading 5</option>
                    <option value="h6">Heading 6</option>
                    <option value="blockquote">Blockquote</option>
                    <option value="pre">Preformatted</option>
                </select>
            </div>

            <div class="toolbar-group size-control">
                <button class="toolbar-btn" onclick="decreaseFontSize()" title="Decrease Size">
                    <span class="material-symbols-outlined">remove</span>
                </button>
                <input type="number" id="fontSize" value="16" min="8" max="72" onchange="changeFontSize(this.value)" />
                <button class="toolbar-btn" onclick="increaseFontSize()" title="Increase Size">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="toggleFormat('bold')" title="Bold">
                    <span class="material-symbols-outlined">format_bold</span>
                </button>
                <button class="toolbar-btn" onclick="toggleFormat('italic')" title="Italic">
                    <span class="material-symbols-outlined">format_italic</span>
                </button>
                <button class="toolbar-btn" onclick="toggleFormat('underline')" title="Underline">
                    <span class="material-symbols-outlined">format_underlined</span>
                </button>
                <button class="toolbar-btn" onclick="toggleFormat('strikeThrough')" title="Strikethrough">
                    <span class="material-symbols-outlined">strikethrough_s</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="document.execCommand('justifyLeft')" title="Align Left">
                    <span class="material-symbols-outlined">format_align_left</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('justifyCenter')" title="Align Center">
                    <span class="material-symbols-outlined">format_align_center</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('justifyRight')" title="Align Right">
                    <span class="material-symbols-outlined">format_align_right</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('justifyFull')" title="Justify">
                    <span class="material-symbols-outlined">format_align_justify</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="document.execCommand('insertUnorderedList')" title="Bulleted List">
                    <span class="material-symbols-outlined">format_list_bulleted</span>
                </button>
                <button class="toolbar-btn" onclick="document.execCommand('insertOrderedList')" title="Numbered List">
                    <span class="material-symbols-outlined">format_list_numbered</span>
                </button>
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="openImageModal()" title="Insert Image">
                    <span class="material-symbols-outlined">image</span>
                </button>
                <button class="toolbar-btn" onclick="openTableModal()" title="Insert Table">
                    <span class="material-symbols-outlined">table</span>
                </button>
                <button class="toolbar-btn" onclick="openLinkModal()" title="Insert Link">
                    <span class="material-symbols-outlined">link</span>
                </button>
            </div>

            <div class="toolbar-group font-dropdown">
                <div class="font-selector" onclick="toggleFontMenu()" id="fontSelector">
                    <span id="selectedFont">Arial</span>
                    <span class="material-symbols-outlined" style="font-size: 18px;">expand_more</span>
                </div>
                <div class="font-menu" id="fontMenu">
                    <div class="font-option selected" onclick="selectFont('Arial')" style="font-family: Arial;">Arial</div>
                </div>
                <button class="upload-font-btn" onclick="document.getElementById('fontUpload').click()" title="Upload Font">
                    <span class="material-symbols-outlined">add</span>
                </button>
                <input type="file" id="fontUpload" accept=".ttf,.otf,.woff,.woff2" style="display:none" onchange="uploadFont(this)" />
            </div>

            <div class="toolbar-group">
                <input type="color" id="textColor" value="#000000" onchange="changeTextColor(this.value)" title="Text Color" />
                <input type="color" id="highlightColor" value="#ffff00" onchange="changeHighlight(this.value)" title="Highlight" />
            </div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">
                    <span class="material-symbols-outlined">format_clear</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Viewing Adjustment</div>
                    <div class="sidebar-control">
                        <label>Zoom Level</label>
                        <div class="zoom-display" id="zoomDisplay">100%</div>
                        <div class="zoom-buttons">
                            <button class="zoom-btn" onclick="adjustZoom(-10)">
                                <span class="material-symbols-outlined" style="font-size: 18px;">remove</span>
                                Zoom Out
                            </button>
                            <button class="zoom-btn" onclick="adjustZoom(10)">
                                <span class="material-symbols-outlined" style="font-size: 18px;">add</span>
                                Zoom In
                            </button>
                        </div>
                        <button class="zoom-btn" onclick="resetZoom()" style="margin-top: 8px; width: 100%;">
                            <span class="material-symbols-outlined" style="font-size: 18px;">refresh</span>
                            Reset
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Watermark</div>
                    <div class="sidebar-control">
                        <label>Text</label>
                        <input type="text" id="watermarkText" oninput="updateWatermark()" placeholder="Enter watermark text" />
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Line Spacing</div>
                    <div class="sidebar-control">
                        <select id="lineSpacing" onchange="updateLineSpacing(this.value)">
                            <option value="1">Single</option>
                            <option value="1.15">1.15</option>
                            <option value="1.5">1.5</option>
                            <option value="2">Double</option>
                            <option value="2.5">2.5</option>
                            <option value="3">Triple</option>
                        </select>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Page Background</div>
                    <div class="sidebar-control">
                        <label>Type</label>
                        <select id="bgType" onchange="toggleGradient(this.value)">
                            <option value="solid">Solid Color</option>
                            <option value="gradient">Gradient</option>
                        </select>
                    </div>
                    <div class="sidebar-control">
                        <label>Color</label>
                        <input type="color" id="bgColor" value="#ffffff" onchange="updateBackground()" />
                    </div>
                    <div class="gradient-controls" id="gradientControls">
                        <div class="sidebar-control">
                            <label>Second Color</label>
                            <input type="color" id="bgColor2" value="#e3f2fd" onchange="updateBackground()" />
                        </div>
                        <div class="sidebar-control">
                            <label>Angle (deg)</label>
                            <input type="number" id="gradientAngle" value="135" min="0" max="360" onchange="updateBackground()" />
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Page Margins</div>
                    <div class="sidebar-control">
                        <label>All Sides (cm)</label>
                        <input type="number" id="pageMargin" value="2" min="0" max="5" step="0.5" onchange="updateMargins(this.value)" />
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Word Count</div>
                    <div id="wordCount" style="font-size: 14px; color: #666;">0 words</div>
                </div>

                <button class="collapse-btn" onclick="toggleSidebar()">
                    <span class="material-symbols-outlined">chevron_left</span>
                    Collapse
                </button>
            </div>

            <button class="expand-btn" id="expandBtn" onclick="toggleSidebar()">
                <span class="material-symbols-outlined">chevron_right</span>
            </button>

            <!-- Editor Area -->
            <div class="editor-area-wrapper" id="editorAreaWrapper">
                <div class="editor-area" id="editorArea">
                    <div class="page" id="page1">
                        <div class="watermark" id="watermark"></div>
                        <div class="page-content" contenteditable="true" id="pageContent1"></div>
                    </div>
                    <button class="add-page-btn" onclick="addNewPage()">
                        <span class="material-symbols-outlined">add</span>
                        Add New Page
                    </button>
                </div>
            </div>

            <!-- Page Indicator -->
            <div class="page-indicator" id="pageIndicator">1/1</div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Insert Image</h2>
                <button class="close-btn" onclick="closeModal('imageModal')">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="drop-zone" id="imageDropZone">
                    <p>Drag & Drop image here or click to select</p>
                    <input type="file" id="imageFile" accept="image/*" style="display:none" onchange="handleImageSelect(this)" />
                </div>
                <img id="imagePreview" style="max-width: 100%; margin-top: 16px; display: none; border-radius: 8px;" />
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('imageModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="insertImage()">Insert</button>
            </div>
        </div>
    </div>

    <!-- Table Modal -->
    <div class="modal" id="tableModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Insert Table</h2>
                <button class="close-btn" onclick="closeModal('tableModal')">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="sidebar-control">
                    <label>Rows</label>
                    <input type="number" id="tableRows" value="3" min="1" max="20" class="modal-input" />
                </div>
                <div class="sidebar-control">
                    <label>Columns</label>
                    <input type="number" id="tableCols" value="3" min="1" max="10" class="modal-input" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('tableModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="insertTable()">Insert</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Insert Link</h2>
                <button class="close-btn" onclick="closeModal('linkModal')">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="sidebar-control">
                    <label>Display Text</label>
                    <input type="text" id="linkText" class="modal-input" placeholder="Link text" />
                </div>
                <div class="sidebar-control">
                    <label>URL</label>
                    <input type="url" id="linkUrl" class="modal-input" placeholder="https://example.com" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('linkModal')">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="insertLink()">Insert</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Exporting Document</h2>
            </div>
            <div class="modal-body">
                <p id="exportProgress">Preparing document...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer" id="exportActions" style="display: none;">
                <button class="modal-btn modal-btn-secondary" onclick="downloadPDF()">
                    <span class="material-symbols-outlined">download</span>
                    Download
                </button>
                <button class="modal-btn modal-btn-primary" onclick="sharePDF()">
                    <span class="material-symbols-outlined">share</span>
                    Share
                </button>
            </div>
        </div>
    </div>

    <div class="image-resize-handle" id="resizeHandle"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Global variables
        let pageCount = 1;
        let lastCursorPosition = null;
        let selectedImage = null;
        let uploadedFonts = {};
        let currentImageData = null;
        let exportedPDFBlob = null;
        let currentZoom = 100;
        let isResizing = false;
        let isDragging = false;
        let startX, startY, startWidth, startHeight;
        let currentFont = 'Arial';

        // Auto-start on load
        window.onload = function() {
            showLoading();
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('editorContainer').style.display = 'flex';
                
                setupPageContentEditable();
                updatePageIndicator();
                updateWordCount();
                
                // Set default font to Arial
                document.execCommand('fontName', false, 'Arial');
                
                // Add scroll listener for page tracking
                document.getElementById('editorAreaWrapper').addEventListener('scroll', updateCurrentPageNumber);
                
                // Click outside to deselect image and close font menu
                document.addEventListener('click', handleDocumentClick);
            }, 1000);
        };

        function showLoading() {
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        function setupPageContentEditable() {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => {
                page.addEventListener('input', handleContentInput);
                page.addEventListener('paste', handlePaste);
                page.addEventListener('keyup', updateFontSizeDisplay);
                page.addEventListener('click', updateFontSizeDisplay);
            });
        }

        // Custom Font Dropdown Functions
        function toggleFontMenu(e) {
            if (e) e.stopPropagation();
            const menu = document.getElementById('fontMenu');
            menu.classList.toggle('active');
        }

        function selectFont(fontName, e) {
            if (e) e.stopPropagation();
            currentFont = fontName;
            document.getElementById('selectedFont').textContent = fontName;
            document.getElementById('fontMenu').classList.remove('active');
            
            // Update selected state
            document.querySelectorAll('.font-option').forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Apply font to selection
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                changeFont(fontName);
            }
        }

        function handleDocumentClick(e) {
            // Close font menu if clicking outside
            if (!e.target.closest('.font-dropdown')) {
                document.getElementById('fontMenu').classList.remove('active');
            }
            
            // Deselect image if not clicking on image
            if (e.target.tagName !== 'IMG' && !e.target.closest('.image-resize-handle')) {
                deselectImage();
            }
        }

        // Toolbar Functions
        function changeFormat(format) {
            document.execCommand('formatBlock', false, format);
        }

        function toggleFormat(command) {
            document.execCommand(command);
        }

        function changeFontSize(size) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.fontSize = size + 'px';
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    document.execCommand('fontSize', false, '7');
                    const fontElements = document.querySelectorAll('font[size="7"]');
                    fontElements.forEach(el => {
                        el.removeAttribute('size');
                        el.style.fontSize = size + 'px';
                    });
                }
            }
        }

        function increaseFontSize() {
            const current = parseInt(document.getElementById('fontSize').value);
            const newSize = Math.min(current + 2, 72);
            document.getElementById('fontSize').value = newSize;
            changeFontSize(newSize);
        }

        function decreaseFontSize() {
            const current = parseInt(document.getElementById('fontSize').value);
            const newSize = Math.max(current - 2, 8);
            document.getElementById('fontSize').value = newSize;
            changeFontSize(newSize);
        }

        function updateFontSizeDisplay() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const element = range.startContainer.parentElement;
                const fontSize = window.getComputedStyle(element).fontSize;
                document.getElementById('fontSize').value = parseInt(fontSize);
            }
        }

        function changeFont(fontFamily) {
            if (fontFamily) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontFamily = fontFamily;
                    
                    try {
                        range.surroundContents(span);
                    } catch (e) {
                        document.execCommand('fontName', false, fontFamily);
                    }
                }
            }
        }

        function uploadFont(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fontName = file.name.split('.')[0];
                    const fontFace = new FontFace(fontName, `url(${e.target.result})`);
                    
                    fontFace.load().then(loadedFont => {
                        document.fonts.add(loadedFont);
                        uploadedFonts[fontName] = e.target.result;
                        
                        // Add to custom dropdown
                        const menu = document.getElementById('fontMenu');
                        const option = document.createElement('div');
                        option.className = 'font-option';
                        option.textContent = fontName;
                        option.style.fontFamily = fontName;
                        option.onclick = (e) => selectFont(fontName, e);
                        menu.appendChild(option);
                        
                        // Select the new font
                        selectFont(fontName);
                    }).catch(err => {
                        console.error('Font loading failed:', err);
                        alert('Failed to load font. Please try a different font file.');
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        function changeTextColor(color) {
            document.execCommand('foreColor', false, color);
        }

        function changeHighlight(color) {
            document.execCommand('hiliteColor', false, color);
        }

        function clearFormatting() {
            document.execCommand('removeFormat');
            document.execCommand('unlink');
        }

        // Modal Functions
        function openImageModal() {
            saveCursorPosition();
            document.getElementById('imageModal').style.display = 'flex';
            setupImageDropZone();
        }

        function setupImageDropZone() {
            const dropZone = document.getElementById('imageDropZone');
            const fileInput = document.getElementById('imageFile');

            dropZone.onclick = () => fileInput.click();

            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            };

            dropZone.ondragleave = () => {
                dropZone.classList.remove('dragover');
            };

            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    displayImagePreview(file);
                }
            };
        }

        function handleImageSelect(input) {
            const file = input.files[0];
            if (file) {
                displayImagePreview(file);
            }
        }

        function displayImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                const preview = document.getElementById('imagePreview');
                preview.src = currentImageData;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function insertImage() {
            if (currentImageData) {
                restoreCursorPosition();
                const img = document.createElement('img');
                img.src = currentImageData;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.cursor = 'move';
                img.draggable = false;
                
                img.addEventListener('mousedown', (e) => startImageDrag(e, img));
                img.addEventListener('touchstart', (e) => startImageDrag(e, img));
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectImage(img);
                });
                
                insertAtCursor(img);
                
                closeModal('imageModal');
                currentImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('imageFile').value = '';
            }
        }

        function selectImage(img) {
            if (selectedImage) {
                selectedImage.classList.remove('selected');
            }
            selectedImage = img;
            img.classList.add('selected');
            showResizeHandle(img);
        }

        function deselectImage() {
            if (selectedImage) {
                selectedImage.classList.remove('selected');
                selectedImage = null;
                hideResizeHandle();
            }
        }

        function showResizeHandle(img) {
            const handle = document.getElementById('resizeHandle');
            const rect = img.getBoundingClientRect();
            handle.style.display = 'block';
            handle.style.left = (rect.right - 6) + 'px';
            handle.style.top = (rect.bottom - 6) + 'px';
            
            handle.onmousedown = (e) => startResize(e, img);
            handle.ontouchstart = (e) => startResize(e, img);
        }

        function hideResizeHandle() {
            document.getElementById('resizeHandle').style.display = 'none';
        }

        function updateResizeHandle() {
            if (selectedImage) {
                const rect = selectedImage.getBoundingClientRect();
                const handle = document.getElementById('resizeHandle');
                handle.style.left = (rect.right - 6) + 'px';
                handle.style.top = (rect.bottom - 6) + 'px';
            }
        }

        function startResize(e, img) {
            e.preventDefault();
            e.stopPropagation();
            isResizing = true;
            
            const touch = e.touches ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            startWidth = img.offsetWidth;
            startHeight = img.offsetHeight;
            
            const moveHandler = (e) => resizeImage(e, img);
            const endHandler = () => {
                isResizing = false;
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', endHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', endHandler);
            };
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', endHandler);
            document.addEventListener('touchmove', moveHandler);
            document.addEventListener('touchend', endHandler);
        }

        function resizeImage(e, img) {
            if (!isResizing) return;
            
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - startX;
            const deltaY = touch.clientY - startY;
            
            const newWidth = startWidth + deltaX;
            
            if (newWidth > 50) {
                img.style.width = newWidth + 'px';
                img.style.height = 'auto';
            }
            
            updateResizeHandle();
        }

        function startImageDrag(e, img) {
            e.preventDefault();
            e.stopPropagation();
            
            selectImage(img);
            isDragging = true;
            
            const touch = e.touches ? e.touches[0] : e;
            const rect = img.getBoundingClientRect();
            
            startX = touch.clientX;
            startY = touch.clientY;
            
            const initialLeft = img.offsetLeft;
            const initialTop = img.offsetTop;
            
            img.classList.add('dragging');
            img.style.position = 'absolute';
            img.style.left = initialLeft + 'px';
            img.style.top = initialTop + 'px';
            img.style.zIndex = '1000';
            
            const moveHandler = (e) => dragImage(e, img, startX, startY, initialLeft, initialTop);
            const endHandler = () => {
                isDragging = false;
                img.classList.remove('dragging');
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', endHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', endHandler);
            };
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', endHandler);
            document.addEventListener('touchmove', moveHandler);
            document.addEventListener('touchend', endHandler);
        }

        function dragImage(e, img, origStartX, origStartY, origLeft, origTop) {
            if (!isDragging) return;
            
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            
            const deltaX = touch.clientX - origStartX;
            const deltaY = touch.clientY - origStartY;
            
            img.style.left = (origLeft + deltaX) + 'px';
            img.style.top = (origTop + deltaY) + 'px';
            
            updateResizeHandle();
        }

        // Scroll handler to update resize handle
        document.addEventListener('scroll', updateResizeHandle, true);

        function openTableModal() {
            saveCursorPosition();
            document.getElementById('tableModal').style.display = 'flex';
        }

        function insertTable() {
            const rows = parseInt(document.getElementById('tableRows').value);
            const cols = parseInt(document.getElementById('tableCols').value);
            
            let tableHTML = '<table><tbody>';
            for (let i = 0; i < rows; i++) {
                tableHTML += '<tr>';
                for (let j = 0; j < cols; j++) {
                    tableHTML += '<td>&nbsp;</td>';
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table>';
            
            restoreCursorPosition();
            document.execCommand('insertHTML', false, tableHTML);
            closeModal('tableModal');
        }

        function openLinkModal() {
            saveCursorPosition();
            const selection = window.getSelection();
            if (selection.toString()) {
                document.getElementById('linkText').value = selection.toString();
            }
            document.getElementById('linkModal').style.display = 'flex';
        }

        function insertLink() {
            const text = document.getElementById('linkText').value;
            const url = document.getElementById('linkUrl').value;
            
            if (text && url) {
                restoreCursorPosition();
                const link = `<a href="${url}" target="_blank">${text}</a>`;
                document.execCommand('insertHTML', false, link);
                closeModal('linkModal');
                document.getElementById('linkText').value = '';
                document.getElementById('linkUrl').value = '';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Cursor position management
        function saveCursorPosition() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                lastCursorPosition = selection.getRangeAt(0).cloneRange();
            }
        }

        function restoreCursorPosition() {
            if (lastCursorPosition) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(lastCursorPosition);
            }
        }

        function insertAtCursor(element) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.insertNode(element);
                range.setStartAfter(element);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        // Paste handling
        function handlePaste(e) {
            const items = e.clipboardData.items;
            
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.maxWidth = '100%';
                        img.style.cursor = 'move';
                        img.draggable = false;
                        
                        img.addEventListener('mousedown', (e) => startImageDrag(e, img));
                        img.addEventListener('touchstart', (e) => startImageDrag(e, img));
                        img.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectImage(img);
                        });
                        
                        insertAtCursor(img);
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        }

        // Sidebar Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                expandBtn.style.display = 'none';
            } else {
                sidebar.classList.add('collapsed');
                expandBtn.style.display = 'block';
            }
        }

        function updateWatermark() {
            const text = document.getElementById('watermarkText').value;
            const watermarks = document.querySelectorAll('.watermark');
            watermarks.forEach(w => w.textContent = text);
        }

        function updateLineSpacing(value) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.style.lineHeight = value);
        }

        function toggleGradient(type) {
            const controls = document.getElementById('gradientControls');
            if (type === 'gradient') {
                controls.classList.add('active');
            } else {
                controls.classList.remove('active');
            }
            updateBackground();
        }

        function updateBackground() {
            const type = document.getElementById('bgType').value;
            const color1 = document.getElementById('bgColor').value;
            const pages = document.querySelectorAll('.page');
            
            if (type === 'solid') {
                pages.forEach(page => page.style.background = color1);
            } else {
                const color2 = document.getElementById('bgColor2').value;
                const angle = document.getElementById('gradientAngle').value;
                pages.forEach(page => {
                    page.style.background = `linear-gradient(${angle}deg, ${color1}, ${color2})`;
                });
            }
        }

        function updateMargins(value) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.padding = value + 'cm');
        }

        // Page Management
        function addNewPage() {
            pageCount++;
            const editorArea = document.getElementById('editorArea');
            const addBtn = editorArea.querySelector('.add-page-btn');
            
            const newPage = document.createElement('div');
            newPage.className = 'page';
            newPage.id = 'page' + pageCount;
            newPage.innerHTML = `
                <div class="watermark" id="watermark${pageCount}"></div>
                <div class="page-content" contenteditable="true" id="pageContent${pageCount}"></div>
            `;
            
            editorArea.insertBefore(newPage, addBtn);
            setupPageContentEditable();
            updatePageIndicator();
            updateWatermark();
            updateBackground();
            updateMargins(document.getElementById('pageMargin').value);
            updateLineSpacing(document.getElementById('lineSpacing').value);
        }

        function updatePageIndicator() {
            updateCurrentPageNumber();
        }

        function updateCurrentPageNumber() {
            const wrapper = document.getElementById('editorAreaWrapper');
            const pages = document.querySelectorAll('.page');
            const scrollTop = wrapper.scrollTop;
            const viewportMiddle = scrollTop + (wrapper.clientHeight / 2);
            
            let currentPage = 1;
            let accumulatedHeight = 40;
            
            for (let i = 0; i < pages.length; i++) {
                const pageHeight = pages[i].offsetHeight + 20;
                accumulatedHeight += pageHeight;
                
                if (viewportMiddle < accumulatedHeight) {
                    currentPage = i + 1;
                    break;
                }
            }
            
            document.getElementById('pageIndicator').textContent = `${currentPage}/${pageCount}`;
        }

        // Word Count
        function handleContentInput() {
            updateWordCount();
        }

        function updateWordCount() {
            const pages = document.querySelectorAll('.page-content');
            let totalText = '';
            pages.forEach(page => {
                totalText += page.textContent + ' ';
            });
            const words = totalText.trim().split(/\s+/).filter(w => w.length > 0);
            document.getElementById('wordCount').textContent = words.length + ' words';
        }

        // Zoom Functions
        function adjustZoom(delta) {
            currentZoom = Math.max(30, Math.min(200, currentZoom + delta));
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 100;
            applyZoom();
        }

        function applyZoom() {
            const editorArea = document.getElementById('editorArea');
            editorArea.style.transform = `scale(${currentZoom / 100})`;
            document.getElementById('zoomDisplay').textContent = currentZoom + '%';
            updateResizeHandle();
        }

        // Export to PDF with selectable text
        async function exportDocument() {
            document.getElementById('exportModal').style.display = 'flex';
            document.getElementById('exportActions').style.display = 'none';
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pages = document.querySelectorAll('.page');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('exportProgress');
            
            for (let i = 0; i < pages.length; i++) {
                progressText.textContent = `Processing page ${i + 1} of ${pages.length}...`;
                progressFill.style.width = ((i / pages.length) * 100) + '%';
                
                if (i > 0) {
                    pdf.addPage();
                }
                
                // Extract text content
                const pageContent = pages[i].querySelector('.page-content');
                const textContent = pageContent.innerText;
                
                // Add text layer
                let yPosition = 20;
                const lines = textContent.split('\n');
                lines.forEach(line => {
                    if (line.trim()) {
                        pdf.setFontSize(12);
                        pdf.text(line, 20, yPosition, { maxWidth: 170 });
                        yPosition += 7;
                    }
                });
                
                // Also render visual representation
                const canvas = await html2canvas(pages[i], {
                    scale: 1.5,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Add image as background
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight, '', 'NONE', 0);
            }
            
            progressFill.style.width = '100%';
            progressText.textContent = 'Document ready!';
            
            exportedPDFBlob = pdf.output('blob');
            document.getElementById('exportActions').style.display = 'flex';
        }

        function downloadPDF() {
            if (exportedPDFBlob) {
                const url = URL.createObjectURL(exportedPDFBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = document.getElementById('docTitle').value + '.pdf';
                a.click();
                URL.revokeObjectURL(url);
                closeModal('exportModal');
            }
        }

        async function sharePDF() {
            if (exportedPDFBlob && navigator.share) {
                const file = new File([exportedPDFBlob], document.getElementById('docTitle').value +         '.pdf', { type: 'application/pdf' });

        try {
            await navigator.share({
                title: document.getElementById('docTitle').value,
                text: 'Shared from Sugercane',
                files: [file]
            });
        } catch (err) {
            console.warn('Share cancelled or failed:', err);
        }
    } else {
        alert('Sharing is not supported on this device. Please download the PDF instead.');
    }
}

/* =========================
   EXPORT + PDF LOGIC
========================= */

function exportDocument() {
    document.getElementById('exportModal').style.display = 'flex';
    document.getElementById('exportActions').style.display = 'none';
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('exportProgress').textContent = 'Preparing document...';

    setTimeout(generatePDF, 300);
}

async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    const pages = document.querySelectorAll('.page');
    let progress = 0;

    for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff'
        });

        const imgData = canvas.toDataURL('image/png');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        if (i > 0) pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

        progress = Math.round(((i + 1) / pages.length) * 100);
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('exportProgress').textContent = `Rendering page ${i + 1} of ${pages.length}...`;
    }

    exportedPDFBlob = pdf.output('blob');
    document.getElementById('exportProgress').textContent = 'Export complete!';
    document.getElementById('exportActions').style.display = 'flex';
}

function downloadPDF() {
    if (!exportedPDFBlob) return;

    const link = document.createElement('a');
    link.href = URL.createObjectURL(exportedPDFBlob);
    link.download = document.getElementById('docTitle').value + '.pdf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/* =========================
   UTILITY / MODALS
========================= */

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

window.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }
});

/* =========================
   FINAL SAFETY NET
========================= */

window.onerror = function (msg, url, line) {
    console.error('Sugercane error:', msg, 'at', line);
};
</script>
<script>
/* ===============================
   GLOBAL FONT SYNC ENGINE
   =============================== */

function uploadFont(input) {
    const file = input.files[0];
    if (!file) return;

    const fontName = file.name.split('.')[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const fontData = e.target.result;
        
        // Create a new @font-face style
        const style = document.createElement('style');
        style.innerHTML = `
            @font-face {
                font-family: '${fontName}';
                src: url(${fontData});
            }
        `;
        document.head.appendChild(style);

        // Wait for font to load
        document.fonts.load(`1em ${fontName}`).then(() => {
            // Add font to dropdown
            const fontMenu = document.getElementById('fontMenu');
            const newOption = document.createElement('div');
            newOption.classList.add('font-option');
            newOption.style.fontFamily = fontName;
            newOption.textContent = fontName;
            newOption.onclick = () => selectFont(fontName);
            fontMenu.appendChild(newOption);

            // Optionally, auto-select the new font
            selectFont(fontName);
        });
    };

    reader.readAsDataURL(file);
}
setInterval(()=>document.querySelectorAll('.page-content').forEach(p=>p.style.fontFamily=document.getElementById('selectedFont').textContent),1000);

document.addEventListener('click', e => { const modal = document.getElementById('exportModal'); if (modal.style.display !== 'none' && !e.target.closest('#exportModal .modal-content') && !e.target.closest('[onclick*="exportDocument"]')) modal.style.display = 'none'; });


</script>

</body>
</html>
