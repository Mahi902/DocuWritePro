<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Document Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- jsPDF for single page export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #f3f4f6; /* gray-100 default */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }

        /* Material Symbol Styling */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 20px;
        }

        /* --- Theme System --- */

        /* Light Mode (Default) */
        #main-header {
            background-color: #ffffff;
            color: #1f2937; /* gray-800 */
            border-bottom: 1px solid #e5e7eb;
        }
        .control-group {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb;
        }
        .tool-btn {
            @apply p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors duration-200 flex items-center justify-center relative;
        }
        .tool-divider {
            background-color: #d1d5db; /* gray-300 */
        }
        .page-input {
            color: #1f2937;
            border-bottom-color: #9ca3af;
        }

        /* Dark Mode (Inverted Class) */
        body.inverted-mode {
            background-color: #0f0f0f;
        }
        body.inverted-mode #main-header {
            background-color: #000000 !important; /* PURE BLACK */
            color: #f3f4f6;
            border-bottom: 1px solid #333;
        }
        body.inverted-mode .control-group {
            background-color: #1a1a1a;
            border-color: #333;
        }
        body.inverted-mode .tool-btn {
            color: #9ca3af; /* gray-400 */
        }
        body.inverted-mode .tool-btn:hover {
            color: #ffffff;
            background-color: #333;
        }
        body.inverted-mode .tool-divider {
            background-color: #4b5563; /* gray-600 */
        }
        body.inverted-mode .page-input {
            color: #ffffff;
            border-bottom-color: #4b5563;
        }

        /* Canvas Specifics */
        #canvas-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            position: relative;
        }
        
        canvas {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: filter 0.3s ease;
            background-color: white; 
        }

        /* The actual page inversion logic */
        body.inverted-mode canvas {
            filter: invert(1) hue-rotate(180deg);
        }

        /* UI Utilities */
        .tool-btn:disabled {
            @apply opacity-30 cursor-not-allowed hover:bg-transparent !important;
        }

        .dropdown-menu {
            transform-origin: top right;
            transition: all 0.2s ease-out;
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .dropdown-menu.open {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        /* Scrollbar */
        #canvas-container::-webkit-scrollbar { width: 10px; height: 10px; }
        #canvas-container::-webkit-scrollbar-track { background: transparent; }
        #canvas-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        body.inverted-mode #canvas-container::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>

    <!-- Header / Toolbar -->
    <header id="main-header" class="shadow-sm z-10 p-2 flex items-center justify-between gap-2 select-none h-16 transition-colors duration-300">
        
        <!-- Left: Upload -->
        <div class="flex items-center">
            <input type="file" id="file-upload" class="hidden" accept=".pdf" />
            <button onclick="document.getElementById('file-upload').click()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 flex items-center mr-2 transition-colors shadow-sm" title="Open File">
                <span class="material-symbols-outlined mr-2">folder_open</span>
                <span class="text-sm font-medium">Open</span>
            </button>
            <div id="file-name" class="text-xs opacity-70 max-w-[150px] truncate hidden md:block font-medium">No file selected</div>
        </div>

        <!-- Center: Navigation & Zoom -->
        <div class="control-group flex items-center rounded-lg p-1 transition-colors duration-300 shadow-sm">
            <!-- Page Nav -->
            <button id="prev-page" class="tool-btn" title="Previous Page">
                <span class="material-symbols-outlined">chevron_left</span>
            </button>
            <div class="flex items-center px-2 space-x-1">
                <input type="number" id="page-num" value="0" class="page-input w-10 bg-transparent text-center text-sm font-medium focus:outline-none border-b focus:border-blue-500 transition-colors" />
                <span class="opacity-60 text-sm">/ <span id="page-count">0</span></span>
            </div>
            <button id="next-page" class="tool-btn" title="Next Page">
                <span class="material-symbols-outlined">chevron_right</span>
            </button>
            
            <div class="tool-divider h-6 w-px mx-2 transition-colors"></div>

            <!-- Zoom -->
            <button id="zoom-out" class="tool-btn" title="Zoom Out">
                <span class="material-symbols-outlined">remove</span>
            </button>
            <span id="zoom-level" class="text-xs font-mono opacity-80 w-12 text-center">100%</span>
            <button id="zoom-in" class="tool-btn" title="Zoom In">
                <span class="material-symbols-outlined">add</span>
            </button>
        </div>

        <!-- Right: View Options & Actions -->
        <div class="flex items-center gap-1 relative">
            <!-- Rotation -->
            <button id="rotate-btn" class="tool-btn" title="Rotate Clockwise">
                <span class="material-symbols-outlined">rotate_right</span>
            </button>
            
            <!-- Theme Toggle -->
            <button id="theme-btn" class="tool-btn" title="Toggle Dark Theme">
                <span id="theme-icon" class="material-symbols-outlined">dark_mode</span>
            </button>

            <div class="tool-divider h-6 w-px mx-2 bg-gray-300"></div>

            <!-- Print -->
            <button id="print-btn" class="tool-btn" title="Print">
                <span class="material-symbols-outlined">print</span>
            </button>

            <!-- Download Dropdown Trigger -->
            <div class="relative">
                <button id="download-menu-btn" class="tool-btn" title="Download Options">
                    <span class="material-symbols-outlined">download</span>
                    <span class="material-symbols-outlined text-[16px] ml-1">arrow_drop_down</span>
                </button>

                <!-- Dropdown Menu -->
                <div id="download-dropdown" class="dropdown-menu absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-100 py-1 z-50 text-gray-800">
                    <button id="download-full" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                        <span class="material-symbols-outlined text-gray-500">description</span>
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold">Download PDF</span>
                            <span class="text-[10px] text-gray-400">Save the entire document</span>
                        </div>
                    </button>
                    <div class="h-px bg-gray-100 mx-2"></div>
                    <button id="download-page" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                        <span class="material-symbols-outlined text-gray-500">article</span>
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold">Download Page</span>
                            <span class="text-[10px] text-gray-400">Save current page as PDF</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="canvas-container">
        <!-- Placeholder / Loading State -->
        <div id="empty-state" class="flex flex-col items-center justify-center h-full opacity-40">
            <span class="material-symbols-outlined text-7xl mb-4">plagiarism</span>
            <h2 class="text-xl font-medium">No document loaded</h2>
            <p class="text-sm mt-2">Click "Open" to view a PDF</p>
        </div>

        <div id="loading-state" class="hidden flex-col items-center justify-center absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 bg-white/90 p-6 rounded-xl backdrop-blur-sm shadow-lg border border-gray-100">
            <div class="loader mb-3"></div>
            <span class="text-sm font-medium text-gray-600">Rendering...</span>
        </div>

        <!-- The PDF Page Canvas -->
        <canvas id="the-canvas" class="hidden"></canvas>
    </main>

    <script>
        // --- State Management ---
        const state = {
            pdfDoc: null,
            pageNum: 1,
            pageRendering: false,
            pageNumPending: null,
            scale: 1.0,
            rotation: 0, 
            isDarkMode: false,
            currentFile: null,
            currentFileName: "document.pdf"
        };

        // --- DOM Elements ---
        const els = {
            canvas: document.getElementById('the-canvas'),
            ctx: document.getElementById('the-canvas').getContext('2d'),
            pageCount: document.getElementById('page-count'),
            pageNum: document.getElementById('page-num'),
            container: document.getElementById('canvas-container'),
            emptyState: document.getElementById('empty-state'),
            loadingState: document.getElementById('loading-state'),
            zoomLevel: document.getElementById('zoom-level'),
            fileName: document.getElementById('file-name'),
            dropdown: document.getElementById('download-dropdown'),
            fileInput: document.getElementById('file-upload'),
            themeIcon: document.getElementById('theme-icon')
        };

        // --- Core Rendering Logic ---
        async function renderPage(num) {
            state.pageRendering = true;
            els.loadingState.classList.remove('hidden');
            els.loadingState.classList.add('flex');

            try {
                const page = await state.pdfDoc.getPage(num);
                const pixelRatio = window.devicePixelRatio || 1;
                const viewport = page.getViewport({ scale: state.scale, rotation: state.rotation });

                els.canvas.width = Math.floor(viewport.width * pixelRatio);
                els.canvas.height = Math.floor(viewport.height * pixelRatio);
                els.canvas.style.width = `${Math.floor(viewport.width)}px`;
                els.canvas.style.height = `${Math.floor(viewport.height)}px`;

                const transform = pixelRatio !== 1 ? [pixelRatio, 0, 0, pixelRatio, 0, 0] : null;

                const renderContext = {
                    canvasContext: els.ctx,
                    transform: transform,
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                
                state.pageRendering = false;
                els.loadingState.classList.add('hidden');
                els.loadingState.classList.remove('flex');
                els.canvas.classList.remove('hidden');
                els.emptyState.classList.add('hidden');
                els.pageNum.value = num;

                if (state.pageNumPending !== null) {
                    renderPage(state.pageNumPending);
                    state.pageNumPending = null;
                }
            } catch (error) {
                console.error("Error rendering page:", error);
                state.pageRendering = false;
                els.loadingState.classList.add('hidden');
            }
        }

        function queueRenderPage(num) {
            if (state.pageRendering) {
                state.pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function onPrevPage() {
            if (state.pageNum <= 1) return;
            state.pageNum--;
            queueRenderPage(state.pageNum);
        }

        function onNextPage() {
            if (state.pageNum >= state.pdfDoc.numPages) return;
            state.pageNum++;
            queueRenderPage(state.pageNum);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            state.currentFile = file;
            state.currentFileName = file.name;
            els.fileName.textContent = file.name;
            state.pageNum = 1;
            state.scale = 1.0;
            state.rotation = 0;
            els.zoomLevel.textContent = "100%";

            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                    state.pdfDoc = pdf;
                    els.pageCount.textContent = pdf.numPages;
                    renderPage(state.pageNum);
                    updateButtonStates();
                }, reason => {
                    console.error('Error loading PDF:', reason);
                    alert("Error loading PDF: " + reason);
                });
            };
            fileReader.readAsArrayBuffer(file);
        }

        // --- Controls & Theme ---

        function updateButtonStates() {
            const loaded = !!state.pdfDoc;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                // Keep file open and theme button enabled always
                if (!btn.querySelector('.material-symbols-outlined').textContent.includes('folder_open') && 
                    !btn.id.includes('theme-btn')) {
                    btn.disabled = !loaded;
                }
            });
        }

        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            
            if (state.isDarkMode) {
                document.body.classList.add('inverted-mode');
                els.themeIcon.textContent = 'light_mode'; // Icon becomes sun to switch back
                els.themeIcon.parentElement.title = "Switch to Light Mode";
            } else {
                document.body.classList.remove('inverted-mode');
                els.themeIcon.textContent = 'dark_mode'; // Icon becomes moon
                els.themeIcon.parentElement.title = "Switch to Dark Mode";
            }
        }

        function rotatePage() {
            state.rotation = (state.rotation + 90) % 360;
            queueRenderPage(state.pageNum);
        }

        function zoomIn() {
            state.scale += 0.2;
            els.zoomLevel.textContent = Math.round(state.scale * 100) + "%";
            queueRenderPage(state.pageNum);
        }

        function zoomOut() {
            if (state.scale <= 0.4) return;
            state.scale -= 0.2;
            els.zoomLevel.textContent = Math.round(state.scale * 100) + "%";
            queueRenderPage(state.pageNum);
        }

        // --- Export & Download ---

        function downloadFullPDF() {
            if (!state.currentFile) return;
            const url = URL.createObjectURL(state.currentFile);
            const a = document.createElement('a');
            a.href = url;
            a.download = state.currentFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            closeDropdown();
        }

        async function downloadCurrentPage() {
            if (!state.pdfDoc) return;
            const originalText = document.getElementById('download-page').innerHTML;
            document.getElementById('download-page').innerHTML = `<span class="material-symbols-outlined animate-spin">refresh</span> Generating...`;

            try {
                const { jsPDF } = window.jspdf;
                const page = await state.pdfDoc.getPage(state.pageNum);
                const viewport = page.getViewport({ scale: 2.0, rotation: state.rotation });
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new jsPDF({
                    orientation: viewport.width > viewport.height ? 'landscape' : 'portrait',
                    unit: 'px',
                    format: [viewport.width, viewport.height]
                });

                pdf.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height);
                pdf.save(`page_${state.pageNum}_${state.currentFileName}`);
            } catch (err) {
                console.error(err);
                alert("Could not generate page PDF.");
            } finally {
                document.getElementById('download-page').innerHTML = originalText;
                closeDropdown();
            }
        }

        function printPDF() {
            if (!state.currentFile) return;
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            const objectUrl = URL.createObjectURL(state.currentFile);
            iframe.src = objectUrl;
            iframe.onload = function() {
                try {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                } catch (e) {
                    alert("Please use the browser's print dialog (Ctrl+P) after downloading.");
                }
            };
            setTimeout(() => { document.body.removeChild(iframe); URL.revokeObjectURL(objectUrl); }, 60000);
        }

        // --- Event Listeners ---
        document.getElementById('prev-page').addEventListener('click', onPrevPage);
        document.getElementById('next-page').addEventListener('click', onNextPage);
        document.getElementById('zoom-in').addEventListener('click', zoomIn);
        document.getElementById('zoom-out').addEventListener('click', zoomOut);
        document.getElementById('rotate-btn').addEventListener('click', rotatePage);
        document.getElementById('theme-btn').addEventListener('click', toggleTheme);
        els.fileInput.addEventListener('change', handleFileSelect);

        els.pageNum.addEventListener('change', (e) => {
            let num = parseInt(e.target.value);
            if (num >= 1 && num <= state.pdfDoc.numPages) {
                state.pageNum = num;
                queueRenderPage(num);
            } else {
                e.target.value = state.pageNum;
            }
        });

        const dropdownBtn = document.getElementById('download-menu-btn');
        const closeDropdown = () => els.dropdown.classList.remove('open');
        dropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            els.dropdown.classList.toggle('open');
        });
        document.addEventListener('click', closeDropdown);
        document.getElementById('download-full').addEventListener('click', downloadFullPDF);
        document.getElementById('download-page').addEventListener('click', (e) => {
            e.stopPropagation();
            downloadCurrentPage();
        });
        document.getElementById('print-btn').addEventListener('click', printPDF);

        document.addEventListener('keydown', (e) => {
            if (!state.pdfDoc) return;
            if (e.key === 'ArrowLeft') onPrevPage();
            if (e.key === 'ArrowRight') onNextPage();
            if (e.key === '+' || (e.ctrlKey && e.key === '=')) { e.preventDefault(); zoomIn(); }
            if (e.key === '-' || (e.ctrlKey && e.key === '-')) { e.preventDefault(); zoomOut(); }
        });

        updateButtonStates();
    </script>
</body>
</html>
